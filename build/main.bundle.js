(()=>{"use strict";const t=["00","01","02","03","04","05","06","07","08","09","0a","0b","0c","0d","0e","0f","10","11","12","13","14","15","16","17","18","19","1a","1b","1c","1d","1e","1f","20","21","22","23","24","25","26","27","28","29","2a","2b","2c","2d","2e","2f","30","31","32","33","34","35","36","37","38","39","3a","3b","3c","3d","3e","3f","40","41","42","43","44","45","46","47","48","49","4a","4b","4c","4d","4e","4f","50","51","52","53","54","55","56","57","58","59","5a","5b","5c","5d","5e","5f","60","61","62","63","64","65","66","67","68","69","6a","6b","6c","6d","6e","6f","70","71","72","73","74","75","76","77","78","79","7a","7b","7c","7d","7e","7f","80","81","82","83","84","85","86","87","88","89","8a","8b","8c","8d","8e","8f","90","91","92","93","94","95","96","97","98","99","9a","9b","9c","9d","9e","9f","a0","a1","a2","a3","a4","a5","a6","a7","a8","a9","aa","ab","ac","ad","ae","af","b0","b1","b2","b3","b4","b5","b6","b7","b8","b9","ba","bb","bc","bd","be","bf","c0","c1","c2","c3","c4","c5","c6","c7","c8","c9","ca","cb","cc","cd","ce","cf","d0","d1","d2","d3","d4","d5","d6","d7","d8","d9","da","db","dc","dd","de","df","e0","e1","e2","e3","e4","e5","e6","e7","e8","e9","ea","eb","ec","ed","ee","ef","f0","f1","f2","f3","f4","f5","f6","f7","f8","f9","fa","fb","fc","fd","fe","ff"],e=Math.PI/180,i=180/Math.PI;function s(t,e,i){return Math.max(e,Math.min(i,t))}function r(t,e,i){return(1-i)*t+i*e}const n="srgb",o="srgb-linear";function h(t){return t<.04045?.0773993808*t:Math.pow(.9478672986*t+.0521327014,2.4)}function a(t){return t<.0031308?12.92*t:1.055*Math.pow(t,.41666)-.055}const l={[n]:{[o]:h},[o]:{[n]:a}},m={legacyMode:!0,get workingColorSpace(){return o},set workingColorSpace(t){console.warn("THREE.ColorManagement: .workingColorSpace is readonly.")},convert:function(t,e,i){if(this.legacyMode||e===i||!e||!i)return t;if(l[e]&&void 0!==l[e][i]){const s=l[e][i];return t.r=s(t.r),t.g=s(t.g),t.b=s(t.b),t}throw new Error("Unsupported color space conversion.")},fromWorkingColorSpace:function(t,e){return this.convert(t,this.workingColorSpace,e)},toWorkingColorSpace:function(t,e){return this.convert(t,e,this.workingColorSpace)}},c={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,rebeccapurple:6697881,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074},u={r:0,g:0,b:0},_={h:0,s:0,l:0},d={h:0,s:0,l:0};function p(t,e,i){return i<0&&(i+=1),i>1&&(i-=1),i<1/6?t+6*(e-t)*i:i<.5?e:i<2/3?t+6*(e-t)*(2/3-i):t}function f(t,e){return e.r=t.r,e.g=t.g,e.b=t.b,e}class y{constructor(t,e,i){return this.isColor=!0,this.r=1,this.g=1,this.b=1,void 0===e&&void 0===i?this.set(t):this.setRGB(t,e,i)}set(t){return t&&t.isColor?this.copy(t):"number"==typeof t?this.setHex(t):"string"==typeof t&&this.setStyle(t),this}setScalar(t){return this.r=t,this.g=t,this.b=t,this}setHex(t,e="srgb"){return t=Math.floor(t),this.r=(t>>16&255)/255,this.g=(t>>8&255)/255,this.b=(255&t)/255,m.toWorkingColorSpace(this,e),this}setRGB(t,e,i,s="srgb-linear"){return this.r=t,this.g=e,this.b=i,m.toWorkingColorSpace(this,s),this}setHSL(t,e,i,r="srgb-linear"){if(t=(t%(n=1)+n)%n,e=s(e,0,1),i=s(i,0,1),0===e)this.r=this.g=this.b=i;else{const s=i<=.5?i*(1+e):i+e-i*e,r=2*i-s;this.r=p(r,s,t+1/3),this.g=p(r,s,t),this.b=p(r,s,t-1/3)}var n;return m.toWorkingColorSpace(this,r),this}setStyle(t,e="srgb"){function i(e){void 0!==e&&parseFloat(e)<1&&console.warn("THREE.Color: Alpha component of "+t+" will be ignored.")}let s;if(s=/^((?:rgb|hsl)a?)\(([^\)]*)\)/.exec(t)){let t;const r=s[1],n=s[2];switch(r){case"rgb":case"rgba":if(t=/^\s*(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(n))return this.r=Math.min(255,parseInt(t[1],10))/255,this.g=Math.min(255,parseInt(t[2],10))/255,this.b=Math.min(255,parseInt(t[3],10))/255,m.toWorkingColorSpace(this,e),i(t[4]),this;if(t=/^\s*(\d+)\%\s*,\s*(\d+)\%\s*,\s*(\d+)\%\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(n))return this.r=Math.min(100,parseInt(t[1],10))/100,this.g=Math.min(100,parseInt(t[2],10))/100,this.b=Math.min(100,parseInt(t[3],10))/100,m.toWorkingColorSpace(this,e),i(t[4]),this;break;case"hsl":case"hsla":if(t=/^\s*(\d*\.?\d+)\s*,\s*(\d+)\%\s*,\s*(\d+)\%\s*(?:,\s*(\d*\.?\d+)\s*)?$/.exec(n)){const s=parseFloat(t[1])/360,r=parseInt(t[2],10)/100,n=parseInt(t[3],10)/100;return i(t[4]),this.setHSL(s,r,n,e)}}}else if(s=/^\#([A-Fa-f\d]+)$/.exec(t)){const t=s[1],i=t.length;if(3===i)return this.r=parseInt(t.charAt(0)+t.charAt(0),16)/255,this.g=parseInt(t.charAt(1)+t.charAt(1),16)/255,this.b=parseInt(t.charAt(2)+t.charAt(2),16)/255,m.toWorkingColorSpace(this,e),this;if(6===i)return this.r=parseInt(t.charAt(0)+t.charAt(1),16)/255,this.g=parseInt(t.charAt(2)+t.charAt(3),16)/255,this.b=parseInt(t.charAt(4)+t.charAt(5),16)/255,m.toWorkingColorSpace(this,e),this}return t&&t.length>0?this.setColorName(t,e):this}setColorName(t,e="srgb"){const i=c[t.toLowerCase()];return void 0!==i?this.setHex(i,e):console.warn("THREE.Color: Unknown color "+t),this}clone(){return new this.constructor(this.r,this.g,this.b)}copy(t){return this.r=t.r,this.g=t.g,this.b=t.b,this}copySRGBToLinear(t){return this.r=h(t.r),this.g=h(t.g),this.b=h(t.b),this}copyLinearToSRGB(t){return this.r=a(t.r),this.g=a(t.g),this.b=a(t.b),this}convertSRGBToLinear(){return this.copySRGBToLinear(this),this}convertLinearToSRGB(){return this.copyLinearToSRGB(this),this}getHex(t="srgb"){return m.fromWorkingColorSpace(f(this,u),t),s(255*u.r,0,255)<<16^s(255*u.g,0,255)<<8^s(255*u.b,0,255)<<0}getHexString(t="srgb"){return("000000"+this.getHex(t).toString(16)).slice(-6)}getHSL(t,e="srgb-linear"){m.fromWorkingColorSpace(f(this,u),e);const i=u.r,s=u.g,r=u.b,n=Math.max(i,s,r),o=Math.min(i,s,r);let h,a;const l=(o+n)/2;if(o===n)h=0,a=0;else{const t=n-o;switch(a=l<=.5?t/(n+o):t/(2-n-o),n){case i:h=(s-r)/t+(s<r?6:0);break;case s:h=(r-i)/t+2;break;case r:h=(i-s)/t+4}h/=6}return t.h=h,t.s=a,t.l=l,t}getRGB(t,e="srgb-linear"){return m.fromWorkingColorSpace(f(this,u),e),t.r=u.r,t.g=u.g,t.b=u.b,t}getStyle(t="srgb"){return m.fromWorkingColorSpace(f(this,u),t),t!==n?`color(${t} ${u.r} ${u.g} ${u.b})`:`rgb(${255*u.r|0},${255*u.g|0},${255*u.b|0})`}offsetHSL(t,e,i){return this.getHSL(_),_.h+=t,_.s+=e,_.l+=i,this.setHSL(_.h,_.s,_.l),this}add(t){return this.r+=t.r,this.g+=t.g,this.b+=t.b,this}addColors(t,e){return this.r=t.r+e.r,this.g=t.g+e.g,this.b=t.b+e.b,this}addScalar(t){return this.r+=t,this.g+=t,this.b+=t,this}sub(t){return this.r=Math.max(0,this.r-t.r),this.g=Math.max(0,this.g-t.g),this.b=Math.max(0,this.b-t.b),this}multiply(t){return this.r*=t.r,this.g*=t.g,this.b*=t.b,this}multiplyScalar(t){return this.r*=t,this.g*=t,this.b*=t,this}lerp(t,e){return this.r+=(t.r-this.r)*e,this.g+=(t.g-this.g)*e,this.b+=(t.b-this.b)*e,this}lerpColors(t,e,i){return this.r=t.r+(e.r-t.r)*i,this.g=t.g+(e.g-t.g)*i,this.b=t.b+(e.b-t.b)*i,this}lerpHSL(t,e){this.getHSL(_),t.getHSL(d);const i=r(_.h,d.h,e),s=r(_.s,d.s,e),n=r(_.l,d.l,e);return this.setHSL(i,s,n),this}equals(t){return t.r===this.r&&t.g===this.g&&t.b===this.b}fromArray(t,e=0){return this.r=t[e],this.g=t[e+1],this.b=t[e+2],this}toArray(t=[],e=0){return t[e]=this.r,t[e+1]=this.g,t[e+2]=this.b,t}fromBufferAttribute(t,e){return this.r=t.getX(e),this.g=t.getY(e),this.b=t.getZ(e),!0===t.normalized&&(this.r/=255,this.g/=255,this.b/=255),this}toJSON(){return this.getHex()}*[Symbol.iterator](){yield this.r,yield this.g,yield this.b}}y.NAMES=c;class x{}class g extends x{static get instance(){return g._instance}}g._instance=new g;class w extends x{constructor(t){super(),this.Et=t}get seconds(){return this.Et}}class C extends x{constructor(t){super(),this.Ot=t}get predicate(){return this.Ot}}class v extends x{constructor(t){super(),this.Ot=t}get predicate(){return this.Ot}}class S{constructor(t){this.h=t,this.Wt=[],this.Ft=0}addCoroutine(t){this.Wt.push(t),this.Ft+=1}removeCoroutine(t){const e=this.Wt.indexOf(t);e>=0&&(this.Wt[e]=null,this.Ft-=1)}tryCompact(){if(S._needToCompactCount<=this.Wt.length-this.Ft){let t=0;for(let e=0;e<this.Wt.length;e++){const i=this.Wt[e];null!==i&&(this.Wt[t]=i,t+=1)}this.Wt.length=this.Ft}}updateAfterProcess(){const t=this.Wt;for(let e=0;e<t.length;e++){const i=t[e];null!=i&&(i.currentYieldInstructionExist?this.Pt(i):(t[e]=null,this.Ft-=1))}}Pt(t){const e=t.currentYieldInstruction;e instanceof w?(t.elapsedTime+=this.h.deltaTime,t.elapsedTime>=e.seconds&&(t.elapsedTime=0,t.fatchNextInstruction())):e instanceof C?e.predicate()&&t.fatchNextInstruction():e instanceof v?e.predicate()||t.fatchNextInstruction():null===e&&t.fatchNextInstruction()}endFrameAfterProcess(){const t=this.Wt;for(let e=0;e<t.length;e++){const i=t[e];null!=i&&(i.currentYieldInstructionExist?this.Ct(i):(t[e]=null,this.Ft-=1))}}Ct(t){t.currentYieldInstruction instanceof g&&t.fatchNextInstruction()}}S._needToCompactCount=16;class b{constructor(t){this.next=null,this.prev=null,this.value=t}}class B{constructor(){this.st=!1,this.it=null,this.et=null,this.lt=0}get length(){return this.lt}add(t){const e=new b(t);null===this.it?(this.it=e,this.et=e):(this.et.next=e,e.prev=this.et,this.et=e),this.lt++}ht(t){null!==t.prev?t.prev.next=t.next:this.it=t.next,null!==t.next?t.next.prev=t.prev:this.et=t.prev,this.lt--}remove(t){let e=this.it;for(;null!==e;){if(e.value===t)return void this.ht(e);e=e.next}}removeAll(){this.it=null,this.et=null,this.lt=0,this.st=!0}forEach(t){this.st=!1;let e=this.it;for(;null!==e;)if(t(e.value),this.st){if(null===this.it)return;e=this.it,this.st=!1}else e=e.next}}class A{constructor(){this.nt=new B}addListener(t){this.nt.add(t)}removeListener(t){this.nt.remove(t)}removeAllListeners(){this.nt.removeAll()}invoke(...t){this.nt.forEach((e=>{e(...t)}))}get length(){return this.nt.length}}class V{constructor(t){this.Ks=new A,this.ks=new A,this.Hs=new A,this.Is=new A,this.Xs=new A,this.Ys=new A,this.zs=new A,this.Gs=new A,this.Js=!1,this.Zs=null,this.$s=null,this.ue=null,this.le=t=>{const e=1===t.key.length?t.key.toLowerCase():t.key;this.we.set(e,!0),this.Ks.invoke(t)},this.ve=t=>{const e=1===t.key.length?t.key.toLowerCase():t.key;this.we.set(e,!1),this.ks.invoke(t)},this.me=t=>{this.Hs.invoke(t)},this.de=t=>{this.$s=t,this.Is.invoke(t)},this.pe=t=>{this.$s=null,this.Xs.invoke(t)},this.Ee=t=>{this.ue=t,this.Ys.invoke(t)},this.ge=t=>{this.ue=null,this.zs.invoke(t)},this.ye=t=>{this.$s=t,this.Gs.invoke(t)},this.Ce=t=>{this.Zs=()=>{this.Ke("mouseenter",t.touches[0]),this.Ke("mousedown",t.touches[0])}},this.be=t=>{this.Js&&(this.Js=!1,this.Ke("mouseup",t.changedTouches[0]),this.Ke("mouseleave",t.changedTouches[0]))},this.Pe=t=>{this.Zs&&(this.Zs(),this.Zs=null),this.Ke("mousemove",t.touches[0]),this.Js=!0},this.ke=t=>{this.Js&&(this.Js=!1,this.Ke("mouseleave",t.changedTouches[0]))},this.we=new Map,this.F=!1,this.He=t}get map(){return this.we}dispose(){this.stopHandleEvents(),this.F=!0}startHandleEvents(){if(this.F)throw new Error("InputHandler is disposed.");window.addEventListener("keydown",this.le),window.addEventListener("keyup",this.ve),window.addEventListener("wheel",this.me),this.He.addEventListener("mousedown",this.de),this.He.addEventListener("mouseup",this.pe),this.He.addEventListener("mouseenter",this.Ee),this.He.addEventListener("mouseleave",this.ge),this.He.addEventListener("mousemove",this.ye),this.He.addEventListener("touchstart",this.Ce),this.He.addEventListener("touchend",this.be),this.He.addEventListener("touchmove",this.Pe),this.He.addEventListener("touchcancel",this.ke)}stopHandleEvents(){this.$s&&this.pe(this.$s),this.ue&&this.ge(this.ue),this.we.clear(),window.removeEventListener("keydown",this.le),window.removeEventListener("keyup",this.ve),window.removeEventListener("wheel",this.me),this.He.removeEventListener("mousedown",this.de),this.He.removeEventListener("mouseup",this.pe),this.He.removeEventListener("mouseenter",this.Ee),this.He.removeEventListener("mouseleave",this.ge),this.He.removeEventListener("mousemove",this.ye),this.He.removeEventListener("touchstart",this.Ce),this.He.removeEventListener("touchend",this.be),this.He.removeEventListener("touchmove",this.Pe),this.He.removeEventListener("touchcancel",this.ke)}Ke(t,e){const i=new MouseEvent(t,{bubbles:!0,cancelable:!0,view:window,detail:1,screenX:e.screenX,screenY:e.screenY,clientX:e.clientX,clientY:e.clientY,ctrlKey:!1,altKey:!1,shiftKey:!1,metaKey:!1,button:0,relatedTarget:null});e.target.dispatchEvent(i)}get onKeyDown(){return this.Ks}get onKeyUp(){return this.ks}get onWheel(){return this.Hs}get onPointerDown(){return this.Is}get onPointerUp(){return this.Xs}get onPointerEnter(){return this.Ys}get onPointerLeave(){return this.zs}get onPointerMove(){return this.Gs}}var M,D=(M=function(t,e){return M=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i])},M(t,e)},function(t,e){if("function"!=typeof e&&null!==e)throw new G("Class extends value "+String(e)+" is not a constructor or null");function i(){this.constructor=t}M(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)});function I(t,e){return function(i){function s(s){void 0===s&&(s=e);var r=i.call(this,s)||this;return r.name=t,r}return D(s,i),s}(Error)}I("TestError","test error");var P,G=I("TypeError","type error"),T=I("RunTimeError","access out of bounds"),R=I("InternalError","internal error"),F=I("NullValueError","you can not set null value here"),k=(I("ContainerInitError","container init failed"),function(){var t=function(e,i){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i])},t(e,i)};return function(e,i){if("function"!=typeof i&&null!==i)throw new TypeError("Class extends value "+String(i)+" is not a constructor or null");function s(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(s.prototype=i.prototype,new s)}}()),E=function(){function t(){this.length=0}return t.prototype.size=function(){return this.length},t.prototype.empty=function(){return 0===this.length},t}();function L(t,e,i){if(t<e||t>i)throw new T}k((function(){return null!==P&&P.apply(this,arguments)||this}),P=E);const O=function(){function t(t,e){this.color=!0,this.key=void 0,this.value=void 0,this.parent=void 0,this.brother=void 0,this.leftChild=void 0,this.rightChild=void 0,this.key=t,this.value=e}return t.prototype.rotateLeft=function(){var t=this.parent,e=this.brother,i=this.leftChild,s=this.rightChild,r=s.leftChild,n=s.rightChild;return t&&void 0!==t.key&&(t.leftChild===this?t.leftChild=s:t.rightChild===this&&(t.rightChild=s)),s.parent=t,s.brother=e,s.leftChild=this,s.rightChild=n,e&&(e.brother=s),this.parent=s,this.brother=n,this.leftChild=i,this.rightChild=r,n&&(n.parent=s,n.brother=this),i&&(i.parent=this,i.brother=r),r&&(r.parent=this,r.brother=i),s},t.prototype.rotateRight=function(){var t=this.parent,e=this.brother,i=this.leftChild,s=this.rightChild,r=i.leftChild,n=i.rightChild;return t&&void 0!==t.key&&(t.leftChild===this?t.leftChild=i:t.rightChild===this&&(t.rightChild=i)),i.parent=t,i.brother=e,i.leftChild=r,i.rightChild=this,e&&(e.brother=i),r&&(r.parent=i,r.brother=this),this.parent=i,this.brother=r,this.leftChild=n,this.rightChild=s,n&&(n.parent=this,n.brother=s),s&&(s.parent=this,s.brother=n),i},t.prototype.remove=function(){if(this.leftChild||this.rightChild)throw new R("can only remove leaf node");this.parent&&(this===this.parent.leftChild?this.parent.leftChild=void 0:this===this.parent.rightChild&&(this.parent.rightChild=void 0)),this.brother&&(this.brother.brother=void 0),this.key=void 0,this.value=void 0,this.parent=void 0,this.brother=void 0},t.TreeNodeColorType={red:!0,black:!1},t}();var z=function(){var t=function(e,i){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i])},t(e,i)};return function(e,i){if("function"!=typeof i&&null!==i)throw new TypeError("Class extends value "+String(i)+" is not a constructor or null");function s(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(s.prototype=i.prototype,new s)}}();const j=function(t){function e(e){void 0===e&&(e=function(t,e){return t<e?-1:t>e?1:0});var i=t.call(this)||this;return i.root=new O,i.header=new O,i.findSubTreeMinNode=function(t){return t.leftChild?i.findSubTreeMinNode(t.leftChild):t},i.findSubTreeMaxNode=function(t){return t.rightChild?i.findSubTreeMaxNode(t.rightChild):t},i._lowerBound=function(t,e){if(t&&void 0!==t.key){var s=i.cmp(t.key,e);if(0===s)return t;if(s<0)return i._lowerBound(t.rightChild,e);var r=i._lowerBound(t.leftChild,e);return void 0===r?t:r}},i._upperBound=function(t,e){if(t&&void 0!==t.key){if(i.cmp(t.key,e)<=0)return i._upperBound(t.rightChild,e);var s=i._upperBound(t.leftChild,e);return void 0===s?t:s}},i._reverseLowerBound=function(t,e){if(t&&void 0!==t.key){var s=i.cmp(t.key,e);if(0===s)return t;if(s>0)return i._reverseLowerBound(t.leftChild,e);var r=i._reverseLowerBound(t.rightChild,e);return void 0===r?t:r}},i._reverseUpperBound=function(t,e){if(t&&void 0!==t.key){if(i.cmp(t.key,e)>=0)return i._reverseUpperBound(t.leftChild,e);var s=i._reverseUpperBound(t.rightChild,e);return void 0===s?t:s}},i.inOrderTraversal=function(t,e){return!(!t||void 0===t.key)&&(!!i.inOrderTraversal(t.leftChild,e)||!!e(t)||i.inOrderTraversal(t.rightChild,e))},i.findInsertPos=function(t,e){if(!t||void 0===t.key)throw new R;var s=i.cmp(e,t.key);return s<0?t.leftChild?i.findInsertPos(t.leftChild,e):(t.leftChild=new O,t.leftChild.parent=t,t.leftChild.brother=t.rightChild,t.rightChild&&(t.rightChild.brother=t.leftChild),t.leftChild):s>0?t.rightChild?i.findInsertPos(t.rightChild,e):(t.rightChild=new O,t.rightChild.parent=t,t.rightChild.brother=t.leftChild,t.leftChild&&(t.leftChild.brother=t.rightChild),t.rightChild):t},i.findElementNode=function(t,e){if(t&&void 0!==t.key){var s=i.cmp(e,t.key);return s<0?i.findElementNode(t.leftChild,e):s>0?i.findElementNode(t.rightChild,e):t}},i.root.color=O.TreeNodeColorType.black,i.header.parent=i.root,i.root.parent=i.header,i.cmp=e,i}return z(e,t),e.prototype.eraseNodeSelfBalance=function(t){var e=t.parent;if(!e||e===this.header){if(t===this.root)return;throw new R}if(t.color!==O.TreeNodeColorType.red){var i=t.brother;if(!i)throw new R;if(t===e.leftChild)if(i.color===O.TreeNodeColorType.red){i.color=O.TreeNodeColorType.black,e.color=O.TreeNodeColorType.red;var s=e.rotateLeft();this.root===e&&(this.root=s,this.header.parent=this.root,this.root.parent=this.header),this.eraseNodeSelfBalance(t)}else i.color===O.TreeNodeColorType.black&&(i.rightChild&&i.rightChild.color===O.TreeNodeColorType.red?(i.color=e.color,e.color=O.TreeNodeColorType.black,i.rightChild&&(i.rightChild.color=O.TreeNodeColorType.black),s=e.rotateLeft(),this.root===e&&(this.root=s,this.header.parent=this.root,this.root.parent=this.header),t.color=O.TreeNodeColorType.black):i.rightChild&&i.rightChild.color!==O.TreeNodeColorType.black||!i.leftChild||i.leftChild.color!==O.TreeNodeColorType.red?i.leftChild&&i.leftChild.color!==O.TreeNodeColorType.black||i.rightChild&&i.rightChild.color!==O.TreeNodeColorType.black||(i.color=O.TreeNodeColorType.red,this.eraseNodeSelfBalance(e)):(i.color=O.TreeNodeColorType.red,i.leftChild&&(i.leftChild.color=O.TreeNodeColorType.black),s=i.rotateRight(),this.root===i&&(this.root=s,this.header.parent=this.root,this.root.parent=this.header),this.eraseNodeSelfBalance(t)));else t===e.rightChild&&(i.color===O.TreeNodeColorType.red?(i.color=O.TreeNodeColorType.black,e.color=O.TreeNodeColorType.red,s=e.rotateRight(),this.root===e&&(this.root=s,this.header.parent=this.root,this.root.parent=this.header),this.eraseNodeSelfBalance(t)):i.color===O.TreeNodeColorType.black&&(i.leftChild&&i.leftChild.color===O.TreeNodeColorType.red?(i.color=e.color,e.color=O.TreeNodeColorType.black,i.leftChild&&(i.leftChild.color=O.TreeNodeColorType.black),s=e.rotateRight(),this.root===e&&(this.root=s,this.header.parent=this.root,this.root.parent=this.header),t.color=O.TreeNodeColorType.black):i.leftChild&&i.leftChild.color!==O.TreeNodeColorType.black||!i.rightChild||i.rightChild.color!==O.TreeNodeColorType.red?i.leftChild&&i.leftChild.color!==O.TreeNodeColorType.black||i.rightChild&&i.rightChild.color!==O.TreeNodeColorType.black||(i.color=O.TreeNodeColorType.red,this.eraseNodeSelfBalance(e)):(i.color=O.TreeNodeColorType.red,i.rightChild&&(i.rightChild.color=O.TreeNodeColorType.black),s=i.rotateLeft(),this.root===i&&(this.root=s,this.header.parent=this.root,this.root.parent=this.header),this.eraseNodeSelfBalance(t))))}else t.color=O.TreeNodeColorType.black},e.prototype.eraseNode=function(t){for(var e,i,s,r,n,o,h=t;h.leftChild||h.rightChild;){if(h.rightChild){h=this.findSubTreeMinNode(h.rightChild);var a=t.key;t.key=h.key,h.key=a;var l=t.value;t.value=h.value,h.value=l,t=h}h.leftChild&&(h=this.findSubTreeMaxNode(h.leftChild),a=t.key,t.key=h.key,h.key=a,l=t.value,t.value=h.value,h.value=l,t=h)}if(void 0===h.key)throw new R;this.header.leftChild&&void 0!==this.header.leftChild.key&&0===this.cmp(this.header.leftChild.key,h.key)&&(this.header.leftChild!==this.root?this.header.leftChild=null===(e=this.header.leftChild)||void 0===e?void 0:e.parent:(null===(i=this.header.leftChild)||void 0===i?void 0:i.rightChild)?this.header.leftChild=null===(s=this.header.leftChild)||void 0===s?void 0:s.rightChild:this.header.leftChild=void 0),this.header.rightChild&&void 0!==this.header.rightChild.key&&0===this.cmp(this.header.rightChild.key,h.key)&&(this.header.rightChild!==this.root?this.header.rightChild=null===(r=this.header.rightChild)||void 0===r?void 0:r.parent:(null===(n=this.header.rightChild)||void 0===n?void 0:n.leftChild)?this.header.rightChild=null===(o=this.header.rightChild)||void 0===o?void 0:o.leftChild:this.header.rightChild=void 0),this.eraseNodeSelfBalance(h),h&&h.remove(),--this.length,this.root.color=O.TreeNodeColorType.black},e.prototype.insertNodeSelfBalance=function(t){var e=t.parent;if(!e||e===this.header){if(t===this.root)return;throw new R}if(e.color!==O.TreeNodeColorType.black&&e.color===O.TreeNodeColorType.red){var i=e.brother,s=e.parent;if(!s)throw new R;if(i&&i.color===O.TreeNodeColorType.red)i.color=e.color=O.TreeNodeColorType.black,s.color=O.TreeNodeColorType.red,this.insertNodeSelfBalance(s);else if(!i||i.color===O.TreeNodeColorType.black)if(e===s.leftChild)if(t===e.leftChild){e.color=O.TreeNodeColorType.black,s.color=O.TreeNodeColorType.red;var r=s.rotateRight();s===this.root&&(this.root=r,this.header.parent=this.root,this.root.parent=this.header)}else t===e.rightChild&&(r=e.rotateLeft(),e===this.root&&(this.root=r,this.header.parent=this.root,this.root.parent=this.header),this.insertNodeSelfBalance(e));else e===s.rightChild&&(t===e.leftChild?(r=e.rotateRight(),e===this.root&&(this.root=r,this.header.parent=this.root,this.root.parent=this.header),this.insertNodeSelfBalance(e)):t===e.rightChild&&(e.color=O.TreeNodeColorType.black,s.color=O.TreeNodeColorType.red,r=s.rotateLeft(),s===this.root&&(this.root=r,this.header.parent=this.root,this.root.parent=this.header)))}},e.prototype.clear=function(){this.length=0,this.root.key=this.root.value=void 0,this.root.leftChild=this.root.rightChild=this.root.brother=void 0,this.header.leftChild=this.header.rightChild=void 0},e.prototype.eraseElementByPos=function(t){var e=this;L(t,0,this.length-1);var i=0;this.inOrderTraversal(this.root,(function(s){return t===i?(e.eraseNode(s),!0):(++i,!1)}))},e.prototype.eraseElementByKey=function(t){if(!this.empty()){var e=this.findElementNode(this.root,t);void 0!==e&&void 0!==e.key&&0===this.cmp(e.key,t)&&this.eraseNode(e)}},e.prototype.getHeight=function(){if(this.empty())return 0;var t=function(e){return e?Math.max(t(e.leftChild),t(e.rightChild))+1:1};return t(this.root)},e}(E);var q=function(){var t=function(e,i){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i])},t(e,i)};return function(e,i){if("function"!=typeof i&&null!==i)throw new TypeError("Class extends value "+String(i)+" is not a constructor or null");function s(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(s.prototype=i.prototype,new s)}}();const N=function(t){function e(e,i,s){var r=t.call(this,e,s)||this;return r.header=i,r}return q(e,t),e.prototype._pre=function(){var t,e=this.node;if(e.color===O.TreeNodeColorType.red&&(null===(t=e.parent)||void 0===t?void 0:t.parent)===e)e=e.rightChild;else if(e.leftChild)for(e=e.leftChild;e.rightChild;)e=null==e?void 0:e.rightChild;else{for(var i=null==e?void 0:e.parent;(null==i?void 0:i.leftChild)===e;)i=null==(e=i)?void 0:e.parent;e=i}return e},e.prototype._next=function(){var t=this.node;if(null==t?void 0:t.rightChild)for(t=t.rightChild;t.leftChild;)t=null==t?void 0:t.leftChild;else{for(var e=null==t?void 0:t.parent;(null==e?void 0:e.rightChild)===t;)e=null==(t=e)?void 0:t.parent;t.rightChild!==e&&(t=e)}return t},e.prototype.pre=function(){if("reverse"===this.iteratorType){if(this.node===this.header.rightChild)throw new T("Tree iterator access denied!");this.node=this._next()}else{if(this.node===this.header.leftChild)throw new T("Tree iterator access denied!");this.node=this._pre()}return this},e.prototype.next=function(){if("reverse"===this.iteratorType){if(this.node===this.header)throw new T("Tree iterator access denied!");this.node=this._pre()}else{if(this.node===this.header)throw new T("Tree iterator access denied!");this.node=this._next()}return this},e.prototype.equals=function(t){if(t.constructor.name!==this.constructor.name)throw new TypeError("obj's constructor is not ".concat(this.constructor.name,"!"));if(this.iteratorType!==t.iteratorType)throw new TypeError("iterator type error!");return this.node===t.node},e}((function(t,e){this.node=t,this.iteratorType=e}));var W=function(){var t=function(e,i){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i])},t(e,i)};return function(e,i){if("function"!=typeof i&&null!==i)throw new TypeError("Class extends value "+String(i)+" is not a constructor or null");function s(){this.constructor=e}t(e,i),e.prototype=null===i?Object.create(i):(s.prototype=i.prototype,new s)}}(),X=function(t){var e="function"==typeof Symbol&&Symbol.iterator,i=e&&t[e],s=0;if(i)return i.call(t);if(t&&"number"==typeof t.length)return{next:function(){return t&&s>=t.length&&(t=void 0),{value:t&&t[s++],done:!t}}};throw new TypeError(e?"Object is not iterable.":"Symbol.iterator is not defined.")},U=function(t){function e(e,i,s){return void 0===s&&(s="normal"),t.call(this,e,i,s)||this}return W(e,t),Object.defineProperty(e.prototype,"pointer",{get:function(){if(void 0===this.node.key)throw new T("OrderedSet iterator access denied!");return this.node.key},enumerable:!1,configurable:!0}),e}(N);const J=function(t){function e(e,i){void 0===e&&(e=[]);var s=t.call(this,i)||this;return s.iterationFunc=function(t){return function(t,e){var i,s,r,n,o={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]};return n={next:h(0),throw:h(1),return:h(2)},"function"==typeof Symbol&&(n[Symbol.iterator]=function(){return this}),n;function h(n){return function(h){return function(n){if(i)throw new TypeError("Generator is already executing.");for(;o;)try{if(i=1,s&&(r=2&n[0]?s.return:n[0]?s.throw||((r=s.return)&&r.call(s),0):s.next)&&!(r=r.call(s,n[1])).done)return r;switch(s=0,r&&(n=[2&n[0],r.value]),n[0]){case 0:case 1:r=n;break;case 4:return o.label++,{value:n[1],done:!1};case 5:o.label++,s=n[1],n=[0];continue;case 7:n=o.ops.pop(),o.trys.pop();continue;default:if(!((r=(r=o.trys).length>0&&r[r.length-1])||6!==n[0]&&2!==n[0])){o=0;continue}if(3===n[0]&&(!r||n[1]>r[0]&&n[1]<r[3])){o.label=n[1];break}if(6===n[0]&&o.label<r[1]){o.label=r[1],r=n;break}if(r&&o.label<r[2]){o.label=r[2],o.ops.push(n);break}r[2]&&o.ops.pop(),o.trys.pop();continue}n=e.call(t,o)}catch(t){n=[6,t],s=0}finally{i=r=0}if(5&n[0])throw n[1];return{value:n[0]?n[1]:void 0,done:!0}}([n,h])}}}(this,(function(e){switch(e.label){case 0:return t&&void 0!==t.key?[5,X(this.iterationFunc(t.leftChild))]:[2];case 1:return e.sent(),[4,t.key];case 2:return e.sent(),[5,X(this.iterationFunc(t.rightChild))];case 3:return e.sent(),[2]}}))},e.forEach((function(t){return s.insert(t)})),s.iterationFunc=s.iterationFunc.bind(s),s}return W(e,t),e.prototype.begin=function(){return new U(this.header.leftChild||this.header,this.header)},e.prototype.end=function(){return new U(this.header,this.header)},e.prototype.rBegin=function(){return new U(this.header.rightChild||this.header,this.header,"reverse")},e.prototype.rEnd=function(){return new U(this.header,this.header,"reverse")},e.prototype.front=function(){var t;return null===(t=this.header.leftChild)||void 0===t?void 0:t.key},e.prototype.back=function(){var t;return null===(t=this.header.rightChild)||void 0===t?void 0:t.key},e.prototype.forEach=function(t){var e,i,s=0;try{for(var r=X(this),n=r.next();!n.done;n=r.next())t(n.value,s++)}catch(t){e={error:t}}finally{try{n&&!n.done&&(i=r.return)&&i.call(r)}finally{if(e)throw e.error}}},e.prototype.getElementByPos=function(t){var e,i;L(t,0,this.length-1);var s=0;try{for(var r=X(this),n=r.next();!n.done;n=r.next()){var o=n.value;if(s===t)return o;++s}}catch(t){e={error:t}}finally{try{n&&!n.done&&(i=r.return)&&i.call(r)}finally{if(e)throw e.error}}},e.prototype.eraseElementByIterator=function(t){var e=t.node;return t=t.next(),this.eraseNode(e),t},e.prototype.insert=function(t){if(function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];if(t.includes(void 0)||t.includes(null))throw new F}(t),this.empty())return++this.length,this.root.key=t,this.root.color=O.TreeNodeColorType.black,this.header.leftChild=this.root,void(this.header.rightChild=this.root);var e=this.findInsertPos(this.root,t);void 0!==e.key&&0===this.cmp(e.key,t)||(++this.length,e.key=t,(void 0===this.header.leftChild||void 0===this.header.leftChild.key||this.cmp(this.header.leftChild.key,t)>0)&&(this.header.leftChild=e),(void 0===this.header.rightChild||void 0===this.header.rightChild.key||this.cmp(this.header.rightChild.key,t)<0)&&(this.header.rightChild=e),this.insertNodeSelfBalance(e),this.root.color=O.TreeNodeColorType.black)},e.prototype.find=function(t){var e=this.findElementNode(this.root,t);return void 0!==e&&void 0!==e.key?new U(e,this.header):this.end()},e.prototype.lowerBound=function(t){var e=this._lowerBound(this.root,t);return void 0===e?this.end():new U(e,this.header)},e.prototype.upperBound=function(t){var e=this._upperBound(this.root,t);return void 0===e?this.end():new U(e,this.header)},e.prototype.reverseLowerBound=function(t){var e=this._reverseLowerBound(this.root,t);return void 0===e?this.end():new U(e,this.header)},e.prototype.reverseUpperBound=function(t){var e=this._reverseUpperBound(this.root,t);return void 0===e?this.end():new U(e,this.header)},e.prototype.union=function(t){var e=this;t.forEach((function(t){return e.insert(t)}))},e.prototype[Symbol.iterator]=function(){return this.iterationFunc(this.root)},e}(j);class Z{constructor(t){this.rt=null,this.dt=new J(void 0,t),this.ut=new J(void 0,t),this.ft=new J(void 0,t),this.ot=new J(void 0,t)}get size(){return this.dt.size()}insert(t){t.isRemoved=!1,null!==this.rt?this.ut.insert(t):this.dt.insert(t)}delete(t){null!==this.rt?(t.isRemoved=!0,this.ot.insert(t)):this.dt.eraseElementByKey(t)}clear(){this.dt.clear(),this.ut.clear(),this.ot.clear()}forEach(t){this.rt=this.dt,this.rt.forEach((e=>{e.isRemoved||t(e)}));do{this.rt=this.ct(),this.rt.forEach((e=>{e.isRemoved||t(e)}))}while(0<this.ut.size()||0<this.ot.size());this.rt=null}ct(){this.rt=null,this.ot.forEach((t=>this.delete(t))),this.ut.forEach((t=>this.insert(t)));const t=this.ut;return this.ut=this.ft,this.ft=t,this.ut.clear(),this.ot.clear(),t}}class H{constructor(t,e,i,s){this.isRemoved=!1,this.Dt=i,this.St=t.generateEventId(),this.kt=s,this.At=e}static createAwakeEvent(t,e){return new H(t,e,0,0)}static createStartEvent(t,e,i){return new H(t,e,2,i)}static createUpdateEvent(t,e,i){return new H(t,e,3,i)}static createOnEnableEvent(t,e,i){return new H(t,e,1,i)}static createOnDisableEvent(t,e,i){return new H(t,e,1,i)}static createOnDestroyEvent(t,e,i){return new H(t,e,4,i)}static createOnCollisionEnter2DEvent(t,e,i){return new H(t,e,1,i)}static createOnCollisionStay2DEvent(t,e,i){return new H(t,e,1,i)}static createOnCollisionExit2DEvent(t,e,i){return new H(t,e,1,i)}static createOnTriggerEnter2DEvent(t,e,i){return new H(t,e,1,i)}static createOnTriggerStay2DEvent(t,e,i){return new H(t,e,1,i)}static createOnTriggerExit2DEvent(t,e,i){return new H(t,e,1,i)}get invoke(){return this.At}static comparator(t,e){return t.Dt===e.Dt?t.kt===e.kt?t.St-e.St:t.kt-e.kt:t.Dt-e.Dt}}function Y(t){return void 0!==t.onWorldMatrixUpdated}class Q{constructor(){this.ti=new Set,this.ii=new Z(H.comparator),this.ei=new Z(H.comparator),this.ni=new Z(H.comparator),this.oi=new Z(H.comparator),this.ri=new Z(H.comparator),this.si=new Z(H.comparator)}registerComponent(t){Y(t)&&this.ti.add(t);const e=t._engine_internal_componentEventContainer;e.onCollisionEnter2D&&this.ii.insert(e.onCollisionEnter2D),e.onCollisionStay2D&&this.ei.insert(e.onCollisionStay2D),e.onCollisionExit2D&&this.ni.insert(e.onCollisionExit2D),e.onTriggerEnter2D&&this.oi.insert(e.onTriggerEnter2D),e.onTriggerStay2D&&this.ri.insert(e.onTriggerStay2D),e.onTriggerExit2D&&this.si.insert(e.onTriggerExit2D)}unregisterComponent(t){Y(t)&&this.ti.delete(t);const e=t._engine_internal_componentEventContainer;e.onCollisionEnter2D&&this.ii.delete(e.onCollisionEnter2D),e.onCollisionStay2D&&this.ei.delete(e.onCollisionStay2D),e.onCollisionExit2D&&this.ni.delete(e.onCollisionExit2D),e.onTriggerEnter2D&&this.oi.delete(e.onTriggerEnter2D),e.onTriggerStay2D&&this.ri.delete(e.onTriggerStay2D),e.onTriggerExit2D&&this.si.delete(e.onTriggerExit2D)}invokeOnWorldMatrixUpdated(){for(const t of this.ti)t.onWorldMatrixUpdated()}invokeOnCollisionEnter2D(t){0!==this.ii.size&&this.ii.forEach((e=>e.invoke(t)))}invokeOnCollisionStay2D(t){0!==this.ei.size&&this.ei.forEach((e=>e.invoke(t)))}invokeOnCollisionExit2D(t){0!==this.ni.size&&this.ni.forEach((e=>e.invoke(t)))}invokeOnTriggerEnter2D(t){0!==this.oi.size&&this.oi.forEach((e=>e.invoke(t)))}invokeOnTriggerStay2D(t){0!==this.ri.size&&this.ri.forEach((e=>e.invoke(t)))}invokeOnTriggerExit2D(t){0!==this.si.size&&this.si.forEach((e=>e.invoke(t)))}}class K{constructor(t=0,e=0,i=0,s=1){this.isQuaternion=!0,this._x=t,this._y=e,this._z=i,this._w=s}static slerp(t,e,i,s){return console.warn("THREE.Quaternion: Static .slerp() has been deprecated. Use qm.slerpQuaternions( qa, qb, t ) instead."),i.slerpQuaternions(t,e,s)}static slerpFlat(t,e,i,s,r,n,o){let h=i[s+0],a=i[s+1],l=i[s+2],m=i[s+3];const c=r[n+0],u=r[n+1],_=r[n+2],d=r[n+3];if(0===o)return t[e+0]=h,t[e+1]=a,t[e+2]=l,void(t[e+3]=m);if(1===o)return t[e+0]=c,t[e+1]=u,t[e+2]=_,void(t[e+3]=d);if(m!==d||h!==c||a!==u||l!==_){let t=1-o;const e=h*c+a*u+l*_+m*d,i=e>=0?1:-1,s=1-e*e;if(s>Number.EPSILON){const r=Math.sqrt(s),n=Math.atan2(r,e*i);t=Math.sin(t*n)/r,o=Math.sin(o*n)/r}const r=o*i;if(h=h*t+c*r,a=a*t+u*r,l=l*t+_*r,m=m*t+d*r,t===1-o){const t=1/Math.sqrt(h*h+a*a+l*l+m*m);h*=t,a*=t,l*=t,m*=t}}t[e]=h,t[e+1]=a,t[e+2]=l,t[e+3]=m}static multiplyQuaternionsFlat(t,e,i,s,r,n){const o=i[s],h=i[s+1],a=i[s+2],l=i[s+3],m=r[n],c=r[n+1],u=r[n+2],_=r[n+3];return t[e]=o*_+l*m+h*u-a*c,t[e+1]=h*_+l*c+a*m-o*u,t[e+2]=a*_+l*u+o*c-h*m,t[e+3]=l*_-o*m-h*c-a*u,t}get x(){return this._x}set x(t){this._x=t,this._onChangeCallback()}get y(){return this._y}set y(t){this._y=t,this._onChangeCallback()}get z(){return this._z}set z(t){this._z=t,this._onChangeCallback()}get w(){return this._w}set w(t){this._w=t,this._onChangeCallback()}set(t,e,i,s){return this._x=t,this._y=e,this._z=i,this._w=s,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._w)}copy(t){return this._x=t.x,this._y=t.y,this._z=t.z,this._w=t.w,this._onChangeCallback(),this}setFromEuler(t,e){if(!t||!t.isEuler)throw new Error("THREE.Quaternion: .setFromEuler() now expects an Euler rotation rather than a Vector3 and order.");const i=t._x,s=t._y,r=t._z,n=t._order,o=Math.cos,h=Math.sin,a=o(i/2),l=o(s/2),m=o(r/2),c=h(i/2),u=h(s/2),_=h(r/2);switch(n){case"XYZ":this._x=c*l*m+a*u*_,this._y=a*u*m-c*l*_,this._z=a*l*_+c*u*m,this._w=a*l*m-c*u*_;break;case"YXZ":this._x=c*l*m+a*u*_,this._y=a*u*m-c*l*_,this._z=a*l*_-c*u*m,this._w=a*l*m+c*u*_;break;case"ZXY":this._x=c*l*m-a*u*_,this._y=a*u*m+c*l*_,this._z=a*l*_+c*u*m,this._w=a*l*m-c*u*_;break;case"ZYX":this._x=c*l*m-a*u*_,this._y=a*u*m+c*l*_,this._z=a*l*_-c*u*m,this._w=a*l*m+c*u*_;break;case"YZX":this._x=c*l*m+a*u*_,this._y=a*u*m+c*l*_,this._z=a*l*_-c*u*m,this._w=a*l*m-c*u*_;break;case"XZY":this._x=c*l*m-a*u*_,this._y=a*u*m-c*l*_,this._z=a*l*_+c*u*m,this._w=a*l*m+c*u*_;break;default:console.warn("THREE.Quaternion: .setFromEuler() encountered an unknown order: "+n)}return!1!==e&&this._onChangeCallback(),this}setFromAxisAngle(t,e){const i=e/2,s=Math.sin(i);return this._x=t.x*s,this._y=t.y*s,this._z=t.z*s,this._w=Math.cos(i),this._onChangeCallback(),this}setFromRotationMatrix(t){const e=t.elements,i=e[0],s=e[4],r=e[8],n=e[1],o=e[5],h=e[9],a=e[2],l=e[6],m=e[10],c=i+o+m;if(c>0){const t=.5/Math.sqrt(c+1);this._w=.25/t,this._x=(l-h)*t,this._y=(r-a)*t,this._z=(n-s)*t}else if(i>o&&i>m){const t=2*Math.sqrt(1+i-o-m);this._w=(l-h)/t,this._x=.25*t,this._y=(s+n)/t,this._z=(r+a)/t}else if(o>m){const t=2*Math.sqrt(1+o-i-m);this._w=(r-a)/t,this._x=(s+n)/t,this._y=.25*t,this._z=(h+l)/t}else{const t=2*Math.sqrt(1+m-i-o);this._w=(n-s)/t,this._x=(r+a)/t,this._y=(h+l)/t,this._z=.25*t}return this._onChangeCallback(),this}setFromUnitVectors(t,e){let i=t.dot(e)+1;return i<Number.EPSILON?(i=0,Math.abs(t.x)>Math.abs(t.z)?(this._x=-t.y,this._y=t.x,this._z=0,this._w=i):(this._x=0,this._y=-t.z,this._z=t.y,this._w=i)):(this._x=t.y*e.z-t.z*e.y,this._y=t.z*e.x-t.x*e.z,this._z=t.x*e.y-t.y*e.x,this._w=i),this.normalize()}angleTo(t){return 2*Math.acos(Math.abs(s(this.dot(t),-1,1)))}rotateTowards(t,e){const i=this.angleTo(t);if(0===i)return this;const s=Math.min(1,e/i);return this.slerp(t,s),this}identity(){return this.set(0,0,0,1)}invert(){return this.conjugate()}conjugate(){return this._x*=-1,this._y*=-1,this._z*=-1,this._onChangeCallback(),this}dot(t){return this._x*t._x+this._y*t._y+this._z*t._z+this._w*t._w}lengthSq(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w}length(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w)}normalize(){let t=this.length();return 0===t?(this._x=0,this._y=0,this._z=0,this._w=1):(t=1/t,this._x=this._x*t,this._y=this._y*t,this._z=this._z*t,this._w=this._w*t),this._onChangeCallback(),this}multiply(t,e){return void 0!==e?(console.warn("THREE.Quaternion: .multiply() now only accepts one argument. Use .multiplyQuaternions( a, b ) instead."),this.multiplyQuaternions(t,e)):this.multiplyQuaternions(this,t)}premultiply(t){return this.multiplyQuaternions(t,this)}multiplyQuaternions(t,e){const i=t._x,s=t._y,r=t._z,n=t._w,o=e._x,h=e._y,a=e._z,l=e._w;return this._x=i*l+n*o+s*a-r*h,this._y=s*l+n*h+r*o-i*a,this._z=r*l+n*a+i*h-s*o,this._w=n*l-i*o-s*h-r*a,this._onChangeCallback(),this}slerp(t,e){if(0===e)return this;if(1===e)return this.copy(t);const i=this._x,s=this._y,r=this._z,n=this._w;let o=n*t._w+i*t._x+s*t._y+r*t._z;if(o<0?(this._w=-t._w,this._x=-t._x,this._y=-t._y,this._z=-t._z,o=-o):this.copy(t),o>=1)return this._w=n,this._x=i,this._y=s,this._z=r,this;const h=1-o*o;if(h<=Number.EPSILON){const t=1-e;return this._w=t*n+e*this._w,this._x=t*i+e*this._x,this._y=t*s+e*this._y,this._z=t*r+e*this._z,this.normalize(),this._onChangeCallback(),this}const a=Math.sqrt(h),l=Math.atan2(a,o),m=Math.sin((1-e)*l)/a,c=Math.sin(e*l)/a;return this._w=n*m+this._w*c,this._x=i*m+this._x*c,this._y=s*m+this._y*c,this._z=r*m+this._z*c,this._onChangeCallback(),this}slerpQuaternions(t,e,i){return this.copy(t).slerp(e,i)}random(){const t=Math.random(),e=Math.sqrt(1-t),i=Math.sqrt(t),s=2*Math.PI*Math.random(),r=2*Math.PI*Math.random();return this.set(e*Math.cos(s),i*Math.sin(r),i*Math.cos(r),e*Math.sin(s))}equals(t){return t._x===this._x&&t._y===this._y&&t._z===this._z&&t._w===this._w}fromArray(t,e=0){return this._x=t[e],this._y=t[e+1],this._z=t[e+2],this._w=t[e+3],this._onChangeCallback(),this}toArray(t=[],e=0){return t[e]=this._x,t[e+1]=this._y,t[e+2]=this._z,t[e+3]=this._w,t}fromBufferAttribute(t,e){return this._x=t.getX(e),this._y=t.getY(e),this._z=t.getZ(e),this._w=t.getW(e),this}_onChange(t){return this._onChangeCallback=t,this}_onChangeCallback(){}*[Symbol.iterator](){yield this._x,yield this._y,yield this._z,yield this._w}}class ${constructor(t=0,e=0,i=0){$.prototype.isVector3=!0,this.x=t,this.y=e,this.z=i}set(t,e,i){return void 0===i&&(i=this.z),this.x=t,this.y=e,this.z=i,this}setScalar(t){return this.x=t,this.y=t,this.z=t,this}setX(t){return this.x=t,this}setY(t){return this.y=t,this}setZ(t){return this.z=t,this}setComponent(t,e){switch(t){case 0:this.x=e;break;case 1:this.y=e;break;case 2:this.z=e;break;default:throw new Error("index is out of range: "+t)}return this}getComponent(t){switch(t){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:throw new Error("index is out of range: "+t)}}clone(){return new this.constructor(this.x,this.y,this.z)}copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this}add(t,e){return void 0!==e?(console.warn("THREE.Vector3: .add() now only accepts one argument. Use .addVectors( a, b ) instead."),this.addVectors(t,e)):(this.x+=t.x,this.y+=t.y,this.z+=t.z,this)}addScalar(t){return this.x+=t,this.y+=t,this.z+=t,this}addVectors(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this}addScaledVector(t,e){return this.x+=t.x*e,this.y+=t.y*e,this.z+=t.z*e,this}sub(t,e){return void 0!==e?(console.warn("THREE.Vector3: .sub() now only accepts one argument. Use .subVectors( a, b ) instead."),this.subVectors(t,e)):(this.x-=t.x,this.y-=t.y,this.z-=t.z,this)}subScalar(t){return this.x-=t,this.y-=t,this.z-=t,this}subVectors(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this}multiply(t,e){return void 0!==e?(console.warn("THREE.Vector3: .multiply() now only accepts one argument. Use .multiplyVectors( a, b ) instead."),this.multiplyVectors(t,e)):(this.x*=t.x,this.y*=t.y,this.z*=t.z,this)}multiplyScalar(t){return this.x*=t,this.y*=t,this.z*=t,this}multiplyVectors(t,e){return this.x=t.x*e.x,this.y=t.y*e.y,this.z=t.z*e.z,this}applyEuler(t){return t&&t.isEuler||console.error("THREE.Vector3: .applyEuler() now expects an Euler rotation rather than a Vector3 and order."),this.applyQuaternion(et.setFromEuler(t))}applyAxisAngle(t,e){return this.applyQuaternion(et.setFromAxisAngle(t,e))}applyMatrix3(t){const e=this.x,i=this.y,s=this.z,r=t.elements;return this.x=r[0]*e+r[3]*i+r[6]*s,this.y=r[1]*e+r[4]*i+r[7]*s,this.z=r[2]*e+r[5]*i+r[8]*s,this}applyNormalMatrix(t){return this.applyMatrix3(t).normalize()}applyMatrix4(t){const e=this.x,i=this.y,s=this.z,r=t.elements,n=1/(r[3]*e+r[7]*i+r[11]*s+r[15]);return this.x=(r[0]*e+r[4]*i+r[8]*s+r[12])*n,this.y=(r[1]*e+r[5]*i+r[9]*s+r[13])*n,this.z=(r[2]*e+r[6]*i+r[10]*s+r[14])*n,this}applyQuaternion(t){const e=this.x,i=this.y,s=this.z,r=t.x,n=t.y,o=t.z,h=t.w,a=h*e+n*s-o*i,l=h*i+o*e-r*s,m=h*s+r*i-n*e,c=-r*e-n*i-o*s;return this.x=a*h+c*-r+l*-o-m*-n,this.y=l*h+c*-n+m*-r-a*-o,this.z=m*h+c*-o+a*-n-l*-r,this}project(t){return this.applyMatrix4(t.matrixWorldInverse).applyMatrix4(t.projectionMatrix)}unproject(t){return this.applyMatrix4(t.projectionMatrixInverse).applyMatrix4(t.matrixWorld)}transformDirection(t){const e=this.x,i=this.y,s=this.z,r=t.elements;return this.x=r[0]*e+r[4]*i+r[8]*s,this.y=r[1]*e+r[5]*i+r[9]*s,this.z=r[2]*e+r[6]*i+r[10]*s,this.normalize()}divide(t){return this.x/=t.x,this.y/=t.y,this.z/=t.z,this}divideScalar(t){return this.multiplyScalar(1/t)}min(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this.z=Math.min(this.z,t.z),this}max(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this.z=Math.max(this.z,t.z),this}clamp(t,e){return this.x=Math.max(t.x,Math.min(e.x,this.x)),this.y=Math.max(t.y,Math.min(e.y,this.y)),this.z=Math.max(t.z,Math.min(e.z,this.z)),this}clampScalar(t,e){return this.x=Math.max(t,Math.min(e,this.x)),this.y=Math.max(t,Math.min(e,this.y)),this.z=Math.max(t,Math.min(e,this.z)),this}clampLength(t,e){const i=this.length();return this.divideScalar(i||1).multiplyScalar(Math.max(t,Math.min(e,i)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this}roundToZero(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this.z=this.z<0?Math.ceil(this.z):Math.floor(this.z),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}dot(t){return this.x*t.x+this.y*t.y+this.z*t.z}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)}normalize(){return this.divideScalar(this.length()||1)}setLength(t){return this.normalize().multiplyScalar(t)}lerp(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this.z+=(t.z-this.z)*e,this}lerpVectors(t,e,i){return this.x=t.x+(e.x-t.x)*i,this.y=t.y+(e.y-t.y)*i,this.z=t.z+(e.z-t.z)*i,this}cross(t,e){return void 0!==e?(console.warn("THREE.Vector3: .cross() now only accepts one argument. Use .crossVectors( a, b ) instead."),this.crossVectors(t,e)):this.crossVectors(this,t)}crossVectors(t,e){const i=t.x,s=t.y,r=t.z,n=e.x,o=e.y,h=e.z;return this.x=s*h-r*o,this.y=r*n-i*h,this.z=i*o-s*n,this}projectOnVector(t){const e=t.lengthSq();if(0===e)return this.set(0,0,0);const i=t.dot(this)/e;return this.copy(t).multiplyScalar(i)}projectOnPlane(t){return tt.copy(this).projectOnVector(t),this.sub(tt)}reflect(t){return this.sub(tt.copy(t).multiplyScalar(2*this.dot(t)))}angleTo(t){const e=Math.sqrt(this.lengthSq()*t.lengthSq());if(0===e)return Math.PI/2;const i=this.dot(t)/e;return Math.acos(s(i,-1,1))}distanceTo(t){return Math.sqrt(this.distanceToSquared(t))}distanceToSquared(t){const e=this.x-t.x,i=this.y-t.y,s=this.z-t.z;return e*e+i*i+s*s}manhattanDistanceTo(t){return Math.abs(this.x-t.x)+Math.abs(this.y-t.y)+Math.abs(this.z-t.z)}setFromSpherical(t){return this.setFromSphericalCoords(t.radius,t.phi,t.theta)}setFromSphericalCoords(t,e,i){const s=Math.sin(e)*t;return this.x=s*Math.sin(i),this.y=Math.cos(e)*t,this.z=s*Math.cos(i),this}setFromCylindrical(t){return this.setFromCylindricalCoords(t.radius,t.theta,t.y)}setFromCylindricalCoords(t,e,i){return this.x=t*Math.sin(e),this.y=i,this.z=t*Math.cos(e),this}setFromMatrixPosition(t){const e=t.elements;return this.x=e[12],this.y=e[13],this.z=e[14],this}setFromMatrixScale(t){const e=this.setFromMatrixColumn(t,0).length(),i=this.setFromMatrixColumn(t,1).length(),s=this.setFromMatrixColumn(t,2).length();return this.x=e,this.y=i,this.z=s,this}setFromMatrixColumn(t,e){return this.fromArray(t.elements,4*e)}setFromMatrix3Column(t,e){return this.fromArray(t.elements,3*e)}setFromEuler(t){return this.x=t._x,this.y=t._y,this.z=t._z,this}equals(t){return t.x===this.x&&t.y===this.y&&t.z===this.z}fromArray(t,e=0){return this.x=t[e],this.y=t[e+1],this.z=t[e+2],this}toArray(t=[],e=0){return t[e]=this.x,t[e+1]=this.y,t[e+2]=this.z,t}fromBufferAttribute(t,e,i){return void 0!==i&&console.warn("THREE.Vector3: offset has been removed from .fromBufferAttribute()."),this.x=t.getX(e),this.y=t.getY(e),this.z=t.getZ(e),this}random(){return this.x=Math.random(),this.y=Math.random(),this.z=Math.random(),this}randomDirection(){const t=2*(Math.random()-.5),e=Math.random()*Math.PI*2,i=Math.sqrt(1-t**2);return this.x=i*Math.cos(e),this.y=i*Math.sin(e),this.z=t,this}*[Symbol.iterator](){yield this.x,yield this.y,yield this.z}}const tt=new $,et=new K;class it{constructor(){it.prototype.isMatrix4=!0,this.elements=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],arguments.length>0&&console.error("THREE.Matrix4: the constructor no longer reads arguments. use .set() instead.")}set(t,e,i,s,r,n,o,h,a,l,m,c,u,_,d,p){const f=this.elements;return f[0]=t,f[4]=e,f[8]=i,f[12]=s,f[1]=r,f[5]=n,f[9]=o,f[13]=h,f[2]=a,f[6]=l,f[10]=m,f[14]=c,f[3]=u,f[7]=_,f[11]=d,f[15]=p,this}identity(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this}clone(){return(new it).fromArray(this.elements)}copy(t){const e=this.elements,i=t.elements;return e[0]=i[0],e[1]=i[1],e[2]=i[2],e[3]=i[3],e[4]=i[4],e[5]=i[5],e[6]=i[6],e[7]=i[7],e[8]=i[8],e[9]=i[9],e[10]=i[10],e[11]=i[11],e[12]=i[12],e[13]=i[13],e[14]=i[14],e[15]=i[15],this}copyPosition(t){const e=this.elements,i=t.elements;return e[12]=i[12],e[13]=i[13],e[14]=i[14],this}setFromMatrix3(t){const e=t.elements;return this.set(e[0],e[3],e[6],0,e[1],e[4],e[7],0,e[2],e[5],e[8],0,0,0,0,1),this}extractBasis(t,e,i){return t.setFromMatrixColumn(this,0),e.setFromMatrixColumn(this,1),i.setFromMatrixColumn(this,2),this}makeBasis(t,e,i){return this.set(t.x,e.x,i.x,0,t.y,e.y,i.y,0,t.z,e.z,i.z,0,0,0,0,1),this}extractRotation(t){const e=this.elements,i=t.elements,s=1/st.setFromMatrixColumn(t,0).length(),r=1/st.setFromMatrixColumn(t,1).length(),n=1/st.setFromMatrixColumn(t,2).length();return e[0]=i[0]*s,e[1]=i[1]*s,e[2]=i[2]*s,e[3]=0,e[4]=i[4]*r,e[5]=i[5]*r,e[6]=i[6]*r,e[7]=0,e[8]=i[8]*n,e[9]=i[9]*n,e[10]=i[10]*n,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,this}makeRotationFromEuler(t){t&&t.isEuler||console.error("THREE.Matrix4: .makeRotationFromEuler() now expects a Euler rotation rather than a Vector3 and order.");const e=this.elements,i=t.x,s=t.y,r=t.z,n=Math.cos(i),o=Math.sin(i),h=Math.cos(s),a=Math.sin(s),l=Math.cos(r),m=Math.sin(r);if("XYZ"===t.order){const t=n*l,i=n*m,s=o*l,r=o*m;e[0]=h*l,e[4]=-h*m,e[8]=a,e[1]=i+s*a,e[5]=t-r*a,e[9]=-o*h,e[2]=r-t*a,e[6]=s+i*a,e[10]=n*h}else if("YXZ"===t.order){const t=h*l,i=h*m,s=a*l,r=a*m;e[0]=t+r*o,e[4]=s*o-i,e[8]=n*a,e[1]=n*m,e[5]=n*l,e[9]=-o,e[2]=i*o-s,e[6]=r+t*o,e[10]=n*h}else if("ZXY"===t.order){const t=h*l,i=h*m,s=a*l,r=a*m;e[0]=t-r*o,e[4]=-n*m,e[8]=s+i*o,e[1]=i+s*o,e[5]=n*l,e[9]=r-t*o,e[2]=-n*a,e[6]=o,e[10]=n*h}else if("ZYX"===t.order){const t=n*l,i=n*m,s=o*l,r=o*m;e[0]=h*l,e[4]=s*a-i,e[8]=t*a+r,e[1]=h*m,e[5]=r*a+t,e[9]=i*a-s,e[2]=-a,e[6]=o*h,e[10]=n*h}else if("YZX"===t.order){const t=n*h,i=n*a,s=o*h,r=o*a;e[0]=h*l,e[4]=r-t*m,e[8]=s*m+i,e[1]=m,e[5]=n*l,e[9]=-o*l,e[2]=-a*l,e[6]=i*m+s,e[10]=t-r*m}else if("XZY"===t.order){const t=n*h,i=n*a,s=o*h,r=o*a;e[0]=h*l,e[4]=-m,e[8]=a*l,e[1]=t*m+r,e[5]=n*l,e[9]=i*m-s,e[2]=s*m-i,e[6]=o*l,e[10]=r*m+t}return e[3]=0,e[7]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,this}makeRotationFromQuaternion(t){return this.compose(nt,t,ot)}lookAt(t,e,i){const s=this.elements;return lt.subVectors(t,e),0===lt.lengthSq()&&(lt.z=1),lt.normalize(),ht.crossVectors(i,lt),0===ht.lengthSq()&&(1===Math.abs(i.z)?lt.x+=1e-4:lt.z+=1e-4,lt.normalize(),ht.crossVectors(i,lt)),ht.normalize(),at.crossVectors(lt,ht),s[0]=ht.x,s[4]=at.x,s[8]=lt.x,s[1]=ht.y,s[5]=at.y,s[9]=lt.y,s[2]=ht.z,s[6]=at.z,s[10]=lt.z,this}multiply(t,e){return void 0!==e?(console.warn("THREE.Matrix4: .multiply() now only accepts one argument. Use .multiplyMatrices( a, b ) instead."),this.multiplyMatrices(t,e)):this.multiplyMatrices(this,t)}premultiply(t){return this.multiplyMatrices(t,this)}multiplyMatrices(t,e){const i=t.elements,s=e.elements,r=this.elements,n=i[0],o=i[4],h=i[8],a=i[12],l=i[1],m=i[5],c=i[9],u=i[13],_=i[2],d=i[6],p=i[10],f=i[14],y=i[3],x=i[7],g=i[11],w=i[15],C=s[0],v=s[4],S=s[8],b=s[12],B=s[1],A=s[5],V=s[9],M=s[13],D=s[2],I=s[6],P=s[10],G=s[14],T=s[3],R=s[7],F=s[11],k=s[15];return r[0]=n*C+o*B+h*D+a*T,r[4]=n*v+o*A+h*I+a*R,r[8]=n*S+o*V+h*P+a*F,r[12]=n*b+o*M+h*G+a*k,r[1]=l*C+m*B+c*D+u*T,r[5]=l*v+m*A+c*I+u*R,r[9]=l*S+m*V+c*P+u*F,r[13]=l*b+m*M+c*G+u*k,r[2]=_*C+d*B+p*D+f*T,r[6]=_*v+d*A+p*I+f*R,r[10]=_*S+d*V+p*P+f*F,r[14]=_*b+d*M+p*G+f*k,r[3]=y*C+x*B+g*D+w*T,r[7]=y*v+x*A+g*I+w*R,r[11]=y*S+x*V+g*P+w*F,r[15]=y*b+x*M+g*G+w*k,this}multiplyScalar(t){const e=this.elements;return e[0]*=t,e[4]*=t,e[8]*=t,e[12]*=t,e[1]*=t,e[5]*=t,e[9]*=t,e[13]*=t,e[2]*=t,e[6]*=t,e[10]*=t,e[14]*=t,e[3]*=t,e[7]*=t,e[11]*=t,e[15]*=t,this}determinant(){const t=this.elements,e=t[0],i=t[4],s=t[8],r=t[12],n=t[1],o=t[5],h=t[9],a=t[13],l=t[2],m=t[6],c=t[10],u=t[14];return t[3]*(+r*h*m-s*a*m-r*o*c+i*a*c+s*o*u-i*h*u)+t[7]*(+e*h*u-e*a*c+r*n*c-s*n*u+s*a*l-r*h*l)+t[11]*(+e*a*m-e*o*u-r*n*m+i*n*u+r*o*l-i*a*l)+t[15]*(-s*o*l-e*h*m+e*o*c+s*n*m-i*n*c+i*h*l)}transpose(){const t=this.elements;let e;return e=t[1],t[1]=t[4],t[4]=e,e=t[2],t[2]=t[8],t[8]=e,e=t[6],t[6]=t[9],t[9]=e,e=t[3],t[3]=t[12],t[12]=e,e=t[7],t[7]=t[13],t[13]=e,e=t[11],t[11]=t[14],t[14]=e,this}setPosition(t,e,i){const s=this.elements;return t.isVector3?(s[12]=t.x,s[13]=t.y,s[14]=t.z):(s[12]=t,s[13]=e,s[14]=i),this}invert(){const t=this.elements,e=t[0],i=t[1],s=t[2],r=t[3],n=t[4],o=t[5],h=t[6],a=t[7],l=t[8],m=t[9],c=t[10],u=t[11],_=t[12],d=t[13],p=t[14],f=t[15],y=m*p*a-d*c*a+d*h*u-o*p*u-m*h*f+o*c*f,x=_*c*a-l*p*a-_*h*u+n*p*u+l*h*f-n*c*f,g=l*d*a-_*m*a+_*o*u-n*d*u-l*o*f+n*m*f,w=_*m*h-l*d*h-_*o*c+n*d*c+l*o*p-n*m*p,C=e*y+i*x+s*g+r*w;if(0===C)return this.set(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);const v=1/C;return t[0]=y*v,t[1]=(d*c*r-m*p*r-d*s*u+i*p*u+m*s*f-i*c*f)*v,t[2]=(o*p*r-d*h*r+d*s*a-i*p*a-o*s*f+i*h*f)*v,t[3]=(m*h*r-o*c*r-m*s*a+i*c*a+o*s*u-i*h*u)*v,t[4]=x*v,t[5]=(l*p*r-_*c*r+_*s*u-e*p*u-l*s*f+e*c*f)*v,t[6]=(_*h*r-n*p*r-_*s*a+e*p*a+n*s*f-e*h*f)*v,t[7]=(n*c*r-l*h*r+l*s*a-e*c*a-n*s*u+e*h*u)*v,t[8]=g*v,t[9]=(_*m*r-l*d*r-_*i*u+e*d*u+l*i*f-e*m*f)*v,t[10]=(n*d*r-_*o*r+_*i*a-e*d*a-n*i*f+e*o*f)*v,t[11]=(l*o*r-n*m*r-l*i*a+e*m*a+n*i*u-e*o*u)*v,t[12]=w*v,t[13]=(l*d*s-_*m*s+_*i*c-e*d*c-l*i*p+e*m*p)*v,t[14]=(_*o*s-n*d*s-_*i*h+e*d*h+n*i*p-e*o*p)*v,t[15]=(n*m*s-l*o*s+l*i*h-e*m*h-n*i*c+e*o*c)*v,this}scale(t){const e=this.elements,i=t.x,s=t.y,r=t.z;return e[0]*=i,e[4]*=s,e[8]*=r,e[1]*=i,e[5]*=s,e[9]*=r,e[2]*=i,e[6]*=s,e[10]*=r,e[3]*=i,e[7]*=s,e[11]*=r,this}getMaxScaleOnAxis(){const t=this.elements,e=t[0]*t[0]+t[1]*t[1]+t[2]*t[2],i=t[4]*t[4]+t[5]*t[5]+t[6]*t[6],s=t[8]*t[8]+t[9]*t[9]+t[10]*t[10];return Math.sqrt(Math.max(e,i,s))}makeTranslation(t,e,i){return this.set(1,0,0,t,0,1,0,e,0,0,1,i,0,0,0,1),this}makeRotationX(t){const e=Math.cos(t),i=Math.sin(t);return this.set(1,0,0,0,0,e,-i,0,0,i,e,0,0,0,0,1),this}makeRotationY(t){const e=Math.cos(t),i=Math.sin(t);return this.set(e,0,i,0,0,1,0,0,-i,0,e,0,0,0,0,1),this}makeRotationZ(t){const e=Math.cos(t),i=Math.sin(t);return this.set(e,-i,0,0,i,e,0,0,0,0,1,0,0,0,0,1),this}makeRotationAxis(t,e){const i=Math.cos(e),s=Math.sin(e),r=1-i,n=t.x,o=t.y,h=t.z,a=r*n,l=r*o;return this.set(a*n+i,a*o-s*h,a*h+s*o,0,a*o+s*h,l*o+i,l*h-s*n,0,a*h-s*o,l*h+s*n,r*h*h+i,0,0,0,0,1),this}makeScale(t,e,i){return this.set(t,0,0,0,0,e,0,0,0,0,i,0,0,0,0,1),this}makeShear(t,e,i,s,r,n){return this.set(1,i,r,0,t,1,n,0,e,s,1,0,0,0,0,1),this}compose(t,e,i){const s=this.elements,r=e._x,n=e._y,o=e._z,h=e._w,a=r+r,l=n+n,m=o+o,c=r*a,u=r*l,_=r*m,d=n*l,p=n*m,f=o*m,y=h*a,x=h*l,g=h*m,w=i.x,C=i.y,v=i.z;return s[0]=(1-(d+f))*w,s[1]=(u+g)*w,s[2]=(_-x)*w,s[3]=0,s[4]=(u-g)*C,s[5]=(1-(c+f))*C,s[6]=(p+y)*C,s[7]=0,s[8]=(_+x)*v,s[9]=(p-y)*v,s[10]=(1-(c+d))*v,s[11]=0,s[12]=t.x,s[13]=t.y,s[14]=t.z,s[15]=1,this}decompose(t,e,i){const s=this.elements;let r=st.set(s[0],s[1],s[2]).length();const n=st.set(s[4],s[5],s[6]).length(),o=st.set(s[8],s[9],s[10]).length();this.determinant()<0&&(r=-r),t.x=s[12],t.y=s[13],t.z=s[14],rt.copy(this);const h=1/r,a=1/n,l=1/o;return rt.elements[0]*=h,rt.elements[1]*=h,rt.elements[2]*=h,rt.elements[4]*=a,rt.elements[5]*=a,rt.elements[6]*=a,rt.elements[8]*=l,rt.elements[9]*=l,rt.elements[10]*=l,e.setFromRotationMatrix(rt),i.x=r,i.y=n,i.z=o,this}makePerspective(t,e,i,s,r,n){void 0===n&&console.warn("THREE.Matrix4: .makePerspective() has been redefined and has a new signature. Please check the docs.");const o=this.elements,h=2*r/(e-t),a=2*r/(i-s),l=(e+t)/(e-t),m=(i+s)/(i-s),c=-(n+r)/(n-r),u=-2*n*r/(n-r);return o[0]=h,o[4]=0,o[8]=l,o[12]=0,o[1]=0,o[5]=a,o[9]=m,o[13]=0,o[2]=0,o[6]=0,o[10]=c,o[14]=u,o[3]=0,o[7]=0,o[11]=-1,o[15]=0,this}makeOrthographic(t,e,i,s,r,n){const o=this.elements,h=1/(e-t),a=1/(i-s),l=1/(n-r),m=(e+t)*h,c=(i+s)*a,u=(n+r)*l;return o[0]=2*h,o[4]=0,o[8]=0,o[12]=-m,o[1]=0,o[5]=2*a,o[9]=0,o[13]=-c,o[2]=0,o[6]=0,o[10]=-2*l,o[14]=-u,o[3]=0,o[7]=0,o[11]=0,o[15]=1,this}equals(t){const e=this.elements,i=t.elements;for(let t=0;t<16;t++)if(e[t]!==i[t])return!1;return!0}fromArray(t,e=0){for(let i=0;i<16;i++)this.elements[i]=t[i+e];return this}toArray(t=[],e=0){const i=this.elements;return t[e]=i[0],t[e+1]=i[1],t[e+2]=i[2],t[e+3]=i[3],t[e+4]=i[4],t[e+5]=i[5],t[e+6]=i[6],t[e+7]=i[7],t[e+8]=i[8],t[e+9]=i[9],t[e+10]=i[10],t[e+11]=i[11],t[e+12]=i[12],t[e+13]=i[13],t[e+14]=i[14],t[e+15]=i[15],t}}const st=new $,rt=new it,nt=new $(0,0,0),ot=new $(1,1,1),ht=new $,at=new $,lt=new $,mt=new it,ct=new K;class ut{constructor(t=0,e=0,i=0,s=ut.DefaultOrder){this.isEuler=!0,this._x=t,this._y=e,this._z=i,this._order=s}get x(){return this._x}set x(t){this._x=t,this._onChangeCallback()}get y(){return this._y}set y(t){this._y=t,this._onChangeCallback()}get z(){return this._z}set z(t){this._z=t,this._onChangeCallback()}get order(){return this._order}set order(t){this._order=t,this._onChangeCallback()}set(t,e,i,s=this._order){return this._x=t,this._y=e,this._z=i,this._order=s,this._onChangeCallback(),this}clone(){return new this.constructor(this._x,this._y,this._z,this._order)}copy(t){return this._x=t._x,this._y=t._y,this._z=t._z,this._order=t._order,this._onChangeCallback(),this}setFromRotationMatrix(t,e=this._order,i=!0){const r=t.elements,n=r[0],o=r[4],h=r[8],a=r[1],l=r[5],m=r[9],c=r[2],u=r[6],_=r[10];switch(e){case"XYZ":this._y=Math.asin(s(h,-1,1)),Math.abs(h)<.9999999?(this._x=Math.atan2(-m,_),this._z=Math.atan2(-o,n)):(this._x=Math.atan2(u,l),this._z=0);break;case"YXZ":this._x=Math.asin(-s(m,-1,1)),Math.abs(m)<.9999999?(this._y=Math.atan2(h,_),this._z=Math.atan2(a,l)):(this._y=Math.atan2(-c,n),this._z=0);break;case"ZXY":this._x=Math.asin(s(u,-1,1)),Math.abs(u)<.9999999?(this._y=Math.atan2(-c,_),this._z=Math.atan2(-o,l)):(this._y=0,this._z=Math.atan2(a,n));break;case"ZYX":this._y=Math.asin(-s(c,-1,1)),Math.abs(c)<.9999999?(this._x=Math.atan2(u,_),this._z=Math.atan2(a,n)):(this._x=0,this._z=Math.atan2(-o,l));break;case"YZX":this._z=Math.asin(s(a,-1,1)),Math.abs(a)<.9999999?(this._x=Math.atan2(-m,l),this._y=Math.atan2(-c,n)):(this._x=0,this._y=Math.atan2(h,_));break;case"XZY":this._z=Math.asin(-s(o,-1,1)),Math.abs(o)<.9999999?(this._x=Math.atan2(u,l),this._y=Math.atan2(h,n)):(this._x=Math.atan2(-m,_),this._y=0);break;default:console.warn("THREE.Euler: .setFromRotationMatrix() encountered an unknown order: "+e)}return this._order=e,!0===i&&this._onChangeCallback(),this}setFromQuaternion(t,e,i){return mt.makeRotationFromQuaternion(t),this.setFromRotationMatrix(mt,e,i)}setFromVector3(t,e=this._order){return this.set(t.x,t.y,t.z,e)}reorder(t){return ct.setFromEuler(this),this.setFromQuaternion(ct,t)}equals(t){return t._x===this._x&&t._y===this._y&&t._z===this._z&&t._order===this._order}fromArray(t){return this._x=t[0],this._y=t[1],this._z=t[2],void 0!==t[3]&&(this._order=t[3]),this._onChangeCallback(),this}toArray(t=[],e=0){return t[e]=this._x,t[e+1]=this._y,t[e+2]=this._z,t[e+3]=this._order,t}_onChange(t){return this._onChangeCallback=t,this}_onChangeCallback(){}*[Symbol.iterator](){yield this._x,yield this._y,yield this._z,yield this._order}toVector3(){console.error("THREE.Euler: .toVector3() has been removed. Use Vector3.setFromEuler() instead")}}ut.DefaultOrder="XYZ",ut.RotationOrders=["XYZ","YZX","ZXY","XZY","YXZ","ZYX"];class _t{constructor(){this.mask=1}set(t){this.mask=(1<<t|0)>>>0}enable(t){this.mask|=1<<t|0}enableAll(){this.mask=-1}toggle(t){this.mask^=1<<t|0}disable(t){this.mask&=~(1<<t|0)}disableAll(){this.mask=0}test(t){return 0!=(this.mask&t.mask)}isEnabled(t){return 0!=(this.mask&(1<<t|0))}}class dt{constructor(){dt.prototype.isMatrix3=!0,this.elements=[1,0,0,0,1,0,0,0,1],arguments.length>0&&console.error("THREE.Matrix3: the constructor no longer reads arguments. use .set() instead.")}set(t,e,i,s,r,n,o,h,a){const l=this.elements;return l[0]=t,l[1]=s,l[2]=o,l[3]=e,l[4]=r,l[5]=h,l[6]=i,l[7]=n,l[8]=a,this}identity(){return this.set(1,0,0,0,1,0,0,0,1),this}copy(t){const e=this.elements,i=t.elements;return e[0]=i[0],e[1]=i[1],e[2]=i[2],e[3]=i[3],e[4]=i[4],e[5]=i[5],e[6]=i[6],e[7]=i[7],e[8]=i[8],this}extractBasis(t,e,i){return t.setFromMatrix3Column(this,0),e.setFromMatrix3Column(this,1),i.setFromMatrix3Column(this,2),this}setFromMatrix4(t){const e=t.elements;return this.set(e[0],e[4],e[8],e[1],e[5],e[9],e[2],e[6],e[10]),this}multiply(t){return this.multiplyMatrices(this,t)}premultiply(t){return this.multiplyMatrices(t,this)}multiplyMatrices(t,e){const i=t.elements,s=e.elements,r=this.elements,n=i[0],o=i[3],h=i[6],a=i[1],l=i[4],m=i[7],c=i[2],u=i[5],_=i[8],d=s[0],p=s[3],f=s[6],y=s[1],x=s[4],g=s[7],w=s[2],C=s[5],v=s[8];return r[0]=n*d+o*y+h*w,r[3]=n*p+o*x+h*C,r[6]=n*f+o*g+h*v,r[1]=a*d+l*y+m*w,r[4]=a*p+l*x+m*C,r[7]=a*f+l*g+m*v,r[2]=c*d+u*y+_*w,r[5]=c*p+u*x+_*C,r[8]=c*f+u*g+_*v,this}multiplyScalar(t){const e=this.elements;return e[0]*=t,e[3]*=t,e[6]*=t,e[1]*=t,e[4]*=t,e[7]*=t,e[2]*=t,e[5]*=t,e[8]*=t,this}determinant(){const t=this.elements,e=t[0],i=t[1],s=t[2],r=t[3],n=t[4],o=t[5],h=t[6],a=t[7],l=t[8];return e*n*l-e*o*a-i*r*l+i*o*h+s*r*a-s*n*h}invert(){const t=this.elements,e=t[0],i=t[1],s=t[2],r=t[3],n=t[4],o=t[5],h=t[6],a=t[7],l=t[8],m=l*n-o*a,c=o*h-l*r,u=a*r-n*h,_=e*m+i*c+s*u;if(0===_)return this.set(0,0,0,0,0,0,0,0,0);const d=1/_;return t[0]=m*d,t[1]=(s*a-l*i)*d,t[2]=(o*i-s*n)*d,t[3]=c*d,t[4]=(l*e-s*h)*d,t[5]=(s*r-o*e)*d,t[6]=u*d,t[7]=(i*h-a*e)*d,t[8]=(n*e-i*r)*d,this}transpose(){let t;const e=this.elements;return t=e[1],e[1]=e[3],e[3]=t,t=e[2],e[2]=e[6],e[6]=t,t=e[5],e[5]=e[7],e[7]=t,this}getNormalMatrix(t){return this.setFromMatrix4(t).invert().transpose()}transposeIntoArray(t){const e=this.elements;return t[0]=e[0],t[1]=e[3],t[2]=e[6],t[3]=e[1],t[4]=e[4],t[5]=e[7],t[6]=e[2],t[7]=e[5],t[8]=e[8],this}setUvTransform(t,e,i,s,r,n,o){const h=Math.cos(r),a=Math.sin(r);return this.set(i*h,i*a,-i*(h*n+a*o)+n+t,-s*a,s*h,-s*(-a*n+h*o)+o+e,0,0,1),this}scale(t,e){const i=this.elements;return i[0]*=t,i[3]*=t,i[6]*=t,i[1]*=e,i[4]*=e,i[7]*=e,this}rotate(t){const e=Math.cos(t),i=Math.sin(t),s=this.elements,r=s[0],n=s[3],o=s[6],h=s[1],a=s[4],l=s[7];return s[0]=e*r+i*h,s[3]=e*n+i*a,s[6]=e*o+i*l,s[1]=-i*r+e*h,s[4]=-i*n+e*a,s[7]=-i*o+e*l,this}translate(t,e){const i=this.elements;return i[0]+=t*i[2],i[3]+=t*i[5],i[6]+=t*i[8],i[1]+=e*i[2],i[4]+=e*i[5],i[7]+=e*i[8],this}equals(t){const e=this.elements,i=t.elements;for(let t=0;t<9;t++)if(e[t]!==i[t])return!1;return!0}fromArray(t,e=0){for(let i=0;i<9;i++)this.elements[i]=t[i+e];return this}toArray(t=[],e=0){const i=this.elements;return t[e]=i[0],t[e+1]=i[1],t[e+2]=i[2],t[e+3]=i[3],t[e+4]=i[4],t[e+5]=i[5],t[e+6]=i[6],t[e+7]=i[7],t[e+8]=i[8],t}clone(){return(new this.constructor).fromArray(this.elements)}}let pt=0;const ft=new $,yt=new K,xt=new it,gt=new $,wt=new $,Ct=new $,vt=new K,St=new $(1,0,0),bt=new $(0,1,0),Bt=new $(0,0,1),At={type:"added"},Vt={type:"removed"};class Mt extends class{addEventListener(t,e){void 0===this._listeners&&(this._listeners={});const i=this._listeners;void 0===i[t]&&(i[t]=[]),-1===i[t].indexOf(e)&&i[t].push(e)}hasEventListener(t,e){if(void 0===this._listeners)return!1;const i=this._listeners;return void 0!==i[t]&&-1!==i[t].indexOf(e)}removeEventListener(t,e){if(void 0===this._listeners)return;const i=this._listeners[t];if(void 0!==i){const t=i.indexOf(e);-1!==t&&i.splice(t,1)}}dispatchEvent(t){if(void 0===this._listeners)return;const e=this._listeners[t.type];if(void 0!==e){t.target=this;const i=e.slice(0);for(let e=0,s=i.length;e<s;e++)i[e].call(this,t);t.target=null}}}{constructor(){super(),this.isObject3D=!0,Object.defineProperty(this,"id",{value:pt++}),this.uuid=function(){const e=4294967295*Math.random()|0,i=4294967295*Math.random()|0,s=4294967295*Math.random()|0,r=4294967295*Math.random()|0;return(t[255&e]+t[e>>8&255]+t[e>>16&255]+t[e>>24&255]+"-"+t[255&i]+t[i>>8&255]+"-"+t[i>>16&15|64]+t[i>>24&255]+"-"+t[63&s|128]+t[s>>8&255]+"-"+t[s>>16&255]+t[s>>24&255]+t[255&r]+t[r>>8&255]+t[r>>16&255]+t[r>>24&255]).toLowerCase()}(),this.name="",this.type="Object3D",this.parent=null,this.children=[],this.up=Mt.DefaultUp.clone();const e=new $,i=new ut,s=new K,r=new $(1,1,1);i._onChange((function(){s.setFromEuler(i,!1)})),s._onChange((function(){i.setFromQuaternion(s,void 0,!1)})),Object.defineProperties(this,{position:{configurable:!0,enumerable:!0,value:e},rotation:{configurable:!0,enumerable:!0,value:i},quaternion:{configurable:!0,enumerable:!0,value:s},scale:{configurable:!0,enumerable:!0,value:r},modelViewMatrix:{value:new it},normalMatrix:{value:new dt}}),this.matrix=new it,this.matrixWorld=new it,this.matrixAutoUpdate=Mt.DefaultMatrixAutoUpdate,this.matrixWorldNeedsUpdate=!1,this.layers=new _t,this.visible=!0,this.castShadow=!1,this.receiveShadow=!1,this.frustumCulled=!0,this.renderOrder=0,this.animations=[],this.userData={}}onBeforeRender(){}onAfterRender(){}applyMatrix4(t){this.matrixAutoUpdate&&this.updateMatrix(),this.matrix.premultiply(t),this.matrix.decompose(this.position,this.quaternion,this.scale)}applyQuaternion(t){return this.quaternion.premultiply(t),this}setRotationFromAxisAngle(t,e){this.quaternion.setFromAxisAngle(t,e)}setRotationFromEuler(t){this.quaternion.setFromEuler(t,!0)}setRotationFromMatrix(t){this.quaternion.setFromRotationMatrix(t)}setRotationFromQuaternion(t){this.quaternion.copy(t)}rotateOnAxis(t,e){return yt.setFromAxisAngle(t,e),this.quaternion.multiply(yt),this}rotateOnWorldAxis(t,e){return yt.setFromAxisAngle(t,e),this.quaternion.premultiply(yt),this}rotateX(t){return this.rotateOnAxis(St,t)}rotateY(t){return this.rotateOnAxis(bt,t)}rotateZ(t){return this.rotateOnAxis(Bt,t)}translateOnAxis(t,e){return ft.copy(t).applyQuaternion(this.quaternion),this.position.add(ft.multiplyScalar(e)),this}translateX(t){return this.translateOnAxis(St,t)}translateY(t){return this.translateOnAxis(bt,t)}translateZ(t){return this.translateOnAxis(Bt,t)}localToWorld(t){return t.applyMatrix4(this.matrixWorld)}worldToLocal(t){return t.applyMatrix4(xt.copy(this.matrixWorld).invert())}lookAt(t,e,i){t.isVector3?gt.copy(t):gt.set(t,e,i);const s=this.parent;this.updateWorldMatrix(!0,!1),wt.setFromMatrixPosition(this.matrixWorld),this.isCamera||this.isLight?xt.lookAt(wt,gt,this.up):xt.lookAt(gt,wt,this.up),this.quaternion.setFromRotationMatrix(xt),s&&(xt.extractRotation(s.matrixWorld),yt.setFromRotationMatrix(xt),this.quaternion.premultiply(yt.invert()))}add(t){if(arguments.length>1){for(let t=0;t<arguments.length;t++)this.add(arguments[t]);return this}return t===this?(console.error("THREE.Object3D.add: object can't be added as a child of itself.",t),this):(t&&t.isObject3D?(null!==t.parent&&t.parent.remove(t),t.parent=this,this.children.push(t),t.dispatchEvent(At)):console.error("THREE.Object3D.add: object not an instance of THREE.Object3D.",t),this)}remove(t){if(arguments.length>1){for(let t=0;t<arguments.length;t++)this.remove(arguments[t]);return this}const e=this.children.indexOf(t);return-1!==e&&(t.parent=null,this.children.splice(e,1),t.dispatchEvent(Vt)),this}removeFromParent(){const t=this.parent;return null!==t&&t.remove(this),this}clear(){for(let t=0;t<this.children.length;t++){const e=this.children[t];e.parent=null,e.dispatchEvent(Vt)}return this.children.length=0,this}attach(t){return this.updateWorldMatrix(!0,!1),xt.copy(this.matrixWorld).invert(),null!==t.parent&&(t.parent.updateWorldMatrix(!0,!1),xt.multiply(t.parent.matrixWorld)),t.applyMatrix4(xt),this.add(t),t.updateWorldMatrix(!1,!0),this}getObjectById(t){return this.getObjectByProperty("id",t)}getObjectByName(t){return this.getObjectByProperty("name",t)}getObjectByProperty(t,e){if(this[t]===e)return this;for(let i=0,s=this.children.length;i<s;i++){const s=this.children[i].getObjectByProperty(t,e);if(void 0!==s)return s}}getWorldPosition(t){return this.updateWorldMatrix(!0,!1),t.setFromMatrixPosition(this.matrixWorld)}getWorldQuaternion(t){return this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(wt,t,Ct),t}getWorldScale(t){return this.updateWorldMatrix(!0,!1),this.matrixWorld.decompose(wt,vt,t),t}getWorldDirection(t){this.updateWorldMatrix(!0,!1);const e=this.matrixWorld.elements;return t.set(e[8],e[9],e[10]).normalize()}raycast(){}traverse(t){t(this);const e=this.children;for(let i=0,s=e.length;i<s;i++)e[i].traverse(t)}traverseVisible(t){if(!1===this.visible)return;t(this);const e=this.children;for(let i=0,s=e.length;i<s;i++)e[i].traverseVisible(t)}traverseAncestors(t){const e=this.parent;null!==e&&(t(e),e.traverseAncestors(t))}updateMatrix(){this.matrix.compose(this.position,this.quaternion,this.scale),this.matrixWorldNeedsUpdate=!0}updateMatrixWorld(t){this.matrixAutoUpdate&&this.updateMatrix(),(this.matrixWorldNeedsUpdate||t)&&(null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix),this.matrixWorldNeedsUpdate=!1,t=!0);const e=this.children;for(let i=0,s=e.length;i<s;i++)e[i].updateMatrixWorld(t)}updateWorldMatrix(t,e){const i=this.parent;if(!0===t&&null!==i&&i.updateWorldMatrix(!0,!1),this.matrixAutoUpdate&&this.updateMatrix(),null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix),!0===e){const t=this.children;for(let e=0,i=t.length;e<i;e++)t[e].updateWorldMatrix(!1,!0)}}toJSON(t){const e=void 0===t||"string"==typeof t,i={};e&&(t={geometries:{},materials:{},textures:{},images:{},shapes:{},skeletons:{},animations:{},nodes:{}},i.metadata={version:4.5,type:"Object",generator:"Object3D.toJSON"});const s={};function r(e,i){return void 0===e[i.uuid]&&(e[i.uuid]=i.toJSON(t)),i.uuid}if(s.uuid=this.uuid,s.type=this.type,""!==this.name&&(s.name=this.name),!0===this.castShadow&&(s.castShadow=!0),!0===this.receiveShadow&&(s.receiveShadow=!0),!1===this.visible&&(s.visible=!1),!1===this.frustumCulled&&(s.frustumCulled=!1),0!==this.renderOrder&&(s.renderOrder=this.renderOrder),"{}"!==JSON.stringify(this.userData)&&(s.userData=this.userData),s.layers=this.layers.mask,s.matrix=this.matrix.toArray(),!1===this.matrixAutoUpdate&&(s.matrixAutoUpdate=!1),this.isInstancedMesh&&(s.type="InstancedMesh",s.count=this.count,s.instanceMatrix=this.instanceMatrix.toJSON(),null!==this.instanceColor&&(s.instanceColor=this.instanceColor.toJSON())),this.isScene)this.background&&(this.background.isColor?s.background=this.background.toJSON():this.background.isTexture&&(s.background=this.background.toJSON(t).uuid)),this.environment&&this.environment.isTexture&&(s.environment=this.environment.toJSON(t).uuid);else if(this.isMesh||this.isLine||this.isPoints){s.geometry=r(t.geometries,this.geometry);const e=this.geometry.parameters;if(void 0!==e&&void 0!==e.shapes){const i=e.shapes;if(Array.isArray(i))for(let e=0,s=i.length;e<s;e++){const s=i[e];r(t.shapes,s)}else r(t.shapes,i)}}if(this.isSkinnedMesh&&(s.bindMode=this.bindMode,s.bindMatrix=this.bindMatrix.toArray(),void 0!==this.skeleton&&(r(t.skeletons,this.skeleton),s.skeleton=this.skeleton.uuid)),void 0!==this.material)if(Array.isArray(this.material)){const e=[];for(let i=0,s=this.material.length;i<s;i++)e.push(r(t.materials,this.material[i]));s.material=e}else s.material=r(t.materials,this.material);if(this.children.length>0){s.children=[];for(let e=0;e<this.children.length;e++)s.children.push(this.children[e].toJSON(t).object)}if(this.animations.length>0){s.animations=[];for(let e=0;e<this.animations.length;e++){const i=this.animations[e];s.animations.push(r(t.animations,i))}}if(e){const e=n(t.geometries),s=n(t.materials),r=n(t.textures),o=n(t.images),h=n(t.shapes),a=n(t.skeletons),l=n(t.animations),m=n(t.nodes);e.length>0&&(i.geometries=e),s.length>0&&(i.materials=s),r.length>0&&(i.textures=r),o.length>0&&(i.images=o),h.length>0&&(i.shapes=h),a.length>0&&(i.skeletons=a),l.length>0&&(i.animations=l),m.length>0&&(i.nodes=m)}return i.object=s,i;function n(t){const e=[];for(const i in t){const s=t[i];delete s.metadata,e.push(s)}return e}}clone(t){return(new this.constructor).copy(this,t)}copy(t,e=!0){if(this.name=t.name,this.up.copy(t.up),this.position.copy(t.position),this.rotation.order=t.rotation.order,this.quaternion.copy(t.quaternion),this.scale.copy(t.scale),this.matrix.copy(t.matrix),this.matrixWorld.copy(t.matrixWorld),this.matrixAutoUpdate=t.matrixAutoUpdate,this.matrixWorldNeedsUpdate=t.matrixWorldNeedsUpdate,this.layers.mask=t.layers.mask,this.visible=t.visible,this.castShadow=t.castShadow,this.receiveShadow=t.receiveShadow,this.frustumCulled=t.frustumCulled,this.renderOrder=t.renderOrder,this.userData=JSON.parse(JSON.stringify(t.userData)),!0===e)for(let e=0;e<t.children.length;e++){const i=t.children[e];this.add(i.clone())}return this}}Mt.DefaultUp=new $(0,1,0),Mt.DefaultMatrixAutoUpdate=!0;class Dt extends Mt{constructor(){super(),this.isScene=!0,this.type="Scene",this.background=null,this.environment=null,this.fog=null,this.overrideMaterial=null,this.autoUpdate=!0,"undefined"!=typeof __THREE_DEVTOOLS__&&__THREE_DEVTOOLS__.dispatchEvent(new CustomEvent("observe",{detail:this}))}copy(t,e){return super.copy(t,e),null!==t.background&&(this.background=t.background.clone()),null!==t.environment&&(this.environment=t.environment.clone()),null!==t.fog&&(this.fog=t.fog.clone()),null!==t.overrideMaterial&&(this.overrideMaterial=t.overrideMaterial.clone()),this.autoUpdate=t.autoUpdate,this.matrixAutoUpdate=t.matrixAutoUpdate,this}toJSON(t){const e=super.toJSON(t);return null!==this.fog&&(e.object.fog=this.fog.toJSON()),e}}class It{constructor(t=0,e=0,i=0,s=It.DefaultOrder){this.isEuler=!0,this.th=t,this.sh=e,this.hh=i,this.ih=s,this._onChangeCallback=()=>{},this.eh=()=>{},this.rh=()=>{}}onBeforeGetComponent(t){this.rh=t}onBeforeChange(t){this.eh=t}get _x(){return this.rh(),this.th}set _x(t){this.th=t}get _y(){return this.rh(),this.sh}set _y(t){this.sh=t}get _z(){return this.rh(),this.hh}set _z(t){this.hh=t}get _order(){return this.rh(),this.ih}set _order(t){this.ih=t}get x(){return this.rh(),this.th}set x(t){this.eh(),this.th=t,this._onChangeCallback()}get y(){return this.rh(),this.sh}set y(t){this.eh(),this.sh=t,this._onChangeCallback()}get z(){return this.rh(),this.hh}set z(t){this.eh(),this.hh=t,this._onChangeCallback()}get order(){return this.rh(),this.ih}set order(t){this.eh(),this.ih=t,this._onChangeCallback()}set(t,e,i,s){return this.eh(),this.th=t,this.sh=e,this.hh=i,s&&(this.ih=s),this._onChangeCallback(),this}clone(){return this.rh(),new ut(this.th,this.sh,this.hh,this.ih)}copy(t){return this.eh(),this.th=t._x,this.sh=t._y,this.hh=t._z,this.ih=t._order,this._onChangeCallback(),this}setFromRotationMatrix(t,e,i=!0){this.rh();const r=t.elements,n=r[0],o=r[4],h=r[8],a=r[1],l=r[5],m=r[9],c=r[2],u=r[6],_=r[10];switch(e||(e=this.ih),this.eh(),e){case"XYZ":this.sh=Math.asin(s(h,-1,1)),Math.abs(h)<.9999999?(this.th=Math.atan2(-m,_),this.hh=Math.atan2(-o,n)):(this.th=Math.atan2(u,l),this.hh=0);break;case"YXZ":this.th=Math.asin(-s(m,-1,1)),Math.abs(m)<.9999999?(this.sh=Math.atan2(h,_),this.hh=Math.atan2(a,l)):(this.sh=Math.atan2(-c,n),this.hh=0);break;case"ZXY":this.th=Math.asin(s(u,-1,1)),Math.abs(u)<.9999999?(this.sh=Math.atan2(-c,_),this.hh=Math.atan2(-o,l)):(this.sh=0,this.hh=Math.atan2(a,n));break;case"ZYX":this.sh=Math.asin(-s(c,-1,1)),Math.abs(c)<.9999999?(this.th=Math.atan2(u,_),this.hh=Math.atan2(a,n)):(this.th=0,this.hh=Math.atan2(-o,l));break;case"YZX":this.hh=Math.asin(s(a,-1,1)),Math.abs(a)<.9999999?(this.th=Math.atan2(-m,l),this.sh=Math.atan2(-c,n)):(this.th=0,this.sh=Math.atan2(h,_));break;case"XZY":this.hh=Math.asin(-s(o,-1,1)),Math.abs(o)<.9999999?(this.th=Math.atan2(u,l),this.sh=Math.atan2(h,n)):(this.th=Math.atan2(-m,_),this.sh=0);break;default:console.warn("THREE.Euler: .setFromRotationMatrix() encountered an unknown order: "+e)}return this.ih=e,!0===i&&this._onChangeCallback(),this}setFromQuaternion(t,e,i){return Pt.makeRotationFromQuaternion(t),this.setFromRotationMatrix(Pt,e,i)}setFromVector3(t,e){return this.set(t.x,t.y,t.z,e)}reorder(t){return Gt.setFromEuler(this),this.setFromQuaternion(Gt,t)}equals(t){return this.rh(),t._x===this.th&&t._y===this.sh&&t._z===this.hh&&t._order===this.ih}fromArray(t){return this.th===t[0]&&this.sh===t[1]&&this.hh===t[2]&&this.ih===t[3]||(this.eh(),this.th=t[0],this.sh=t[1],this.hh=t[2],void 0!==t[3]&&(this.ih=t[3]),this._onChangeCallback()),this}toArray(t=[],e=0){return this.rh(),t[e]=this.th,t[e+1]=this.sh,t[e+2]=this.hh,t[e+3]=this.ih,t}_onChange(t){return this._onChangeCallback=t,this}*[Symbol.iterator](){this.rh(),yield this.th,this.rh(),yield this.sh,this.rh(),yield this.hh,this.rh(),yield this.ih}}It.DefaultOrder="XYZ",It.RotationOrders=["XYZ","YZX","ZXY","XZY","YXZ","ZYX"];const Pt=new it,Gt=new K;class Tt{constructor(t=0,e=0,i=0,s=1){this.isQuaternion=!0,this.th=t,this.sh=e,this.hh=i,this.hi=s,this._onChangeCallback=()=>{},this.eh=()=>{},this.rh=()=>{}}onBeforeGetComponent(t){this.rh=t}onBeforeChange(t){this.eh=t}static slerp(t,e,i,s){return console.warn("THREE.Quaternion: Static .slerp() has been deprecated. Use qm.slerpQuaternions( qa, qb, t ) instead."),i.slerpQuaternions(t,e,s)}static slerpFlat(t,e,i,s,r,n,o){let h=i[s+0],a=i[s+1],l=i[s+2],m=i[s+3];const c=r[n+0],u=r[n+1],_=r[n+2],d=r[n+3];if(0===o)return t[e+0]=h,t[e+1]=a,t[e+2]=l,void(t[e+3]=m);if(1===o)return t[e+0]=c,t[e+1]=u,t[e+2]=_,void(t[e+3]=d);if(m!==d||h!==c||a!==u||l!==_){let t=1-o;const e=h*c+a*u+l*_+m*d,i=e>=0?1:-1,s=1-e*e;if(s>Number.EPSILON){const r=Math.sqrt(s),n=Math.atan2(r,e*i);t=Math.sin(t*n)/r,o=Math.sin(o*n)/r}const r=o*i;if(h=h*t+c*r,a=a*t+u*r,l=l*t+_*r,m=m*t+d*r,t===1-o){const t=1/Math.sqrt(h*h+a*a+l*l+m*m);h*=t,a*=t,l*=t,m*=t}}t[e]=h,t[e+1]=a,t[e+2]=l,t[e+3]=m}static multiplyQuaternionsFlat(t,e,i,s,r,n){const o=i[s],h=i[s+1],a=i[s+2],l=i[s+3],m=r[n],c=r[n+1],u=r[n+2],_=r[n+3];return t[e]=o*_+l*m+h*u-a*c,t[e+1]=h*_+l*c+a*m-o*u,t[e+2]=a*_+l*u+o*c-h*m,t[e+3]=l*_-o*m-h*c-a*u,t}get _x(){return this.rh(),this.th}set _x(t){this.th=t}get _y(){return this.rh(),this.sh}set _y(t){this.sh=t}get _z(){return this.rh(),this.hh}set _z(t){this.hh=t}get _w(){return this.rh(),this.hi}set _w(t){this.hi=t}get x(){return this.rh(),this.th}set x(t){this.eh(),this.th=t,this._onChangeCallback()}get y(){return this.rh(),this.sh}set y(t){this.eh(),this.sh=t,this._onChangeCallback()}get z(){return this.rh(),this.hh}set z(t){this.eh(),this.hh=t,this._onChangeCallback()}get w(){return this.rh(),this.hi}set w(t){this.eh(),this.hi=t,this._onChangeCallback()}set(t,e,i,s){return this.eh(),this.th=t,this.sh=e,this.hh=i,this.hi=s,this._onChangeCallback(),this}clone(){return this.rh(),new K(this.th,this.sh,this.hh,this.hi)}copy(t){return this.eh(),this.th=t.x,this.sh=t.y,this.hh=t.z,this.hi=t.w,this._onChangeCallback(),this}setFromEuler(t,e){if(!t||!t.isEuler)throw new Error("THREE.Quaternion: .setFromEuler() now expects an Euler rotation rather than a Vector3 and order.");const i=t._x,s=t._y,r=t._z,n=t._order,o=Math.cos,h=Math.sin,a=o(i/2),l=o(s/2),m=o(r/2),c=h(i/2),u=h(s/2),_=h(r/2);switch(this.eh(),n){case"XYZ":this.th=c*l*m+a*u*_,this.sh=a*u*m-c*l*_,this.hh=a*l*_+c*u*m,this.hi=a*l*m-c*u*_;break;case"YXZ":this.th=c*l*m+a*u*_,this.sh=a*u*m-c*l*_,this.hh=a*l*_-c*u*m,this.hi=a*l*m+c*u*_;break;case"ZXY":this.th=c*l*m-a*u*_,this.sh=a*u*m+c*l*_,this.hh=a*l*_+c*u*m,this.hi=a*l*m-c*u*_;break;case"ZYX":this.th=c*l*m-a*u*_,this.sh=a*u*m+c*l*_,this.hh=a*l*_-c*u*m,this.hi=a*l*m+c*u*_;break;case"YZX":this.th=c*l*m+a*u*_,this.sh=a*u*m+c*l*_,this.hh=a*l*_-c*u*m,this.hi=a*l*m-c*u*_;break;case"XZY":this.th=c*l*m-a*u*_,this.sh=a*u*m-c*l*_,this.hh=a*l*_+c*u*m,this.hi=a*l*m+c*u*_;break;default:console.warn("THREE.Quaternion: .setFromEuler() encountered an unknown order: "+n)}return!1!==e&&this._onChangeCallback(),this}setFromAxisAngle(t,e){const i=e/2,s=Math.sin(i);return this.eh(),this.th=t.x*s,this.sh=t.y*s,this.hh=t.z*s,this.hi=Math.cos(i),this._onChangeCallback(),this}setFromRotationMatrix(t){const e=t.elements,i=e[0],s=e[4],r=e[8],n=e[1],o=e[5],h=e[9],a=e[2],l=e[6],m=e[10],c=i+o+m;if(this.eh(),c>0){const t=.5/Math.sqrt(c+1);this.hi=.25/t,this.th=(l-h)*t,this.sh=(r-a)*t,this.hh=(n-s)*t}else if(i>o&&i>m){const t=2*Math.sqrt(1+i-o-m);this.hi=(l-h)/t,this.th=.25*t,this.sh=(s+n)/t,this.hh=(r+a)/t}else if(o>m){const t=2*Math.sqrt(1+o-i-m);this.hi=(r-a)/t,this.th=(s+n)/t,this.sh=.25*t,this.hh=(h+l)/t}else{const t=2*Math.sqrt(1+m-i-o);this.hi=(n-s)/t,this.th=(r+a)/t,this.sh=(h+l)/t,this.hh=.25*t}return this._onChangeCallback(),this}setFromUnitVectors(t,e){let i=t.dot(e)+1;return this.eh(),i<Number.EPSILON?(i=0,Math.abs(t.x)>Math.abs(t.z)?(this.th=-t.y,this.sh=t.x,this.hh=0,this.hi=i):(this.th=0,this.sh=-t.z,this.hh=t.y,this.hi=i)):(this.th=t.y*e.z-t.z*e.y,this.sh=t.z*e.x-t.x*e.z,this.hh=t.x*e.y-t.y*e.x,this.hi=i),this.normalize()}angleTo(t){return 2*Math.acos(Math.abs(s(this.dot(t),-1,1)))}rotateTowards(t,e){const i=this.angleTo(t);if(0===i)return this;const s=Math.min(1,e/i);return this.slerp(t,s),this}identity(){return this.set(0,0,0,1)}invert(){return this.conjugate()}conjugate(){return this.rh(),this.eh(),this.th*=-1,this.sh*=-1,this.hh*=-1,this._onChangeCallback(),this}dot(t){return this.rh(),this.th*t._x+this.sh*t._y+this.hh*t._z+this.hi*t._w}lengthSq(){return this.rh(),this.th*this.th+this.sh*this.sh+this.hh*this.hh+this.hi*this.hi}length(){return this.rh(),Math.sqrt(this.th*this.th+this.sh*this.sh+this.hh*this.hh+this.hi*this.hi)}normalize(){let t=this.length();return 0===t?(this.eh(),this.th=0,this.sh=0,this.hh=0,this.hi=1):(t=1/t,this.rh(),this.eh(),this.th=this.th*t,this.sh=this.sh*t,this.hh=this.hh*t,this.hi=this.hi*t),this._onChangeCallback(),this}multiply(t,e){return void 0!==e?(console.warn("THREE.Quaternion: .multiply() now only accepts one argument. Use .multiplyQuaternions( a, b ) instead."),this.multiplyQuaternions(t,e)):0===t._x&&0===t._y&&0===t._z&&1===t._w?this:this.multiplyQuaternions(this,t)}premultiply(t){return this.multiplyQuaternions(t,this)}multiplyQuaternions(t,e){const i=t._x,s=t._y,r=t._z,n=t._w,o=e._x,h=e._y,a=e._z,l=e._w;return this.eh(),this.th=i*l+n*o+s*a-r*h,this.sh=s*l+n*h+r*o-i*a,this.hh=r*l+n*a+i*h-s*o,this.hi=n*l-i*o-s*h-r*a,this._onChangeCallback(),this}slerp(t,e){if(0===e)return this;if(1===e)return this.copy(t);this.rh();const i=this.th,s=this.sh,r=this.hh,n=this.hi;let o=n*t._w+i*t._x+s*t._y+r*t._z;if(this.eh(),o<0?(this.hi=-t._w,this.th=-t._x,this.sh=-t._y,this.hh=-t._z,o=-o):this.copy(t),o>=1)return this.hi=n,this.th=i,this.sh=s,this.hh=r,this;const h=1-o*o;if(h<=Number.EPSILON){const t=1-e;return this.hi=t*n+e*this.hi,this.th=t*i+e*this.th,this.sh=t*s+e*this.sh,this.hh=t*r+e*this.hh,this.normalize(),this}const a=Math.sqrt(h),l=Math.atan2(a,o),m=Math.sin((1-e)*l)/a,c=Math.sin(e*l)/a;return this.hi=n*m+this.hi*c,this.th=i*m+this.th*c,this.sh=s*m+this.sh*c,this.hh=r*m+this.hh*c,this._onChangeCallback(),this}slerpQuaternions(t,e,i){return this.copy(t).slerp(e,i)}random(){const t=Math.random(),e=Math.sqrt(1-t),i=Math.sqrt(t),s=2*Math.PI*Math.random(),r=2*Math.PI*Math.random();return this.set(e*Math.cos(s),i*Math.sin(r),i*Math.cos(r),e*Math.sin(s))}equals(t){return this.rh(),t._x===this.th&&t._y===this.sh&&t._z===this.hh&&t._w===this.hi}fromArray(t,e=0){return this.th===t[e]&&this.sh===t[e+1]&&this.hh===t[e+2]&&this.hi===t[e+3]||(this.eh(),this.th=t[e],this.sh=t[e+1],this.hh=t[e+2],this.hi=t[e+3],this._onChangeCallback()),this}toArray(t=[],e=0){return this.rh(),t[e]=this.th,t[e+1]=this.sh,t[e+2]=this.hh,t[e+3]=this.hi,t}fromBufferAttribute(t,e){return this.th=t.getX(e),this.sh=t.getY(e),this.hh=t.getZ(e),this.hi=t.getW(e),this}_onChange(t){return this._onChangeCallback=t,this}multiplyVector3(t){throw new Error("deprecated")}inverse(){throw new Error("deprecated")}*[Symbol.iterator](){this.rh(),yield this.th,this.rh(),yield this.sh,this.rh(),yield this.hh,this.rh(),yield this.hi}}class Rt{constructor(t=0,e=0,i=0){this.isVector3=!0,this.nh=t,this.ah=e,this.oh=i,this.eh=()=>{},this.rh=()=>{}}onBeforeChange(t){this.eh=t}onBeforeGetComponent(t){this.rh=t}get x(){return this.rh(),this.nh}set x(t){this.eh(),this.nh=t}get y(){return this.rh(),this.ah}set y(t){this.eh(),this.ah=t}get z(){return this.rh(),this.oh}set z(t){this.eh(),this.oh=t}set(t,e,i){return void 0===i&&(this.rh(),i=this.oh),this.eh(),this.nh=t,this.ah=e,this.oh=i,this}setScalar(t){return this.eh(),this.nh=t,this.ah=t,this.oh=t,this}setX(t){return this.eh(),this.nh=t,this}setY(t){return this.eh(),this.ah=t,this}setZ(t){return this.eh(),this.oh=t,this}setComponent(t,e){switch(t){case 0:this.eh(),this.nh=e;break;case 1:this.eh(),this.ah=e;break;case 2:this.eh(),this.oh=e;break;default:throw new Error("index is out of range: "+t)}return this}getComponent(t){switch(this.rh(),t){case 0:return this.nh;case 1:return this.ah;case 2:return this.oh;default:throw new Error("index is out of range: "+t)}}clone(){return this.rh(),new $(this.nh,this.ah,this.oh)}copy(t){return this.eh(),this.nh=t.x,this.ah=t.y,this.oh=t.z,this}add(t,e){return void 0!==e?(console.warn("THREE.Vector3: .add() now only accepts one argument. Use .addVectors( a, b ) instead."),this.addVectors(t,e)):(0===t.x&&0===t.y&&0===t.z||(this.rh(),this.eh(),this.nh+=t.x,this.ah+=t.y,this.oh+=t.z),this)}addScalar(t){return 0===t||(this.rh(),this.eh(),this.nh+=t,this.ah+=t,this.oh+=t),this}addVectors(t,e){return this.eh(),this.nh=t.x+e.x,this.ah=t.y+e.y,this.oh=t.z+e.z,this}addScaledVector(t,e){return this.rh(),this.eh(),this.nh+=t.x*e,this.ah+=t.y*e,this.oh+=t.z*e,this}sub(t,e){return void 0!==e?(console.warn("THREE.Vector3: .sub() now only accepts one argument. Use .subVectors( a, b ) instead."),this.subVectors(t,e)):(0===t.x&&0===t.y&&0===t.z||(this.rh(),this.eh(),this.nh-=t.x,this.ah-=t.y,this.oh-=t.z),this)}subScalar(t){return 0===t||(this.rh(),this.eh(),this.nh-=t,this.ah-=t,this.oh-=t),this}subVectors(t,e){return this.eh(),this.nh=t.x-e.x,this.ah=t.y-e.y,this.oh=t.z-e.z,this}multiply(t,e){return void 0!==e?(console.warn("THREE.Vector3: .multiply() now only accepts one argument. Use .multiplyVectors( a, b ) instead."),this.multiplyVectors(t,e)):(1===t.x&&1===t.y&&1===t.z||(this.rh(),this.eh(),this.nh*=t.x,this.ah*=t.y,this.oh*=t.z),this)}multiplyScalar(t){return 1===t||(this.rh(),this.eh(),this.nh*=t,this.ah*=t,this.oh*=t),this}multiplyVectors(t,e){return this.eh(),this.nh=t.x*e.x,this.ah=t.y*e.y,this.oh=t.z*e.z,this}applyEuler(t){return t&&t.isEuler||console.error("THREE.Vector3: .applyEuler() now expects an Euler rotation rather than a Vector3 and order."),this.applyQuaternion(kt.setFromEuler(t))}applyAxisAngle(t,e){return this.applyQuaternion(kt.setFromAxisAngle(t,e))}applyMatrix3(t){this.rh();const e=this.nh,i=this.ah,s=this.oh,r=t.elements;return this.eh(),this.nh=r[0]*e+r[3]*i+r[6]*s,this.ah=r[1]*e+r[4]*i+r[7]*s,this.oh=r[2]*e+r[5]*i+r[8]*s,this}applyNormalMatrix(t){return this.applyMatrix3(t).normalize()}applyMatrix4(t){this.rh();const e=this.nh,i=this.ah,s=this.oh,r=t.elements,n=1/(r[3]*e+r[7]*i+r[11]*s+r[15]);return this.eh(),this.nh=(r[0]*e+r[4]*i+r[8]*s+r[12])*n,this.ah=(r[1]*e+r[5]*i+r[9]*s+r[13])*n,this.oh=(r[2]*e+r[6]*i+r[10]*s+r[14])*n,this}applyQuaternion(t){this.rh();const e=this.nh,i=this.ah,s=this.oh,r=t.x,n=t.y,o=t.z,h=t.w,a=h*e+n*s-o*i,l=h*i+o*e-r*s,m=h*s+r*i-n*e,c=-r*e-n*i-o*s;return this.eh(),this.nh=a*h+c*-r+l*-o-m*-n,this.ah=l*h+c*-n+m*-r-a*-o,this.oh=m*h+c*-o+a*-n-l*-r,this}project(t){return this.applyMatrix4(t.matrixWorldInverse).applyMatrix4(t.projectionMatrix)}unproject(t){return this.applyMatrix4(t.projectionMatrixInverse).applyMatrix4(t.matrixWorld)}transformDirection(t){this.rh();const e=this.nh,i=this.ah,s=this.oh,r=t.elements;return this.eh(),this.nh=r[0]*e+r[4]*i+r[8]*s,this.ah=r[1]*e+r[5]*i+r[9]*s,this.oh=r[2]*e+r[6]*i+r[10]*s,this.normalize()}divide(t){return 1===t.x&&1===t.y&&1===t.z||(this.rh(),this.eh(),this.nh/=t.x,this.ah/=t.y,this.oh/=t.z),this}divideScalar(t){return this.multiplyScalar(1/t)}min(t){return this.rh(),this.eh(),this.nh=Math.min(this.nh,t.x),this.ah=Math.min(this.ah,t.y),this.oh=Math.min(this.oh,t.z),this}max(t){return this.rh(),this.eh(),this.nh=Math.max(this.nh,t.x),this.ah=Math.max(this.ah,t.y),this.oh=Math.max(this.oh,t.z),this}clamp(t,e){return this.rh(),this.eh(),this.nh=Math.max(t.x,Math.min(e.x,this.nh)),this.ah=Math.max(t.y,Math.min(e.y,this.ah)),this.oh=Math.max(t.z,Math.min(e.z,this.oh)),this}clampScalar(t,e){return this.rh(),this.eh(),this.nh=Math.max(t,Math.min(e,this.nh)),this.ah=Math.max(t,Math.min(e,this.ah)),this.oh=Math.max(t,Math.min(e,this.oh)),this}clampLength(t,e){const i=this.length();return this.divideScalar(i||1).multiplyScalar(Math.max(t,Math.min(e,i)))}floor(){return this.rh(),this.eh(),this.nh=Math.floor(this.nh),this.ah=Math.floor(this.ah),this.oh=Math.floor(this.oh),this}ceil(){return this.rh(),this.eh(),this.nh=Math.ceil(this.nh),this.ah=Math.ceil(this.ah),this.oh=Math.ceil(this.oh),this}round(){return this.rh(),this.eh(),this.nh=Math.round(this.nh),this.ah=Math.round(this.ah),this.oh=Math.round(this.oh),this}roundToZero(){return this.rh(),this.eh(),this.nh=this.nh<0?Math.ceil(this.nh):Math.floor(this.nh),this.ah=this.ah<0?Math.ceil(this.ah):Math.floor(this.ah),this.oh=this.oh<0?Math.ceil(this.oh):Math.floor(this.oh),this}negate(){return this.rh(),this.eh(),this.nh=-this.nh,this.ah=-this.ah,this.oh=-this.oh,this}dot(t){return this.rh(),this.nh*t.x+this.ah*t.y+this.oh*t.z}lengthSq(){return this.rh(),this.nh*this.nh+this.ah*this.ah+this.oh*this.oh}length(){return this.rh(),Math.sqrt(this.nh*this.nh+this.ah*this.ah+this.oh*this.oh)}manhattanLength(){return this.rh(),Math.abs(this.nh)+Math.abs(this.ah)+Math.abs(this.oh)}normalize(){return this.divideScalar(this.length()||1)}setLength(t){return this.normalize().multiplyScalar(t)}lerp(t,e){return this.rh(),this.eh(),this.nh+=(t.x-this.nh)*e,this.ah+=(t.y-this.ah)*e,this.oh+=(t.z-this.oh)*e,this}lerpVectors(t,e,i){return this.eh(),this.nh=t.x+(e.x-t.x)*i,this.ah=t.y+(e.y-t.y)*i,this.oh=t.z+(e.z-t.z)*i,this}cross(t,e){return void 0!==e?(console.warn("THREE.Vector3: .cross() now only accepts one argument. Use .crossVectors( a, b ) instead."),this.crossVectors(t,e)):this.crossVectors(this,t)}crossVectors(t,e){const i=t.x,s=t.y,r=t.z,n=e.x,o=e.y,h=e.z;return this.eh(),this.nh=s*h-r*o,this.ah=r*n-i*h,this.oh=i*o-s*n,this}projectOnVector(t){const e=t.lengthSq();if(0===e)return this.set(0,0,0);const i=t.dot(this)/e;return this.copy(t).multiplyScalar(i)}projectOnPlane(t){return Ft.copy(this).projectOnVector(t),this.sub(Ft)}reflect(t){return this.sub(Ft.copy(t).multiplyScalar(2*this.dot(t)))}angleTo(t){const e=Math.sqrt(this.lengthSq()*t.lengthSq());if(0===e)return Math.PI/2;const i=this.dot(t)/e;return Math.acos(s(i,-1,1))}distanceTo(t){return Math.sqrt(this.distanceToSquared(t))}distanceToSquared(t){this.rh();const e=this.nh-t.x,i=this.ah-t.y,s=this.oh-t.z;return e*e+i*i+s*s}manhattanDistanceTo(t){return this.rh(),Math.abs(this.nh-t.x)+Math.abs(this.ah-t.y)+Math.abs(this.oh-t.z)}setFromSpherical(t){return this.setFromSphericalCoords(t.radius,t.phi,t.theta)}setFromSphericalCoords(t,e,i){const s=Math.sin(e)*t;return this.eh(),this.nh=s*Math.sin(i),this.ah=Math.cos(e)*t,this.oh=s*Math.cos(i),this}setFromCylindrical(t){return this.setFromCylindricalCoords(t.radius,t.theta,t.y)}setFromCylindricalCoords(t,e,i){return this.eh(),this.nh=t*Math.sin(e),this.ah=i,this.oh=t*Math.cos(e),this}setFromMatrixPosition(t){const e=t.elements;return this.eh(),this.nh=e[12],this.ah=e[13],this.oh=e[14],this}setFromMatrixScale(t){const e=this.setFromMatrixColumn(t,0).length(),i=this.setFromMatrixColumn(t,1).length(),s=this.setFromMatrixColumn(t,2).length();return this.eh(),this.nh=e,this.ah=i,this.oh=s,this}setFromMatrixColumn(t,e){return this.fromArray(t.elements,4*e)}setFromMatrix3Column(t,e){return this.fromArray(t.elements,3*e)}setFromEuler(t){return this.x=t._x,this.y=t._y,this.z=t._z,this}equals(t){return this.rh(),t.x===this.nh&&t.y===this.ah&&t.z===this.oh}fromArray(t,e=0){return this.nh===t[e]&&this.ah===t[e+1]&&this.oh===t[e+2]||(this.eh(),this.nh=t[e],this.ah=t[e+1],this.oh=t[e+2]),this}toArray(t=[],e=0){return this.rh(),t[e]=this.nh,t[e+1]=this.ah,t[e+2]=this.oh,t}fromBufferAttribute(t,e,i){return void 0!==i&&console.warn("THREE.Vector3: offset has been removed from .fromBufferAttribute()."),this.eh(),this.nh=t.getX(e),this.ah=t.getY(e),this.oh=t.getZ(e),this}random(){return this.eh(),this.nh=Math.random(),this.ah=Math.random(),this.oh=Math.random(),this}randomDirection(){const t=2*(Math.random()-.5),e=Math.random()*Math.PI*2,i=Math.sqrt(1-Math.pow(t,2));return this.eh(),this.nh=i*Math.cos(e),this.ah=i*Math.sin(e),this.oh=t,this}*[Symbol.iterator](){this.rh(),yield this.nh,this.rh(),yield this.ah,this.rh(),yield this.oh}lengthManhattan(){throw new Error("deprecated")}distanceToManhattan(t){throw new Error("deprecated")}}const Ft=new Rt,kt=new K;class Et{constructor(t,e,i){this.ts=!1,this.ss=!1,this.es=!1,this.rs=!1,this.hs=!1,this.ns=this.os.bind(this),this.ls=this.fs.bind(this),this.cs=this.us.bind(this),this.ds=this.ps.bind(this),this.vs=this.bs.bind(this),this.Ts=this._s.bind(this),this.Os=this.gs.bind(this),this.Rs=this.xs.bind(this),this.ws=!1,this.isRegisteredToProcessor=!1,this.D=e,this.Ws=i,this.Ms=new Et._transformObject3D,this.Ms.matrixAutoUpdate=!0,this.Ms.userData=this,e.scene.unsafeGetThreeScene().add(this.Ms),Object.defineProperties(this.Ms,{position:{writable:!0},rotation:{writable:!0},quaternion:{writable:!0},scale:{writable:!0}});const s=this.ns,r=this.ls,n=new Rt;n.onBeforeGetComponent(s),n.onBeforeChange(r),this.Ms.position=n;const o=new It;o.onBeforeGetComponent(s),o.onBeforeChange(r),o._onChange(this.cs),this.Ms.rotation=o;const h=new Tt;h.onBeforeGetComponent(s),h.onBeforeChange(r),h._onChange(this.ds),this.Ms.quaternion=h;const a=new Rt(1,1,1);a.onBeforeGetComponent(s),a.onBeforeChange(r),this.Ms.scale=a,this._t=t;const l=this.vs,m=this.Ts,c=new Rt;c.onBeforeGetComponent(l),c.onBeforeChange(m),this.Cs=c;const u=new It;u.onBeforeGetComponent(l),u.onBeforeChange(m),u._onChange(this.Os),this.ys=u;const _=new Tt;_.onBeforeGetComponent(l),_.onBeforeChange(m),_._onChange(this.Rs),this.Fs=_;const d=new Rt(1,1,1);d.onBeforeGetComponent(l),d.onBeforeChange(m),this.Vs=d,this.As()}os(){this.ws||this.Ls()}fs(){this.ws||(this.Ls(),this.Ps(),this.hs=!1,this.ss=!0,this.As(),this.Ss(),this.js())}us(){this.ws||this.Ms.quaternion.setFromEuler(this.Ms.rotation,!1)}ps(){this.ws||this.Ms.rotation.setFromQuaternion(this.Ms.quaternion,void 0,!1)}bs(){this.ws||this.Ds()}_s(){this.ws||(this.Ds(),this.Ps(),this.rs=!1,this.hs=!0,this.ss=!0,this.As(),this.Es(),this.js())}gs(){this.ws||this.Fs.setFromEuler(this.ys,!1)}xs(){this.ws||this.ys.setFromQuaternion(this.Fs,void 0,!1)}Ss(){this.rs=!0;const t=this.Ms.children;for(let e=0,i=t.length;e<i;e++){const i=t[e];i.userData instanceof Et&&i.userData.Ss()}}Es(){const t=this.Ms.children;for(let e=0,i=t.length;e<i;e++){const i=t[e];i.userData instanceof Et&&i.userData.Ss()}}As(){this.D.transformMatrixProcessor.enqueueTransformToUpdate(this),this.Us()}Us(){this.es=!0;const t=this.Ms.children;for(let e=0,i=t.length;e<i;e++){const i=t[e];i.userData instanceof Et&&i.userData.Us()}}js(){this.ts=!0;const t=this.Ms.children;for(let e=0,i=t.length;e<i;e++){const i=t[e];i.userData instanceof Et&&i.userData.js()}}Ls(){if(this.hs){if(this.ss){this.es&&(this.ws=!0,this.Ms.matrixWorld.compose(this.Cs,this.Fs,this.Vs),this.ws=!1,this.es=!1,this._t.gameObjectEventContainer.invokeOnWorldMatrixUpdated());const t=this.parent;if(t){t.Qs();const e=Et._matrix4Buffer.copy(t.Ms.matrixWorld).invert();this.Ms.matrix.multiplyMatrices(this.Ms.matrixWorld,e)}else this.Ms.matrix.copy(this.Ms.matrixWorld);this.ss=!1}this.ws=!0,this.Ms.matrix.decompose(this.localPosition,this.localRotation,this.localScale),this.localEulerAngles.setFromQuaternion(this.localRotation,void 0,!1),this.ws=!1,this.hs=!1}}Ds(){this.rs&&(this.Qs(),this.ws=!0,this.Ms.matrixWorld.decompose(this.Cs,this.Fs,this.Vs),this.ys.setFromQuaternion(this.Fs,void 0,!1),this.ws=!1,this.rs=!1)}Qs(){if(!this.es)return;const t=this.Ms.matrix;if(this.ss)if(this.hs)this.ws=!0,this.Ms.matrixWorld.compose(this.Cs,this.Fs,this.Vs),this.ws=!1;else{this.ss&&(this.ws=!0,t.compose(this.localPosition,this.localRotation,this.localScale),this.ws=!1,this.ss=!1);const e=this.parent;e?(e.Qs(),this.Ms.matrixWorld.multiplyMatrices(e.Ms.matrixWorld,t)):this.Ms.matrixWorld.copy(t)}else{const e=this.parent;e?(e.Qs(),this.Ms.matrixWorld.multiplyMatrices(e.Ms.matrixWorld,t)):this.Ms.matrixWorld.copy(t)}this.es=!1,this._t.gameObjectEventContainer.invokeOnWorldMatrixUpdated()}Ns(){if(!this.ss)return;const t=this.Ms.matrix;if(this.es)if(this.rs)this.ws=!0,t.compose(this.localPosition,this.localRotation,this.localScale),this.ws=!1;else{this.es&&(this.ws=!0,this.Ms.matrixWorld.compose(this.Cs,this.Fs,this.Vs),this.ws=!1,this.es=!1,this._t.gameObjectEventContainer.invokeOnWorldMatrixUpdated());const t=this.parent;if(t){t.Qs();const e=Et._matrix4Buffer.copy(t.Ms.matrixWorld).invert();this.Ms.matrix.multiplyMatrices(this.Ms.matrixWorld,e)}else this.Ms.matrix.copy(this.Ms.matrixWorld)}else{const t=this.parent;if(t){t.Qs();const e=Et._matrix4Buffer.copy(t.Ms.matrixWorld).invert();this.Ms.matrix.multiplyMatrices(this.Ms.matrixWorld,e)}else this.Ms.matrix.copy(this.Ms.matrixWorld)}this.ss=!1}Bs(){this.Ls();const t=this.Ms.children;for(let e=0,i=t.length;e<i;e++){const i=t[e];i.userData instanceof Et&&i.userData.Bs()}}Ps(){const t=this.Ms.children;for(let e=0,i=t.length;e<i;e++){const i=t[e];i.userData instanceof Et&&(i.userData.Ls(),i.userData.Ps())}}tryUpdateWorldMatrixRecursivelyFromThisToChildren(){return!!this._t.exists&&this.qs()}qs(){this.Qs();const t=this.Ms.children;for(let e=0,i=t.length;e<i;e++){const i=t[e];i.userData instanceof Et&&i.userData.qs()}return!0}foreachChild(t){const e=this.Ms.children;for(let i=0,s=e.length;i<s;i++){const s=e[i];s.userData instanceof Et&&t(s.userData)}}iterateChild(t){const e=this.Ms.children;for(let i=0,s=e.length;i<s;i++){const s=e[i];if(s.userData instanceof Et&&!t(s.userData))break}}get parent(){return this.Ms.parent instanceof Dt?null:this.Ms.parent.userData}set parent(t){this.setParent(t)}setParent(t,e=!0){if(t){const i=this.parent;this.Bs(),this.As(),this.Ss(),e&&t.getWorldToLocalMatrix(this.Ms.matrix).multiply(this.Ms.matrixWorld),this.Ms.removeFromParent(),t.Ms.add(this.Ms),this.Ws(i,t)}else{const t=this.parent;this.Bs(),this.As(),this.Ss(),e&&this.Ms.matrix.copy(this.Ms.matrixWorld),this.Ms.removeFromParent(),this.D.scene.unsafeGetThreeScene().add(this.Ms),this.Ws(t,null)}}get children(){return this.Ms.children.filter((t=>t.userData instanceof Et)).map((t=>t.userData))}get gameObject(){return this._t}getForward(t){this.Qs();const e=this.Ms.matrixWorld.elements;return t?t.set(e[8],e[9],e[10]):new $(e[8],e[9],e[10])}setForward(t){this.D.transformMatrixProcessor.enqueueTransformToUpdate(this),this.Qs(),this.Ps(),this.ss=!0,this.hs=!0,this.Es(),this.Ss(),this.rs=!0;const e=this.Ms.matrixWorld.elements,i=Et._vector3Buffer.copy(t).normalize();e[8]=i.x,e[9]=i.y,e[10]=i.z}getRight(t){this.Qs();const e=this.Ms.matrixWorld.elements;return t?t.set(e[0],e[1],e[2]):new $(e[0],e[1],e[2])}setRight(t){this.D.transformMatrixProcessor.enqueueTransformToUpdate(this),this.Qs(),this.Ps(),this.ss=!0,this.hs=!0,this.Es(),this.Ss(),this.rs=!0;const e=this.Ms.matrixWorld.elements,i=Et._vector3Buffer.copy(t).normalize();e[0]=i.x,e[1]=i.y,e[2]=i.z}getUp(t){this.Qs();const e=this.Ms.matrixWorld.elements;return t?t.set(e[4],e[5],e[6]):new $(e[4],e[5],e[6])}setUp(t){this.D.transformMatrixProcessor.enqueueTransformToUpdate(this),this.Qs(),this.Ps(),this.ss=!0,this.hs=!0,this.Es(),this.Ss(),this.rs=!0;const e=this.Ms.matrixWorld.elements,i=Et._vector3Buffer.copy(t).normalize();e[4]=i.x,e[5]=i.y,e[6]=i.z}get localPosition(){return this.Ms.position}get localEulerAngles(){return this.Ms.rotation}get localRotation(){return this.Ms.quaternion}get localScale(){return this.Ms.scale}get position(){return this.Cs}get eulerAngles(){return this.ys}get rotation(){return this.Fs}get lossyScale(){return this.Vs}get hasChanged(){return this.ts}set hasChanged(t){this.ts=t}getWorldToLocalMatrix(t){return this.Qs(),t?t.copy(this.Ms.matrixWorld).invert():this.Ms.matrixWorld.clone().invert()}getLocalToWorldMatrix(t){return this.Qs(),t?t.copy(this.Ms.matrixWorld):this.Ms.matrixWorld.clone()}transformPoint(t){return this.Qs(),this.Ms.localToWorld(t)}inverseTransformPoint(t){return this.Qs(),this.Ms.worldToLocal(t)}transformDirection(t){const e=Et._matrix4Buffer.copy(this.Ms.matrixWorld).makeScale(1,1,1);return t.transformDirection(e)}inverseTransformDirection(t){const e=Et._matrix4Buffer.copy(this.Ms.matrixWorld).makeScale(1,1,1).invert();return t.transformDirection(e)}transformVector(t){return t.transformDirection(this.Ms.matrixWorld)}inverseTransformVector(t){return t.transformDirection(Et._matrix4Buffer.copy(this.Ms.matrixWorld).invert())}isChildOf(t){if(this===t)return!0;const e=this.parent;return!!e&&e.isChildOf(t)}lookAt(t){const e=this.parent;Et._vector3Buffer.setFromMatrixPosition(this.Ms.matrixWorld);const i=Et._matrix4Buffer.lookAt(Et._vector3Buffer,t,this.Ms.up);if(this.Ms.quaternion.setFromRotationMatrix(i),e){i.extractRotation(e.Ms.matrixWorld);const t=Et._quaternionBuffer.setFromRotationMatrix(i);this.Ms.quaternion.premultiply(t.invert())}}setRotationFromAxisAngle(t,e){this.Ms.setRotationFromAxisAngle(t,e)}setRotationFromEuler(t){this.Ms.setRotationFromEuler(t)}setRotationFromMatrix(t){this.Ms.setRotationFromMatrix(t)}setRotationFromQuaternion(t){this.Ms.setRotationFromQuaternion(t)}rotateOnAxis(t,e){return this.Ms.rotateOnAxis(t,e),this}rotateOnWorldAxis(t,e){return this.Ms.rotateOnWorldAxis(t,e),this}rotateX(t){return this.Ms.rotateX(t),this}rotateY(t){return this.Ms.rotateY(t),this}rotateZ(t){return this.Ms.rotateZ(t),this}translateOnAxis(t,e){return this.Ms.translateOnAxis(t,e),this}translateX(t){return this.Ms.translateX(t),this}translateY(t){return this.Ms.translateY(t),this}translateZ(t){return this.Ms.translateZ(t),this}unsafeGetObject3D(){return this.Ms}enqueueRenderAttachedObject3D(t){this.D.transformMatrixProcessor.enqueueRenderObject(t)}dequeueRenderAttachedObject3D(t){this.D.transformMatrixProcessor.dequeueRenderObject(t)}static updateRawObject3DWorldMatrixRecursively(t){t.matrixAutoUpdate&&t.updateMatrix(),t.parent?t.matrixWorld.multiplyMatrices(t.parent.matrixWorld,t.matrix):t.matrixWorld.copy(t.matrix);const e=t.children;for(let t=0,i=e.length;t<i;t++)Et.updateRawObject3DWorldMatrixRecursivelyInternal(e[t])}static updateRawObject3DWorldMatrixRecursivelyInternal(t){t.matrixAutoUpdate&&t.updateMatrix(),t.matrixWorld.multiplyMatrices(t.parent.matrixWorld,t.matrix);const e=t.children;for(let t=0,i=e.length;t<i;t++)Et.updateRawObject3DWorldMatrixRecursivelyInternal(e[t])}toJSON(){return{}}}Et._transformObject3D=class extends Mt{updateMatrix(){this.userData.Ns()}updateMatrixWorld(t){this.userData.Qs()}updateWorldMatrix(t,e){if(this.userData.Qs(),e){const t=this.children;for(let e=0,i=t.length;e<i;e++)t[e].updateWorldMatrix(!1,!0)}}},Et._matrix4Buffer=new it,Et._vector3Buffer=new $,Et._quaternionBuffer=new K;class Lt{constructor(t,e){this.$t=!1,this.D=t,this.yt=t.instantiater.generateId(),this.Nt=!0,this.Qt=!0,this._initialized=!1,this.components=[],this.gameObjectEventContainer=new Q,this.Vt=new Et(this,t,this.Xt.bind(this)),this.Vt.unsafeGetObject3D().name=e}addChildFromBuilder(t){this.Zt();const e=t.build(this.transform);return t.processEvent(),e}Xt(t,e){if(e&&this.D!==e.gameObject.D)throw new Error("can't change parent to another engine instance");const i=this.transform.gameObject;e?i.Qt&&i.te(e.gameObject.Nt):i.te(i.Qt)}addComponent(t){this.Zt();const e=new t(this);if(e.engine_internal_constructAfterProcess(),e.disallowMultipleComponent&&this.getComponent(t))return console.warn(`Component ${t.name} already exists on GameObject ${this.name}`),null;const i=e.requiredComponents;for(let e=0;e<i.length;e++){const s=i[e];if(!this.getComponent(s))return console.warn(`Component ${s.name} is required by Component ${t.name} on GameObject ${this.name}`),null}return this.components.push(e),this.gameObjectEventContainer.registerComponent(e),this.Nt&&e.enabled&&(e._engine_internal_componentEventContainer.tryCallAwake(),e._engine_internal_componentEventContainer.tryRegisterOnEnable(),e._engine_internal_componentEventContainer.tryRegisterStart(),e._engine_internal_componentEventContainer.tryRegisterUpdate(),this.D.sceneProcessor.tryStartProcessSyncedEvent()),e}getComponent(t){this.Zt();const e=this.components;for(let i=0;i<e.length;i++){const s=e[i];if(s instanceof t)return s}return null}getComponents(t){if(this.Zt(),!t)return this.components.slice();const e=this.components,i=[];for(let s=0;s<e.length;s++){const r=e[s];r instanceof t&&i.push(r)}return i}getComponentInChildren(t){this.Zt();const e=this.getComponent(t);if(e)return e;let i=null;return this.Vt.iterateChild((e=>{const s=e.gameObject.getComponentInChildren(t);return!s||(i=s,!1)})),i}getComponentsInChildren(t){if(this.Zt(),t){const e=this.getComponents(t);return this.Vt.foreachChild((i=>{const s=i.gameObject.getComponentsInChildren(t);e.push(...s)})),e}{const t=this.getComponents();return this.Vt.foreachChild((e=>{t.push(...e.gameObject.getComponentsInChildren())})),t}}foreachComponent(t,e){this.Zt();const i=this.components;if(e)for(let s=0;s<i.length;s++){const r=i[s];r instanceof e&&t(r)}else for(let e=0;e<i.length;e++)t(i[e])}foreachComponentInChildren(t,e){this.Zt(),e?(this.foreachComponent(t,e),this.Vt.foreachChild((i=>{i.gameObject.foreachComponentInChildren(t,e)}))):(this.foreachComponent(t),this.Vt.foreachChild((e=>{e.gameObject.foreachComponentInChildren(t)})))}destroy(){Lt.destroyRecursively(this),this.D.sceneProcessor.tryStartProcessSyncedEvent(),this.D.sceneProcessor.addRemoveGameObject(this)}static destroyRecursively(t){t.$t||(t.$t=!0,t.ie(),t.Vt.children.forEach((t=>{t instanceof Et&&Lt.destroyRecursively(t.gameObject)})))}ie(){const t=this.components;for(let e=0;e<t.length;e++){const i=t[e];i._engine_internal_destroyed||(i.enabled&&this.Nt&&(i._engine_internal_componentEventContainer.tryRegisterOnDisable(),i._engine_internal_componentEventContainer.tryUnregisterStart(),i._engine_internal_componentEventContainer.tryUnregisterUpdate()),i.stopAllCoroutines(),i._engine_internal_componentEventContainer.tryRegisterOnDestroy(),i._engine_internal_destroyed=!0)}}removeFromParent(){this.Vt.unsafeGetObject3D().removeFromParent()}removeComponent(t){const e=this.components.indexOf(t);e>=0&&this.components.splice(e,1),this.gameObjectEventContainer.unregisterComponent(t)}get engine(){return this.D}get activeInHierarchy(){return this.Nt}set activeInHierarchy(t){if(this.Nt!==t){if(this.Nt=t,this._initialized){const t=this.components;if(this.Nt)for(let e=0;e<t.length;e++){const i=t[e];i.enabled&&(i._engine_internal_componentEventContainer.tryCallAwake(),i._engine_internal_componentEventContainer.tryRegisterOnEnable(),i._engine_internal_componentEventContainer.tryRegisterStart(),i._engine_internal_componentEventContainer.tryRegisterUpdate())}else for(let e=0;e<t.length;e++){const i=t[e];i.enabled&&(i._engine_internal_componentEventContainer.tryRegisterOnDisable(),i._engine_internal_componentEventContainer.tryUnregisterUpdate(),i.stopAllCoroutines())}}this.Vt.foreachChild((t=>{const e=t.gameObject;this.Nt?e.activeInHierarchy=e.Qt:e.activeInHierarchy=!1}))}}te(t){this.Nt!==t&&(this.activeInHierarchy=t,this._initialized&&this.D.sceneProcessor.tryStartProcessSyncedEvent())}get activeSelf(){return this.Qt}set activeSelf(t){this.Zt(),this.Qt!==t&&(this.Qt=t,this.Vt.parent instanceof Et?this.Vt.parent.gameObject.Nt?this.te(this.Qt):this.te(!1):this.te(this.Qt))}get transform(){return this.Vt}get name(){return this.Vt.unsafeGetObject3D().name}set name(t){this.Zt(),this.Vt.unsafeGetObject3D().name=t}get instanceId(){return this.yt}get initialized(){return this._initialized}get exists(){return!this.$t}Zt(){if(this.$t)throw new Error("GameObject "+this.name+" is destroyed")}}class Ot{constructor(t,e,i,s,r){this.se=!1,this._t=new Lt(t,e);const n=this._t.transform;i&&n.localPosition.copy(i),s&&n.localRotation.copy(s),r&&n.localScale.copy(r),this.X=[],this.ne=[]}active(t){return this._t.activeSelf=t,this}getGameObject(t){return t.ref=this._t,this}getComponent(t,e){return e.ref=this._t.getComponent(t),this}getComponents(t,e){return t.ref=e?this._t.getComponents(e):this._t.getComponents(),this}getComponentInChildren(t,e){return e.ref=this._t.getComponentInChildren(t),this}getComponentsInChildren(t,e){return t.ref=e?this._t.getComponentsInChildren(e):this._t.getComponentsInChildren(),this}withComponent(t,e){const i=new t(this._t);return i.engine_internal_constructAfterProcess(),i.disallowMultipleComponent&&this._t.getComponent(t)?(console.warn(`Component ${t.name} already exists on GameObject ${this._t.name}`),this):(this._t.components.push(i),this._t.gameObjectEventContainer.registerComponent(i),e&&this.ne.push((()=>e(i))),this)}withChild(t){return this.X.push(t),this}oe(t){let e=!1;const i=t.components;for(let s=0;s<i.length;s++){const r=i[s],n=r.requiredComponents;for(let i=0;i<n.length;i++){const s=n[i];t.getComponent(s)||(console.warn(`Component ${s.name} is required by Component ${r.constructor.name} on GameObject ${t.name}`),t.removeComponent(r),e=!0)}}e&&this.oe(t)}build(t){if(this.se)throw new Error("GameObjectBuilder is already built");return this.se=!0,this.re(t),this.he(),this.ce(),this._t}re(t){this._t.transform.setParent(t,!1);const e=this.X;for(let t=0;t<e.length;t++)e[t].re(this._t.transform)}he(){this.oe(this._t);const t=this.X;for(let e=0;e<t.length;e++)t[e].he()}ce(){const t=this.ne;for(let e=0;e<t.length;e++)t[e]();const e=this.X;for(let t=0;t<e.length;t++)e[t].ce();this._t._initialized=!0}processEvent(){Ot.processEventByGroup([this],this._t.engine.sceneProcessor)}static processEventByGroup(t,e){const i=[];for(let e=0;e<t.length;e++)i.push(...t[e]._t.getComponentsInChildren());for(let t=0;t<i.length;t++){const e=i[t];e.gameObject.activeInHierarchy&&e.enabled&&e._engine_internal_componentEventContainer.tryCallAwake()}for(let t=0;t<i.length;t++){const e=i[t];e._engine_internal_destroyed||e.gameObject.activeInHierarchy&&e.enabled&&(e._engine_internal_componentEventContainer.tryRegisterOnEnable(),e._engine_internal_componentEventContainer.tryRegisterStart(),e._engine_internal_componentEventContainer.tryRegisterUpdate())}e.tryStartProcessSyncedEvent()}}class zt{constructor(t){this.B=0,this._=0,this.D=t}generateId(){const t=this.B;return this.B+=1,t}generateEventId(){const t=this._;return this._+=1,t}buildGameObject(t,e,i,s){return new Ot(this.D,t,e,i,s)}buildPrefab(t,e,i,s,r){return new e(this.D,t,i,s,r)}}class jt{constructor(t,e,i,s,r,n,o,h,a,l){this.t=t,this.i=e,this.h=i,this.o=s,this.u=r,this.g=n,this.p=o,this.m=h,this.l=a,this.I=l,this.P=new V(l),this.H=new zt(this)}applyGameSetting(t){this.l.applyPhysicsSettings(t.physics)}dispose(){this.P.dispose()}get scene(){return this.t}get cameraContainer(){return this.i}get screen(){return this.u}get input(){return this.P}get time(){return this.h}get physics(){return this.l}get gameState(){return this.o}get instantiater(){return this.H}get domElement(){return this.I}get sceneProcessor(){return this.g}get coroutineProcessor(){return this.p}get transformMatrixProcessor(){return this.m}get physics2DProcessor(){return this.l}}class qt{constructor(t){this.k=t}get kind(){return this.k}set kind(t){this.k=t}}var Nt,Wt;(Wt=Nt||(Nt={}))[Wt.WaitingForStart=0]="WaitingForStart",Wt[Wt.Initializing=1]="Initializing",Wt[Wt.Running=2]="Running",Wt[Wt.Stopped=3]="Stopped",Wt[Wt.Finalizing=4]="Finalizing",Wt[Wt.Finalized=5]="Finalized";class Xt{constructor(){this.fe=new Dt,this.fe.matrixAutoUpdate=!1,this.fe.autoUpdate=!1}addChildFromBuilder(t){const e=t.build(null);return t.processEvent(),e}foreachChild(t){const e=this.fe.children;for(let i=0,s=e.length;i<s;i++){const s=e[i];s.userData instanceof Et&&t(s.userData)}}iterateChild(t){const e=this.fe.children;for(let i=0,s=e.length;i<s;i++){const s=e[i];if(s.userData instanceof Et&&!t(s.userData))break}}get children(){return this.fe.children.filter((t=>t.userData instanceof Et)).map((t=>t.userData))}unsafeGetThreeScene(){return this.fe}}class Ut{constructor(t=0,e=0){Ut.prototype.isVector2=!0,this.x=t,this.y=e}get width(){return this.x}set width(t){this.x=t}get height(){return this.y}set height(t){this.y=t}set(t,e){return this.x=t,this.y=e,this}setScalar(t){return this.x=t,this.y=t,this}setX(t){return this.x=t,this}setY(t){return this.y=t,this}setComponent(t,e){switch(t){case 0:this.x=e;break;case 1:this.y=e;break;default:throw new Error("index is out of range: "+t)}return this}getComponent(t){switch(t){case 0:return this.x;case 1:return this.y;default:throw new Error("index is out of range: "+t)}}clone(){return new this.constructor(this.x,this.y)}copy(t){return this.x=t.x,this.y=t.y,this}add(t,e){return void 0!==e?(console.warn("THREE.Vector2: .add() now only accepts one argument. Use .addVectors( a, b ) instead."),this.addVectors(t,e)):(this.x+=t.x,this.y+=t.y,this)}addScalar(t){return this.x+=t,this.y+=t,this}addVectors(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this}addScaledVector(t,e){return this.x+=t.x*e,this.y+=t.y*e,this}sub(t,e){return void 0!==e?(console.warn("THREE.Vector2: .sub() now only accepts one argument. Use .subVectors( a, b ) instead."),this.subVectors(t,e)):(this.x-=t.x,this.y-=t.y,this)}subScalar(t){return this.x-=t,this.y-=t,this}subVectors(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this}multiply(t){return this.x*=t.x,this.y*=t.y,this}multiplyScalar(t){return this.x*=t,this.y*=t,this}divide(t){return this.x/=t.x,this.y/=t.y,this}divideScalar(t){return this.multiplyScalar(1/t)}applyMatrix3(t){const e=this.x,i=this.y,s=t.elements;return this.x=s[0]*e+s[3]*i+s[6],this.y=s[1]*e+s[4]*i+s[7],this}min(t){return this.x=Math.min(this.x,t.x),this.y=Math.min(this.y,t.y),this}max(t){return this.x=Math.max(this.x,t.x),this.y=Math.max(this.y,t.y),this}clamp(t,e){return this.x=Math.max(t.x,Math.min(e.x,this.x)),this.y=Math.max(t.y,Math.min(e.y,this.y)),this}clampScalar(t,e){return this.x=Math.max(t,Math.min(e,this.x)),this.y=Math.max(t,Math.min(e,this.y)),this}clampLength(t,e){const i=this.length();return this.divideScalar(i||1).multiplyScalar(Math.max(t,Math.min(e,i)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}roundToZero(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this}negate(){return this.x=-this.x,this.y=-this.y,this}dot(t){return this.x*t.x+this.y*t.y}cross(t){return this.x*t.y-this.y*t.x}lengthSq(){return this.x*this.x+this.y*this.y}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)}normalize(){return this.divideScalar(this.length()||1)}angle(){return Math.atan2(-this.y,-this.x)+Math.PI}distanceTo(t){return Math.sqrt(this.distanceToSquared(t))}distanceToSquared(t){const e=this.x-t.x,i=this.y-t.y;return e*e+i*i}manhattanDistanceTo(t){return Math.abs(this.x-t.x)+Math.abs(this.y-t.y)}setLength(t){return this.normalize().multiplyScalar(t)}lerp(t,e){return this.x+=(t.x-this.x)*e,this.y+=(t.y-this.y)*e,this}lerpVectors(t,e,i){return this.x=t.x+(e.x-t.x)*i,this.y=t.y+(e.y-t.y)*i,this}equals(t){return t.x===this.x&&t.y===this.y}fromArray(t,e=0){return this.x=t[e],this.y=t[e+1],this}toArray(t=[],e=0){return t[e]=this.x,t[e+1]=this.y,t}fromBufferAttribute(t,e,i){return void 0!==i&&console.warn("THREE.Vector2: offset has been removed from .fromBufferAttribute()."),this.x=t.getX(e),this.y=t.getY(e),this}rotateAround(t,e){const i=Math.cos(e),s=Math.sin(e),r=this.x-t.x,n=this.y-t.y;return this.x=r*i-n*s+t.x,this.y=r*s+n*i+t.y,this}random(){return this.x=Math.random(),this.y=Math.random(),this}*[Symbol.iterator](){yield this.x,yield this.y}}class Jt{constructor(){this.wi=null,this.yi=8,this.Pi=3,this.mi=!0,this.Ei=null,this.pi=null,this.Si=new Map,this.Ti=null,this.Ii=null,this.reuseCollisionCallbacks=!0,this.xi=null,this.Ni=null}applyPhysicsSettings(t){var e;if(!t.loader)return;this.Ti=t.loader,this.pi=new this.Ti.World(new this.Ti.Vec2(0,-9.81));const i=class extends this.Ti.ContactListener{constructor(t){super(),this.Bi=t,this.Oi=new this.Bi.Ti.Collision2DPool,this.Li=new this.Bi.Ti.TriggerEventPool,this.Mi=new this.Bi.Ti.CollisionEventPool}BeginContact(t){const e=t.GetFixtureA().GetUserData(),i=t.GetFixtureB().GetUserData();if(e.isTrigger||i.isTrigger)this.Li.insert(0,e,i);else if(this.Bi.reuseCollisionCallbacks){const s=this.Oi.getInstance();s.setData(t),this.Mi.insert(0,e,i,s,this.Oi)}else{const s=new this.Bi.Ti.Collision2D;s.setData(t),this.Mi.insert(0,e,i,s)}}EndContact(t){const e=t.GetFixtureA().GetUserData(),i=t.GetFixtureB().GetUserData();if(e.isTrigger||i.isTrigger)this.Li.insert(2,e,i);else if(this.Bi.reuseCollisionCallbacks){const s=this.Oi.getInstance();s.setData(t),this.Mi.insert(2,e,i,s,this.Oi)}else{const s=new this.Bi.Ti.Collision2D;s.setData(t),this.Mi.insert(2,e,i,s)}}PreSolve(t,e){const i=t.GetFixtureA().GetUserData(),s=t.GetFixtureB().GetUserData();if(i.isTrigger||s.isTrigger)this.Li.insert(1,i,s);else if(this.Bi.reuseCollisionCallbacks){const e=this.Oi.getInstance();e.setData(t),this.Mi.insert(1,i,s,e,this.Oi)}else{const e=new this.Bi.Ti.Collision2D;e.setData(t),this.Mi.insert(1,i,s,e)}}onTriggerInvoke(){this.Li.invoke()}onCollisionInvoke(){this.Mi.invoke()}},s=new i(this);this.Ii=s,this.pi.SetContactListener(s),t.gravity&&(null===(e=this.pi)||void 0===e||e.SetGravity(t.gravity)),t.defaultMaterial&&(this.wi=t.defaultMaterial.clone()),t.velocityIterations&&(this.yi=t.velocityIterations),t.positionIterations&&(this.Pi=t.positionIterations),t.queriesHitTriggers&&(this.mi=t.queriesHitTriggers),t.reuseCollisionCallbacks&&(this.reuseCollisionCallbacks=t.reuseCollisionCallbacks),t.collisionLayerMaskMatrix?this.Ei=new this.Ti.CollisionLayerMaskConverter(t.collisionLayerMaskMatrix):this.Ei=new this.Ti.CollisionLayerMaskConverter({default:{default:!0}}),this.xi=new this.Ti.RayCastOneCallback(this),this.Ni=new this.Ti.RayCastFilterCallback}update(t){if(this.pi){{let t=this.pi.GetBodyList();for(;t;){const e=t;t=t.GetNext();const i=e.GetUserData().gameObject.transform,s=i.position,r=i.eulerAngles,n=e.GetPosition(),o=e.GetAngle();s.x===n.x&&s.y===n.y||(e.SetPosition(s),e.SetAwake(!0)),r.z!==o&&(e.SetAngle(r.z),e.SetAwake(!0))}}this.pi.Step(t,this.yi,this.Pi);{let t=this.pi.GetBodyList();for(;t;){const e=t;t=t.GetNext();const i=e.GetUserData().gameObject.transform;i.position.x=e.GetPosition().x,i.position.y=e.GetPosition().y,i.eulerAngles.z=e.GetAngle()}}this.Ii.onTriggerInvoke(),this.Ii.onCollisionInvoke()}}addRigidBody(t,e,i){if(!this.pi)throw new Error("Physics2D is not loaded.");let s=this.Si.get(t);if(s){const t=s.addRigidBody(e),r=t.body;return r.SetType(i.type),r.SetPosition(i.position),r.SetAngle(i.angle),r.SetLinearVelocity(i.linearVelocity),r.SetAngularVelocity(i.angularVelocity),r.SetLinearDamping(i.linearDamping),r.SetAngularDamping(i.angularDamping),r.SetSleepingAllowed(i.allowSleep),r.SetAwake(i.awake),r.SetFixedRotation(i.fixedRotation),r.SetBullet(i.bullet),r.SetEnabled(i.enabled),r.SetUserData(i.userData),r.SetGravityScale(i.gravityScale),t}return s=new this.Ti.PhysicsObject2D(t,this.pi.CreateBody(i),(()=>this.Si.delete(t))),this.Si.set(t,s),s.addRigidBody(e)}removeRigidBody(t){const e=this.Si.get(t);if(!e)throw new Error("PhysicsObject2D not found");e.removeRigidBody()}Ri(t){const e=new this.Ti.BodyDef;return e.type=this.Ti.BodyType.b2_kinematicBody,e.position.x=t.transform.position.x,e.position.y=t.transform.position.y,e.angle=t.transform.eulerAngles.z,e}addCollider(t,e){if(!this.pi)throw new Error("Physics2D is not loaded.");let i=this.Si.get(t);return i||(i=new this.Ti.PhysicsObject2D(t,this.pi.CreateBody(this.Ri(t)),(()=>this.Si.delete(t)))),this.Si.set(t,i),i.addCollider(e)}removeCollider(t,e,i){const s=this.Si.get(t);if(!s)throw new Error("PhysicsObject2D not found");s.removeCollider(e,i)}get physicsLoader(){return this.Ti}get gravity(){if(!this.pi)throw new Error("Physics2D is not loaded.");const t=this.pi.GetGravity();return new Ut(t.x,t.y)}set gravity(t){if(!this.pi)throw new Error("Physics2D is not loaded.");this.pi.SetGravity(new this.Ti.Vec2(t.x,t.y))}get defaultMaterial(){return this.wi}get velocityIterations(){return this.yi}set velocityIterations(t){this.yi=t}get positionIterations(){return this.Pi}set positionIterations(t){this.Pi=t}get maxLinearCorrection(){if(!this.Ti)throw new Error("Physics2D is not loaded.");return this.Ti.maxLinearCorrection}get maxAngularCorrection(){if(!this.Ti)throw new Error("Physics2D is not loaded.");return this.Ti.maxAngularCorrection}get maxTranslationSpeed(){if(!this.Ti)throw new Error("Physics2D is not loaded.");return this.Ti.maxTranslation}get maxRotationSpeed(){if(!this.Ti)throw new Error("Physics2D is not loaded.");return this.Ti.maxRotation}get baumgarteScale(){if(!this.Ti)throw new Error("Physics2D is not loaded.");return this.Ti.baumgarte}get baumgarteTimeOfImpactScale(){if(!this.Ti)throw new Error("Physics2D is not loaded.");return this.Ti.toiBaumgarte}get timeToSleep(){if(!this.Ti)throw new Error("Physics2D is not loaded.");return this.Ti.timeToSleep}get linearSleepTolerance(){if(!this.Ti)throw new Error("Physics2D is not loaded.");return this.Ti.linearSleepTolerance}get angularSleepTolerance(){if(!this.Ti)throw new Error("Physics2D is not loaded.");return this.Ti.angularSleepTolerance}get queriesHitTriggers(){return this.mi}set queriesHitTriggers(t){this.mi=t}get collisionLayerMask(){return this.Ei}raycastOne(t,e,i,s=Number.POSITIVE_INFINITY,r=4294967295,n=Number.NEGATIVE_INFINITY,o=Number.POSITIVE_INFINITY){if(!this.pi)throw new Error("Physics2D is not loaded.");i||(i=new this.Ti.RaycastHit2D);const h=Jt._raycastEndPoint.copy(e).multiplyScalar(s===Number.POSITIVE_INFINITY?1e7:s).add(t);return this.xi.setRaycastData(i,t,r,n,o),this.pi.RayCast(this.xi,t,h),this.xi.hit?i:null}raycast(t,e,i,s,r=Number.POSITIVE_INFINITY){if(!this.pi)throw new Error("Physics2D is not loaded.");const n=Jt._raycastEndPoint.copy(e).multiplyScalar(r===Number.POSITIVE_INFINITY?1e7:r).add(t);return this.Ni.setRaycastData(s,t,i),this.pi.RayCast(this.Ni,t,n),this.Ni.hitCount}}Jt._raycastEndPoint=new Ut;class Zt{constructor(t){this.nr=null,this.ar=new Map,this.ur=new J(void 0,((t,e)=>t.info.priority===e.info.priority?t.camera.instanceId-e.camera.instanceId:t.info.priority-e.info.priority)),this.dr=t}get camera(){var t,e;return null!==(e=null===(t=this.nr)||void 0===t?void 0:t.camera)&&void 0!==e?e:null}get currentCameraPriority(){var t,e;return null!==(e=null===(t=this.nr)||void 0===t?void 0:t.info.priority)&&void 0!==e?e:Number.MIN_SAFE_INTEGER}addCamera(t,e){this.ar.set(t,e),this.ur.insert({camera:t,info:e}),this.lr()}removeCamera(t){const e=this.ar.get(t);e&&(this.ur.eraseElementByKey({camera:t,info:e}),this.ar.delete(t),this.lr())}changeCameraPriority(t,e){const i=this.ar.get(t);i&&(this.ur.eraseElementByKey({camera:t,info:i}),i.priority=e,this.ur.insert({camera:t,info:i}),this.lr())}changeCameraBackgroundColor(t,e){var i;const s=this.ar.get(t);s&&(s.backgroundColor=e,(null===(i=this.nr)||void 0===i?void 0:i.camera)===t&&this.dr(e))}lr(){if(0===this.ur.size())return void(this.nr=null);const t=this.ur.front();t?(this.nr=t,this.dr(this.nr.info.backgroundColor)):this.nr=null}}class Ht{constructor(t,e){this._e=t,this.ze=e,this.Ne=new A}get width(){return this._e}get height(){return this.ze}get onResize(){return this.Ne}resize(t,e){this._e=t,this.ze=e,this.Ne.invoke(t,e)}}const Yt=new $,Qt=new K,Kt=new $,$t=new it,te=new it;class ee{constructor(){this._e=0,this.ze=0,this.Te=0,this.We=0,this.Ze={camera:{fov:0,style:""}};const t=document.createElement("div");t.style.overflow="hidden",this.domElement=t,this.Ae=document.createElement("div"),this.Ae.style.transformStyle="preserve-3d",this.Ae.style.pointerEvents="none",this.domElement.appendChild(this.Ae)}getSize(){return{width:this._e,height:this.ze}}render(t,e,i){const s=i.projectionMatrix.elements[5]*this.We;let r,n;this.Ze.camera.fov!==s&&(this.domElement.style.perspective=i.isPerspectiveCamera?s+"px":"",this.Ze.camera.fov=s),!0===e.autoUpdate&&e.updateMatrixWorld(),null===i.parent&&i.updateMatrixWorld(),i.isOrthographicCamera?(r=-(i.right+i.left)/2,n=(i.top+i.bottom)/2):(r=1,n=1);const o=(i.isOrthographicCamera?"scale("+s+")translate("+this.Be(r)+"px,"+this.Be(n)+"px)"+this.Ge(i.matrixWorldInverse):"translateZ("+s+"px)"+this.Ge(i.matrixWorldInverse))+"translate("+this.Te+"px,"+this.We+"px)";this.Ze.camera.style!==o&&(this.Ae.style.transform=o,this.Ze.camera.style=o);for(const s of t)this.Je(s,e,i)}setSize(t,e){this._e=t,this.ze=e,this.Te=this._e/2,this.We=this.ze/2,this.domElement.style.width=t+"px",this.domElement.style.height=e+"px",this.Ae.style.width=t+"px",this.Ae.style.height=e+"px"}Be(t){return Math.abs(t)<1e-10?0:t}Ge(t){const e=t.elements,i=this.Be;return"matrix3d("+i(e[0])+","+i(-e[1])+","+i(e[2])+","+i(e[3])+","+i(e[4])+","+i(-e[5])+","+i(e[6])+","+i(e[7])+","+i(e[8])+","+i(-e[9])+","+i(e[10])+","+i(e[11])+","+i(e[12])+","+i(-e[13])+","+i(e[14])+","+i(e[15])+")"}Le(t){const e=t.elements,i=this.Be;return"translate(-50%,-50%)matrix3d("+i(e[0])+","+i(e[1])+","+i(e[2])+","+i(e[3])+","+i(-e[4])+","+i(-e[5])+","+i(-e[6])+","+i(-e[7])+","+i(e[8])+","+i(e[9])+","+i(e[10])+","+i(e[11])+","+i(e[12])+","+i(e[13])+","+i(e[14])+","+i(e[15])+")"}Je(t,e,i){if(t.isCSS3DObject){let s;t.onBeforeRender(this,e,i),t.isCSS3DSprite?($t.copy(i.matrixWorldInverse),$t.transpose(),0!==t.rotation2D&&$t.multiply(te.makeRotationZ(t.rotation2D)),t.matrixWorld.decompose(Yt,Qt,Kt),$t.setPosition(Yt),$t.scale(Kt),$t.elements[3]=0,$t.elements[7]=0,$t.elements[11]=0,$t.elements[15]=1,s=this.Le($t)):s=this.Le(t.matrixWorld);const r=t.element;r.style.transform=s,r.style.display=t.visible?"":"none",r.parentNode!==this.Ae&&this.Ae.appendChild(r),t.onAfterRender(this,e,i)}}}class ie{constructor(){this.Ue=[],this.Xe=new Set,this.Ye=new Set}$e(){const t=this.Xe;this.Xe=this.Ye,this.Ye=t}enqueueTransformToUpdate(t){t.isRegisteredToProcessor||(t.isRegisteredToProcessor=!0,this.Ue.push(t))}enqueueRenderObject(t){this.Ye.add(t)}dequeueRenderObject(t){this.Ye.delete(t)}flush(){this.Xe.clear()}update(){const t=this.Ue;for(let e=0;e<t.length;e++){const i=t[e];i.tryUpdateWorldMatrixRecursivelyFromThisToChildren(),i.isRegisteredToProcessor=!1}return this.Ue.length=0,this.$e(),this.Xe}}class se{constructor(){this.N=new Z(H.comparator),this.q=new Z(H.comparator),this.J=!1,this.L=[],this.U=[]}addEventToNonSyncedCollection(t){this.N.insert(t)}removeEventFromNonSyncedCollection(t){this.N.delete(t)}addEventToSyncedCollection(t){this.q.insert(t)}startProcessNonSyncedEvent(){this.N.forEach((t=>t.invoke()))}tryStartProcessSyncedEvent(){this.J||(this.J=!0,this.q.forEach((t=>t.invoke())),this.q.clear(),this.J=!1)}addRemoveGameObject(t){this.L.push(t)}addRemoveComponent(t){this.U.push(t)}processRemoveObject(){const t=this.U;for(let e=0;e<t.length;e++)t[e].gameObject.removeComponent(t[e]);const e=this.L;for(let t=0;t<e.length;t++)e[t].removeFromParent()}}class re{constructor(){this.tm=1/3,this.im=0,this.h=0,this.sm=0,this.hm=0,this.rm=0,this.am=1}start(){this.im=performance.now()}update(){const t=performance.now();let e=(t-this.im)/1e3;this.tm<e&&(e=this.tm),this.rm=e,this.sm+=e,this.hm=e*this.am,this.h+=this.hm,this.im=t}get time(){return this.h}get unscaledTime(){return this.sm}get deltaTime(){return this.hm}get unscaledDeltaTime(){return this.rm}get timeScale(){return this.am}set timeScale(t){this.am=t}get maximumDeltaTime(){return this.tm}set maximumDeltaTime(t){this.tm=t}}class ne{constructor(t,e=!0){this.S=null;const i=document.createElement("div");i.style.width="100%",i.style.height="100%",i.style.position="relative",t.appendChild(i),t=i,this.G=new Xt,this.C=new Ht(t.clientWidth,t.clientHeight),this.K=t,this.i=new Zt((t=>{this.T?this.G.unsafeGetThreeScene().background=new y(t.r,t.g,t.b):this.v&&(this.v.domElement.style.backgroundColor="rgba("+255*t.r+","+255*t.g+","+255*t.b+","+t.a+")")})),this.h=new re,this.o=new qt(Nt.WaitingForStart),this.g=new se,this.p=new S(this.h),this.m=new ie,this.l=new Jt,this.D=new jt(this.G,this.i,this.h,this.o,this.C,this.g,this.p,this.m,this.l,t),this.O=null,this.F=!1,this.j=e,this.A=this.resizeFramebuffer.bind(this),e&&window.addEventListener("resize",this.A),this.M=this.R.bind(this)}resizeFramebuffer(){const t=this.K.clientWidth,e=this.K.clientHeight;t===this.C.width&&e===this.C.height||(this.C.resize(t,e),this.v&&(this.v.setSize(t,e),this.v.domElement.style.width="100%",this.v.domElement.style.height="100%"),this.T&&(this.T.setSize(t,e),this.T.domElement.style.width="100%",this.T.domElement.style.height="100%"))}run(t,e){if(this.F)throw new Error("Game is disposed.");if(this.o.kind!==Nt.WaitingForStart)throw new Error("Game is already running.");this.o.kind=Nt.Initializing,this.h.start();const i=new t(this.D,e),s=i.run();if(this.S=i.getGameSettingObject(),this.D.applyGameSetting(this.S),this.S.render.webGLRenderer){const t=this.K;this.T=this.S.render.webGLRenderer,this.T.setSize(t.clientWidth,t.clientHeight),this.T.domElement.style.position="absolute",t.appendChild(this.T.domElement)}if(this.S.render.useCss3DRenderer){const t=this.K;this.v=new ee,this.v.setSize(t.clientWidth,t.clientHeight);const e=this.v.domElement;e.style.width="100%",e.style.height="100%",e.style.position="absolute",e.style.pointerEvents="none",e.onscroll=t=>{const e=t.target;e.scrollTop=0,e.scrollLeft=0},t.appendChild(e)}if(s.build(),!this.i.camera)throw new Error("Camera is not exist or not active in the scene.");if(this.o.kind=Nt.Running,this.g.startProcessNonSyncedEvent(),this.l.update(this.h.deltaTime),this.p.updateAfterProcess(),!this.i.camera)throw new Error("Camera is not exist or not active in the scene.");this.g.processRemoveObject();const r=this.m.update();this.v&&this.v.render(r,this.G.unsafeGetThreeScene(),this.i.camera.threeCamera),this.T&&this.T.render(this.G.unsafeGetThreeScene(),this.i.camera.threeCamera),this.m.flush(),this.p.endFrameAfterProcess(),this.O=requestAnimationFrame(this.M)}R(){if(this.h.update(),this.g.startProcessNonSyncedEvent(),this.l.update(this.h.deltaTime),this.p.tryCompact(),this.p.updateAfterProcess(),!this.i.camera)throw new Error("Camera is not exist or not active in the scene.");this.g.processRemoveObject();const t=this.m.update();this.v&&this.v.render(t,this.G.unsafeGetThreeScene(),this.i.camera.threeCamera),this.T&&this.T.render(this.G.unsafeGetThreeScene(),this.i.camera.threeCamera),this.m.flush(),this.p.endFrameAfterProcess(),this.O=requestAnimationFrame(this.M)}stop(){if(this.F)throw new Error("Game is disposed.");if(this.o.kind!==Nt.Running)throw new Error("Game is not running.");this.o.kind=Nt.Stopped,this.O&&cancelAnimationFrame(this.O),this.O=null}resume(){if(this.F)throw new Error("Game is disposed.");if(this.o.kind!==Nt.Stopped)throw new Error("Game is not stopped.");this.o.kind=Nt.Running,this.R()}dispose(){if(this.F)return;this.o.kind=Nt.Finalizing,this.O&&cancelAnimationFrame(this.O),this.D.dispose();const t=this.G.children;for(let e=0;e<t.length;e++)t[e].gameObject.destroy();this.j&&window.removeEventListener("resize",this.A),this.v&&this.K.removeChild(this.v.domElement),this.T&&this.K.removeChild(this.T.domElement),this.K.remove(),this.F=!0,this.o.kind=Nt.Finalized}get inputHandler(){return this.D.input}get currentGameState(){return this.o.kind}}class oe{constructor(t){this.g=t,this.X=[]}withChild(t){return this.X.push(t),this}build(){for(let t=0;t<this.X.length;t++)this.X[t].build(null);Ot.processEventByGroup(this.X,this.g)}}class he{constructor(t){this.tt=t}static createDefaultObject(){return{}}loader(t){return this.tt.loader=t,this}gravity(t){return this.tt.gravity=t,this}defaultMaterial(t){return this.tt.defaultMaterial=t,this}velocityIterations(t){return this.tt.velocityIterations=t,this}positionIterations(t){return this.tt.positionIterations=t,this}queriesHitTriggers(t){return this.tt.queriesHitTriggers=t,this}reuseCollisionCallbacks(t){return this.tt.reuseCollisionCallbacks=t,this}layerCollisionMatrix(t){return this.tt.collisionLayerMaskMatrix=t,this}}class ae{constructor(t){this.ee=t}static createDefaultObject(){return{useCss3DRenderer:!0}}useCss3DRenderer(t){return this.ee.useCss3DRenderer=t,this}webGLRenderer(t){return this.ee.webGLRenderer=t,this}}class le{constructor(t){this.Y=t,this.Z=new ae(this.Y.render),this.$=new he(this.Y.physics)}static createDefaultObject(){return{render:ae.createDefaultObject(),physics:he.createDefaultObject()}}get render(){return this.Z}get physics(){return this.$}make(){return this.Y}}function me(t,e){return void 0!==t?t:e}const ce=1e37,ue=1e-5,_e=ue*ue,de=.005,pe=.03490658503988889,fe=.13962634015955555,ye=1.570796326795,xe=2.4674011002726646,ge=-1;function we(t,e){const i=new Array(t);for(let s=0;s<t;++s)i[s]=e(s);return i}function Ce(t,e=0){const i=new Array(t);for(let s=0;s<t;++s)i[s]=e;return i}new class{constructor(t=0,e=0,i=0){this.major=0,this.minor=0,this.revision=0,this.major=t,this.minor=e,this.revision=i}toString(){return this.major+"."+this.minor+"."+this.revision}}(2,4,1);const ve=6.28318530718,Se=Math.abs;function be(t,e){return t<e?t:e}function Be(t,e){return t>e?t:e}function Ae(t,e,i){return t<e?e:t>i?i:t}function Ve(t){return t*t}function Me(t){return 1/Math.sqrt(t)}isFinite;const De=Math.sqrt;Math.pow,Math.cos,Math.sin,Math.acos,Math.asin,Math.atan2;class Ie{constructor(t=0,e=0){this.x=t,this.y=e}Clone(){return new Ie(this.x,this.y)}SetZero(){return this.x=0,this.y=0,this}Set(t,e){return this.x=t,this.y=e,this}Copy(t){return this.x=t.x,this.y=t.y,this}SelfAdd(t){return this.x+=t.x,this.y+=t.y,this}SelfAddXY(t,e){return this.x+=t,this.y+=e,this}SelfSub(t){return this.x-=t.x,this.y-=t.y,this}SelfSubXY(t,e){return this.x-=t,this.y-=e,this}SelfMul(t){return this.x*=t,this.y*=t,this}SelfMulAdd(t,e){return this.x+=t*e.x,this.y+=t*e.y,this}SelfMulSub(t,e){return this.x-=t*e.x,this.y-=t*e.y,this}Dot(t){return this.x*t.x+this.y*t.y}Cross(t){return this.x*t.y-this.y*t.x}Length(){const t=this.x,e=this.y;return Math.sqrt(t*t+e*e)}LengthSquared(){const t=this.x,e=this.y;return t*t+e*e}Normalize(){const t=this.Length();if(t>=ue){const e=1/t;this.x*=e,this.y*=e}return t}SelfNormalize(){const t=this.Length();if(t>=ue){const e=1/t;this.x*=e,this.y*=e}return this}SelfRotate(t){const e=Math.cos(t),i=Math.sin(t),s=this.x;return this.x=e*s-i*this.y,this.y=i*s+e*this.y,this}SelfRotateCosSin(t,e){const i=this.x;return this.x=t*i-e*this.y,this.y=e*i+t*this.y,this}IsValid(){return isFinite(this.x)&&isFinite(this.y)}SelfCrossVS(t){const e=this.x;return this.x=t*this.y,this.y=-t*e,this}SelfCrossSV(t){const e=this.x;return this.x=-t*this.y,this.y=t*e,this}SelfMinV(t){return this.x=be(this.x,t.x),this.y=be(this.y,t.y),this}SelfMaxV(t){return this.x=Be(this.x,t.x),this.y=Be(this.y,t.y),this}SelfAbs(){return this.x=Se(this.x),this.y=Se(this.y),this}SelfNeg(){return this.x=-this.x,this.y=-this.y,this}SelfSkew(){const t=this.x;return this.x=-this.y,this.y=t,this}static MakeArray(t){return we(t,(t=>new Ie))}static AbsV(t,e){return e.x=Se(t.x),e.y=Se(t.y),e}static MinV(t,e,i){return i.x=be(t.x,e.x),i.y=be(t.y,e.y),i}static MaxV(t,e,i){return i.x=Be(t.x,e.x),i.y=Be(t.y,e.y),i}static ClampV(t,e,i,s){return s.x=Ae(t.x,e.x,i.x),s.y=Ae(t.y,e.y,i.y),s}static RotateV(t,e,i){const s=t.x,r=t.y,n=Math.cos(e),o=Math.sin(e);return i.x=n*s-o*r,i.y=o*s+n*r,i}static DotVV(t,e){return t.x*e.x+t.y*e.y}static CrossVV(t,e){return t.x*e.y-t.y*e.x}static CrossVS(t,e,i){const s=t.x;return i.x=e*t.y,i.y=-e*s,i}static CrossVOne(t,e){const i=t.x;return e.x=t.y,e.y=-i,e}static CrossSV(t,e,i){const s=e.x;return i.x=-t*e.y,i.y=t*s,i}static CrossOneV(t,e){const i=t.x;return e.x=-t.y,e.y=i,e}static AddVV(t,e,i){return i.x=t.x+e.x,i.y=t.y+e.y,i}static SubVV(t,e,i){return i.x=t.x-e.x,i.y=t.y-e.y,i}static MulSV(t,e,i){return i.x=e.x*t,i.y=e.y*t,i}static MulVS(t,e,i){return i.x=t.x*e,i.y=t.y*e,i}static AddVMulSV(t,e,i,s){return s.x=t.x+e*i.x,s.y=t.y+e*i.y,s}static SubVMulSV(t,e,i,s){return s.x=t.x-e*i.x,s.y=t.y-e*i.y,s}static AddVCrossSV(t,e,i,s){const r=i.x;return s.x=t.x-e*i.y,s.y=t.y+e*r,s}static MidVV(t,e,i){return i.x=.5*(t.x+e.x),i.y=.5*(t.y+e.y),i}static ExtVV(t,e,i){return i.x=.5*(e.x-t.x),i.y=.5*(e.y-t.y),i}static IsEqualToV(t,e){return t.x===e.x&&t.y===e.y}static DistanceVV(t,e){const i=t.x-e.x,s=t.y-e.y;return Math.sqrt(i*i+s*s)}static DistanceSquaredVV(t,e){const i=t.x-e.x,s=t.y-e.y;return i*i+s*s}static NegV(t,e){return e.x=-t.x,e.y=-t.y,e}}Ie.ZERO=new Ie(0,0),Ie.UNITX=new Ie(1,0),Ie.UNITY=new Ie(0,1),Ie.s_t0=new Ie,Ie.s_t1=new Ie,Ie.s_t2=new Ie,Ie.s_t3=new Ie,new Ie(0,0);class Pe{constructor(...t){if(t[0]instanceof Float32Array){if(2!==t[0].length)throw new Error;this.data=t[0]}else{const e="number"==typeof t[0]?t[0]:0,i="number"==typeof t[1]?t[1]:0;this.data=new Float32Array([e,i])}}get x(){return this.data[0]}set x(t){this.data[0]=t}get y(){return this.data[1]}set y(t){this.data[1]=t}Clone(){return new Pe(new Float32Array(this.data))}SetZero(){return this.x=0,this.y=0,this}Set(t,e){return this.x=t,this.y=e,this}Copy(t){return t instanceof Pe?this.data.set(t.data):(this.x=t.x,this.y=t.y),this}SelfAdd(t){return this.x+=t.x,this.y+=t.y,this}SelfAddXY(t,e){return this.x+=t,this.y+=e,this}SelfSub(t){return this.x-=t.x,this.y-=t.y,this}SelfSubXY(t,e){return this.x-=t,this.y-=e,this}SelfMul(t){return this.x*=t,this.y*=t,this}SelfMulAdd(t,e){return this.x+=t*e.x,this.y+=t*e.y,this}SelfMulSub(t,e){return this.x-=t*e.x,this.y-=t*e.y,this}Dot(t){return this.x*t.x+this.y*t.y}Cross(t){return this.x*t.y-this.y*t.x}Length(){const t=this.x,e=this.y;return Math.sqrt(t*t+e*e)}LengthSquared(){const t=this.x,e=this.y;return t*t+e*e}Normalize(){const t=this.Length();if(t>=ue){const e=1/t;this.x*=e,this.y*=e}return t}SelfNormalize(){const t=this.Length();if(t>=ue){const e=1/t;this.x*=e,this.y*=e}return this}SelfRotate(t){const e=Math.cos(t),i=Math.sin(t),s=this.x;return this.x=e*s-i*this.y,this.y=i*s+e*this.y,this}SelfRotateCosSin(t,e){const i=this.x;return this.x=t*i-e*this.y,this.y=e*i+t*this.y,this}IsValid(){return isFinite(this.x)&&isFinite(this.y)}SelfCrossVS(t){const e=this.x;return this.x=t*this.y,this.y=-t*e,this}SelfCrossSV(t){const e=this.x;return this.x=-t*this.y,this.y=t*e,this}SelfMinV(t){return this.x=be(this.x,t.x),this.y=be(this.y,t.y),this}SelfMaxV(t){return this.x=Be(this.x,t.x),this.y=Be(this.y,t.y),this}SelfAbs(){return this.x=Se(this.x),this.y=Se(this.y),this}SelfNeg(){return this.x=-this.x,this.y=-this.y,this}SelfSkew(){const t=this.x;return this.x=-this.y,this.y=t,this}}class Ge{constructor(...t){if(t[0]instanceof Float32Array){if(3!==t[0].length)throw new Error;this.data=t[0]}else{const e="number"==typeof t[0]?t[0]:0,i="number"==typeof t[1]?t[1]:0,s="number"==typeof t[2]?t[2]:0;this.data=new Float32Array([e,i,s])}}get x(){return this.data[0]}set x(t){this.data[0]=t}get y(){return this.data[1]}set y(t){this.data[1]=t}get z(){return this.data[2]}set z(t){this.data[2]=t}Clone(){return new Ge(this.x,this.y,this.z)}SetZero(){return this.x=0,this.y=0,this.z=0,this}SetXYZ(t,e,i){return this.x=t,this.y=e,this.z=i,this}Copy(t){return this.x=t.x,this.y=t.y,this.z=t.z,this}SelfNeg(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}SelfAdd(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this}SelfAddXYZ(t,e,i){return this.x+=t,this.y+=e,this.z+=i,this}SelfSub(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this}SelfSubXYZ(t,e,i){return this.x-=t,this.y-=e,this.z-=i,this}SelfMul(t){return this.x*=t,this.y*=t,this.z*=t,this}static DotV3V3(t,e){return t.x*e.x+t.y*e.y+t.z*e.z}static CrossV3V3(t,e,i){const s=t.x,r=t.y,n=t.z,o=e.x,h=e.y,a=e.z;return i.x=r*a-n*h,i.y=n*o-s*a,i.z=s*h-r*o,i}}Ge.ZERO=new Ge(0,0,0),Ge.s_t0=new Ge;class Te{constructor(){this.ex=new Ie(1,0),this.ey=new Ie(0,1)}Clone(){return(new Te).Copy(this)}static FromVV(t,e){return(new Te).SetVV(t,e)}static FromSSSS(t,e,i,s){return(new Te).SetSSSS(t,e,i,s)}static FromAngle(t){return(new Te).SetAngle(t)}SetSSSS(t,e,i,s){return this.ex.Set(t,i),this.ey.Set(e,s),this}SetVV(t,e){return this.ex.Copy(t),this.ey.Copy(e),this}SetAngle(t){const e=Math.cos(t),i=Math.sin(t);return this.ex.Set(e,i),this.ey.Set(-i,e),this}Copy(t){return this.ex.Copy(t.ex),this.ey.Copy(t.ey),this}SetIdentity(){return this.ex.Set(1,0),this.ey.Set(0,1),this}SetZero(){return this.ex.SetZero(),this.ey.SetZero(),this}GetAngle(){return Math.atan2(this.ex.y,this.ex.x)}GetInverse(t){const e=this.ex.x,i=this.ey.x,s=this.ex.y,r=this.ey.y;let n=e*r-i*s;return 0!==n&&(n=1/n),t.ex.x=n*r,t.ey.x=-n*i,t.ex.y=-n*s,t.ey.y=n*e,t}Solve(t,e,i){const s=this.ex.x,r=this.ey.x,n=this.ex.y,o=this.ey.y;let h=s*o-r*n;return 0!==h&&(h=1/h),i.x=h*(o*t-r*e),i.y=h*(s*e-n*t),i}SelfAbs(){return this.ex.SelfAbs(),this.ey.SelfAbs(),this}SelfInv(){return this.GetInverse(this),this}SelfAddM(t){return this.ex.SelfAdd(t.ex),this.ey.SelfAdd(t.ey),this}SelfSubM(t){return this.ex.SelfSub(t.ex),this.ey.SelfSub(t.ey),this}static AbsM(t,e){const i=t.ex,s=t.ey;return e.ex.x=Se(i.x),e.ex.y=Se(i.y),e.ey.x=Se(s.x),e.ey.y=Se(s.y),e}static MulMV(t,e,i){const s=t.ex,r=t.ey,n=e.x,o=e.y;return i.x=s.x*n+r.x*o,i.y=s.y*n+r.y*o,i}static MulTMV(t,e,i){const s=t.ex,r=t.ey,n=e.x,o=e.y;return i.x=s.x*n+s.y*o,i.y=r.x*n+r.y*o,i}static AddMM(t,e,i){const s=t.ex,r=t.ey,n=e.ex,o=e.ey;return i.ex.x=s.x+n.x,i.ex.y=s.y+n.y,i.ey.x=r.x+o.x,i.ey.y=r.y+o.y,i}static MulMM(t,e,i){const s=t.ex.x,r=t.ex.y,n=t.ey.x,o=t.ey.y,h=e.ex.x,a=e.ex.y,l=e.ey.x,m=e.ey.y;return i.ex.x=s*h+n*a,i.ex.y=r*h+o*a,i.ey.x=s*l+n*m,i.ey.y=r*l+o*m,i}static MulTMM(t,e,i){const s=t.ex.x,r=t.ex.y,n=t.ey.x,o=t.ey.y,h=e.ex.x,a=e.ex.y,l=e.ey.x,m=e.ey.y;return i.ex.x=s*h+r*a,i.ex.y=n*h+o*a,i.ey.x=s*l+r*m,i.ey.y=n*l+o*m,i}}Te.IDENTITY=new Te;class Re{constructor(){this.data=new Float32Array([1,0,0,0,1,0,0,0,1]),this.ex=new Ge(this.data.subarray(0,3)),this.ey=new Ge(this.data.subarray(3,6)),this.ez=new Ge(this.data.subarray(6,9))}Clone(){return(new Re).Copy(this)}SetVVV(t,e,i){return this.ex.Copy(t),this.ey.Copy(e),this.ez.Copy(i),this}Copy(t){return this.ex.Copy(t.ex),this.ey.Copy(t.ey),this.ez.Copy(t.ez),this}SetIdentity(){return this.ex.SetXYZ(1,0,0),this.ey.SetXYZ(0,1,0),this.ez.SetXYZ(0,0,1),this}SetZero(){return this.ex.SetZero(),this.ey.SetZero(),this.ez.SetZero(),this}SelfAddM(t){return this.ex.SelfAdd(t.ex),this.ey.SelfAdd(t.ey),this.ez.SelfAdd(t.ez),this}Solve33(t,e,i,s){const r=this.ex.x,n=this.ex.y,o=this.ex.z,h=this.ey.x,a=this.ey.y,l=this.ey.z,m=this.ez.x,c=this.ez.y,u=this.ez.z;let _=r*(a*u-l*c)+n*(l*m-h*u)+o*(h*c-a*m);return 0!==_&&(_=1/_),s.x=_*(t*(a*u-l*c)+e*(l*m-h*u)+i*(h*c-a*m)),s.y=_*(r*(e*u-i*c)+n*(i*m-t*u)+o*(t*c-e*m)),s.z=_*(r*(a*i-l*e)+n*(l*t-h*i)+o*(h*e-a*t)),s}Solve22(t,e,i){const s=this.ex.x,r=this.ey.x,n=this.ex.y,o=this.ey.y;let h=s*o-r*n;return 0!==h&&(h=1/h),i.x=h*(o*t-r*e),i.y=h*(s*e-n*t),i}GetInverse22(t){const e=this.ex.x,i=this.ey.x,s=this.ex.y,r=this.ey.y;let n=e*r-i*s;0!==n&&(n=1/n),t.ex.x=n*r,t.ey.x=-n*i,t.ex.z=0,t.ex.y=-n*s,t.ey.y=n*e,t.ey.z=0,t.ez.x=0,t.ez.y=0,t.ez.z=0}GetSymInverse33(t){let e=Ge.DotV3V3(this.ex,Ge.CrossV3V3(this.ey,this.ez,Ge.s_t0));0!==e&&(e=1/e);const i=this.ex.x,s=this.ey.x,r=this.ez.x,n=this.ey.y,o=this.ez.y,h=this.ez.z;t.ex.x=e*(n*h-o*o),t.ex.y=e*(r*o-s*h),t.ex.z=e*(s*o-r*n),t.ey.x=t.ex.y,t.ey.y=e*(i*h-r*r),t.ey.z=e*(r*s-i*o),t.ez.x=t.ex.z,t.ez.y=t.ey.z,t.ez.z=e*(i*n-s*s)}static MulM33V3(t,e,i){const s=e.x,r=e.y,n=e.z;return i.x=t.ex.x*s+t.ey.x*r+t.ez.x*n,i.y=t.ex.y*s+t.ey.y*r+t.ez.y*n,i.z=t.ex.z*s+t.ey.z*r+t.ez.z*n,i}static MulM33XYZ(t,e,i,s,r){return r.x=t.ex.x*e+t.ey.x*i+t.ez.x*s,r.y=t.ex.y*e+t.ey.y*i+t.ez.y*s,r.z=t.ex.z*e+t.ey.z*i+t.ez.z*s,r}static MulM33V2(t,e,i){const s=e.x,r=e.y;return i.x=t.ex.x*s+t.ey.x*r,i.y=t.ex.y*s+t.ey.y*r,i}static MulM33XY(t,e,i,s){return s.x=t.ex.x*e+t.ey.x*i,s.y=t.ex.y*e+t.ey.y*i,s}}Re.IDENTITY=new Re;class Fe{constructor(t=0){this.s=0,this.c=1,t&&(this.s=Math.sin(t),this.c=Math.cos(t))}Clone(){return(new Fe).Copy(this)}Copy(t){return this.s=t.s,this.c=t.c,this}SetAngle(t){return this.s=Math.sin(t),this.c=Math.cos(t),this}SetIdentity(){return this.s=0,this.c=1,this}GetAngle(){return Math.atan2(this.s,this.c)}GetXAxis(t){return t.x=this.c,t.y=this.s,t}GetYAxis(t){return t.x=-this.s,t.y=this.c,t}static MulRR(t,e,i){const s=t.c,r=t.s,n=e.c,o=e.s;return i.s=r*n+s*o,i.c=s*n-r*o,i}static MulTRR(t,e,i){const s=t.c,r=t.s,n=e.c,o=e.s;return i.s=s*o-r*n,i.c=s*n+r*o,i}static MulRV(t,e,i){const s=t.c,r=t.s,n=e.x,o=e.y;return i.x=s*n-r*o,i.y=r*n+s*o,i}static MulTRV(t,e,i){const s=t.c,r=t.s,n=e.x,o=e.y;return i.x=s*n+r*o,i.y=-r*n+s*o,i}}Fe.IDENTITY=new Fe;class ke{constructor(){this.p=new Ie,this.q=new Fe}Clone(){return(new ke).Copy(this)}Copy(t){return this.p.Copy(t.p),this.q.Copy(t.q),this}SetIdentity(){return this.p.SetZero(),this.q.SetIdentity(),this}SetPositionRotation(t,e){return this.p.Copy(t),this.q.Copy(e),this}SetPositionAngle(t,e){return this.p.Copy(t),this.q.SetAngle(e),this}SetPosition(t){return this.p.Copy(t),this}SetPositionXY(t,e){return this.p.Set(t,e),this}SetRotation(t){return this.q.Copy(t),this}SetRotationAngle(t){return this.q.SetAngle(t),this}GetPosition(){return this.p}GetRotation(){return this.q}GetRotationAngle(){return this.q.GetAngle()}GetAngle(){return this.q.GetAngle()}static MulXV(t,e,i){const s=t.q.c,r=t.q.s,n=e.x,o=e.y;return i.x=s*n-r*o+t.p.x,i.y=r*n+s*o+t.p.y,i}static MulTXV(t,e,i){const s=t.q.c,r=t.q.s,n=e.x-t.p.x,o=e.y-t.p.y;return i.x=s*n+r*o,i.y=-r*n+s*o,i}static MulXX(t,e,i){return Fe.MulRR(t.q,e.q,i.q),Ie.AddVV(Fe.MulRV(t.q,e.p,i.p),t.p,i.p),i}static MulTXX(t,e,i){return Fe.MulTRR(t.q,e.q,i.q),Fe.MulTRV(t.q,Ie.SubVV(e.p,t.p,i.p),i.p),i}}ke.IDENTITY=new ke;class Ee{constructor(){this.localCenter=new Ie,this.c0=new Ie,this.c=new Ie,this.a0=0,this.a=0,this.alpha0=0}Clone(){return(new Ee).Copy(this)}Copy(t){return this.localCenter.Copy(t.localCenter),this.c0.Copy(t.c0),this.c.Copy(t.c),this.a0=t.a0,this.a=t.a,this.alpha0=t.alpha0,this}GetTransform(t,e){t.p.x=(1-e)*this.c0.x+e*this.c.x,t.p.y=(1-e)*this.c0.y+e*this.c.y;const i=(1-e)*this.a0+e*this.a;return t.q.SetAngle(i),t.p.SelfSub(Fe.MulRV(t.q,this.localCenter,Ie.s_t0)),t}Advance(t){const e=(t-this.alpha0)/(1-this.alpha0),i=1-e;this.c0.x=i*this.c0.x+e*this.c.x,this.c0.y=i*this.c0.y+e*this.c.y,this.a0=i*this.a0+e*this.a,this.alpha0=t}Normalize(){const t=ve*Math.floor(this.a0/ve);this.a0-=t,this.a-=t}}class Le{constructor(){this.mass=0,this.center=new Ie(0,0),this.I=0}}var Oe,ze;(ze=Oe||(Oe={}))[ze.e_unknown=-1]="e_unknown",ze[ze.e_circleShape=0]="e_circleShape",ze[ze.e_edgeShape=1]="e_edgeShape",ze[ze.e_polygonShape=2]="e_polygonShape",ze[ze.e_chainShape=3]="e_chainShape",ze[ze.e_shapeTypeCount=4]="e_shapeTypeCount";class je{constructor(t,e){this.m_type=Oe.e_unknown,this.m_radius=0,this.m_type=t,this.m_radius=e}Copy(t){return this.m_radius=t.m_radius,this}GetType(){return this.m_type}}class qe{constructor(){this.m_buffer=Ie.MakeArray(2),this.m_vertices=this.m_buffer,this.m_count=0,this.m_radius=0}Copy(t){return t.m_vertices===t.m_buffer?(this.m_vertices=this.m_buffer,this.m_buffer[0].Copy(t.m_buffer[0]),this.m_buffer[1].Copy(t.m_buffer[1])):this.m_vertices=t.m_vertices,this.m_count=t.m_count,this.m_radius=t.m_radius,this}Reset(){return this.m_vertices=this.m_buffer,this.m_count=0,this.m_radius=0,this}SetShape(t,e){t.SetupDistanceProxy(this,e)}SetVerticesRadius(t,e,i){this.m_vertices=t,this.m_count=e,this.m_radius=i}GetSupport(t){let e=0,i=Ie.DotVV(this.m_vertices[0],t);for(let s=1;s<this.m_count;++s){const r=Ie.DotVV(this.m_vertices[s],t);r>i&&(e=s,i=r)}return e}GetSupportVertex(t){let e=0,i=Ie.DotVV(this.m_vertices[0],t);for(let s=1;s<this.m_count;++s){const r=Ie.DotVV(this.m_vertices[s],t);r>i&&(e=s,i=r)}return this.m_vertices[e]}GetVertexCount(){return this.m_count}GetVertex(t){return this.m_vertices[t]}}class Ne{constructor(){this.metric=0,this.count=0,this.indexA=[0,0,0],this.indexB=[0,0,0]}Reset(){return this.metric=0,this.count=0,this}}class We{constructor(){this.proxyA=new qe,this.proxyB=new qe,this.transformA=new ke,this.transformB=new ke,this.useRadii=!1}Reset(){return this.proxyA.Reset(),this.proxyB.Reset(),this.transformA.SetIdentity(),this.transformB.SetIdentity(),this.useRadii=!1,this}}class Xe{constructor(){this.pointA=new Ie,this.pointB=new Ie,this.distance=0,this.iterations=0}Reset(){return this.pointA.SetZero(),this.pointB.SetZero(),this.distance=0,this.iterations=0,this}}let Ue=0;class Je{constructor(){this.wA=new Ie,this.wB=new Ie,this.w=new Ie,this.a=0,this.indexA=0,this.indexB=0}Copy(t){return this.wA.Copy(t.wA),this.wB.Copy(t.wB),this.w.Copy(t.w),this.a=t.a,this.indexA=t.indexA,this.indexB=t.indexB,this}}class Ze{constructor(){this.m_v1=new Je,this.m_v2=new Je,this.m_v3=new Je,this.m_vertices=[],this.m_count=0,this.m_vertices[0]=this.m_v1,this.m_vertices[1]=this.m_v2,this.m_vertices[2]=this.m_v3}ReadCache(t,e,i,s,r){this.m_count=t.count;const n=this.m_vertices;for(let o=0;o<this.m_count;++o){const h=n[o];h.indexA=t.indexA[o],h.indexB=t.indexB[o];const a=e.GetVertex(h.indexA),l=s.GetVertex(h.indexB);ke.MulXV(i,a,h.wA),ke.MulXV(r,l,h.wB),Ie.SubVV(h.wB,h.wA,h.w),h.a=0}if(this.m_count>1){const e=t.metric,i=this.GetMetric();(i<.5*e||2*e<i||i<ue)&&(this.m_count=0)}if(0===this.m_count){const t=n[0];t.indexA=0,t.indexB=0;const o=e.GetVertex(0),h=s.GetVertex(0);ke.MulXV(i,o,t.wA),ke.MulXV(r,h,t.wB),Ie.SubVV(t.wB,t.wA,t.w),t.a=1,this.m_count=1}}WriteCache(t){t.metric=this.GetMetric(),t.count=this.m_count;const e=this.m_vertices;for(let i=0;i<this.m_count;++i)t.indexA[i]=e[i].indexA,t.indexB[i]=e[i].indexB}GetSearchDirection(t){switch(this.m_count){case 1:return Ie.NegV(this.m_v1.w,t);case 2:{const e=Ie.SubVV(this.m_v2.w,this.m_v1.w,t);return Ie.CrossVV(e,Ie.NegV(this.m_v1.w,Ie.s_t0))>0?Ie.CrossOneV(e,t):Ie.CrossVOne(e,t)}default:return t.SetZero()}}GetClosestPoint(t){switch(this.m_count){case 0:case 3:default:return t.SetZero();case 1:return t.Copy(this.m_v1.w);case 2:return t.Set(this.m_v1.a*this.m_v1.w.x+this.m_v2.a*this.m_v2.w.x,this.m_v1.a*this.m_v1.w.y+this.m_v2.a*this.m_v2.w.y)}}GetWitnessPoints(t,e){switch(this.m_count){case 0:default:break;case 1:t.Copy(this.m_v1.wA),e.Copy(this.m_v1.wB);break;case 2:t.x=this.m_v1.a*this.m_v1.wA.x+this.m_v2.a*this.m_v2.wA.x,t.y=this.m_v1.a*this.m_v1.wA.y+this.m_v2.a*this.m_v2.wA.y,e.x=this.m_v1.a*this.m_v1.wB.x+this.m_v2.a*this.m_v2.wB.x,e.y=this.m_v1.a*this.m_v1.wB.y+this.m_v2.a*this.m_v2.wB.y;break;case 3:e.x=t.x=this.m_v1.a*this.m_v1.wA.x+this.m_v2.a*this.m_v2.wA.x+this.m_v3.a*this.m_v3.wA.x,e.y=t.y=this.m_v1.a*this.m_v1.wA.y+this.m_v2.a*this.m_v2.wA.y+this.m_v3.a*this.m_v3.wA.y}}GetMetric(){switch(this.m_count){case 0:case 1:default:return 0;case 2:return Ie.DistanceVV(this.m_v1.w,this.m_v2.w);case 3:return Ie.CrossVV(Ie.SubVV(this.m_v2.w,this.m_v1.w,Ie.s_t0),Ie.SubVV(this.m_v3.w,this.m_v1.w,Ie.s_t1))}}Solve2(){const t=this.m_v1.w,e=this.m_v2.w,i=Ie.SubVV(e,t,Ze.s_e12),s=-Ie.DotVV(t,i);if(s<=0)return this.m_v1.a=1,void(this.m_count=1);const r=Ie.DotVV(e,i);if(r<=0)return this.m_v2.a=1,this.m_count=1,void this.m_v1.Copy(this.m_v2);const n=1/(r+s);this.m_v1.a=r*n,this.m_v2.a=s*n,this.m_count=2}Solve3(){const t=this.m_v1.w,e=this.m_v2.w,i=this.m_v3.w,s=Ie.SubVV(e,t,Ze.s_e12),r=Ie.DotVV(t,s),n=Ie.DotVV(e,s),o=-r,h=Ie.SubVV(i,t,Ze.s_e13),a=Ie.DotVV(t,h),l=Ie.DotVV(i,h),m=-a,c=Ie.SubVV(i,e,Ze.s_e23),u=Ie.DotVV(e,c),_=Ie.DotVV(i,c),d=-u,p=Ie.CrossVV(s,h),f=p*Ie.CrossVV(e,i),y=p*Ie.CrossVV(i,t),x=p*Ie.CrossVV(t,e);if(o<=0&&m<=0)return this.m_v1.a=1,void(this.m_count=1);if(n>0&&o>0&&x<=0){const t=1/(n+o);return this.m_v1.a=n*t,this.m_v2.a=o*t,void(this.m_count=2)}if(l>0&&m>0&&y<=0){const t=1/(l+m);return this.m_v1.a=l*t,this.m_v3.a=m*t,this.m_count=2,void this.m_v2.Copy(this.m_v3)}if(n<=0&&d<=0)return this.m_v2.a=1,this.m_count=1,void this.m_v1.Copy(this.m_v2);if(l<=0&&_<=0)return this.m_v3.a=1,this.m_count=1,void this.m_v1.Copy(this.m_v3);if(_>0&&d>0&&f<=0){const t=1/(_+d);return this.m_v2.a=_*t,this.m_v3.a=d*t,this.m_count=2,void this.m_v1.Copy(this.m_v3)}const g=1/(f+y+x);this.m_v1.a=f*g,this.m_v2.a=y*g,this.m_v3.a=x*g,this.m_count=3}}Ze.s_e12=new Ie,Ze.s_e13=new Ie,Ze.s_e23=new Ie;const He=new Ze,Ye=[0,0,0],Qe=[0,0,0],Ke=new Ie,$e=new Ie,ti=new Ie,ei=new Ie,ii=new Ie;function si(t,e,i){const s=i.proxyA,r=i.proxyB,n=i.transformA,o=i.transformB,h=He;h.ReadCache(e,s,n,r,o);const a=h.m_vertices,l=Ye,m=Qe;let c=0,u=0;for(;u<20;){c=h.m_count;for(let t=0;t<c;++t)l[t]=a[t].indexA,m[t]=a[t].indexB;switch(h.m_count){case 1:default:break;case 2:h.Solve2();break;case 3:h.Solve3()}if(3===h.m_count)break;const t=h.GetSearchDirection($e);if(t.LengthSquared()<_e)break;const e=a[h.m_count];e.indexA=s.GetSupport(Fe.MulTRV(n.q,Ie.NegV(t,Ie.s_t0),ei)),ke.MulXV(n,s.GetVertex(e.indexA),e.wA),e.indexB=r.GetSupport(Fe.MulTRV(o.q,t,ii)),ke.MulXV(o,r.GetVertex(e.indexB),e.wB),Ie.SubVV(e.wB,e.wA,e.w),++u;let i=!1;for(let t=0;t<c;++t)if(e.indexA===l[t]&&e.indexB===m[t]){i=!0;break}if(i)break;++h.m_count}if(Ue=Be(Ue,u),h.GetWitnessPoints(t.pointA,t.pointB),t.distance=Ie.DistanceVV(t.pointA,t.pointB),t.iterations=u,h.WriteCache(e),i.useRadii){const e=s.m_radius,i=r.m_radius;if(t.distance>e+i&&t.distance>ue){t.distance-=e+i;const s=Ie.SubVV(t.pointB,t.pointA,ti);s.Normalize(),t.pointA.SelfMulAdd(e,s),t.pointB.SelfMulSub(i,s)}else{const e=Ie.MidVV(t.pointA,t.pointB,Ke);t.pointA.Copy(e),t.pointB.Copy(e),t.distance=0}}}var ri,ni,oi;new Ie,new Ze,new Ie,new Ie,new Ie,new Ie,new Ie,new Ie,function(t){t[t.e_vertex=0]="e_vertex",t[t.e_face=1]="e_face"}(ri||(ri={}));class hi{constructor(){this._key=0,this._key_invalid=!1,this._indexA=0,this._indexB=0,this._typeA=0,this._typeB=0}get key(){return this._key_invalid&&(this._key_invalid=!1,this._key=this._indexA|this._indexB<<8|this._typeA<<16|this._typeB<<24),this._key}set key(t){this._key=t,this._key_invalid=!1,this._indexA=255&this._key,this._indexB=this._key>>8&255,this._typeA=this._key>>16&255,this._typeB=this._key>>24&255}get indexA(){return this._indexA}set indexA(t){this._indexA=t,this._key_invalid=!0}get indexB(){return this._indexB}set indexB(t){this._indexB=t,this._key_invalid=!0}get typeA(){return this._typeA}set typeA(t){this._typeA=t,this._key_invalid=!0}get typeB(){return this._typeB}set typeB(t){this._typeB=t,this._key_invalid=!0}}class ai{constructor(){this.cf=new hi}Copy(t){return this.key=t.key,this}Clone(){return(new ai).Copy(this)}get key(){return this.cf.key}set key(t){this.cf.key=t}}class li{constructor(){this.localPoint=new Ie,this.normalImpulse=0,this.tangentImpulse=0,this.id=new ai}static MakeArray(t){return we(t,(t=>new li))}Reset(){this.localPoint.SetZero(),this.normalImpulse=0,this.tangentImpulse=0,this.id.key=0}Copy(t){return this.localPoint.Copy(t.localPoint),this.normalImpulse=t.normalImpulse,this.tangentImpulse=t.tangentImpulse,this.id.Copy(t.id),this}}!function(t){t[t.e_unknown=-1]="e_unknown",t[t.e_circles=0]="e_circles",t[t.e_faceA=1]="e_faceA",t[t.e_faceB=2]="e_faceB"}(ni||(ni={}));class mi{constructor(){this.points=li.MakeArray(2),this.localNormal=new Ie,this.localPoint=new Ie,this.type=ni.e_unknown,this.pointCount=0}Reset(){for(let t=0;t<2;++t)this.points[t].Reset();this.localNormal.SetZero(),this.localPoint.SetZero(),this.type=ni.e_unknown,this.pointCount=0}Copy(t){this.pointCount=t.pointCount;for(let e=0;e<2;++e)this.points[e].Copy(t.points[e]);return this.localNormal.Copy(t.localNormal),this.localPoint.Copy(t.localPoint),this.type=t.type,this}Clone(){return(new mi).Copy(this)}}class ci{constructor(){this.normal=new Ie,this.points=Ie.MakeArray(2),this.separations=Ce(2)}Initialize(t,e,i,s,r){if(0!==t.pointCount)switch(t.type){case ni.e_circles:{this.normal.Set(1,0);const n=ke.MulXV(e,t.localPoint,ci.Initialize_s_pointA),o=ke.MulXV(s,t.points[0].localPoint,ci.Initialize_s_pointB);Ie.DistanceSquaredVV(n,o)>_e&&Ie.SubVV(o,n,this.normal).SelfNormalize();const h=Ie.AddVMulSV(n,i,this.normal,ci.Initialize_s_cA),a=Ie.SubVMulSV(o,r,this.normal,ci.Initialize_s_cB);Ie.MidVV(h,a,this.points[0]),this.separations[0]=Ie.DotVV(Ie.SubVV(a,h,Ie.s_t0),this.normal);break}case ni.e_faceA:{Fe.MulRV(e.q,t.localNormal,this.normal);const n=ke.MulXV(e,t.localPoint,ci.Initialize_s_planePoint);for(let e=0;e<t.pointCount;++e){const o=ke.MulXV(s,t.points[e].localPoint,ci.Initialize_s_clipPoint),h=i-Ie.DotVV(Ie.SubVV(o,n,Ie.s_t0),this.normal),a=Ie.AddVMulSV(o,h,this.normal,ci.Initialize_s_cA),l=Ie.SubVMulSV(o,r,this.normal,ci.Initialize_s_cB);Ie.MidVV(a,l,this.points[e]),this.separations[e]=Ie.DotVV(Ie.SubVV(l,a,Ie.s_t0),this.normal)}break}case ni.e_faceB:{Fe.MulRV(s.q,t.localNormal,this.normal);const n=ke.MulXV(s,t.localPoint,ci.Initialize_s_planePoint);for(let s=0;s<t.pointCount;++s){const o=ke.MulXV(e,t.points[s].localPoint,ci.Initialize_s_clipPoint),h=r-Ie.DotVV(Ie.SubVV(o,n,Ie.s_t0),this.normal),a=Ie.AddVMulSV(o,h,this.normal,ci.Initialize_s_cB),l=Ie.SubVMulSV(o,i,this.normal,ci.Initialize_s_cA);Ie.MidVV(l,a,this.points[s]),this.separations[s]=Ie.DotVV(Ie.SubVV(l,a,Ie.s_t0),this.normal)}this.normal.SelfNeg();break}}}}ci.Initialize_s_pointA=new Ie,ci.Initialize_s_pointB=new Ie,ci.Initialize_s_cA=new Ie,ci.Initialize_s_cB=new Ie,ci.Initialize_s_planePoint=new Ie,ci.Initialize_s_clipPoint=new Ie,function(t){t[t.b2_nullState=0]="b2_nullState",t[t.b2_addState=1]="b2_addState",t[t.b2_persistState=2]="b2_persistState",t[t.b2_removeState=3]="b2_removeState"}(oi||(oi={}));class ui{constructor(){this.v=new Ie,this.id=new ai}static MakeArray(t){return we(t,(t=>new ui))}Copy(t){return this.v.Copy(t.v),this.id.Copy(t.id),this}}class _i{constructor(){this.p1=new Ie,this.p2=new Ie,this.maxFraction=1}Copy(t){return this.p1.Copy(t.p1),this.p2.Copy(t.p2),this.maxFraction=t.maxFraction,this}}class di{constructor(){this.normal=new Ie,this.fraction=0}Copy(t){return this.normal.Copy(t.normal),this.fraction=t.fraction,this}}class pi{constructor(){this.lowerBound=new Ie,this.upperBound=new Ie,this.m_cache_center=new Ie,this.m_cache_extent=new Ie}Copy(t){return this.lowerBound.Copy(t.lowerBound),this.upperBound.Copy(t.upperBound),this}IsValid(){return!(!this.lowerBound.IsValid()||!this.upperBound.IsValid()||this.upperBound.x<this.lowerBound.x||this.upperBound.y<this.lowerBound.y)}GetCenter(){return Ie.MidVV(this.lowerBound,this.upperBound,this.m_cache_center)}GetExtents(){return Ie.ExtVV(this.lowerBound,this.upperBound,this.m_cache_extent)}GetPerimeter(){return 2*(this.upperBound.x-this.lowerBound.x+(this.upperBound.y-this.lowerBound.y))}Combine1(t){return this.lowerBound.x=be(this.lowerBound.x,t.lowerBound.x),this.lowerBound.y=be(this.lowerBound.y,t.lowerBound.y),this.upperBound.x=Be(this.upperBound.x,t.upperBound.x),this.upperBound.y=Be(this.upperBound.y,t.upperBound.y),this}Combine2(t,e){return this.lowerBound.x=be(t.lowerBound.x,e.lowerBound.x),this.lowerBound.y=be(t.lowerBound.y,e.lowerBound.y),this.upperBound.x=Be(t.upperBound.x,e.upperBound.x),this.upperBound.y=Be(t.upperBound.y,e.upperBound.y),this}static Combine(t,e,i){return i.Combine2(t,e),i}Contains(t){let e=!0;return e=e&&this.lowerBound.x<=t.lowerBound.x,e=e&&this.lowerBound.y<=t.lowerBound.y,e=e&&t.upperBound.x<=this.upperBound.x,e=e&&t.upperBound.y<=this.upperBound.y,e}RayCast(t,e){let i=-ce,s=ce;const r=e.p1.x,n=e.p1.y,o=e.p2.x-e.p1.x,h=e.p2.y-e.p1.y,a=Se(o),l=Se(h),m=t.normal;if(a<ue){if(r<this.lowerBound.x||this.upperBound.x<r)return!1}else{const t=1/o;let e=(this.lowerBound.x-r)*t,n=(this.upperBound.x-r)*t,h=-1;if(e>n){const t=e;e=n,n=t,h=1}if(e>i&&(m.x=h,m.y=0,i=e),s=be(s,n),i>s)return!1}if(l<ue){if(n<this.lowerBound.y||this.upperBound.y<n)return!1}else{const t=1/h;let e=(this.lowerBound.y-n)*t,r=(this.upperBound.y-n)*t,o=-1;if(e>r){const t=e;e=r,r=t,o=1}if(e>i&&(m.x=0,m.y=o,i=e),s=be(s,r),i>s)return!1}return!(i<0||e.maxFraction<i||(t.fraction=i,0))}TestContain(t){return!(t.x<this.lowerBound.x||this.upperBound.x<t.x||t.y<this.lowerBound.y||this.upperBound.y<t.y)}TestOverlap(t){return!(this.upperBound.x<t.lowerBound.x||this.upperBound.y<t.lowerBound.y||t.upperBound.x<this.lowerBound.x||t.upperBound.y<this.lowerBound.y)}}function fi(t,e){return!(t.upperBound.x<e.lowerBound.x||t.upperBound.y<e.lowerBound.y||e.upperBound.x<t.lowerBound.x||e.upperBound.y<t.lowerBound.y)}function yi(t,e,i,s,r){let n=0;const o=e[0],h=e[1],a=Ie.DotVV(i,o.v)-s,l=Ie.DotVV(i,h.v)-s;if(a<=0&&t[n++].Copy(o),l<=0&&t[n++].Copy(h),a*l<0){const e=a/(a-l),i=t[n].v;i.x=o.v.x+e*(h.v.x-o.v.x),i.y=o.v.y+e*(h.v.y-o.v.y);const s=t[n].id;s.cf.indexA=r,s.cf.indexB=o.id.cf.indexB,s.cf.typeA=ri.e_vertex,s.cf.typeB=ri.e_face,++n}return n}const xi=new We,gi=new Ne,wi=new Xe;function Ci(t,e,i,s,r,n){const o=xi.Reset();o.proxyA.SetShape(t,e),o.proxyB.SetShape(i,s),o.transformA.Copy(r),o.transformB.Copy(n),o.useRadii=!0;const h=gi.Reset();h.count=0;const a=wi.Reset();return si(a,h,o),a.distance<1e-4}class vi{constructor(){this.categoryBits=1,this.maskBits=65535,this.groupIndex=0}Clone(){return(new vi).Copy(this)}Copy(t){return this.categoryBits=t.categoryBits,this.maskBits=t.maskBits,this.groupIndex=t.groupIndex||0,this}}vi.DEFAULT=new vi;class Si{constructor(){this.userData=null,this.friction=.2,this.restitution=0,this.restitutionThreshold=1,this.density=0,this.isSensor=!1,this.filter=new vi}}class bi{constructor(t,e){this.aabb=new pi,this.childIndex=0,this.fixture=t,this.childIndex=e,this.fixture.m_shape.ComputeAABB(this.aabb,this.fixture.m_body.GetTransform(),e),this.treeNode=this.fixture.m_body.m_world.m_contactManager.m_broadPhase.CreateProxy(this.aabb,this)}Reset(){this.fixture.m_body.m_world.m_contactManager.m_broadPhase.DestroyProxy(this.treeNode)}Touch(){this.fixture.m_body.m_world.m_contactManager.m_broadPhase.TouchProxy(this.treeNode)}Synchronize(t,e){if(t===e)this.fixture.m_shape.ComputeAABB(this.aabb,t,this.childIndex),this.fixture.m_body.m_world.m_contactManager.m_broadPhase.MoveProxy(this.treeNode,this.aabb,Ie.ZERO);else{const i=bi.Synchronize_s_aabb1,s=bi.Synchronize_s_aabb2;this.fixture.m_shape.ComputeAABB(i,t,this.childIndex),this.fixture.m_shape.ComputeAABB(s,e,this.childIndex),this.aabb.Combine2(i,s);const r=bi.Synchronize_s_displacement;r.Copy(s.GetCenter()).SelfSub(i.GetCenter()),this.fixture.m_body.m_world.m_contactManager.m_broadPhase.MoveProxy(this.treeNode,this.aabb,r)}}}bi.Synchronize_s_aabb1=new pi,bi.Synchronize_s_aabb2=new pi,bi.Synchronize_s_displacement=new Ie;class Bi{constructor(t,e){this.m_density=0,this.m_next=null,this.m_friction=0,this.m_restitution=0,this.m_restitutionThreshold=1,this.m_proxies=[],this.m_filter=new vi,this.m_isSensor=!1,this.m_userData=null,this.m_body=t,this.m_shape=e.shape.Clone(),this.m_userData=me(e.userData,null),this.m_friction=me(e.friction,.2),this.m_restitution=me(e.restitution,0),this.m_restitutionThreshold=me(e.restitutionThreshold,0),this.m_filter.Copy(me(e.filter,vi.DEFAULT)),this.m_isSensor=me(e.isSensor,!1),this.m_density=me(e.density,0)}get m_proxyCount(){return this.m_proxies.length}Reset(){}GetType(){return this.m_shape.GetType()}GetShape(){return this.m_shape}SetSensor(t){t!==this.m_isSensor&&(this.m_body.SetAwake(!0),this.m_isSensor=t)}IsSensor(){return this.m_isSensor}SetFilterData(t){this.m_filter.Copy(t),this.Refilter()}GetFilterData(){return this.m_filter}Refilter(){let t=this.m_body.GetContactList();for(;t;){const e=t.contact,i=e.GetFixtureA(),s=e.GetFixtureB();i!==this&&s!==this||e.FlagForFiltering(),t=t.next}this.TouchProxies()}GetBody(){return this.m_body}GetNext(){return this.m_next}GetUserData(){return this.m_userData}SetUserData(t){this.m_userData=t}TestPoint(t){return this.m_shape.TestPoint(this.m_body.GetTransform(),t)}ComputeDistance(t,e,i){return this.m_shape.ComputeDistance(this.m_body.GetTransform(),t,e,i)}RayCast(t,e,i){return this.m_shape.RayCast(t,e,this.m_body.GetTransform(),i)}GetMassData(t=new Le){return this.m_shape.ComputeMass(t,this.m_density),t}SetDensity(t){this.m_density=t}GetDensity(){return this.m_density}GetFriction(){return this.m_friction}SetFriction(t){this.m_friction=t}GetRestitution(){return this.m_restitution}SetRestitution(t){this.m_restitution=t}GetRestitutionThreshold(){return this.m_restitutionThreshold}SetRestitutionThreshold(t){this.m_restitutionThreshold=t}GetAABB(t){return this.m_proxies[t].aabb}Dump(t,e){t("    const fd: b2FixtureDef = new b2FixtureDef();\n"),t("    fd.friction = %.15f;\n",this.m_friction),t("    fd.restitution = %.15f;\n",this.m_restitution),t("    fd.restitutionThreshold = %.15f;\n",this.m_restitutionThreshold),t("    fd.density = %.15f;\n",this.m_density),t("    fd.isSensor = %s;\n",this.m_isSensor?"true":"false"),t("    fd.filter.categoryBits = %d;\n",this.m_filter.categoryBits),t("    fd.filter.maskBits = %d;\n",this.m_filter.maskBits),t("    fd.filter.groupIndex = %d;\n",this.m_filter.groupIndex),this.m_shape.Dump(t),t("\n"),t("    fd.shape = shape;\n"),t("\n"),t("    bodies[%d].CreateFixture(fd);\n",e)}CreateProxies(){if(0!==this.m_proxies.length)throw new Error;for(let t=0;t<this.m_shape.GetChildCount();++t)this.m_proxies[t]=new bi(this,t)}DestroyProxies(){for(const t of this.m_proxies)t.Reset();this.m_proxies.length=0}TouchProxies(){for(const t of this.m_proxies)t.Touch()}SynchronizeProxies(t,e){for(const i of this.m_proxies)i.Synchronize(t,e)}}var Ai,Vi;!function(t){t[t.b2_unknown=-1]="b2_unknown",t[t.b2_staticBody=0]="b2_staticBody",t[t.b2_kinematicBody=1]="b2_kinematicBody",t[t.b2_dynamicBody=2]="b2_dynamicBody"}(Ai||(Ai={}));class Mi{constructor(){this.type=Ai.b2_staticBody,this.position=new Ie(0,0),this.angle=0,this.linearVelocity=new Ie(0,0),this.angularVelocity=0,this.linearDamping=0,this.angularDamping=0,this.allowSleep=!0,this.awake=!0,this.fixedRotation=!1,this.bullet=!1,this.enabled=!0,this.userData=null,this.gravityScale=1}}class Di{constructor(t,e){this.m_type=Ai.b2_staticBody,this.m_islandFlag=!1,this.m_awakeFlag=!1,this.m_autoSleepFlag=!1,this.m_bulletFlag=!1,this.m_fixedRotationFlag=!1,this.m_enabledFlag=!1,this.m_toiFlag=!1,this.m_islandIndex=0,this.m_xf=new ke,this.m_xf0=new ke,this.m_sweep=new Ee,this.m_linearVelocity=new Ie,this.m_angularVelocity=0,this.m_force=new Ie,this.m_torque=0,this.m_prev=null,this.m_next=null,this.m_fixtureList=null,this.m_fixtureCount=0,this.m_jointList=null,this.m_contactList=null,this.m_mass=1,this.m_invMass=1,this.m_I=0,this.m_invI=0,this.m_linearDamping=0,this.m_angularDamping=0,this.m_gravityScale=1,this.m_sleepTime=0,this.m_userData=null,this.m_controllerList=null,this.m_controllerCount=0,this.m_bulletFlag=me(t.bullet,!1),this.m_fixedRotationFlag=me(t.fixedRotation,!1),this.m_autoSleepFlag=me(t.allowSleep,!0),me(t.awake,!0)&&me(t.type,Ai.b2_staticBody)!==Ai.b2_staticBody&&(this.m_awakeFlag=!0),this.m_enabledFlag=me(t.enabled,!0),this.m_world=e,this.m_xf.p.Copy(me(t.position,Ie.ZERO)),this.m_xf.q.SetAngle(me(t.angle,0)),this.m_xf0.Copy(this.m_xf),this.m_sweep.localCenter.SetZero(),this.m_sweep.c0.Copy(this.m_xf.p),this.m_sweep.c.Copy(this.m_xf.p),this.m_sweep.a0=this.m_sweep.a=this.m_xf.q.GetAngle(),this.m_sweep.alpha0=0,this.m_linearVelocity.Copy(me(t.linearVelocity,Ie.ZERO)),this.m_angularVelocity=me(t.angularVelocity,0),this.m_linearDamping=me(t.linearDamping,0),this.m_angularDamping=me(t.angularDamping,0),this.m_gravityScale=me(t.gravityScale,1),this.m_force.SetZero(),this.m_torque=0,this.m_sleepTime=0,this.m_type=me(t.type,Ai.b2_staticBody),this.m_mass=0,this.m_invMass=0,this.m_I=0,this.m_invI=0,this.m_userData=t.userData,this.m_fixtureList=null,this.m_fixtureCount=0,this.m_controllerList=null,this.m_controllerCount=0}CreateFixture(t,e=0){return t instanceof je?this.CreateFixtureShapeDensity(t,e):this.CreateFixtureDef(t)}CreateFixtureDef(t){if(this.m_world.IsLocked())throw new Error;const e=new Bi(this,t);return this.m_enabledFlag&&e.CreateProxies(),e.m_next=this.m_fixtureList,this.m_fixtureList=e,++this.m_fixtureCount,e.m_density>0&&this.ResetMassData(),this.m_world.m_newContacts=!0,e}CreateFixtureShapeDensity(t,e=0){const i=Di.CreateFixtureShapeDensity_s_def;return i.shape=t,i.density=e,this.CreateFixtureDef(i)}DestroyFixture(t){if(this.m_world.IsLocked())throw new Error;let e=this.m_fixtureList,i=null;for(;null!==e;){if(e===t){i?i.m_next=t.m_next:this.m_fixtureList=t.m_next;break}i=e,e=e.m_next}let s=this.m_contactList;for(;s;){const e=s.contact;s=s.next;const i=e.GetFixtureA(),r=e.GetFixtureB();t!==i&&t!==r||this.m_world.m_contactManager.Destroy(e)}this.m_enabledFlag&&t.DestroyProxies(),t.m_next=null,t.Reset(),--this.m_fixtureCount,this.ResetMassData()}SetTransformVec(t,e){this.SetTransformXY(t.x,t.y,e)}SetTransformXY(t,e,i){if(this.m_world.IsLocked())throw new Error;this.m_xf.q.SetAngle(i),this.m_xf.p.Set(t,e),this.m_xf0.Copy(this.m_xf),ke.MulXV(this.m_xf,this.m_sweep.localCenter,this.m_sweep.c),this.m_sweep.a=i,this.m_sweep.c0.Copy(this.m_sweep.c),this.m_sweep.a0=i;for(let t=this.m_fixtureList;t;t=t.m_next)t.SynchronizeProxies(this.m_xf,this.m_xf);this.m_world.m_newContacts=!0}SetTransform(t){this.SetTransformVec(t.p,t.GetAngle())}GetTransform(){return this.m_xf}GetPosition(){return this.m_xf.p}SetPosition(t){this.SetTransformVec(t,this.GetAngle())}SetPositionXY(t,e){this.SetTransformXY(t,e,this.GetAngle())}GetAngle(){return this.m_sweep.a}SetAngle(t){this.SetTransformVec(this.GetPosition(),t)}GetWorldCenter(){return this.m_sweep.c}GetLocalCenter(){return this.m_sweep.localCenter}SetLinearVelocity(t){this.m_type!==Ai.b2_staticBody&&(Ie.DotVV(t,t)>0&&this.SetAwake(!0),this.m_linearVelocity.Copy(t))}GetLinearVelocity(){return this.m_linearVelocity}SetAngularVelocity(t){this.m_type!==Ai.b2_staticBody&&(t*t>0&&this.SetAwake(!0),this.m_angularVelocity=t)}GetAngularVelocity(){return this.m_angularVelocity}GetDefinition(t){return t.type=this.GetType(),t.allowSleep=this.m_autoSleepFlag,t.angle=this.GetAngle(),t.angularDamping=this.m_angularDamping,t.gravityScale=this.m_gravityScale,t.angularVelocity=this.m_angularVelocity,t.fixedRotation=this.m_fixedRotationFlag,t.bullet=this.m_bulletFlag,t.awake=this.m_awakeFlag,t.linearDamping=this.m_linearDamping,t.linearVelocity.Copy(this.GetLinearVelocity()),t.position.Copy(this.GetPosition()),t.userData=this.GetUserData(),t}ApplyForce(t,e,i=!0){this.m_type===Ai.b2_dynamicBody&&(i&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_force.x+=t.x,this.m_force.y+=t.y,this.m_torque+=(e.x-this.m_sweep.c.x)*t.y-(e.y-this.m_sweep.c.y)*t.x))}ApplyForceToCenter(t,e=!0){this.m_type===Ai.b2_dynamicBody&&(e&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_force.x+=t.x,this.m_force.y+=t.y))}ApplyTorque(t,e=!0){this.m_type===Ai.b2_dynamicBody&&(e&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_torque+=t))}ApplyLinearImpulse(t,e,i=!0){this.m_type===Ai.b2_dynamicBody&&(i&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_linearVelocity.x+=this.m_invMass*t.x,this.m_linearVelocity.y+=this.m_invMass*t.y,this.m_angularVelocity+=this.m_invI*((e.x-this.m_sweep.c.x)*t.y-(e.y-this.m_sweep.c.y)*t.x)))}ApplyLinearImpulseToCenter(t,e=!0){this.m_type===Ai.b2_dynamicBody&&(e&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_linearVelocity.x+=this.m_invMass*t.x,this.m_linearVelocity.y+=this.m_invMass*t.y))}ApplyAngularImpulse(t,e=!0){this.m_type===Ai.b2_dynamicBody&&(e&&!this.m_awakeFlag&&this.SetAwake(!0),this.m_awakeFlag&&(this.m_angularVelocity+=this.m_invI*t))}GetMass(){return this.m_mass}GetInertia(){return this.m_I+this.m_mass*Ie.DotVV(this.m_sweep.localCenter,this.m_sweep.localCenter)}GetMassData(t){return t.mass=this.m_mass,t.I=this.m_I+this.m_mass*Ie.DotVV(this.m_sweep.localCenter,this.m_sweep.localCenter),t.center.Copy(this.m_sweep.localCenter),t}SetMassData(t){if(this.m_world.IsLocked())throw new Error;if(this.m_type!==Ai.b2_dynamicBody)return;this.m_invMass=0,this.m_I=0,this.m_invI=0,this.m_mass=t.mass,this.m_mass<=0&&(this.m_mass=1),this.m_invMass=1/this.m_mass,t.I>0&&!this.m_fixedRotationFlag&&(this.m_I=t.I-this.m_mass*Ie.DotVV(t.center,t.center),this.m_invI=1/this.m_I);const e=Di.SetMassData_s_oldCenter.Copy(this.m_sweep.c);this.m_sweep.localCenter.Copy(t.center),ke.MulXV(this.m_xf,this.m_sweep.localCenter,this.m_sweep.c),this.m_sweep.c0.Copy(this.m_sweep.c),Ie.AddVCrossSV(this.m_linearVelocity,this.m_angularVelocity,Ie.SubVV(this.m_sweep.c,e,Ie.s_t0),this.m_linearVelocity)}ResetMassData(){if(this.m_mass=0,this.m_invMass=0,this.m_I=0,this.m_invI=0,this.m_sweep.localCenter.SetZero(),this.m_type===Ai.b2_staticBody||this.m_type===Ai.b2_kinematicBody)return this.m_sweep.c0.Copy(this.m_xf.p),this.m_sweep.c.Copy(this.m_xf.p),void(this.m_sweep.a0=this.m_sweep.a);const t=Di.ResetMassData_s_localCenter.SetZero();for(let e=this.m_fixtureList;e;e=e.m_next){if(0===e.m_density)continue;const i=e.GetMassData(Di.ResetMassData_s_massData);this.m_mass+=i.mass,t.x+=i.center.x*i.mass,t.y+=i.center.y*i.mass,this.m_I+=i.I}this.m_mass>0&&(this.m_invMass=1/this.m_mass,t.x*=this.m_invMass,t.y*=this.m_invMass),this.m_I>0&&!this.m_fixedRotationFlag?(this.m_I-=this.m_mass*Ie.DotVV(t,t),this.m_invI=1/this.m_I):(this.m_I=0,this.m_invI=0);const e=Di.ResetMassData_s_oldCenter.Copy(this.m_sweep.c);this.m_sweep.localCenter.Copy(t),ke.MulXV(this.m_xf,this.m_sweep.localCenter,this.m_sweep.c),this.m_sweep.c0.Copy(this.m_sweep.c),Ie.AddVCrossSV(this.m_linearVelocity,this.m_angularVelocity,Ie.SubVV(this.m_sweep.c,e,Ie.s_t0),this.m_linearVelocity)}GetWorldPoint(t,e){return ke.MulXV(this.m_xf,t,e)}GetWorldVector(t,e){return Fe.MulRV(this.m_xf.q,t,e)}GetLocalPoint(t,e){return ke.MulTXV(this.m_xf,t,e)}GetLocalVector(t,e){return Fe.MulTRV(this.m_xf.q,t,e)}GetLinearVelocityFromWorldPoint(t,e){return Ie.AddVCrossSV(this.m_linearVelocity,this.m_angularVelocity,Ie.SubVV(t,this.m_sweep.c,Ie.s_t0),e)}GetLinearVelocityFromLocalPoint(t,e){return this.GetLinearVelocityFromWorldPoint(this.GetWorldPoint(t,e),e)}GetLinearDamping(){return this.m_linearDamping}SetLinearDamping(t){this.m_linearDamping=t}GetAngularDamping(){return this.m_angularDamping}SetAngularDamping(t){this.m_angularDamping=t}GetGravityScale(){return this.m_gravityScale}SetGravityScale(t){this.m_gravityScale=t}SetType(t){if(this.m_world.IsLocked())throw new Error;if(this.m_type===t)return;this.m_type=t,this.ResetMassData(),this.m_type===Ai.b2_staticBody&&(this.m_linearVelocity.SetZero(),this.m_angularVelocity=0,this.m_sweep.a0=this.m_sweep.a,this.m_sweep.c0.Copy(this.m_sweep.c),this.m_awakeFlag=!1,this.SynchronizeFixtures()),this.SetAwake(!0),this.m_force.SetZero(),this.m_torque=0;let e=this.m_contactList;for(;e;){const t=e;e=e.next,this.m_world.m_contactManager.Destroy(t.contact)}this.m_contactList=null;for(let t=this.m_fixtureList;t;t=t.m_next)t.TouchProxies()}GetType(){return this.m_type}SetBullet(t){this.m_bulletFlag=t}IsBullet(){return this.m_bulletFlag}SetSleepingAllowed(t){this.m_autoSleepFlag=t,t||this.SetAwake(!0)}IsSleepingAllowed(){return this.m_autoSleepFlag}SetAwake(t){this.m_type!==Ai.b2_staticBody&&(t?(this.m_awakeFlag=!0,this.m_sleepTime=0):(this.m_awakeFlag=!1,this.m_sleepTime=0,this.m_linearVelocity.SetZero(),this.m_angularVelocity=0,this.m_force.SetZero(),this.m_torque=0))}IsAwake(){return this.m_awakeFlag}SetEnabled(t){if(this.m_world.IsLocked())throw new Error;if(t!==this.IsEnabled())if(this.m_enabledFlag=t,t){for(let t=this.m_fixtureList;t;t=t.m_next)t.CreateProxies();this.m_world.m_newContacts=!0}else{for(let t=this.m_fixtureList;t;t=t.m_next)t.DestroyProxies();let t=this.m_contactList;for(;t;){const e=t;t=t.next,this.m_world.m_contactManager.Destroy(e.contact)}this.m_contactList=null}}IsEnabled(){return this.m_enabledFlag}SetFixedRotation(t){this.m_fixedRotationFlag!==t&&(this.m_fixedRotationFlag=t,this.m_angularVelocity=0,this.ResetMassData())}IsFixedRotation(){return this.m_fixedRotationFlag}GetFixtureList(){return this.m_fixtureList}GetJointList(){return this.m_jointList}GetContactList(){return this.m_contactList}GetNext(){return this.m_next}GetUserData(){return this.m_userData}SetUserData(t){this.m_userData=t}GetWorld(){return this.m_world}Dump(t){const e=this.m_islandIndex;t("{\n"),t("  const bd: b2BodyDef = new b2BodyDef();\n");let i="";switch(this.m_type){case Ai.b2_staticBody:i="b2BodyType.b2_staticBody";break;case Ai.b2_kinematicBody:i="b2BodyType.b2_kinematicBody";break;case Ai.b2_dynamicBody:i="b2BodyType.b2_dynamicBody"}t("  bd.type = %s;\n",i),t("  bd.position.Set(%.15f, %.15f);\n",this.m_xf.p.x,this.m_xf.p.y),t("  bd.angle = %.15f;\n",this.m_sweep.a),t("  bd.linearVelocity.Set(%.15f, %.15f);\n",this.m_linearVelocity.x,this.m_linearVelocity.y),t("  bd.angularVelocity = %.15f;\n",this.m_angularVelocity),t("  bd.linearDamping = %.15f;\n",this.m_linearDamping),t("  bd.angularDamping = %.15f;\n",this.m_angularDamping),t("  bd.allowSleep = %s;\n",this.m_autoSleepFlag?"true":"false"),t("  bd.awake = %s;\n",this.m_awakeFlag?"true":"false"),t("  bd.fixedRotation = %s;\n",this.m_fixedRotationFlag?"true":"false"),t("  bd.bullet = %s;\n",this.m_bulletFlag?"true":"false"),t("  bd.active = %s;\n",this.m_enabledFlag?"true":"false"),t("  bd.gravityScale = %.15f;\n",this.m_gravityScale),t("\n"),t("  bodies[%d] = this.m_world.CreateBody(bd);\n",this.m_islandIndex),t("\n");for(let i=this.m_fixtureList;i;i=i.m_next)t("  {\n"),i.Dump(t,e),t("  }\n");t("}\n")}SynchronizeFixtures(){if(this.m_awakeFlag){const t=Di.SynchronizeFixtures_s_xf1;t.q.SetAngle(this.m_sweep.a0),Fe.MulRV(t.q,this.m_sweep.localCenter,t.p),Ie.SubVV(this.m_sweep.c0,t.p,t.p);for(let e=this.m_fixtureList;e;e=e.m_next)e.SynchronizeProxies(t,this.m_xf)}else for(let t=this.m_fixtureList;t;t=t.m_next)t.SynchronizeProxies(this.m_xf,this.m_xf)}SynchronizeTransform(){this.m_xf.q.SetAngle(this.m_sweep.a),Fe.MulRV(this.m_xf.q,this.m_sweep.localCenter,this.m_xf.p),Ie.SubVV(this.m_sweep.c,this.m_xf.p,this.m_xf.p)}ShouldCollide(t){return(this.m_type!==Ai.b2_staticBody||t.m_type!==Ai.b2_staticBody)&&this.ShouldCollideConnected(t)}ShouldCollideConnected(t){for(let e=this.m_jointList;e;e=e.next)if(e.other===t&&!e.joint.m_collideConnected)return!1;return!0}Advance(t){this.m_sweep.Advance(t),this.m_sweep.c.Copy(this.m_sweep.c0),this.m_sweep.a=this.m_sweep.a0,this.m_xf.q.SetAngle(this.m_sweep.a),Fe.MulRV(this.m_xf.q,this.m_sweep.localCenter,this.m_xf.p),Ie.SubVV(this.m_sweep.c,this.m_xf.p,this.m_xf.p)}GetControllerList(){return this.m_controllerList}GetControllerCount(){return this.m_controllerCount}}Di.CreateFixtureShapeDensity_s_def=new Si,Di.SetMassData_s_oldCenter=new Ie,Di.ResetMassData_s_localCenter=new Ie,Di.ResetMassData_s_oldCenter=new Ie,Di.ResetMassData_s_massData=new Le,Di.SynchronizeFixtures_s_xf1=new ke;class Ii{ShouldCollide(t,e){const i=t.GetBody(),s=e.GetBody();if(s.GetType()===Ai.b2_staticBody&&i.GetType()===Ai.b2_staticBody)return!1;if(!s.ShouldCollideConnected(i))return!1;const r=t.GetFilterData(),n=e.GetFilterData();return r.groupIndex===n.groupIndex&&0!==r.groupIndex?r.groupIndex>0:0!=(r.maskBits&n.categoryBits)&&0!=(r.categoryBits&n.maskBits)}ShouldCollideFixtureParticle(t,e,i){return!0}ShouldCollideParticleParticle(t,e,i){return!0}}Ii.b2_defaultFilter=new Ii;class Pi{BeginContact(t){}EndContact(t){}BeginContactFixtureParticle(t,e){}EndContactFixtureParticle(t,e){}BeginContactParticleParticle(t,e){}EndContactParticleParticle(t,e){}PreSolve(t,e){}PostSolve(t,e){}}Pi.b2_defaultListener=new Pi;class Gi{ReportFixture(t){return!0}ReportParticle(t,e){return!1}ShouldQueryParticleSystem(t){return!0}}class Ti{ReportFixture(t,e,i,s){return s}ReportParticle(t,e,i,s,r){return 0}ShouldQueryParticleSystem(t){return!0}}class Ri extends je{constructor(){super(Oe.e_polygonShape,.01),this.m_centroid=new Ie(0,0),this.m_vertices=[],this.m_normals=[],this.m_count=0}Clone(){return(new Ri).Copy(this)}Copy(t){super.Copy(t),this.m_centroid.Copy(t.m_centroid),this.m_count=t.m_count,this.m_vertices=Ie.MakeArray(this.m_count),this.m_normals=Ie.MakeArray(this.m_count);for(let e=0;e<this.m_count;++e)this.m_vertices[e].Copy(t.m_vertices[e]),this.m_normals[e].Copy(t.m_normals[e]);return this}GetChildCount(){return 1}Set(...t){if("number"==typeof t[0][0]){const e=t[0];if(e.length%2!=0)throw new Error;return this._Set((t=>({x:e[2*t],y:e[2*t+1]})),e.length/2)}{const e=t[0],i=t[1]||e.length;return this._Set((t=>e[t]),i)}}_Set(t,e){if(e<3)return this.SetAsBox(1,1);let i=e;const s=[];for(let e=0;e<i;++e){const i=t(e);let r=!0;for(let t=0;t<s.length;++t)if(Ie.DistanceSquaredVV(i,s[t])<625e-8){r=!1;break}r&&s.push(i)}if(i=s.length,i<3)return this.SetAsBox(1,1);let r=0,n=s[0].x;for(let t=1;t<i;++t){const e=s[t].x;(e>n||e===n&&s[t].y<s[r].y)&&(r=t,n=e)}const o=[];let h=0,a=r;for(;;){o[h]=a;let t=0;for(let e=1;e<i;++e){if(t===a){t=e;continue}const i=Ie.SubVV(s[t],s[o[h]],Ri.Set_s_r),r=Ie.SubVV(s[e],s[o[h]],Ri.Set_s_v),n=Ie.CrossVV(i,r);n<0&&(t=e),0===n&&r.LengthSquared()>i.LengthSquared()&&(t=e)}if(++h,a=t,t===r)break}this.m_count=h,this.m_vertices=Ie.MakeArray(this.m_count),this.m_normals=Ie.MakeArray(this.m_count);for(let t=0;t<h;++t)this.m_vertices[t].Copy(s[o[t]]);for(let t=0;t<h;++t){const e=this.m_vertices[t],i=this.m_vertices[(t+1)%h],s=Ie.SubVV(i,e,Ie.s_t0);Ie.CrossVOne(s,this.m_normals[t]).SelfNormalize()}return Ri.ComputeCentroid(this.m_vertices,h,this.m_centroid),this}SetAsBox(t,e,i,s=0){if(this.m_count=4,this.m_vertices=Ie.MakeArray(this.m_count),this.m_normals=Ie.MakeArray(this.m_count),this.m_vertices[0].Set(-t,-e),this.m_vertices[1].Set(t,-e),this.m_vertices[2].Set(t,e),this.m_vertices[3].Set(-t,e),this.m_normals[0].Set(0,-1),this.m_normals[1].Set(1,0),this.m_normals[2].Set(0,1),this.m_normals[3].Set(-1,0),this.m_centroid.SetZero(),i){this.m_centroid.Copy(i);const t=new ke;t.SetPosition(i),t.SetRotationAngle(s);for(let e=0;e<this.m_count;++e)ke.MulXV(t,this.m_vertices[e],this.m_vertices[e]),Fe.MulRV(t.q,this.m_normals[e],this.m_normals[e])}return this}TestPoint(t,e){const i=ke.MulTXV(t,e,Ri.TestPoint_s_pLocal);for(let t=0;t<this.m_count;++t)if(Ie.DotVV(this.m_normals[t],Ie.SubVV(i,this.m_vertices[t],Ie.s_t0))>0)return!1;return!0}ComputeDistance(t,e,i,s){const r=ke.MulTXV(t,e,Ri.ComputeDistance_s_pLocal);let n=-ce;const o=Ri.ComputeDistance_s_normalForMaxDistance.Copy(r);for(let t=0;t<this.m_count;++t){const e=Ie.DotVV(this.m_normals[t],Ie.SubVV(r,this.m_vertices[t],Ie.s_t0));e>n&&(n=e,o.Copy(this.m_normals[t]))}if(n>0){const e=Ri.ComputeDistance_s_minDistance.Copy(o);let s=n*n;for(let t=0;t<this.m_count;++t){const i=Ie.SubVV(r,this.m_vertices[t],Ri.ComputeDistance_s_distance),n=i.LengthSquared();s>n&&(e.Copy(i),s=n)}return Fe.MulRV(t.q,e,i),i.Normalize(),Math.sqrt(s)}return Fe.MulRV(t.q,o,i),n}RayCast(t,e,i,s){const r=ke.MulTXV(i,e.p1,Ri.RayCast_s_p1),n=ke.MulTXV(i,e.p2,Ri.RayCast_s_p2),o=Ie.SubVV(n,r,Ri.RayCast_s_d);let h=0,a=e.maxFraction,l=-1;for(let t=0;t<this.m_count;++t){const e=Ie.DotVV(this.m_normals[t],Ie.SubVV(this.m_vertices[t],r,Ie.s_t0)),i=Ie.DotVV(this.m_normals[t],o);if(0===i){if(e<0)return!1}else i<0&&e<h*i?(h=e/i,l=t):i>0&&e<a*i&&(a=e/i);if(a<h)return!1}return l>=0&&(t.fraction=h,Fe.MulRV(i.q,this.m_normals[l],t.normal),!0)}ComputeAABB(t,e,i){const s=ke.MulXV(e,this.m_vertices[0],t.lowerBound),r=t.upperBound.Copy(s);for(let t=0;t<this.m_count;++t){const i=ke.MulXV(e,this.m_vertices[t],Ri.ComputeAABB_s_v);Ie.MinV(i,s,s),Ie.MaxV(i,r,r)}const n=this.m_radius;s.SelfSubXY(n,n),r.SelfAddXY(n,n)}ComputeMass(t,e){const i=Ri.ComputeMass_s_center.SetZero();let s=0,r=0;const n=Ri.ComputeMass_s_s.Copy(this.m_vertices[0]),o=1/3;for(let t=0;t<this.m_count;++t){const e=Ie.SubVV(this.m_vertices[t],n,Ri.ComputeMass_s_e1),h=Ie.SubVV(this.m_vertices[(t+1)%this.m_count],n,Ri.ComputeMass_s_e2),a=Ie.CrossVV(e,h),l=.5*a;s+=l,i.SelfAdd(Ie.MulSV(l*o,Ie.AddVV(e,h,Ie.s_t0),Ie.s_t1));const m=e.x,c=e.y,u=h.x,_=h.y;r+=.25*o*a*(m*m+u*m+u*u+(c*c+_*c+_*_))}t.mass=e*s,i.SelfMul(1/s),Ie.AddVV(i,n,t.center),t.I=e*r,t.I+=t.mass*(Ie.DotVV(t.center,t.center)-Ie.DotVV(i,i))}Validate(){for(let t=0;t<this.m_count;++t){const e=t,i=(t+1)%this.m_count,s=this.m_vertices[e],r=Ie.SubVV(this.m_vertices[i],s,Ri.Validate_s_e);for(let t=0;t<this.m_count;++t){if(t===e||t===i)continue;const n=Ie.SubVV(this.m_vertices[t],s,Ri.Validate_s_v);if(Ie.CrossVV(r,n)<0)return!1}}return!0}SetupDistanceProxy(t,e){t.m_vertices=this.m_vertices,t.m_count=this.m_count,t.m_radius=this.m_radius}ComputeSubmergedArea(t,e,i,s){const r=Fe.MulTRV(i.q,t,Ri.ComputeSubmergedArea_s_normalL),n=e-Ie.DotVV(t,i.p),o=[];let h=0,a=-1,l=-1,m=!1;for(let t=0;t<this.m_count;++t){o[t]=Ie.DotVV(r,this.m_vertices[t])-n;const e=o[t]<-1e-5;t>0&&(e?m||(a=t-1,h++):m&&(l=t-1,h++)),m=e}switch(h){case 0:if(m){const t=Ri.ComputeSubmergedArea_s_md;return this.ComputeMass(t,1),ke.MulXV(i,t.center,s),t.mass}return 0;case 1:-1===a?a=this.m_count-1:l=this.m_count-1}const c=(a+1)%this.m_count,u=(l+1)%this.m_count,_=(0-o[a])/(o[c]-o[a]),d=(0-o[l])/(o[u]-o[l]),p=Ri.ComputeSubmergedArea_s_intoVec.Set(this.m_vertices[a].x*(1-_)+this.m_vertices[c].x*_,this.m_vertices[a].y*(1-_)+this.m_vertices[c].y*_),f=Ri.ComputeSubmergedArea_s_outoVec.Set(this.m_vertices[l].x*(1-d)+this.m_vertices[u].x*d,this.m_vertices[l].y*(1-d)+this.m_vertices[u].y*d);let y=0;const x=Ri.ComputeSubmergedArea_s_center.SetZero();let g,w=this.m_vertices[c],C=c;for(;C!==u;){C=(C+1)%this.m_count,g=C===u?f:this.m_vertices[C];const t=.5*((w.x-p.x)*(g.y-p.y)-(w.y-p.y)*(g.x-p.x));y+=t,x.x+=t*(p.x+w.x+g.x)/3,x.y+=t*(p.y+w.y+g.y)/3,w=g}return x.SelfMul(1/y),ke.MulXV(i,x,s),y}Dump(t){t("    const shape: b2PolygonShape = new b2PolygonShape();\n"),t("    const vs: b2Vec2[] = [];\n");for(let e=0;e<this.m_count;++e)t("    vs[%d] = new b2Vec2(%.15f, %.15f);\n",e,this.m_vertices[e].x,this.m_vertices[e].y);t("    shape.Set(vs, %d);\n",this.m_count)}static ComputeCentroid(t,e,i){const s=i;s.SetZero();let r=0;const n=Ri.ComputeCentroid_s_s.Copy(t[0]),o=1/3;for(let i=0;i<e;++i){const h=Ie.SubVV(t[0],n,Ri.ComputeCentroid_s_p1),a=Ie.SubVV(t[i],n,Ri.ComputeCentroid_s_p2),l=Ie.SubVV(t[(i+1)%e],n,Ri.ComputeCentroid_s_p3),m=Ie.SubVV(a,h,Ri.ComputeCentroid_s_e1),c=Ie.SubVV(l,h,Ri.ComputeCentroid_s_e2),u=.5*Ie.CrossVV(m,c);r+=u,s.x+=u*o*(h.x+a.x+l.x),s.y+=u*o*(h.y+a.y+l.y)}return s.x=1/r*s.x+n.x,s.y=1/r*s.y+n.y,s}}Ri.Set_s_r=new Ie,Ri.Set_s_v=new Ie,Ri.TestPoint_s_pLocal=new Ie,Ri.ComputeDistance_s_pLocal=new Ie,Ri.ComputeDistance_s_normalForMaxDistance=new Ie,Ri.ComputeDistance_s_minDistance=new Ie,Ri.ComputeDistance_s_distance=new Ie,Ri.RayCast_s_p1=new Ie,Ri.RayCast_s_p2=new Ie,Ri.RayCast_s_d=new Ie,Ri.ComputeAABB_s_v=new Ie,Ri.ComputeMass_s_center=new Ie,Ri.ComputeMass_s_s=new Ie,Ri.ComputeMass_s_e1=new Ie,Ri.ComputeMass_s_e2=new Ie,Ri.Validate_s_e=new Ie,Ri.Validate_s_v=new Ie,Ri.ComputeSubmergedArea_s_normalL=new Ie,Ri.ComputeSubmergedArea_s_md=new Le,Ri.ComputeSubmergedArea_s_intoVec=new Ie,Ri.ComputeSubmergedArea_s_outoVec=new Ie,Ri.ComputeSubmergedArea_s_center=new Ie,Ri.ComputeCentroid_s_s=new Ie,Ri.ComputeCentroid_s_p1=new Ie,Ri.ComputeCentroid_s_p2=new Ie,Ri.ComputeCentroid_s_p3=new Ie,Ri.ComputeCentroid_s_e1=new Ie,Ri.ComputeCentroid_s_e2=new Ie;class Fi{constructor(){this.m_start=Date.now()}Reset(){return this.m_start=Date.now(),this}GetMilliseconds(){return Date.now()-this.m_start}}class ki{constructor(t=.5,e=.5,i=.5,s=1){this.r=t,this.g=e,this.b=i,this.a=s}Clone(){return(new ki).Copy(this)}Copy(t){return this.r=t.r,this.g=t.g,this.b=t.b,this.a=t.a,this}IsEqual(t){return this.r===t.r&&this.g===t.g&&this.b===t.b&&this.a===t.a}IsZero(){return 0===this.r&&0===this.g&&0===this.b&&0===this.a}Set(t,e,i,s=this.a){this.SetRGBA(t,e,i,s)}SetByteRGB(t,e,i){return this.r=t/255,this.g=e/255,this.b=i/255,this}SetByteRGBA(t,e,i,s){return this.r=t/255,this.g=e/255,this.b=i/255,this.a=s/255,this}SetRGB(t,e,i){return this.r=t,this.g=e,this.b=i,this}SetRGBA(t,e,i,s){return this.r=t,this.g=e,this.b=i,this.a=s,this}SelfAdd(t){return this.r+=t.r,this.g+=t.g,this.b+=t.b,this.a+=t.a,this}Add(t,e){return e.r=this.r+t.r,e.g=this.g+t.g,e.b=this.b+t.b,e.a=this.a+t.a,e}SelfSub(t){return this.r-=t.r,this.g-=t.g,this.b-=t.b,this.a-=t.a,this}Sub(t,e){return e.r=this.r-t.r,e.g=this.g-t.g,e.b=this.b-t.b,e.a=this.a-t.a,e}SelfMul(t){return this.r*=t,this.g*=t,this.b*=t,this.a*=t,this}Mul(t,e){return e.r=this.r*t,e.g=this.g*t,e.b=this.b*t,e.a=this.a*t,e}Mix(t,e){ki.MixColors(this,t,e)}static MixColors(t,e,i){const s=i*(e.r-t.r),r=i*(e.g-t.g),n=i*(e.b-t.b),o=i*(e.a-t.a);t.r+=s,t.g+=r,t.b+=n,t.a+=o,e.r-=s,e.g-=r,e.b-=n,e.a-=o}MakeStyleString(t=this.a){return ki.MakeStyleString(this.r,this.g,this.b,t)}static MakeStyleString(t,e,i,s=1){return t*=255,e*=255,i*=255,s<1?`rgba(${t},${e},${i},${s})`:`rgb(${t},${e},${i})`}}ki.ZERO=new ki(0,0,0,0),ki.RED=new ki(1,0,0),ki.GREEN=new ki(0,1,0),ki.BLUE=new ki(0,0,1);class Ei{constructor(...t){if(t[0]instanceof Float32Array){if(4!==t[0].length)throw new Error;this.data=t[0]}else{const e="number"==typeof t[0]?t[0]:.5,i="number"==typeof t[1]?t[1]:.5,s="number"==typeof t[2]?t[2]:.5,r="number"==typeof t[3]?t[3]:1;this.data=new Float32Array([e,i,s,r])}}get r(){return this.data[0]}set r(t){this.data[0]=t}get g(){return this.data[1]}set g(t){this.data[1]=t}get b(){return this.data[2]}set b(t){this.data[2]=t}get a(){return this.data[3]}set a(t){this.data[3]=t}Clone(){return new Ei(new Float32Array(this.data))}Copy(t){return t instanceof Ei?this.data.set(t.data):(this.r=t.r,this.g=t.g,this.b=t.b,this.a=t.a),this}IsEqual(t){return this.r===t.r&&this.g===t.g&&this.b===t.b&&this.a===t.a}IsZero(){return 0===this.r&&0===this.g&&0===this.b&&0===this.a}Set(t,e,i,s=this.a){this.SetRGBA(t,e,i,s)}SetByteRGB(t,e,i){return this.r=t/255,this.g=e/255,this.b=i/255,this}SetByteRGBA(t,e,i,s){return this.r=t/255,this.g=e/255,this.b=i/255,this.a=s/255,this}SetRGB(t,e,i){return this.r=t,this.g=e,this.b=i,this}SetRGBA(t,e,i,s){return this.r=t,this.g=e,this.b=i,this.a=s,this}SelfAdd(t){return this.r+=t.r,this.g+=t.g,this.b+=t.b,this.a+=t.a,this}Add(t,e){return e.r=this.r+t.r,e.g=this.g+t.g,e.b=this.b+t.b,e.a=this.a+t.a,e}SelfSub(t){return this.r-=t.r,this.g-=t.g,this.b-=t.b,this.a-=t.a,this}Sub(t,e){return e.r=this.r-t.r,e.g=this.g-t.g,e.b=this.b-t.b,e.a=this.a-t.a,e}SelfMul(t){return this.r*=t,this.g*=t,this.b*=t,this.a*=t,this}Mul(t,e){return e.r=this.r*t,e.g=this.g*t,e.b=this.b*t,e.a=this.a*t,e}Mix(t,e){ki.MixColors(this,t,e)}MakeStyleString(t=this.a){return ki.MakeStyleString(this.r,this.g,this.b,t)}}!function(t){t[t.e_none=0]="e_none",t[t.e_shapeBit=1]="e_shapeBit",t[t.e_jointBit=2]="e_jointBit",t[t.e_aabbBit=4]="e_aabbBit",t[t.e_pairBit=8]="e_pairBit",t[t.e_centerOfMassBit=16]="e_centerOfMassBit",t[t.e_particleBit=32]="e_particleBit",t[t.e_controllerBit=64]="e_controllerBit",t[t.e_all=63]="e_all"}(Vi||(Vi={}));let Li=0,Oi=0,zi=0,ji=0;const qi=new ke,Ni=new ke,Wi=new Ie,Xi=new Ie,Ui=new Ie,Ji=new Ie,Zi=new Ie;class Hi{constructor(){this.proxyA=new qe,this.proxyB=new qe,this.sweepA=new Ee,this.sweepB=new Ee,this.tMax=0}}var Yi,Qi;!function(t){t[t.e_unknown=0]="e_unknown",t[t.e_failed=1]="e_failed",t[t.e_overlapped=2]="e_overlapped",t[t.e_touching=3]="e_touching",t[t.e_separated=4]="e_separated"}(Yi||(Yi={}));class Ki{constructor(){this.state=Yi.e_unknown,this.t=0}}!function(t){t[t.e_unknown=-1]="e_unknown",t[t.e_points=0]="e_points",t[t.e_faceA=1]="e_faceA",t[t.e_faceB=2]="e_faceB"}(Qi||(Qi={}));const $i=new Fi,ts=new Ne,es=new We,is=new Xe,ss=new class{constructor(){this.m_sweepA=new Ee,this.m_sweepB=new Ee,this.m_type=Qi.e_unknown,this.m_localPoint=new Ie,this.m_axis=new Ie}Initialize(t,e,i,s,r,n){this.m_proxyA=e,this.m_proxyB=s;const o=t.count;this.m_sweepA.Copy(i),this.m_sweepB.Copy(r);const h=qi,a=Ni;if(this.m_sweepA.GetTransform(h,n),this.m_sweepB.GetTransform(a,n),1===o){this.m_type=Qi.e_points;const e=this.m_proxyA.GetVertex(t.indexA[0]),i=this.m_proxyB.GetVertex(t.indexB[0]),s=ke.MulXV(h,e,Wi),r=ke.MulXV(a,i,Xi);Ie.SubVV(r,s,this.m_axis);const n=this.m_axis.Normalize();return this.m_localPoint.SetZero(),n}if(t.indexA[0]===t.indexA[1]){this.m_type=Qi.e_faceB;const e=this.m_proxyB.GetVertex(t.indexB[0]),i=this.m_proxyB.GetVertex(t.indexB[1]);Ie.CrossVOne(Ie.SubVV(i,e,Ie.s_t0),this.m_axis).SelfNormalize();const s=Fe.MulRV(a.q,this.m_axis,Ui);Ie.MidVV(e,i,this.m_localPoint);const r=ke.MulXV(a,this.m_localPoint,Xi),n=this.m_proxyA.GetVertex(t.indexA[0]),o=ke.MulXV(h,n,Wi);let l=Ie.DotVV(Ie.SubVV(o,r,Ie.s_t0),s);return l<0&&(this.m_axis.SelfNeg(),l=-l),l}{this.m_type=Qi.e_faceA;const e=this.m_proxyA.GetVertex(t.indexA[0]),i=this.m_proxyA.GetVertex(t.indexA[1]);Ie.CrossVOne(Ie.SubVV(i,e,Ie.s_t0),this.m_axis).SelfNormalize();const s=Fe.MulRV(h.q,this.m_axis,Ui);Ie.MidVV(e,i,this.m_localPoint);const r=ke.MulXV(h,this.m_localPoint,Wi),n=this.m_proxyB.GetVertex(t.indexB[0]),o=ke.MulXV(a,n,Xi);let l=Ie.DotVV(Ie.SubVV(o,r,Ie.s_t0),s);return l<0&&(this.m_axis.SelfNeg(),l=-l),l}}FindMinSeparation(t,e,i){const s=qi,r=Ni;switch(this.m_sweepA.GetTransform(s,i),this.m_sweepB.GetTransform(r,i),this.m_type){case Qi.e_points:{const i=Fe.MulTRV(s.q,this.m_axis,Ji),n=Fe.MulTRV(r.q,Ie.NegV(this.m_axis,Ie.s_t0),Zi);t[0]=this.m_proxyA.GetSupport(i),e[0]=this.m_proxyB.GetSupport(n);const o=this.m_proxyA.GetVertex(t[0]),h=this.m_proxyB.GetVertex(e[0]),a=ke.MulXV(s,o,Wi),l=ke.MulXV(r,h,Xi);return Ie.DotVV(Ie.SubVV(l,a,Ie.s_t0),this.m_axis)}case Qi.e_faceA:{const i=Fe.MulRV(s.q,this.m_axis,Ui),n=ke.MulXV(s,this.m_localPoint,Wi),o=Fe.MulTRV(r.q,Ie.NegV(i,Ie.s_t0),Zi);t[0]=-1,e[0]=this.m_proxyB.GetSupport(o);const h=this.m_proxyB.GetVertex(e[0]),a=ke.MulXV(r,h,Xi);return Ie.DotVV(Ie.SubVV(a,n,Ie.s_t0),i)}case Qi.e_faceB:{const i=Fe.MulRV(r.q,this.m_axis,Ui),n=ke.MulXV(r,this.m_localPoint,Xi),o=Fe.MulTRV(s.q,Ie.NegV(i,Ie.s_t0),Ji);e[0]=-1,t[0]=this.m_proxyA.GetSupport(o);const h=this.m_proxyA.GetVertex(t[0]),a=ke.MulXV(s,h,Wi);return Ie.DotVV(Ie.SubVV(a,n,Ie.s_t0),i)}default:return t[0]=-1,e[0]=-1,0}}Evaluate(t,e,i){const s=qi,r=Ni;switch(this.m_sweepA.GetTransform(s,i),this.m_sweepB.GetTransform(r,i),this.m_type){case Qi.e_points:{const i=this.m_proxyA.GetVertex(t),n=this.m_proxyB.GetVertex(e),o=ke.MulXV(s,i,Wi),h=ke.MulXV(r,n,Xi);return Ie.DotVV(Ie.SubVV(h,o,Ie.s_t0),this.m_axis)}case Qi.e_faceA:{const t=Fe.MulRV(s.q,this.m_axis,Ui),i=ke.MulXV(s,this.m_localPoint,Wi),n=this.m_proxyB.GetVertex(e),o=ke.MulXV(r,n,Xi);return Ie.DotVV(Ie.SubVV(o,i,Ie.s_t0),t)}case Qi.e_faceB:{const e=Fe.MulRV(r.q,this.m_axis,Ui),i=ke.MulXV(r,this.m_localPoint,Xi),n=this.m_proxyA.GetVertex(t),o=ke.MulXV(s,n,Wi);return Ie.DotVV(Ie.SubVV(o,i,Ie.s_t0),e)}default:return 0}}},rs=[0],ns=[0],os=new Ee,hs=new Ee;function as(t,e){const i=$i.Reset();t.state=Yi.e_unknown,t.t=e.tMax;const s=e.proxyA,r=e.proxyB,n=Be(8,Be(s.m_count,r.m_count)),o=os.Copy(e.sweepA),h=hs.Copy(e.sweepB);o.Normalize(),h.Normalize();const a=e.tMax,l=s.m_radius+r.m_radius,m=Be(de,l-.015),c=.00125;let u=0,_=0;const d=ts;d.count=0;const p=es;for(p.proxyA.Copy(e.proxyA),p.proxyB.Copy(e.proxyB),p.useRadii=!1;;){const e=qi,i=Ni;o.GetTransform(e,u),h.GetTransform(i,u),p.transformA.Copy(e),p.transformB.Copy(i);const l=is;if(si(l,d,p),l.distance<=0){t.state=Yi.e_overlapped,t.t=0;break}if(l.distance<m+c){t.state=Yi.e_touching,t.t=u;break}const f=ss;f.Initialize(d,s,o,r,h,u);let y=!1,x=a,g=0;for(;;){const e=rs,i=ns;let s=f.FindMinSeparation(e,i,x);if(s>m+c){t.state=Yi.e_separated,t.t=a,y=!0;break}if(s>m-c){u=x;break}let r=f.Evaluate(e[0],i[0],u);if(r<m-c){t.state=Yi.e_failed,t.t=u,y=!0;break}if(r<=m+c){t.state=Yi.e_touching,t.t=u,y=!0;break}let o=0,h=u,l=x;for(;;){let t=0;t=1&o?h+(m-r)*(l-h)/(s-r):.5*(h+l),++o;const n=f.Evaluate(e[0],i[0],t);if(Se(n-m)<c){x=t;break}if(n>m?(h=t,r=n):(l=t,s=n),50===o)break}if(ji=Be(ji,o),++g,g===n)break}if(++_,y)break;if(20===_){t.state=Yi.e_failed,t.t=u;break}}zi=Be(zi,_);const f=i.GetMilliseconds();Oi=Be(Oi,f),Li+=f}var ls;!function(t){t[t.e_unknownJoint=0]="e_unknownJoint",t[t.e_revoluteJoint=1]="e_revoluteJoint",t[t.e_prismaticJoint=2]="e_prismaticJoint",t[t.e_distanceJoint=3]="e_distanceJoint",t[t.e_pulleyJoint=4]="e_pulleyJoint",t[t.e_mouseJoint=5]="e_mouseJoint",t[t.e_gearJoint=6]="e_gearJoint",t[t.e_wheelJoint=7]="e_wheelJoint",t[t.e_weldJoint=8]="e_weldJoint",t[t.e_frictionJoint=9]="e_frictionJoint",t[t.e_ropeJoint=10]="e_ropeJoint",t[t.e_motorJoint=11]="e_motorJoint",t[t.e_areaJoint=12]="e_areaJoint"}(ls||(ls={}));class ms{constructor(t){this._other=null,this.prev=null,this.next=null,this.joint=t}get other(){if(null===this._other)throw new Error;return this._other}set other(t){if(null!==this._other)throw new Error;this._other=t}Reset(){this._other=null,this.prev=null,this.next=null}}class cs{constructor(t){this.m_type=ls.e_unknownJoint,this.m_prev=null,this.m_next=null,this.m_edgeA=new ms(this),this.m_edgeB=new ms(this),this.m_index=0,this.m_islandFlag=!1,this.m_collideConnected=!1,this.m_userData=null,this.m_type=t.type,this.m_edgeA.other=t.bodyB,this.m_edgeB.other=t.bodyA,this.m_bodyA=t.bodyA,this.m_bodyB=t.bodyB,this.m_collideConnected=me(t.collideConnected,!1),this.m_userData=me(t.userData,null)}GetType(){return this.m_type}GetBodyA(){return this.m_bodyA}GetBodyB(){return this.m_bodyB}GetNext(){return this.m_next}GetUserData(){return this.m_userData}SetUserData(t){this.m_userData=t}IsEnabled(){return this.m_bodyA.IsEnabled()&&this.m_bodyB.IsEnabled()}GetCollideConnected(){return this.m_collideConnected}Dump(t){t("// Dump is not supported for this joint type.\n")}ShiftOrigin(t){}Draw(t){const e=this.m_bodyA.GetTransform(),i=this.m_bodyB.GetTransform(),s=e.p,r=i.p,n=this.GetAnchorA(cs.Draw_s_p1),o=this.GetAnchorB(cs.Draw_s_p2),h=cs.Draw_s_color.SetRGB(.5,.8,.8);switch(this.m_type){case ls.e_distanceJoint:t.DrawSegment(n,o,h);break;case ls.e_pulleyJoint:{const e=this,i=e.GetGroundAnchorA(),s=e.GetGroundAnchorB();t.DrawSegment(i,n,h),t.DrawSegment(s,o,h),t.DrawSegment(i,s,h)}break;case ls.e_mouseJoint:{const e=cs.Draw_s_c;e.Set(0,1,0),t.DrawPoint(n,4,e),t.DrawPoint(o,4,e),e.Set(.8,.8,.8),t.DrawSegment(n,o,e)}break;default:t.DrawSegment(s,n,h),t.DrawSegment(n,o,h),t.DrawSegment(r,o,h)}}}cs.Draw_s_p1=new Ie,cs.Draw_s_p2=new Ie,cs.Draw_s_color=new ki(.5,.8,.8),cs.Draw_s_c=new ki;class us extends class{constructor(t){this.type=ls.e_unknownJoint,this.userData=null,this.collideConnected=!1,this.type=t}}{constructor(){super(ls.e_distanceJoint),this.localAnchorA=new Ie,this.localAnchorB=new Ie,this.length=1,this.minLength=0,this.maxLength=ce,this.stiffness=0,this.damping=0}Initialize(t,e,i,s){this.bodyA=t,this.bodyB=e,this.bodyA.GetLocalPoint(i,this.localAnchorA),this.bodyB.GetLocalPoint(s,this.localAnchorB),this.length=Be(Ie.DistanceVV(i,s),de),this.minLength=this.length,this.maxLength=this.length}}class _s extends cs{constructor(t){super(t),this.m_stiffness=0,this.m_damping=0,this.m_bias=0,this.m_length=0,this.m_minLength=0,this.m_maxLength=0,this.m_localAnchorA=new Ie,this.m_localAnchorB=new Ie,this.m_gamma=0,this.m_impulse=0,this.m_lowerImpulse=0,this.m_upperImpulse=0,this.m_indexA=0,this.m_indexB=0,this.m_u=new Ie,this.m_rA=new Ie,this.m_rB=new Ie,this.m_localCenterA=new Ie,this.m_localCenterB=new Ie,this.m_currentLength=0,this.m_invMassA=0,this.m_invMassB=0,this.m_invIA=0,this.m_invIB=0,this.m_softMass=0,this.m_mass=0,this.m_qA=new Fe,this.m_qB=new Fe,this.m_lalcA=new Ie,this.m_lalcB=new Ie,this.m_localAnchorA.Copy(me(t.localAnchorA,Ie.ZERO)),this.m_localAnchorB.Copy(me(t.localAnchorB,Ie.ZERO)),this.m_length=Be(me(t.length,this.GetCurrentLength()),de),this.m_minLength=Be(me(t.minLength,this.m_length),de),this.m_maxLength=Be(me(t.maxLength,this.m_length),this.m_minLength),this.m_stiffness=me(t.stiffness,0),this.m_damping=me(t.damping,0)}GetAnchorA(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)}GetAnchorB(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)}GetReactionForce(t,e){return e.x=t*(this.m_impulse+this.m_lowerImpulse-this.m_upperImpulse)*this.m_u.x,e.y=t*(this.m_impulse+this.m_lowerImpulse-this.m_upperImpulse)*this.m_u.y,e}GetReactionTorque(t){return 0}GetLocalAnchorA(){return this.m_localAnchorA}GetLocalAnchorB(){return this.m_localAnchorB}SetLength(t){return this.m_impulse=0,this.m_length=Be(de,t),this.m_length}GetLength(){return this.m_length}SetMinLength(t){return this.m_lowerImpulse=0,this.m_minLength=Ae(t,de,this.m_maxLength),this.m_minLength}SetMaxLength(t){return this.m_upperImpulse=0,this.m_maxLength=Be(t,this.m_minLength),this.m_maxLength}GetCurrentLength(){const t=this.m_bodyA.GetWorldPoint(this.m_localAnchorA,new Ie),e=this.m_bodyB.GetWorldPoint(this.m_localAnchorB,new Ie);return Ie.DistanceVV(t,e)}SetStiffness(t){this.m_stiffness=t}GetStiffness(){return this.m_stiffness}SetDamping(t){this.m_damping=t}GetDamping(){return this.m_damping}Dump(t){const e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t("  const jd: b2DistanceJointDef = new b2DistanceJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.length = %.15f;\n",this.m_length),t("  jd.minLength = %.15f;\n",this.m_minLength),t("  jd.maxLength = %.15f;\n",this.m_maxLength),t("  jd.stiffness = %.15f;\n",this.m_stiffness),t("  jd.damping = %.15f;\n",this.m_damping),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)}InitVelocityConstraints(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;const e=t.positions[this.m_indexA].c,i=t.positions[this.m_indexA].a,s=t.velocities[this.m_indexA].v;let r=t.velocities[this.m_indexA].w;const n=t.positions[this.m_indexB].c,o=t.positions[this.m_indexB].a,h=t.velocities[this.m_indexB].v;let a=t.velocities[this.m_indexB].w;const l=this.m_qA.SetAngle(i),m=this.m_qB.SetAngle(o);Ie.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA),Fe.MulRV(l,this.m_lalcA,this.m_rA),Ie.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),Fe.MulRV(m,this.m_lalcB,this.m_rB),this.m_u.x=n.x+this.m_rB.x-e.x-this.m_rA.x,this.m_u.y=n.y+this.m_rB.y-e.y-this.m_rA.y,this.m_currentLength=this.m_u.Length(),this.m_currentLength>de?this.m_u.SelfMul(1/this.m_currentLength):(this.m_u.SetZero(),this.m_mass=0,this.m_impulse=0,this.m_lowerImpulse=0,this.m_upperImpulse=0);const c=Ie.CrossVV(this.m_rA,this.m_u),u=Ie.CrossVV(this.m_rB,this.m_u);let _=this.m_invMassA+this.m_invIA*c*c+this.m_invMassB+this.m_invIB*u*u;if(this.m_mass=0!==_?1/_:0,this.m_stiffness>0&&this.m_minLength<this.m_maxLength){const e=this.m_currentLength-this.m_length,i=this.m_damping,s=this.m_stiffness,r=t.step.dt;this.m_gamma=r*(i+r*s),this.m_gamma=0!==this.m_gamma?1/this.m_gamma:0,this.m_bias=e*r*s*this.m_gamma,_+=this.m_gamma,this.m_softMass=0!==_?1/_:0}else this.m_gamma=0,this.m_bias=0,this.m_softMass=this.m_mass;if(t.step.warmStarting){this.m_impulse*=t.step.dtRatio,this.m_lowerImpulse*=t.step.dtRatio,this.m_upperImpulse*=t.step.dtRatio;const e=Ie.MulSV(this.m_impulse+this.m_lowerImpulse-this.m_upperImpulse,this.m_u,_s.InitVelocityConstraints_s_P);s.SelfMulSub(this.m_invMassA,e),r-=this.m_invIA*Ie.CrossVV(this.m_rA,e),h.SelfMulAdd(this.m_invMassB,e),a+=this.m_invIB*Ie.CrossVV(this.m_rB,e)}else this.m_impulse=0;t.velocities[this.m_indexA].w=r,t.velocities[this.m_indexB].w=a}SolveVelocityConstraints(t){const e=t.velocities[this.m_indexA].v;let i=t.velocities[this.m_indexA].w;const s=t.velocities[this.m_indexB].v;let r=t.velocities[this.m_indexB].w;if(this.m_minLength<this.m_maxLength){if(this.m_stiffness>0){const t=Ie.AddVCrossSV(e,i,this.m_rA,_s.SolveVelocityConstraints_s_vpA),n=Ie.AddVCrossSV(s,r,this.m_rB,_s.SolveVelocityConstraints_s_vpB),o=Ie.DotVV(this.m_u,Ie.SubVV(n,t,Ie.s_t0)),h=-this.m_softMass*(o+this.m_bias+this.m_gamma*this.m_impulse);this.m_impulse+=h;const a=Ie.MulSV(h,this.m_u,_s.SolveVelocityConstraints_s_P);e.SelfMulSub(this.m_invMassA,a),i-=this.m_invIA*Ie.CrossVV(this.m_rA,a),s.SelfMulAdd(this.m_invMassB,a),r+=this.m_invIB*Ie.CrossVV(this.m_rB,a)}{const n=Be(0,this.m_currentLength-this.m_minLength)*t.step.inv_dt,o=Ie.AddVCrossSV(e,i,this.m_rA,_s.SolveVelocityConstraints_s_vpA),h=Ie.AddVCrossSV(s,r,this.m_rB,_s.SolveVelocityConstraints_s_vpB),a=Ie.DotVV(this.m_u,Ie.SubVV(h,o,Ie.s_t0));let l=-this.m_mass*(a+n);const m=this.m_lowerImpulse;this.m_lowerImpulse=Be(0,this.m_lowerImpulse+l),l=this.m_lowerImpulse-m;const c=Ie.MulSV(l,this.m_u,_s.SolveVelocityConstraints_s_P);e.SelfMulSub(this.m_invMassA,c),i-=this.m_invIA*Ie.CrossVV(this.m_rA,c),s.SelfMulAdd(this.m_invMassB,c),r+=this.m_invIB*Ie.CrossVV(this.m_rB,c)}{const n=Be(0,this.m_maxLength-this.m_currentLength)*t.step.inv_dt,o=Ie.AddVCrossSV(e,i,this.m_rA,_s.SolveVelocityConstraints_s_vpA),h=Ie.AddVCrossSV(s,r,this.m_rB,_s.SolveVelocityConstraints_s_vpB),a=Ie.DotVV(this.m_u,Ie.SubVV(o,h,Ie.s_t0));let l=-this.m_mass*(a+n);const m=this.m_upperImpulse;this.m_upperImpulse=Be(0,this.m_upperImpulse+l),l=this.m_upperImpulse-m;const c=Ie.MulSV(-l,this.m_u,_s.SolveVelocityConstraints_s_P);e.SelfMulSub(this.m_invMassA,c),i-=this.m_invIA*Ie.CrossVV(this.m_rA,c),s.SelfMulAdd(this.m_invMassB,c),r+=this.m_invIB*Ie.CrossVV(this.m_rB,c)}}else{const t=Ie.AddVCrossSV(e,i,this.m_rA,_s.SolveVelocityConstraints_s_vpA),n=Ie.AddVCrossSV(s,r,this.m_rB,_s.SolveVelocityConstraints_s_vpB),o=Ie.DotVV(this.m_u,Ie.SubVV(n,t,Ie.s_t0)),h=-this.m_mass*o;this.m_impulse+=h;const a=Ie.MulSV(h,this.m_u,_s.SolveVelocityConstraints_s_P);e.SelfMulSub(this.m_invMassA,a),i-=this.m_invIA*Ie.CrossVV(this.m_rA,a),s.SelfMulAdd(this.m_invMassB,a),r+=this.m_invIB*Ie.CrossVV(this.m_rB,a)}t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=r}SolvePositionConstraints(t){const e=t.positions[this.m_indexA].c;let i=t.positions[this.m_indexA].a;const s=t.positions[this.m_indexB].c;let r=t.positions[this.m_indexB].a;const n=this.m_qA.SetAngle(i),o=this.m_qB.SetAngle(r),h=Fe.MulRV(n,this.m_lalcA,this.m_rA),a=Fe.MulRV(o,this.m_lalcB,this.m_rB),l=this.m_u;l.x=s.x+a.x-e.x-h.x,l.y=s.y+a.y-e.y-h.y;const m=this.m_u.Normalize();let c;if(this.m_minLength==this.m_maxLength)c=m-this.m_minLength;else if(m<this.m_minLength)c=m-this.m_minLength;else{if(!(this.m_maxLength<m))return!0;c=m-this.m_maxLength}const u=-this.m_mass*c,_=Ie.MulSV(u,l,_s.SolvePositionConstraints_s_P);return e.SelfMulSub(this.m_invMassA,_),i-=this.m_invIA*Ie.CrossVV(h,_),s.SelfMulAdd(this.m_invMassB,_),r+=this.m_invIB*Ie.CrossVV(a,_),t.positions[this.m_indexA].a=i,t.positions[this.m_indexB].a=r,Se(c)<de}Draw(t){const e=this.m_bodyA.GetTransform(),i=this.m_bodyB.GetTransform(),s=ke.MulXV(e,this.m_localAnchorA,_s.Draw_s_pA),r=ke.MulXV(i,this.m_localAnchorB,_s.Draw_s_pB),n=Ie.SubVV(r,s,_s.Draw_s_axis);n.Normalize();const o=_s.Draw_s_c1,h=_s.Draw_s_c2,a=_s.Draw_s_c3,l=_s.Draw_s_c4;t.DrawSegment(s,r,l);const m=Ie.AddVMulSV(s,this.m_length,n,_s.Draw_s_pRest);if(t.DrawPoint(m,8,o),this.m_minLength!=this.m_maxLength){if(this.m_minLength>de){const e=Ie.AddVMulSV(s,this.m_minLength,n,_s.Draw_s_pMin);t.DrawPoint(e,4,h)}if(this.m_maxLength<ce){const e=Ie.AddVMulSV(s,this.m_maxLength,n,_s.Draw_s_pMax);t.DrawPoint(e,4,a)}}}}_s.InitVelocityConstraints_s_P=new Ie,_s.SolveVelocityConstraints_s_vpA=new Ie,_s.SolveVelocityConstraints_s_vpB=new Ie,_s.SolveVelocityConstraints_s_P=new Ie,_s.SolvePositionConstraints_s_P=new Ie,_s.Draw_s_pA=new Ie,_s.Draw_s_pB=new Ie,_s.Draw_s_axis=new Ie,_s.Draw_s_c1=new ki(.7,.7,.7),_s.Draw_s_c2=new ki(.3,.9,.3),_s.Draw_s_c3=new ki(.9,.3,.3),_s.Draw_s_c4=new ki(.4,.4,.4),_s.Draw_s_pRest=new Ie,_s.Draw_s_pMin=new Ie,_s.Draw_s_pMax=new Ie;class ds extends cs{constructor(t){super(t),this.m_stiffness=0,this.m_damping=0,this.m_impulse=0,this.m_targetArea=0,this.m_delta=new Ie,this.m_bodies=t.bodies,this.m_stiffness=me(t.stiffness,0),this.m_damping=me(t.damping,0),this.m_targetLengths=Ce(t.bodies.length),this.m_normals=Ie.MakeArray(t.bodies.length),this.m_joints=[],this.m_deltas=Ie.MakeArray(t.bodies.length);const e=new us;e.stiffness=this.m_stiffness,e.damping=this.m_damping,this.m_targetArea=0;for(let t=0;t<this.m_bodies.length;++t){const i=this.m_bodies[t],s=this.m_bodies[(t+1)%this.m_bodies.length],r=i.GetWorldCenter(),n=s.GetWorldCenter();this.m_targetLengths[t]=Ie.DistanceVV(r,n),this.m_targetArea+=Ie.CrossVV(r,n),e.Initialize(i,s,r,n),this.m_joints[t]=i.GetWorld().CreateJoint(e)}this.m_targetArea*=.5}GetAnchorA(t){return t}GetAnchorB(t){return t}GetReactionForce(t,e){return e}GetReactionTorque(t){return 0}SetStiffness(t){this.m_stiffness=t;for(let e=0;e<this.m_joints.length;++e)this.m_joints[e].SetStiffness(t)}GetStiffness(){return this.m_stiffness}SetDamping(t){this.m_damping=t;for(let e=0;e<this.m_joints.length;++e)this.m_joints[e].SetDamping(t)}GetDamping(){return this.m_damping}Dump(t){t("Area joint dumping is not supported.\n")}InitVelocityConstraints(t){for(let e=0;e<this.m_bodies.length;++e){const i=this.m_bodies[(e+this.m_bodies.length-1)%this.m_bodies.length],s=this.m_bodies[(e+1)%this.m_bodies.length],r=t.positions[i.m_islandIndex].c,n=t.positions[s.m_islandIndex].c,o=this.m_deltas[e];Ie.SubVV(n,r,o)}if(t.step.warmStarting){this.m_impulse*=t.step.dtRatio;for(let e=0;e<this.m_bodies.length;++e){const i=this.m_bodies[e],s=t.velocities[i.m_islandIndex].v,r=this.m_deltas[e];s.x+=i.m_invMass*r.y*.5*this.m_impulse,s.y+=i.m_invMass*-r.x*.5*this.m_impulse}}else this.m_impulse=0}SolveVelocityConstraints(t){let e=0,i=0;for(let s=0;s<this.m_bodies.length;++s){const r=this.m_bodies[s],n=t.velocities[r.m_islandIndex].v,o=this.m_deltas[s];e+=o.LengthSquared()/r.GetMass(),i+=Ie.CrossVV(n,o)}const s=-2*i/e;this.m_impulse+=s;for(let e=0;e<this.m_bodies.length;++e){const i=this.m_bodies[e],r=t.velocities[i.m_islandIndex].v,n=this.m_deltas[e];r.x+=i.m_invMass*n.y*.5*s,r.y+=i.m_invMass*-n.x*.5*s}}SolvePositionConstraints(t){let e=0,i=0;for(let s=0;s<this.m_bodies.length;++s){const r=this.m_bodies[s],n=this.m_bodies[(s+1)%this.m_bodies.length],o=t.positions[r.m_islandIndex].c,h=t.positions[n.m_islandIndex].c,a=Ie.SubVV(h,o,this.m_delta);let l=a.Length();l<ue&&(l=1),this.m_normals[s].x=a.y/l,this.m_normals[s].y=-a.x/l,e+=l,i+=Ie.CrossVV(o,h)}i*=.5;const s=.5*(this.m_targetArea-i)/e;let r=!0;for(let e=0;e<this.m_bodies.length;++e){const i=this.m_bodies[e],n=t.positions[i.m_islandIndex].c,o=(e+1)%this.m_bodies.length,h=Ie.AddVV(this.m_normals[e],this.m_normals[o],this.m_delta);h.SelfMul(s);const a=h.LengthSquared();a>Ve(.2)&&h.SelfMul(.2/De(a)),a>Ve(de)&&(r=!1),n.x+=h.x,n.y+=h.y}return r}}class ps extends cs{constructor(t){super(t),this.m_localAnchorA=new Ie,this.m_localAnchorB=new Ie,this.m_linearImpulse=new Ie,this.m_angularImpulse=0,this.m_maxForce=0,this.m_maxTorque=0,this.m_indexA=0,this.m_indexB=0,this.m_rA=new Ie,this.m_rB=new Ie,this.m_localCenterA=new Ie,this.m_localCenterB=new Ie,this.m_invMassA=0,this.m_invMassB=0,this.m_invIA=0,this.m_invIB=0,this.m_linearMass=new Te,this.m_angularMass=0,this.m_qA=new Fe,this.m_qB=new Fe,this.m_lalcA=new Ie,this.m_lalcB=new Ie,this.m_K=new Te,this.m_localAnchorA.Copy(me(t.localAnchorA,Ie.ZERO)),this.m_localAnchorB.Copy(me(t.localAnchorB,Ie.ZERO)),this.m_linearImpulse.SetZero(),this.m_maxForce=me(t.maxForce,0),this.m_maxTorque=me(t.maxTorque,0),this.m_linearMass.SetZero()}InitVelocityConstraints(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;const e=t.positions[this.m_indexA].a,i=t.velocities[this.m_indexA].v;let s=t.velocities[this.m_indexA].w;const r=t.positions[this.m_indexB].a,n=t.velocities[this.m_indexB].v;let o=t.velocities[this.m_indexB].w;const h=this.m_qA.SetAngle(e),a=this.m_qB.SetAngle(r);Ie.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);const l=Fe.MulRV(h,this.m_lalcA,this.m_rA);Ie.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);const m=Fe.MulRV(a,this.m_lalcB,this.m_rB),c=this.m_invMassA,u=this.m_invMassB,_=this.m_invIA,d=this.m_invIB,p=this.m_K;if(p.ex.x=c+u+_*l.y*l.y+d*m.y*m.y,p.ex.y=-_*l.x*l.y-d*m.x*m.y,p.ey.x=p.ex.y,p.ey.y=c+u+_*l.x*l.x+d*m.x*m.x,p.GetInverse(this.m_linearMass),this.m_angularMass=_+d,this.m_angularMass>0&&(this.m_angularMass=1/this.m_angularMass),t.step.warmStarting){this.m_linearImpulse.SelfMul(t.step.dtRatio),this.m_angularImpulse*=t.step.dtRatio;const e=this.m_linearImpulse;i.SelfMulSub(c,e),s-=_*(Ie.CrossVV(this.m_rA,e)+this.m_angularImpulse),n.SelfMulAdd(u,e),o+=d*(Ie.CrossVV(this.m_rB,e)+this.m_angularImpulse)}else this.m_linearImpulse.SetZero(),this.m_angularImpulse=0;t.velocities[this.m_indexA].w=s,t.velocities[this.m_indexB].w=o}SolveVelocityConstraints(t){const e=t.velocities[this.m_indexA].v;let i=t.velocities[this.m_indexA].w;const s=t.velocities[this.m_indexB].v;let r=t.velocities[this.m_indexB].w;const n=this.m_invMassA,o=this.m_invMassB,h=this.m_invIA,a=this.m_invIB,l=t.step.dt;{const t=r-i;let e=-this.m_angularMass*t;const s=this.m_angularImpulse,n=l*this.m_maxTorque;this.m_angularImpulse=Ae(this.m_angularImpulse+e,-n,n),e=this.m_angularImpulse-s,i-=h*e,r+=a*e}{const t=Ie.SubVV(Ie.AddVCrossSV(s,r,this.m_rB,Ie.s_t0),Ie.AddVCrossSV(e,i,this.m_rA,Ie.s_t1),ps.SolveVelocityConstraints_s_Cdot_v2),m=Te.MulMV(this.m_linearMass,t,ps.SolveVelocityConstraints_s_impulseV).SelfNeg(),c=ps.SolveVelocityConstraints_s_oldImpulseV.Copy(this.m_linearImpulse);this.m_linearImpulse.SelfAdd(m);const u=l*this.m_maxForce;this.m_linearImpulse.LengthSquared()>u*u&&(this.m_linearImpulse.Normalize(),this.m_linearImpulse.SelfMul(u)),Ie.SubVV(this.m_linearImpulse,c,m),e.SelfMulSub(n,m),i-=h*Ie.CrossVV(this.m_rA,m),s.SelfMulAdd(o,m),r+=a*Ie.CrossVV(this.m_rB,m)}t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=r}SolvePositionConstraints(t){return!0}GetAnchorA(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)}GetAnchorB(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)}GetReactionForce(t,e){return e.x=t*this.m_linearImpulse.x,e.y=t*this.m_linearImpulse.y,e}GetReactionTorque(t){return t*this.m_angularImpulse}GetLocalAnchorA(){return this.m_localAnchorA}GetLocalAnchorB(){return this.m_localAnchorB}SetMaxForce(t){this.m_maxForce=t}GetMaxForce(){return this.m_maxForce}SetMaxTorque(t){this.m_maxTorque=t}GetMaxTorque(){return this.m_maxTorque}Dump(t){const e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t("  const jd: b2FrictionJointDef = new b2FrictionJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.maxForce = %.15f;\n",this.m_maxForce),t("  jd.maxTorque = %.15f;\n",this.m_maxTorque),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)}}ps.SolveVelocityConstraints_s_Cdot_v2=new Ie,ps.SolveVelocityConstraints_s_impulseV=new Ie,ps.SolveVelocityConstraints_s_oldImpulseV=new Ie;class fs extends cs{constructor(t){let e,i;super(t),this.m_typeA=ls.e_unknownJoint,this.m_typeB=ls.e_unknownJoint,this.m_localAnchorA=new Ie,this.m_localAnchorB=new Ie,this.m_localAnchorC=new Ie,this.m_localAnchorD=new Ie,this.m_localAxisC=new Ie,this.m_localAxisD=new Ie,this.m_referenceAngleA=0,this.m_referenceAngleB=0,this.m_constant=0,this.m_ratio=0,this.m_impulse=0,this.m_indexA=0,this.m_indexB=0,this.m_indexC=0,this.m_indexD=0,this.m_lcA=new Ie,this.m_lcB=new Ie,this.m_lcC=new Ie,this.m_lcD=new Ie,this.m_mA=0,this.m_mB=0,this.m_mC=0,this.m_mD=0,this.m_iA=0,this.m_iB=0,this.m_iC=0,this.m_iD=0,this.m_JvAC=new Ie,this.m_JvBD=new Ie,this.m_JwA=0,this.m_JwB=0,this.m_JwC=0,this.m_JwD=0,this.m_mass=0,this.m_qA=new Fe,this.m_qB=new Fe,this.m_qC=new Fe,this.m_qD=new Fe,this.m_lalcA=new Ie,this.m_lalcB=new Ie,this.m_lalcC=new Ie,this.m_lalcD=new Ie,this.m_joint1=t.joint1,this.m_joint2=t.joint2,this.m_typeA=this.m_joint1.GetType(),this.m_typeB=this.m_joint2.GetType(),this.m_bodyC=this.m_joint1.GetBodyA(),this.m_bodyA=this.m_joint1.GetBodyB();const s=this.m_bodyA.m_xf,r=this.m_bodyA.m_sweep.a,n=this.m_bodyC.m_xf,o=this.m_bodyC.m_sweep.a;if(this.m_typeA===ls.e_revoluteJoint){const i=t.joint1;this.m_localAnchorC.Copy(i.m_localAnchorA),this.m_localAnchorA.Copy(i.m_localAnchorB),this.m_referenceAngleA=i.m_referenceAngle,this.m_localAxisC.SetZero(),e=r-o-this.m_referenceAngleA}else{const i=t.joint1;this.m_localAnchorC.Copy(i.m_localAnchorA),this.m_localAnchorA.Copy(i.m_localAnchorB),this.m_referenceAngleA=i.m_referenceAngle,this.m_localAxisC.Copy(i.m_localXAxisA);const r=this.m_localAnchorC,o=Fe.MulTRV(n.q,Ie.AddVV(Fe.MulRV(s.q,this.m_localAnchorA,Ie.s_t0),Ie.SubVV(s.p,n.p,Ie.s_t1),Ie.s_t0),Ie.s_t0);e=Ie.DotVV(Ie.SubVV(o,r,Ie.s_t0),this.m_localAxisC)}this.m_bodyD=this.m_joint2.GetBodyA(),this.m_bodyB=this.m_joint2.GetBodyB();const h=this.m_bodyB.m_xf,a=this.m_bodyB.m_sweep.a,l=this.m_bodyD.m_xf,m=this.m_bodyD.m_sweep.a;if(this.m_typeB===ls.e_revoluteJoint){const e=t.joint2;this.m_localAnchorD.Copy(e.m_localAnchorA),this.m_localAnchorB.Copy(e.m_localAnchorB),this.m_referenceAngleB=e.m_referenceAngle,this.m_localAxisD.SetZero(),i=a-m-this.m_referenceAngleB}else{const e=t.joint2;this.m_localAnchorD.Copy(e.m_localAnchorA),this.m_localAnchorB.Copy(e.m_localAnchorB),this.m_referenceAngleB=e.m_referenceAngle,this.m_localAxisD.Copy(e.m_localXAxisA);const s=this.m_localAnchorD,r=Fe.MulTRV(l.q,Ie.AddVV(Fe.MulRV(h.q,this.m_localAnchorB,Ie.s_t0),Ie.SubVV(h.p,l.p,Ie.s_t1),Ie.s_t0),Ie.s_t0);i=Ie.DotVV(Ie.SubVV(r,s,Ie.s_t0),this.m_localAxisD)}this.m_ratio=me(t.ratio,1),this.m_constant=e+this.m_ratio*i,this.m_impulse=0}InitVelocityConstraints(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_indexC=this.m_bodyC.m_islandIndex,this.m_indexD=this.m_bodyD.m_islandIndex,this.m_lcA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_lcB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_lcC.Copy(this.m_bodyC.m_sweep.localCenter),this.m_lcD.Copy(this.m_bodyD.m_sweep.localCenter),this.m_mA=this.m_bodyA.m_invMass,this.m_mB=this.m_bodyB.m_invMass,this.m_mC=this.m_bodyC.m_invMass,this.m_mD=this.m_bodyD.m_invMass,this.m_iA=this.m_bodyA.m_invI,this.m_iB=this.m_bodyB.m_invI,this.m_iC=this.m_bodyC.m_invI,this.m_iD=this.m_bodyD.m_invI;const e=t.positions[this.m_indexA].a,i=t.velocities[this.m_indexA].v;let s=t.velocities[this.m_indexA].w;const r=t.positions[this.m_indexB].a,n=t.velocities[this.m_indexB].v;let o=t.velocities[this.m_indexB].w;const h=t.positions[this.m_indexC].a,a=t.velocities[this.m_indexC].v;let l=t.velocities[this.m_indexC].w;const m=t.positions[this.m_indexD].a,c=t.velocities[this.m_indexD].v;let u=t.velocities[this.m_indexD].w;const _=this.m_qA.SetAngle(e),d=this.m_qB.SetAngle(r),p=this.m_qC.SetAngle(h),f=this.m_qD.SetAngle(m);if(this.m_mass=0,this.m_typeA===ls.e_revoluteJoint)this.m_JvAC.SetZero(),this.m_JwA=1,this.m_JwC=1,this.m_mass+=this.m_iA+this.m_iC;else{const t=Fe.MulRV(p,this.m_localAxisC,fs.InitVelocityConstraints_s_u);Ie.SubVV(this.m_localAnchorC,this.m_lcC,this.m_lalcC);const e=Fe.MulRV(p,this.m_lalcC,fs.InitVelocityConstraints_s_rC);Ie.SubVV(this.m_localAnchorA,this.m_lcA,this.m_lalcA);const i=Fe.MulRV(_,this.m_lalcA,fs.InitVelocityConstraints_s_rA);this.m_JvAC.Copy(t),this.m_JwC=Ie.CrossVV(e,t),this.m_JwA=Ie.CrossVV(i,t),this.m_mass+=this.m_mC+this.m_mA+this.m_iC*this.m_JwC*this.m_JwC+this.m_iA*this.m_JwA*this.m_JwA}if(this.m_typeB===ls.e_revoluteJoint)this.m_JvBD.SetZero(),this.m_JwB=this.m_ratio,this.m_JwD=this.m_ratio,this.m_mass+=this.m_ratio*this.m_ratio*(this.m_iB+this.m_iD);else{const t=Fe.MulRV(f,this.m_localAxisD,fs.InitVelocityConstraints_s_u);Ie.SubVV(this.m_localAnchorD,this.m_lcD,this.m_lalcD);const e=Fe.MulRV(f,this.m_lalcD,fs.InitVelocityConstraints_s_rD);Ie.SubVV(this.m_localAnchorB,this.m_lcB,this.m_lalcB);const i=Fe.MulRV(d,this.m_lalcB,fs.InitVelocityConstraints_s_rB);Ie.MulSV(this.m_ratio,t,this.m_JvBD),this.m_JwD=this.m_ratio*Ie.CrossVV(e,t),this.m_JwB=this.m_ratio*Ie.CrossVV(i,t),this.m_mass+=this.m_ratio*this.m_ratio*(this.m_mD+this.m_mB)+this.m_iD*this.m_JwD*this.m_JwD+this.m_iB*this.m_JwB*this.m_JwB}this.m_mass=this.m_mass>0?1/this.m_mass:0,t.step.warmStarting?(i.SelfMulAdd(this.m_mA*this.m_impulse,this.m_JvAC),s+=this.m_iA*this.m_impulse*this.m_JwA,n.SelfMulAdd(this.m_mB*this.m_impulse,this.m_JvBD),o+=this.m_iB*this.m_impulse*this.m_JwB,a.SelfMulSub(this.m_mC*this.m_impulse,this.m_JvAC),l-=this.m_iC*this.m_impulse*this.m_JwC,c.SelfMulSub(this.m_mD*this.m_impulse,this.m_JvBD),u-=this.m_iD*this.m_impulse*this.m_JwD):this.m_impulse=0,t.velocities[this.m_indexA].w=s,t.velocities[this.m_indexB].w=o,t.velocities[this.m_indexC].w=l,t.velocities[this.m_indexD].w=u}SolveVelocityConstraints(t){const e=t.velocities[this.m_indexA].v;let i=t.velocities[this.m_indexA].w;const s=t.velocities[this.m_indexB].v;let r=t.velocities[this.m_indexB].w;const n=t.velocities[this.m_indexC].v;let o=t.velocities[this.m_indexC].w;const h=t.velocities[this.m_indexD].v;let a=t.velocities[this.m_indexD].w,l=Ie.DotVV(this.m_JvAC,Ie.SubVV(e,n,Ie.s_t0))+Ie.DotVV(this.m_JvBD,Ie.SubVV(s,h,Ie.s_t0));l+=this.m_JwA*i-this.m_JwC*o+(this.m_JwB*r-this.m_JwD*a);const m=-this.m_mass*l;this.m_impulse+=m,e.SelfMulAdd(this.m_mA*m,this.m_JvAC),i+=this.m_iA*m*this.m_JwA,s.SelfMulAdd(this.m_mB*m,this.m_JvBD),r+=this.m_iB*m*this.m_JwB,n.SelfMulSub(this.m_mC*m,this.m_JvAC),o-=this.m_iC*m*this.m_JwC,h.SelfMulSub(this.m_mD*m,this.m_JvBD),a-=this.m_iD*m*this.m_JwD,t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=r,t.velocities[this.m_indexC].w=o,t.velocities[this.m_indexD].w=a}SolvePositionConstraints(t){const e=t.positions[this.m_indexA].c;let i=t.positions[this.m_indexA].a;const s=t.positions[this.m_indexB].c;let r=t.positions[this.m_indexB].a;const n=t.positions[this.m_indexC].c;let o=t.positions[this.m_indexC].a;const h=t.positions[this.m_indexD].c;let a=t.positions[this.m_indexD].a;const l=this.m_qA.SetAngle(i),m=this.m_qB.SetAngle(r),c=this.m_qC.SetAngle(o),u=this.m_qD.SetAngle(a);let _,d;const p=this.m_JvAC,f=this.m_JvBD;let y,x,g,w,C=0;if(this.m_typeA===ls.e_revoluteJoint)p.SetZero(),y=1,g=1,C+=this.m_iA+this.m_iC,_=i-o-this.m_referenceAngleA;else{const t=Fe.MulRV(c,this.m_localAxisC,fs.SolvePositionConstraints_s_u),i=Fe.MulRV(c,this.m_lalcC,fs.SolvePositionConstraints_s_rC),s=Fe.MulRV(l,this.m_lalcA,fs.SolvePositionConstraints_s_rA);p.Copy(t),g=Ie.CrossVV(i,t),y=Ie.CrossVV(s,t),C+=this.m_mC+this.m_mA+this.m_iC*g*g+this.m_iA*y*y;const r=this.m_lalcC,o=Fe.MulTRV(c,Ie.AddVV(s,Ie.SubVV(e,n,Ie.s_t0),Ie.s_t0),Ie.s_t0);_=Ie.DotVV(Ie.SubVV(o,r,Ie.s_t0),this.m_localAxisC)}if(this.m_typeB===ls.e_revoluteJoint)f.SetZero(),x=this.m_ratio,w=this.m_ratio,C+=this.m_ratio*this.m_ratio*(this.m_iB+this.m_iD),d=r-a-this.m_referenceAngleB;else{const t=Fe.MulRV(u,this.m_localAxisD,fs.SolvePositionConstraints_s_u),e=Fe.MulRV(u,this.m_lalcD,fs.SolvePositionConstraints_s_rD),i=Fe.MulRV(m,this.m_lalcB,fs.SolvePositionConstraints_s_rB);Ie.MulSV(this.m_ratio,t,f),w=this.m_ratio*Ie.CrossVV(e,t),x=this.m_ratio*Ie.CrossVV(i,t),C+=this.m_ratio*this.m_ratio*(this.m_mD+this.m_mB)+this.m_iD*w*w+this.m_iB*x*x;const r=this.m_lalcD,n=Fe.MulTRV(u,Ie.AddVV(i,Ie.SubVV(s,h,Ie.s_t0),Ie.s_t0),Ie.s_t0);d=Ie.DotVV(Ie.SubVV(n,r,Ie.s_t0),this.m_localAxisD)}const v=_+this.m_ratio*d-this.m_constant;let S=0;return C>0&&(S=-v/C),e.SelfMulAdd(this.m_mA*S,p),i+=this.m_iA*S*y,s.SelfMulAdd(this.m_mB*S,f),r+=this.m_iB*S*x,n.SelfMulSub(this.m_mC*S,p),o-=this.m_iC*S*g,h.SelfMulSub(this.m_mD*S,f),a-=this.m_iD*S*w,t.positions[this.m_indexA].a=i,t.positions[this.m_indexB].a=r,t.positions[this.m_indexC].a=o,t.positions[this.m_indexD].a=a,!0}GetAnchorA(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)}GetAnchorB(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)}GetReactionForce(t,e){return Ie.MulSV(t*this.m_impulse,this.m_JvAC,e)}GetReactionTorque(t){return t*this.m_impulse*this.m_JwA}GetJoint1(){return this.m_joint1}GetJoint2(){return this.m_joint2}GetRatio(){return this.m_ratio}SetRatio(t){this.m_ratio=t}Dump(t){const e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex,s=this.m_joint1.m_index,r=this.m_joint2.m_index;t("  const jd: b2GearJointDef = new b2GearJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.joint1 = joints[%d];\n",s),t("  jd.joint2 = joints[%d];\n",r),t("  jd.ratio = %.15f;\n",this.m_ratio),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)}}fs.InitVelocityConstraints_s_u=new Ie,fs.InitVelocityConstraints_s_rA=new Ie,fs.InitVelocityConstraints_s_rB=new Ie,fs.InitVelocityConstraints_s_rC=new Ie,fs.InitVelocityConstraints_s_rD=new Ie,fs.SolvePositionConstraints_s_u=new Ie,fs.SolvePositionConstraints_s_rA=new Ie,fs.SolvePositionConstraints_s_rB=new Ie,fs.SolvePositionConstraints_s_rC=new Ie,fs.SolvePositionConstraints_s_rD=new Ie;class ys extends cs{constructor(t){super(t),this.m_linearOffset=new Ie,this.m_angularOffset=0,this.m_linearImpulse=new Ie,this.m_angularImpulse=0,this.m_maxForce=0,this.m_maxTorque=0,this.m_correctionFactor=.3,this.m_indexA=0,this.m_indexB=0,this.m_rA=new Ie,this.m_rB=new Ie,this.m_localCenterA=new Ie,this.m_localCenterB=new Ie,this.m_linearError=new Ie,this.m_angularError=0,this.m_invMassA=0,this.m_invMassB=0,this.m_invIA=0,this.m_invIB=0,this.m_linearMass=new Te,this.m_angularMass=0,this.m_qA=new Fe,this.m_qB=new Fe,this.m_K=new Te,this.m_linearOffset.Copy(me(t.linearOffset,Ie.ZERO)),this.m_linearImpulse.SetZero(),this.m_maxForce=me(t.maxForce,0),this.m_maxTorque=me(t.maxTorque,0),this.m_correctionFactor=me(t.correctionFactor,.3)}GetAnchorA(t){const e=this.m_bodyA.GetPosition();return t.x=e.x,t.y=e.y,t}GetAnchorB(t){const e=this.m_bodyB.GetPosition();return t.x=e.x,t.y=e.y,t}GetReactionForce(t,e){return Ie.MulSV(t,this.m_linearImpulse,e)}GetReactionTorque(t){return t*this.m_angularImpulse}SetLinearOffset(t){Ie.IsEqualToV(t,this.m_linearOffset)||(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_linearOffset.Copy(t))}GetLinearOffset(){return this.m_linearOffset}SetAngularOffset(t){t!==this.m_angularOffset&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_angularOffset=t)}GetAngularOffset(){return this.m_angularOffset}SetMaxForce(t){this.m_maxForce=t}GetMaxForce(){return this.m_maxForce}SetMaxTorque(t){this.m_maxTorque=t}GetMaxTorque(){return this.m_maxTorque}InitVelocityConstraints(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;const e=t.positions[this.m_indexA].c,i=t.positions[this.m_indexA].a,s=t.velocities[this.m_indexA].v;let r=t.velocities[this.m_indexA].w;const n=t.positions[this.m_indexB].c,o=t.positions[this.m_indexB].a,h=t.velocities[this.m_indexB].v;let a=t.velocities[this.m_indexB].w;const l=this.m_qA.SetAngle(i),m=this.m_qB.SetAngle(o),c=Fe.MulRV(l,Ie.SubVV(this.m_linearOffset,this.m_localCenterA,Ie.s_t0),this.m_rA),u=Fe.MulRV(m,Ie.NegV(this.m_localCenterB,Ie.s_t0),this.m_rB),_=this.m_invMassA,d=this.m_invMassB,p=this.m_invIA,f=this.m_invIB,y=this.m_K;if(y.ex.x=_+d+p*c.y*c.y+f*u.y*u.y,y.ex.y=-p*c.x*c.y-f*u.x*u.y,y.ey.x=y.ex.y,y.ey.y=_+d+p*c.x*c.x+f*u.x*u.x,y.GetInverse(this.m_linearMass),this.m_angularMass=p+f,this.m_angularMass>0&&(this.m_angularMass=1/this.m_angularMass),Ie.SubVV(Ie.AddVV(n,u,Ie.s_t0),Ie.AddVV(e,c,Ie.s_t1),this.m_linearError),this.m_angularError=o-i-this.m_angularOffset,t.step.warmStarting){this.m_linearImpulse.SelfMul(t.step.dtRatio),this.m_angularImpulse*=t.step.dtRatio;const e=this.m_linearImpulse;s.SelfMulSub(_,e),r-=p*(Ie.CrossVV(c,e)+this.m_angularImpulse),h.SelfMulAdd(d,e),a+=f*(Ie.CrossVV(u,e)+this.m_angularImpulse)}else this.m_linearImpulse.SetZero(),this.m_angularImpulse=0;t.velocities[this.m_indexA].w=r,t.velocities[this.m_indexB].w=a}SolveVelocityConstraints(t){const e=t.velocities[this.m_indexA].v;let i=t.velocities[this.m_indexA].w;const s=t.velocities[this.m_indexB].v;let r=t.velocities[this.m_indexB].w;const n=this.m_invMassA,o=this.m_invMassB,h=this.m_invIA,a=this.m_invIB,l=t.step.dt,m=t.step.inv_dt;{const t=r-i+m*this.m_correctionFactor*this.m_angularError;let e=-this.m_angularMass*t;const s=this.m_angularImpulse,n=l*this.m_maxTorque;this.m_angularImpulse=Ae(this.m_angularImpulse+e,-n,n),e=this.m_angularImpulse-s,i-=h*e,r+=a*e}{const t=this.m_rA,c=this.m_rB,u=Ie.AddVV(Ie.SubVV(Ie.AddVV(s,Ie.CrossSV(r,c,Ie.s_t0),Ie.s_t0),Ie.AddVV(e,Ie.CrossSV(i,t,Ie.s_t1),Ie.s_t1),Ie.s_t2),Ie.MulSV(m*this.m_correctionFactor,this.m_linearError,Ie.s_t3),ys.SolveVelocityConstraints_s_Cdot_v2),_=Te.MulMV(this.m_linearMass,u,ys.SolveVelocityConstraints_s_impulse_v2).SelfNeg(),d=ys.SolveVelocityConstraints_s_oldImpulse_v2.Copy(this.m_linearImpulse);this.m_linearImpulse.SelfAdd(_);const p=l*this.m_maxForce;this.m_linearImpulse.LengthSquared()>p*p&&(this.m_linearImpulse.Normalize(),this.m_linearImpulse.SelfMul(p)),Ie.SubVV(this.m_linearImpulse,d,_),e.SelfMulSub(n,_),i-=h*Ie.CrossVV(t,_),s.SelfMulAdd(o,_),r+=a*Ie.CrossVV(c,_)}t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=r}SolvePositionConstraints(t){return!0}Dump(t){const e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t("  const jd: b2MotorJointDef = new b2MotorJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.linearOffset.Set(%.15f, %.15f);\n",this.m_linearOffset.x,this.m_linearOffset.y),t("  jd.angularOffset = %.15f;\n",this.m_angularOffset),t("  jd.maxForce = %.15f;\n",this.m_maxForce),t("  jd.maxTorque = %.15f;\n",this.m_maxTorque),t("  jd.correctionFactor = %.15f;\n",this.m_correctionFactor),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)}}ys.SolveVelocityConstraints_s_Cdot_v2=new Ie,ys.SolveVelocityConstraints_s_impulse_v2=new Ie,ys.SolveVelocityConstraints_s_oldImpulse_v2=new Ie;class xs extends cs{constructor(t){super(t),this.m_localAnchorB=new Ie,this.m_targetA=new Ie,this.m_stiffness=0,this.m_damping=0,this.m_beta=0,this.m_impulse=new Ie,this.m_maxForce=0,this.m_gamma=0,this.m_indexA=0,this.m_indexB=0,this.m_rB=new Ie,this.m_localCenterB=new Ie,this.m_invMassB=0,this.m_invIB=0,this.m_mass=new Te,this.m_C=new Ie,this.m_qB=new Fe,this.m_lalcB=new Ie,this.m_K=new Te,this.m_targetA.Copy(me(t.target,Ie.ZERO)),ke.MulTXV(this.m_bodyB.GetTransform(),this.m_targetA,this.m_localAnchorB),this.m_maxForce=me(t.maxForce,0),this.m_impulse.SetZero(),this.m_stiffness=me(t.stiffness,0),this.m_damping=me(t.damping,0),this.m_beta=0,this.m_gamma=0}SetTarget(t){this.m_bodyB.IsAwake()||this.m_bodyB.SetAwake(!0),this.m_targetA.Copy(t)}GetTarget(){return this.m_targetA}SetMaxForce(t){this.m_maxForce=t}GetMaxForce(){return this.m_maxForce}SetStiffness(t){this.m_stiffness=t}GetStiffness(){return this.m_stiffness}SetDamping(t){this.m_damping=t}GetDamping(){return this.m_damping}InitVelocityConstraints(t){this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIB=this.m_bodyB.m_invI;const e=t.positions[this.m_indexB].c,i=t.positions[this.m_indexB].a,s=t.velocities[this.m_indexB].v;let r=t.velocities[this.m_indexB].w;const n=this.m_qB.SetAngle(i),o=this.m_bodyB.GetMass(),h=6.28318530718*this.m_stiffness,a=2*o*this.m_damping*h,l=o*(h*h),m=t.step.dt;this.m_gamma=m*(a+m*l),0!==this.m_gamma&&(this.m_gamma=1/this.m_gamma),this.m_beta=m*l*this.m_gamma,Ie.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),Fe.MulRV(n,this.m_lalcB,this.m_rB);const c=this.m_K;c.ex.x=this.m_invMassB+this.m_invIB*this.m_rB.y*this.m_rB.y+this.m_gamma,c.ex.y=-this.m_invIB*this.m_rB.x*this.m_rB.y,c.ey.x=c.ex.y,c.ey.y=this.m_invMassB+this.m_invIB*this.m_rB.x*this.m_rB.x+this.m_gamma,c.GetInverse(this.m_mass),this.m_C.x=e.x+this.m_rB.x-this.m_targetA.x,this.m_C.y=e.y+this.m_rB.y-this.m_targetA.y,this.m_C.SelfMul(this.m_beta),r*=.98,t.step.warmStarting?(this.m_impulse.SelfMul(t.step.dtRatio),s.x+=this.m_invMassB*this.m_impulse.x,s.y+=this.m_invMassB*this.m_impulse.y,r+=this.m_invIB*Ie.CrossVV(this.m_rB,this.m_impulse)):this.m_impulse.SetZero(),t.velocities[this.m_indexB].w=r}SolveVelocityConstraints(t){const e=t.velocities[this.m_indexB].v;let i=t.velocities[this.m_indexB].w;const s=Ie.AddVCrossSV(e,i,this.m_rB,xs.SolveVelocityConstraints_s_Cdot),r=Te.MulMV(this.m_mass,Ie.AddVV(s,Ie.AddVV(this.m_C,Ie.MulSV(this.m_gamma,this.m_impulse,Ie.s_t0),Ie.s_t0),Ie.s_t0).SelfNeg(),xs.SolveVelocityConstraints_s_impulse),n=xs.SolveVelocityConstraints_s_oldImpulse.Copy(this.m_impulse);this.m_impulse.SelfAdd(r);const o=t.step.dt*this.m_maxForce;this.m_impulse.LengthSquared()>o*o&&this.m_impulse.SelfMul(o/this.m_impulse.Length()),Ie.SubVV(this.m_impulse,n,r),e.SelfMulAdd(this.m_invMassB,r),i+=this.m_invIB*Ie.CrossVV(this.m_rB,r),t.velocities[this.m_indexB].w=i}SolvePositionConstraints(t){return!0}GetAnchorA(t){return t.x=this.m_targetA.x,t.y=this.m_targetA.y,t}GetAnchorB(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)}GetReactionForce(t,e){return Ie.MulSV(t,this.m_impulse,e)}GetReactionTorque(t){return 0}Dump(t){t("Mouse joint dumping is not supported.\n")}ShiftOrigin(t){this.m_targetA.SelfSub(t)}}xs.SolveVelocityConstraints_s_Cdot=new Ie,xs.SolveVelocityConstraints_s_impulse=new Ie,xs.SolveVelocityConstraints_s_oldImpulse=new Ie;class gs extends cs{constructor(t){super(t),this.m_localAnchorA=new Ie,this.m_localAnchorB=new Ie,this.m_localXAxisA=new Ie,this.m_localYAxisA=new Ie,this.m_referenceAngle=0,this.m_impulse=new Ie(0,0),this.m_motorImpulse=0,this.m_lowerImpulse=0,this.m_upperImpulse=0,this.m_lowerTranslation=0,this.m_upperTranslation=0,this.m_maxMotorForce=0,this.m_motorSpeed=0,this.m_enableLimit=!1,this.m_enableMotor=!1,this.m_indexA=0,this.m_indexB=0,this.m_localCenterA=new Ie,this.m_localCenterB=new Ie,this.m_invMassA=0,this.m_invMassB=0,this.m_invIA=0,this.m_invIB=0,this.m_axis=new Ie(0,0),this.m_perp=new Ie(0,0),this.m_s1=0,this.m_s2=0,this.m_a1=0,this.m_a2=0,this.m_K=new Te,this.m_K3=new Re,this.m_K2=new Te,this.m_translation=0,this.m_axialMass=0,this.m_qA=new Fe,this.m_qB=new Fe,this.m_lalcA=new Ie,this.m_lalcB=new Ie,this.m_rA=new Ie,this.m_rB=new Ie,this.m_localAnchorA.Copy(me(t.localAnchorA,Ie.ZERO)),this.m_localAnchorB.Copy(me(t.localAnchorB,Ie.ZERO)),this.m_localXAxisA.Copy(me(t.localAxisA,new Ie(1,0))).SelfNormalize(),Ie.CrossOneV(this.m_localXAxisA,this.m_localYAxisA),this.m_referenceAngle=me(t.referenceAngle,0),this.m_lowerTranslation=me(t.lowerTranslation,0),this.m_upperTranslation=me(t.upperTranslation,0),this.m_maxMotorForce=me(t.maxMotorForce,0),this.m_motorSpeed=me(t.motorSpeed,0),this.m_enableLimit=me(t.enableLimit,!1),this.m_enableMotor=me(t.enableMotor,!1)}InitVelocityConstraints(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;const e=t.positions[this.m_indexA].c,i=t.positions[this.m_indexA].a,s=t.velocities[this.m_indexA].v;let r=t.velocities[this.m_indexA].w;const n=t.positions[this.m_indexB].c,o=t.positions[this.m_indexB].a,h=t.velocities[this.m_indexB].v;let a=t.velocities[this.m_indexB].w;const l=this.m_qA.SetAngle(i),m=this.m_qB.SetAngle(o);Ie.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);const c=Fe.MulRV(l,this.m_lalcA,this.m_rA);Ie.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);const u=Fe.MulRV(m,this.m_lalcB,this.m_rB),_=Ie.AddVV(Ie.SubVV(n,e,Ie.s_t0),Ie.SubVV(u,c,Ie.s_t1),gs.InitVelocityConstraints_s_d),d=this.m_invMassA,p=this.m_invMassB,f=this.m_invIA,y=this.m_invIB;if(Fe.MulRV(l,this.m_localXAxisA,this.m_axis),this.m_a1=Ie.CrossVV(Ie.AddVV(_,c,Ie.s_t0),this.m_axis),this.m_a2=Ie.CrossVV(u,this.m_axis),this.m_axialMass=d+p+f*this.m_a1*this.m_a1+y*this.m_a2*this.m_a2,this.m_axialMass>0&&(this.m_axialMass=1/this.m_axialMass),Fe.MulRV(l,this.m_localYAxisA,this.m_perp),this.m_s1=Ie.CrossVV(Ie.AddVV(_,c,Ie.s_t0),this.m_perp),this.m_s2=Ie.CrossVV(u,this.m_perp),this.m_K.ex.x=d+p+f*this.m_s1*this.m_s1+y*this.m_s2*this.m_s2,this.m_K.ex.y=f*this.m_s1+y*this.m_s2,this.m_K.ey.x=this.m_K.ex.y,this.m_K.ey.y=f+y,0===this.m_K.ey.y&&(this.m_K.ey.y=1),this.m_enableLimit?this.m_translation=Ie.DotVV(this.m_axis,_):(this.m_lowerImpulse=0,this.m_upperImpulse=0),this.m_enableMotor||(this.m_motorImpulse=0),t.step.warmStarting){this.m_impulse.SelfMul(t.step.dtRatio),this.m_motorImpulse*=t.step.dtRatio,this.m_lowerImpulse*=t.step.dtRatio,this.m_upperImpulse*=t.step.dtRatio;const e=this.m_motorImpulse+this.m_lowerImpulse-this.m_upperImpulse,i=Ie.AddVV(Ie.MulSV(this.m_impulse.x,this.m_perp,Ie.s_t0),Ie.MulSV(e,this.m_axis,Ie.s_t1),gs.InitVelocityConstraints_s_P),n=this.m_impulse.x*this.m_s1+this.m_impulse.y+e*this.m_a1,o=this.m_impulse.x*this.m_s2+this.m_impulse.y+e*this.m_a2;s.SelfMulSub(d,i),r-=f*n,h.SelfMulAdd(p,i),a+=y*o}else this.m_impulse.SetZero(),this.m_motorImpulse=0,this.m_lowerImpulse=0,this.m_upperImpulse=0;t.velocities[this.m_indexA].w=r,t.velocities[this.m_indexB].w=a}SolveVelocityConstraints(t){const e=t.velocities[this.m_indexA].v;let i=t.velocities[this.m_indexA].w;const s=t.velocities[this.m_indexB].v;let r=t.velocities[this.m_indexB].w;const n=this.m_invMassA,o=this.m_invMassB,h=this.m_invIA,a=this.m_invIB;if(this.m_enableMotor){const l=Ie.DotVV(this.m_axis,Ie.SubVV(s,e,Ie.s_t0))+this.m_a2*r-this.m_a1*i;let m=this.m_axialMass*(this.m_motorSpeed-l);const c=this.m_motorImpulse,u=t.step.dt*this.m_maxMotorForce;this.m_motorImpulse=Ae(this.m_motorImpulse+m,-u,u),m=this.m_motorImpulse-c;const _=Ie.MulSV(m,this.m_axis,gs.SolveVelocityConstraints_s_P),d=m*this.m_a1,p=m*this.m_a2;e.SelfMulSub(n,_),i-=h*d,s.SelfMulAdd(o,_),r+=a*p}if(this.m_enableLimit){{const l=this.m_translation-this.m_lowerTranslation,m=Ie.DotVV(this.m_axis,Ie.SubVV(s,e,Ie.s_t0))+this.m_a2*r-this.m_a1*i;let c=-this.m_axialMass*(m+Be(l,0)*t.step.inv_dt);const u=this.m_lowerImpulse;this.m_lowerImpulse=Be(this.m_lowerImpulse+c,0),c=this.m_lowerImpulse-u;const _=Ie.MulSV(c,this.m_axis,gs.SolveVelocityConstraints_s_P),d=c*this.m_a1,p=c*this.m_a2;e.SelfMulSub(n,_),i-=h*d,s.SelfMulAdd(o,_),r+=a*p}{const l=this.m_upperTranslation-this.m_translation,m=Ie.DotVV(this.m_axis,Ie.SubVV(e,s,Ie.s_t0))+this.m_a1*i-this.m_a2*r;let c=-this.m_axialMass*(m+Be(l,0)*t.step.inv_dt);const u=this.m_upperImpulse;this.m_upperImpulse=Be(this.m_upperImpulse+c,0),c=this.m_upperImpulse-u;const _=Ie.MulSV(c,this.m_axis,gs.SolveVelocityConstraints_s_P),d=c*this.m_a1,p=c*this.m_a2;e.SelfMulAdd(n,_),i+=h*d,s.SelfMulSub(o,_),r-=a*p}}{const t=Ie.DotVV(this.m_perp,Ie.SubVV(s,e,Ie.s_t0))+this.m_s2*r-this.m_s1*i,l=r-i,m=this.m_K.Solve(-t,-l,gs.SolveVelocityConstraints_s_df);this.m_impulse.SelfAdd(m);const c=Ie.MulSV(m.x,this.m_perp,gs.SolveVelocityConstraints_s_P),u=m.x*this.m_s1+m.y,_=m.x*this.m_s2+m.y;e.SelfMulSub(n,c),i-=h*u,s.SelfMulAdd(o,c),r+=a*_}t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=r}SolvePositionConstraints(t){const e=t.positions[this.m_indexA].c;let i=t.positions[this.m_indexA].a;const s=t.positions[this.m_indexB].c;let r=t.positions[this.m_indexB].a;const n=this.m_qA.SetAngle(i),o=this.m_qB.SetAngle(r),h=this.m_invMassA,a=this.m_invMassB,l=this.m_invIA,m=this.m_invIB,c=Fe.MulRV(n,this.m_lalcA,this.m_rA),u=Fe.MulRV(o,this.m_lalcB,this.m_rB),_=Ie.SubVV(Ie.AddVV(s,u,Ie.s_t0),Ie.AddVV(e,c,Ie.s_t1),gs.SolvePositionConstraints_s_d),d=Fe.MulRV(n,this.m_localXAxisA,this.m_axis),p=Ie.CrossVV(Ie.AddVV(_,c,Ie.s_t0),d),f=Ie.CrossVV(u,d),y=Fe.MulRV(n,this.m_localYAxisA,this.m_perp),x=Ie.CrossVV(Ie.AddVV(_,c,Ie.s_t0),y),g=Ie.CrossVV(u,y);let w=gs.SolvePositionConstraints_s_impulse;const C=Ie.DotVV(y,_),v=r-i-this.m_referenceAngle;let S=Se(C);const b=Se(v);let B=!1,A=0;if(this.m_enableLimit){const t=Ie.DotVV(d,_);Se(this.m_upperTranslation-this.m_lowerTranslation)<.01?(A=t,S=Be(S,Se(t)),B=!0):t<=this.m_lowerTranslation?(A=be(t-this.m_lowerTranslation,0),S=Be(S,this.m_lowerTranslation-t),B=!0):t>=this.m_upperTranslation&&(A=Be(t-this.m_upperTranslation,0),S=Be(S,t-this.m_upperTranslation),B=!0)}if(B){const t=h+a+l*x*x+m*g*g,e=l*x+m*g,i=l*x*p+m*g*f;let s=l+m;0===s&&(s=1);const r=l*p+m*f,n=h+a+l*p*p+m*f*f,o=this.m_K3;o.ex.SetXYZ(t,e,i),o.ey.SetXYZ(e,s,r),o.ez.SetXYZ(i,r,n),w=o.Solve33(-C,-v,-A,w)}else{const t=h+a+l*x*x+m*g*g,e=l*x+m*g;let i=l+m;0===i&&(i=1);const s=this.m_K2;s.ex.Set(t,e),s.ey.Set(e,i);const r=s.Solve(-C,-v,gs.SolvePositionConstraints_s_impulse1);w.x=r.x,w.y=r.y,w.z=0}const V=Ie.AddVV(Ie.MulSV(w.x,y,Ie.s_t0),Ie.MulSV(w.z,d,Ie.s_t1),gs.SolvePositionConstraints_s_P),M=w.x*x+w.y+w.z*p,D=w.x*g+w.y+w.z*f;return e.SelfMulSub(h,V),i-=l*M,s.SelfMulAdd(a,V),r+=m*D,t.positions[this.m_indexA].a=i,t.positions[this.m_indexB].a=r,S<=de&&b<=pe}GetAnchorA(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)}GetAnchorB(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)}GetReactionForce(t,e){return e.x=t*(this.m_impulse.x*this.m_perp.x+(this.m_motorImpulse+this.m_lowerImpulse-this.m_upperImpulse)*this.m_axis.x),e.y=t*(this.m_impulse.y*this.m_perp.y+(this.m_motorImpulse+this.m_lowerImpulse-this.m_upperImpulse)*this.m_axis.y),e}GetReactionTorque(t){return t*this.m_impulse.y}GetLocalAnchorA(){return this.m_localAnchorA}GetLocalAnchorB(){return this.m_localAnchorB}GetLocalAxisA(){return this.m_localXAxisA}GetReferenceAngle(){return this.m_referenceAngle}GetJointTranslation(){const t=this.m_bodyA.GetWorldPoint(this.m_localAnchorA,gs.GetJointTranslation_s_pA),e=this.m_bodyB.GetWorldPoint(this.m_localAnchorB,gs.GetJointTranslation_s_pB),i=Ie.SubVV(e,t,gs.GetJointTranslation_s_d),s=this.m_bodyA.GetWorldVector(this.m_localXAxisA,gs.GetJointTranslation_s_axis);return Ie.DotVV(i,s)}GetJointSpeed(){const t=this.m_bodyA,e=this.m_bodyB;Ie.SubVV(this.m_localAnchorA,t.m_sweep.localCenter,this.m_lalcA);const i=Fe.MulRV(t.m_xf.q,this.m_lalcA,this.m_rA);Ie.SubVV(this.m_localAnchorB,e.m_sweep.localCenter,this.m_lalcB);const s=Fe.MulRV(e.m_xf.q,this.m_lalcB,this.m_rB),r=Ie.AddVV(t.m_sweep.c,i,Ie.s_t0),n=Ie.AddVV(e.m_sweep.c,s,Ie.s_t1),o=Ie.SubVV(n,r,Ie.s_t2),h=t.GetWorldVector(this.m_localXAxisA,this.m_axis),a=t.m_linearVelocity,l=e.m_linearVelocity,m=t.m_angularVelocity,c=e.m_angularVelocity;return Ie.DotVV(o,Ie.CrossSV(m,h,Ie.s_t0))+Ie.DotVV(h,Ie.SubVV(Ie.AddVCrossSV(l,c,s,Ie.s_t0),Ie.AddVCrossSV(a,m,i,Ie.s_t1),Ie.s_t0))}IsLimitEnabled(){return this.m_enableLimit}EnableLimit(t){t!==this.m_enableLimit&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableLimit=t,this.m_lowerImpulse=0,this.m_upperImpulse=0)}GetLowerLimit(){return this.m_lowerTranslation}GetUpperLimit(){return this.m_upperTranslation}SetLimits(t,e){t===this.m_lowerTranslation&&e===this.m_upperTranslation||(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_lowerTranslation=t,this.m_upperTranslation=e,this.m_lowerImpulse=0,this.m_upperImpulse=0)}IsMotorEnabled(){return this.m_enableMotor}EnableMotor(t){t!==this.m_enableMotor&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableMotor=t)}SetMotorSpeed(t){t!==this.m_motorSpeed&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_motorSpeed=t)}GetMotorSpeed(){return this.m_motorSpeed}SetMaxMotorForce(t){t!==this.m_maxMotorForce&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_maxMotorForce=t)}GetMaxMotorForce(){return this.m_maxMotorForce}GetMotorForce(t){return t*this.m_motorImpulse}Dump(t){const e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t("  const jd: b2PrismaticJointDef = new b2PrismaticJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.localAxisA.Set(%.15f, %.15f);\n",this.m_localXAxisA.x,this.m_localXAxisA.y),t("  jd.referenceAngle = %.15f;\n",this.m_referenceAngle),t("  jd.enableLimit = %s;\n",this.m_enableLimit?"true":"false"),t("  jd.lowerTranslation = %.15f;\n",this.m_lowerTranslation),t("  jd.upperTranslation = %.15f;\n",this.m_upperTranslation),t("  jd.enableMotor = %s;\n",this.m_enableMotor?"true":"false"),t("  jd.motorSpeed = %.15f;\n",this.m_motorSpeed),t("  jd.maxMotorForce = %.15f;\n",this.m_maxMotorForce),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)}Draw(t){const e=this.m_bodyA.GetTransform(),i=this.m_bodyB.GetTransform(),s=ke.MulXV(e,this.m_localAnchorA,gs.Draw_s_pA),r=ke.MulXV(i,this.m_localAnchorB,gs.Draw_s_pB),n=Fe.MulRV(e.q,this.m_localXAxisA,gs.Draw_s_axis),o=gs.Draw_s_c1,h=gs.Draw_s_c2,a=gs.Draw_s_c3,l=gs.Draw_s_c4,m=gs.Draw_s_c5;if(t.DrawSegment(s,r,m),this.m_enableLimit){const i=Ie.AddVMulSV(s,this.m_lowerTranslation,n,gs.Draw_s_lower),r=Ie.AddVMulSV(s,this.m_upperTranslation,n,gs.Draw_s_upper),l=Fe.MulRV(e.q,this.m_localYAxisA,gs.Draw_s_perp);t.DrawSegment(i,r,o),t.DrawSegment(Ie.AddVMulSV(i,-.5,l,Ie.s_t0),Ie.AddVMulSV(i,.5,l,Ie.s_t1),h),t.DrawSegment(Ie.AddVMulSV(r,-.5,l,Ie.s_t0),Ie.AddVMulSV(r,.5,l,Ie.s_t1),a)}else t.DrawSegment(Ie.AddVMulSV(s,-1,n,Ie.s_t0),Ie.AddVMulSV(s,1,n,Ie.s_t1),o);t.DrawPoint(s,5,o),t.DrawPoint(r,5,l)}}gs.InitVelocityConstraints_s_d=new Ie,gs.InitVelocityConstraints_s_P=new Ie,gs.SolveVelocityConstraints_s_P=new Ie,gs.SolveVelocityConstraints_s_df=new Ie,gs.SolvePositionConstraints_s_d=new Ie,gs.SolvePositionConstraints_s_impulse=new Ge,gs.SolvePositionConstraints_s_impulse1=new Ie,gs.SolvePositionConstraints_s_P=new Ie,gs.GetJointTranslation_s_pA=new Ie,gs.GetJointTranslation_s_pB=new Ie,gs.GetJointTranslation_s_d=new Ie,gs.GetJointTranslation_s_axis=new Ie,gs.Draw_s_pA=new Ie,gs.Draw_s_pB=new Ie,gs.Draw_s_axis=new Ie,gs.Draw_s_c1=new ki(.7,.7,.7),gs.Draw_s_c2=new ki(.3,.9,.3),gs.Draw_s_c3=new ki(.9,.3,.3),gs.Draw_s_c4=new ki(.3,.3,.9),gs.Draw_s_c5=new ki(.4,.4,.4),gs.Draw_s_lower=new Ie,gs.Draw_s_upper=new Ie,gs.Draw_s_perp=new Ie;class ws extends cs{constructor(t){super(t),this.m_groundAnchorA=new Ie,this.m_groundAnchorB=new Ie,this.m_lengthA=0,this.m_lengthB=0,this.m_localAnchorA=new Ie,this.m_localAnchorB=new Ie,this.m_constant=0,this.m_ratio=0,this.m_impulse=0,this.m_indexA=0,this.m_indexB=0,this.m_uA=new Ie,this.m_uB=new Ie,this.m_rA=new Ie,this.m_rB=new Ie,this.m_localCenterA=new Ie,this.m_localCenterB=new Ie,this.m_invMassA=0,this.m_invMassB=0,this.m_invIA=0,this.m_invIB=0,this.m_mass=0,this.m_qA=new Fe,this.m_qB=new Fe,this.m_lalcA=new Ie,this.m_lalcB=new Ie,this.m_groundAnchorA.Copy(me(t.groundAnchorA,new Ie(-1,1))),this.m_groundAnchorB.Copy(me(t.groundAnchorB,new Ie(1,0))),this.m_localAnchorA.Copy(me(t.localAnchorA,new Ie(-1,0))),this.m_localAnchorB.Copy(me(t.localAnchorB,new Ie(1,0))),this.m_lengthA=me(t.lengthA,0),this.m_lengthB=me(t.lengthB,0),this.m_ratio=me(t.ratio,1),this.m_constant=me(t.lengthA,0)+this.m_ratio*me(t.lengthB,0),this.m_impulse=0}InitVelocityConstraints(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;const e=t.positions[this.m_indexA].c,i=t.positions[this.m_indexA].a,s=t.velocities[this.m_indexA].v;let r=t.velocities[this.m_indexA].w;const n=t.positions[this.m_indexB].c,o=t.positions[this.m_indexB].a,h=t.velocities[this.m_indexB].v;let a=t.velocities[this.m_indexB].w;const l=this.m_qA.SetAngle(i),m=this.m_qB.SetAngle(o);Ie.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA),Fe.MulRV(l,this.m_lalcA,this.m_rA),Ie.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),Fe.MulRV(m,this.m_lalcB,this.m_rB),this.m_uA.Copy(e).SelfAdd(this.m_rA).SelfSub(this.m_groundAnchorA),this.m_uB.Copy(n).SelfAdd(this.m_rB).SelfSub(this.m_groundAnchorB);const c=this.m_uA.Length(),u=this.m_uB.Length();c>.05?this.m_uA.SelfMul(1/c):this.m_uA.SetZero(),u>.05?this.m_uB.SelfMul(1/u):this.m_uB.SetZero();const _=Ie.CrossVV(this.m_rA,this.m_uA),d=Ie.CrossVV(this.m_rB,this.m_uB),p=this.m_invMassA+this.m_invIA*_*_,f=this.m_invMassB+this.m_invIB*d*d;if(this.m_mass=p+this.m_ratio*this.m_ratio*f,this.m_mass>0&&(this.m_mass=1/this.m_mass),t.step.warmStarting){this.m_impulse*=t.step.dtRatio;const e=Ie.MulSV(-this.m_impulse,this.m_uA,ws.InitVelocityConstraints_s_PA),i=Ie.MulSV(-this.m_ratio*this.m_impulse,this.m_uB,ws.InitVelocityConstraints_s_PB);s.SelfMulAdd(this.m_invMassA,e),r+=this.m_invIA*Ie.CrossVV(this.m_rA,e),h.SelfMulAdd(this.m_invMassB,i),a+=this.m_invIB*Ie.CrossVV(this.m_rB,i)}else this.m_impulse=0;t.velocities[this.m_indexA].w=r,t.velocities[this.m_indexB].w=a}SolveVelocityConstraints(t){const e=t.velocities[this.m_indexA].v;let i=t.velocities[this.m_indexA].w;const s=t.velocities[this.m_indexB].v;let r=t.velocities[this.m_indexB].w;const n=Ie.AddVCrossSV(e,i,this.m_rA,ws.SolveVelocityConstraints_s_vpA),o=Ie.AddVCrossSV(s,r,this.m_rB,ws.SolveVelocityConstraints_s_vpB),h=-Ie.DotVV(this.m_uA,n)-this.m_ratio*Ie.DotVV(this.m_uB,o),a=-this.m_mass*h;this.m_impulse+=a;const l=Ie.MulSV(-a,this.m_uA,ws.SolveVelocityConstraints_s_PA),m=Ie.MulSV(-this.m_ratio*a,this.m_uB,ws.SolveVelocityConstraints_s_PB);e.SelfMulAdd(this.m_invMassA,l),i+=this.m_invIA*Ie.CrossVV(this.m_rA,l),s.SelfMulAdd(this.m_invMassB,m),r+=this.m_invIB*Ie.CrossVV(this.m_rB,m),t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=r}SolvePositionConstraints(t){const e=t.positions[this.m_indexA].c;let i=t.positions[this.m_indexA].a;const s=t.positions[this.m_indexB].c;let r=t.positions[this.m_indexB].a;const n=this.m_qA.SetAngle(i),o=this.m_qB.SetAngle(r);Ie.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);const h=Fe.MulRV(n,this.m_lalcA,this.m_rA);Ie.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);const a=Fe.MulRV(o,this.m_lalcB,this.m_rB),l=this.m_uA.Copy(e).SelfAdd(h).SelfSub(this.m_groundAnchorA),m=this.m_uB.Copy(s).SelfAdd(a).SelfSub(this.m_groundAnchorB),c=l.Length(),u=m.Length();c>.05?l.SelfMul(1/c):l.SetZero(),u>.05?m.SelfMul(1/u):m.SetZero();const _=Ie.CrossVV(h,l),d=Ie.CrossVV(a,m),p=this.m_invMassA+this.m_invIA*_*_,f=this.m_invMassB+this.m_invIB*d*d;let y=p+this.m_ratio*this.m_ratio*f;y>0&&(y=1/y);const x=this.m_constant-c-this.m_ratio*u,g=Se(x),w=-y*x,C=Ie.MulSV(-w,l,ws.SolvePositionConstraints_s_PA),v=Ie.MulSV(-this.m_ratio*w,m,ws.SolvePositionConstraints_s_PB);return e.SelfMulAdd(this.m_invMassA,C),i+=this.m_invIA*Ie.CrossVV(h,C),s.SelfMulAdd(this.m_invMassB,v),r+=this.m_invIB*Ie.CrossVV(a,v),t.positions[this.m_indexA].a=i,t.positions[this.m_indexB].a=r,g<de}GetAnchorA(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)}GetAnchorB(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)}GetReactionForce(t,e){return e.x=t*this.m_impulse*this.m_uB.x,e.y=t*this.m_impulse*this.m_uB.y,e}GetReactionTorque(t){return 0}GetGroundAnchorA(){return this.m_groundAnchorA}GetGroundAnchorB(){return this.m_groundAnchorB}GetLengthA(){return this.m_lengthA}GetLengthB(){return this.m_lengthB}GetRatio(){return this.m_ratio}GetCurrentLengthA(){const t=this.m_bodyA.GetWorldPoint(this.m_localAnchorA,ws.GetCurrentLengthA_s_p),e=this.m_groundAnchorA;return Ie.DistanceVV(t,e)}GetCurrentLengthB(){const t=this.m_bodyB.GetWorldPoint(this.m_localAnchorB,ws.GetCurrentLengthB_s_p),e=this.m_groundAnchorB;return Ie.DistanceVV(t,e)}Dump(t){const e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t("  const jd: b2PulleyJointDef = new b2PulleyJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.groundAnchorA.Set(%.15f, %.15f);\n",this.m_groundAnchorA.x,this.m_groundAnchorA.y),t("  jd.groundAnchorB.Set(%.15f, %.15f);\n",this.m_groundAnchorB.x,this.m_groundAnchorB.y),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.lengthA = %.15f;\n",this.m_lengthA),t("  jd.lengthB = %.15f;\n",this.m_lengthB),t("  jd.ratio = %.15f;\n",this.m_ratio),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)}ShiftOrigin(t){this.m_groundAnchorA.SelfSub(t),this.m_groundAnchorB.SelfSub(t)}}ws.InitVelocityConstraints_s_PA=new Ie,ws.InitVelocityConstraints_s_PB=new Ie,ws.SolveVelocityConstraints_s_vpA=new Ie,ws.SolveVelocityConstraints_s_vpB=new Ie,ws.SolveVelocityConstraints_s_PA=new Ie,ws.SolveVelocityConstraints_s_PB=new Ie,ws.SolvePositionConstraints_s_PA=new Ie,ws.SolvePositionConstraints_s_PB=new Ie,ws.GetCurrentLengthA_s_p=new Ie,ws.GetCurrentLengthB_s_p=new Ie;class Cs extends cs{constructor(t){super(t),this.m_localAnchorA=new Ie,this.m_localAnchorB=new Ie,this.m_impulse=new Ie,this.m_motorImpulse=0,this.m_lowerImpulse=0,this.m_upperImpulse=0,this.m_enableMotor=!1,this.m_maxMotorTorque=0,this.m_motorSpeed=0,this.m_enableLimit=!1,this.m_referenceAngle=0,this.m_lowerAngle=0,this.m_upperAngle=0,this.m_indexA=0,this.m_indexB=0,this.m_rA=new Ie,this.m_rB=new Ie,this.m_localCenterA=new Ie,this.m_localCenterB=new Ie,this.m_invMassA=0,this.m_invMassB=0,this.m_invIA=0,this.m_invIB=0,this.m_K=new Te,this.m_angle=0,this.m_axialMass=0,this.m_qA=new Fe,this.m_qB=new Fe,this.m_lalcA=new Ie,this.m_lalcB=new Ie,this.m_localAnchorA.Copy(me(t.localAnchorA,Ie.ZERO)),this.m_localAnchorB.Copy(me(t.localAnchorB,Ie.ZERO)),this.m_referenceAngle=me(t.referenceAngle,0),this.m_impulse.SetZero(),this.m_motorImpulse=0,this.m_lowerAngle=me(t.lowerAngle,0),this.m_upperAngle=me(t.upperAngle,0),this.m_maxMotorTorque=me(t.maxMotorTorque,0),this.m_motorSpeed=me(t.motorSpeed,0),this.m_enableLimit=me(t.enableLimit,!1),this.m_enableMotor=me(t.enableMotor,!1)}InitVelocityConstraints(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;const e=t.positions[this.m_indexA].a,i=t.velocities[this.m_indexA].v;let s=t.velocities[this.m_indexA].w;const r=t.positions[this.m_indexB].a,n=t.velocities[this.m_indexB].v;let o=t.velocities[this.m_indexB].w;const h=this.m_qA.SetAngle(e),a=this.m_qB.SetAngle(r);Ie.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA),Fe.MulRV(h,this.m_lalcA,this.m_rA),Ie.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),Fe.MulRV(a,this.m_lalcB,this.m_rB);const l=this.m_invMassA,m=this.m_invMassB,c=this.m_invIA,u=this.m_invIB;let _;if(this.m_K.ex.x=l+m+this.m_rA.y*this.m_rA.y*c+this.m_rB.y*this.m_rB.y*u,this.m_K.ey.x=-this.m_rA.y*this.m_rA.x*c-this.m_rB.y*this.m_rB.x*u,this.m_K.ex.y=this.m_K.ey.x,this.m_K.ey.y=l+m+this.m_rA.x*this.m_rA.x*c+this.m_rB.x*this.m_rB.x*u,this.m_axialMass=c+u,this.m_axialMass>0?(this.m_axialMass=1/this.m_axialMass,_=!1):_=!0,this.m_angle=r-e-this.m_referenceAngle,(!1===this.m_enableLimit||_)&&(this.m_lowerImpulse=0,this.m_upperImpulse=0),(!1===this.m_enableMotor||_)&&(this.m_motorImpulse=0),t.step.warmStarting){this.m_impulse.SelfMul(t.step.dtRatio),this.m_motorImpulse*=t.step.dtRatio,this.m_lowerImpulse*=t.step.dtRatio,this.m_upperImpulse*=t.step.dtRatio;const e=this.m_motorImpulse+this.m_lowerImpulse-this.m_upperImpulse,r=Cs.InitVelocityConstraints_s_P.Set(this.m_impulse.x,this.m_impulse.y);i.SelfMulSub(l,r),s-=c*(Ie.CrossVV(this.m_rA,r)+e),n.SelfMulAdd(m,r),o+=u*(Ie.CrossVV(this.m_rB,r)+e)}else this.m_impulse.SetZero(),this.m_motorImpulse=0,this.m_lowerImpulse=0,this.m_upperImpulse=0;t.velocities[this.m_indexA].w=s,t.velocities[this.m_indexB].w=o}SolveVelocityConstraints(t){const e=t.velocities[this.m_indexA].v;let i=t.velocities[this.m_indexA].w;const s=t.velocities[this.m_indexB].v;let r=t.velocities[this.m_indexB].w;const n=this.m_invMassA,o=this.m_invMassB,h=this.m_invIA,a=this.m_invIB,l=h+a===0;if(this.m_enableMotor&&!l){const e=r-i-this.m_motorSpeed;let s=-this.m_axialMass*e;const n=this.m_motorImpulse,o=t.step.dt*this.m_maxMotorTorque;this.m_motorImpulse=Ae(this.m_motorImpulse+s,-o,o),s=this.m_motorImpulse-n,i-=h*s,r+=a*s}if(this.m_enableLimit&&!l){{const e=this.m_angle-this.m_lowerAngle,s=r-i;let n=-this.m_axialMass*(s+Be(e,0)*t.step.inv_dt);const o=this.m_lowerImpulse;this.m_lowerImpulse=Be(this.m_lowerImpulse+n,0),n=this.m_lowerImpulse-o,i-=h*n,r+=a*n}{const e=this.m_upperAngle-this.m_angle,s=i-r;let n=-this.m_axialMass*(s+Be(e,0)*t.step.inv_dt);const o=this.m_upperImpulse;this.m_upperImpulse=Be(this.m_upperImpulse+n,0),n=this.m_upperImpulse-o,i+=h*n,r-=a*n}}{const t=Ie.SubVV(Ie.AddVCrossSV(s,r,this.m_rB,Ie.s_t0),Ie.AddVCrossSV(e,i,this.m_rA,Ie.s_t1),Cs.SolveVelocityConstraints_s_Cdot_v2),l=this.m_K.Solve(-t.x,-t.y,Cs.SolveVelocityConstraints_s_impulse_v2);this.m_impulse.x+=l.x,this.m_impulse.y+=l.y,e.SelfMulSub(n,l),i-=h*Ie.CrossVV(this.m_rA,l),s.SelfMulAdd(o,l),r+=a*Ie.CrossVV(this.m_rB,l)}t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=r}SolvePositionConstraints(t){const e=t.positions[this.m_indexA].c;let i=t.positions[this.m_indexA].a;const s=t.positions[this.m_indexB].c;let r=t.positions[this.m_indexB].a;const n=this.m_qA.SetAngle(i),o=this.m_qB.SetAngle(r);let h=0,a=0;const l=this.m_invIA+this.m_invIB===0;if(this.m_enableLimit&&!l){const t=r-i-this.m_referenceAngle;let e=0;Se(this.m_upperAngle-this.m_lowerAngle)<2*pe?e=Ae(t-this.m_lowerAngle,-.13962634015955555,fe):t<=this.m_lowerAngle?e=Ae(t-this.m_lowerAngle+pe,-.13962634015955555,0):t>=this.m_upperAngle&&(e=Ae(t-this.m_upperAngle-pe,0,fe));const s=-this.m_axialMass*e;i-=this.m_invIA*s,r+=this.m_invIB*s,h=Se(e)}{n.SetAngle(i),o.SetAngle(r),Ie.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);const t=Fe.MulRV(n,this.m_lalcA,this.m_rA);Ie.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);const h=Fe.MulRV(o,this.m_lalcB,this.m_rB),l=Ie.SubVV(Ie.AddVV(s,h,Ie.s_t0),Ie.AddVV(e,t,Ie.s_t1),Cs.SolvePositionConstraints_s_C_v2);a=l.Length();const m=this.m_invMassA,c=this.m_invMassB,u=this.m_invIA,_=this.m_invIB,d=this.m_K;d.ex.x=m+c+u*t.y*t.y+_*h.y*h.y,d.ex.y=-u*t.x*t.y-_*h.x*h.y,d.ey.x=d.ex.y,d.ey.y=m+c+u*t.x*t.x+_*h.x*h.x;const p=d.Solve(l.x,l.y,Cs.SolvePositionConstraints_s_impulse).SelfNeg();e.SelfMulSub(m,p),i-=u*Ie.CrossVV(t,p),s.SelfMulAdd(c,p),r+=_*Ie.CrossVV(h,p)}return t.positions[this.m_indexA].a=i,t.positions[this.m_indexB].a=r,a<=de&&h<=pe}GetAnchorA(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)}GetAnchorB(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)}GetReactionForce(t,e){return e.x=t*this.m_impulse.x,e.y=t*this.m_impulse.y,e}GetReactionTorque(t){return t*(this.m_lowerImpulse-this.m_upperImpulse)}GetLocalAnchorA(){return this.m_localAnchorA}GetLocalAnchorB(){return this.m_localAnchorB}GetReferenceAngle(){return this.m_referenceAngle}GetJointAngle(){return this.m_bodyB.m_sweep.a-this.m_bodyA.m_sweep.a-this.m_referenceAngle}GetJointSpeed(){return this.m_bodyB.m_angularVelocity-this.m_bodyA.m_angularVelocity}IsMotorEnabled(){return this.m_enableMotor}EnableMotor(t){t!==this.m_enableMotor&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableMotor=t)}GetMotorTorque(t){return t*this.m_motorImpulse}GetMotorSpeed(){return this.m_motorSpeed}SetMaxMotorTorque(t){t!==this.m_maxMotorTorque&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_maxMotorTorque=t)}GetMaxMotorTorque(){return this.m_maxMotorTorque}IsLimitEnabled(){return this.m_enableLimit}EnableLimit(t){t!==this.m_enableLimit&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableLimit=t,this.m_lowerImpulse=0,this.m_upperImpulse=0)}GetLowerLimit(){return this.m_lowerAngle}GetUpperLimit(){return this.m_upperAngle}SetLimits(t,e){t===this.m_lowerAngle&&e===this.m_upperAngle||(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_lowerImpulse=0,this.m_upperImpulse=0,this.m_lowerAngle=t,this.m_upperAngle=e)}SetMotorSpeed(t){t!==this.m_motorSpeed&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_motorSpeed=t)}Dump(t){const e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t("  const jd: b2RevoluteJointDef = new b2RevoluteJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.referenceAngle = %.15f;\n",this.m_referenceAngle),t("  jd.enableLimit = %s;\n",this.m_enableLimit?"true":"false"),t("  jd.lowerAngle = %.15f;\n",this.m_lowerAngle),t("  jd.upperAngle = %.15f;\n",this.m_upperAngle),t("  jd.enableMotor = %s;\n",this.m_enableMotor?"true":"false"),t("  jd.motorSpeed = %.15f;\n",this.m_motorSpeed),t("  jd.maxMotorTorque = %.15f;\n",this.m_maxMotorTorque),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)}Draw(t){const e=this.m_bodyA.GetTransform(),i=this.m_bodyB.GetTransform(),s=ke.MulXV(e,this.m_localAnchorA,Cs.Draw_s_pA),r=ke.MulXV(i,this.m_localAnchorB,Cs.Draw_s_pB),n=Cs.Draw_s_c1,o=Cs.Draw_s_c2,h=Cs.Draw_s_c3,a=Cs.Draw_s_c4,l=Cs.Draw_s_c5;t.DrawPoint(s,5,a),t.DrawPoint(r,5,l);const m=this.m_bodyA.GetAngle(),c=this.m_bodyB.GetAngle()-m-this.m_referenceAngle,u=.5,_=Cs.Draw_s_r.Set(u*Math.cos(c),u*Math.sin(c));if(t.DrawSegment(r,Ie.AddVV(r,_,Ie.s_t0),n),t.DrawCircle(r,u,n),this.m_enableLimit){const e=Cs.Draw_s_rlo.Set(u*Math.cos(this.m_lowerAngle),u*Math.sin(this.m_lowerAngle)),i=Cs.Draw_s_rhi.Set(u*Math.cos(this.m_upperAngle),u*Math.sin(this.m_upperAngle));t.DrawSegment(r,Ie.AddVV(r,e,Ie.s_t0),o),t.DrawSegment(r,Ie.AddVV(r,i,Ie.s_t0),h)}const d=Cs.Draw_s_color_;t.DrawSegment(e.p,s,d),t.DrawSegment(s,r,d),t.DrawSegment(i.p,r,d)}}Cs.InitVelocityConstraints_s_P=new Ie,Cs.SolveVelocityConstraints_s_Cdot_v2=new Ie,Cs.SolveVelocityConstraints_s_impulse_v2=new Ie,Cs.SolvePositionConstraints_s_C_v2=new Ie,Cs.SolvePositionConstraints_s_impulse=new Ie,Cs.Draw_s_pA=new Ie,Cs.Draw_s_pB=new Ie,Cs.Draw_s_c1=new ki(.7,.7,.7),Cs.Draw_s_c2=new ki(.3,.9,.3),Cs.Draw_s_c3=new ki(.9,.3,.3),Cs.Draw_s_c4=new ki(.3,.3,.9),Cs.Draw_s_c5=new ki(.4,.4,.4),Cs.Draw_s_color_=new ki(.5,.8,.8),Cs.Draw_s_r=new Ie,Cs.Draw_s_rlo=new Ie,Cs.Draw_s_rhi=new Ie;class vs extends cs{constructor(t){super(t),this.m_stiffness=0,this.m_damping=0,this.m_bias=0,this.m_localAnchorA=new Ie,this.m_localAnchorB=new Ie,this.m_referenceAngle=0,this.m_gamma=0,this.m_impulse=new Ge(0,0,0),this.m_indexA=0,this.m_indexB=0,this.m_rA=new Ie,this.m_rB=new Ie,this.m_localCenterA=new Ie,this.m_localCenterB=new Ie,this.m_invMassA=0,this.m_invMassB=0,this.m_invIA=0,this.m_invIB=0,this.m_mass=new Re,this.m_qA=new Fe,this.m_qB=new Fe,this.m_lalcA=new Ie,this.m_lalcB=new Ie,this.m_K=new Re,this.m_stiffness=me(t.stiffness,0),this.m_damping=me(t.damping,0),this.m_localAnchorA.Copy(me(t.localAnchorA,Ie.ZERO)),this.m_localAnchorB.Copy(me(t.localAnchorB,Ie.ZERO)),this.m_referenceAngle=me(t.referenceAngle,0),this.m_impulse.SetZero()}InitVelocityConstraints(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;const e=t.positions[this.m_indexA].a,i=t.velocities[this.m_indexA].v;let s=t.velocities[this.m_indexA].w;const r=t.positions[this.m_indexB].a,n=t.velocities[this.m_indexB].v;let o=t.velocities[this.m_indexB].w;const h=this.m_qA.SetAngle(e),a=this.m_qB.SetAngle(r);Ie.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA),Fe.MulRV(h,this.m_lalcA,this.m_rA),Ie.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB),Fe.MulRV(a,this.m_lalcB,this.m_rB);const l=this.m_invMassA,m=this.m_invMassB,c=this.m_invIA,u=this.m_invIB,_=this.m_K;if(_.ex.x=l+m+this.m_rA.y*this.m_rA.y*c+this.m_rB.y*this.m_rB.y*u,_.ey.x=-this.m_rA.y*this.m_rA.x*c-this.m_rB.y*this.m_rB.x*u,_.ez.x=-this.m_rA.y*c-this.m_rB.y*u,_.ex.y=_.ey.x,_.ey.y=l+m+this.m_rA.x*this.m_rA.x*c+this.m_rB.x*this.m_rB.x*u,_.ez.y=this.m_rA.x*c+this.m_rB.x*u,_.ex.z=_.ez.x,_.ey.z=_.ez.y,_.ez.z=c+u,this.m_stiffness>0){_.GetInverse22(this.m_mass);let i=c+u;const s=r-e-this.m_referenceAngle,n=this.m_damping,o=this.m_stiffness,h=t.step.dt;this.m_gamma=h*(n+h*o),this.m_gamma=0!==this.m_gamma?1/this.m_gamma:0,this.m_bias=s*h*o*this.m_gamma,i+=this.m_gamma,this.m_mass.ez.z=0!==i?1/i:0}else _.GetSymInverse33(this.m_mass),this.m_gamma=0,this.m_bias=0;if(t.step.warmStarting){this.m_impulse.SelfMul(t.step.dtRatio);const e=vs.InitVelocityConstraints_s_P.Set(this.m_impulse.x,this.m_impulse.y);i.SelfMulSub(l,e),s-=c*(Ie.CrossVV(this.m_rA,e)+this.m_impulse.z),n.SelfMulAdd(m,e),o+=u*(Ie.CrossVV(this.m_rB,e)+this.m_impulse.z)}else this.m_impulse.SetZero();t.velocities[this.m_indexA].w=s,t.velocities[this.m_indexB].w=o}SolveVelocityConstraints(t){const e=t.velocities[this.m_indexA].v;let i=t.velocities[this.m_indexA].w;const s=t.velocities[this.m_indexB].v;let r=t.velocities[this.m_indexB].w;const n=this.m_invMassA,o=this.m_invMassB,h=this.m_invIA,a=this.m_invIB;if(this.m_stiffness>0){const t=r-i,l=-this.m_mass.ez.z*(t+this.m_bias+this.m_gamma*this.m_impulse.z);this.m_impulse.z+=l,i-=h*l,r+=a*l;const m=Ie.SubVV(Ie.AddVCrossSV(s,r,this.m_rB,Ie.s_t0),Ie.AddVCrossSV(e,i,this.m_rA,Ie.s_t1),vs.SolveVelocityConstraints_s_Cdot1),c=Re.MulM33XY(this.m_mass,m.x,m.y,vs.SolveVelocityConstraints_s_impulse1).SelfNeg();this.m_impulse.x+=c.x,this.m_impulse.y+=c.y;const u=c;e.SelfMulSub(n,u),i-=h*Ie.CrossVV(this.m_rA,u),s.SelfMulAdd(o,u),r+=a*Ie.CrossVV(this.m_rB,u)}else{const t=Ie.SubVV(Ie.AddVCrossSV(s,r,this.m_rB,Ie.s_t0),Ie.AddVCrossSV(e,i,this.m_rA,Ie.s_t1),vs.SolveVelocityConstraints_s_Cdot1),l=r-i,m=Re.MulM33XYZ(this.m_mass,t.x,t.y,l,vs.SolveVelocityConstraints_s_impulse).SelfNeg();this.m_impulse.SelfAdd(m);const c=vs.SolveVelocityConstraints_s_P.Set(m.x,m.y);e.SelfMulSub(n,c),i-=h*(Ie.CrossVV(this.m_rA,c)+m.z),s.SelfMulAdd(o,c),r+=a*(Ie.CrossVV(this.m_rB,c)+m.z)}t.velocities[this.m_indexA].w=i,t.velocities[this.m_indexB].w=r}SolvePositionConstraints(t){const e=t.positions[this.m_indexA].c;let i=t.positions[this.m_indexA].a;const s=t.positions[this.m_indexB].c;let r=t.positions[this.m_indexB].a;const n=this.m_qA.SetAngle(i),o=this.m_qB.SetAngle(r),h=this.m_invMassA,a=this.m_invMassB,l=this.m_invIA,m=this.m_invIB;Ie.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);const c=Fe.MulRV(n,this.m_lalcA,this.m_rA);Ie.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);const u=Fe.MulRV(o,this.m_lalcB,this.m_rB);let _,d;const p=this.m_K;if(p.ex.x=h+a+c.y*c.y*l+u.y*u.y*m,p.ey.x=-c.y*c.x*l-u.y*u.x*m,p.ez.x=-c.y*l-u.y*m,p.ex.y=p.ey.x,p.ey.y=h+a+c.x*c.x*l+u.x*u.x*m,p.ez.y=c.x*l+u.x*m,p.ex.z=p.ez.x,p.ey.z=p.ez.y,p.ez.z=l+m,this.m_stiffness>0){const t=Ie.SubVV(Ie.AddVV(s,u,Ie.s_t0),Ie.AddVV(e,c,Ie.s_t1),vs.SolvePositionConstraints_s_C1);_=t.Length(),d=0;const n=p.Solve22(t.x,t.y,vs.SolvePositionConstraints_s_P).SelfNeg();e.SelfMulSub(h,n),i-=l*Ie.CrossVV(c,n),s.SelfMulAdd(a,n),r+=m*Ie.CrossVV(u,n)}else{const t=Ie.SubVV(Ie.AddVV(s,u,Ie.s_t0),Ie.AddVV(e,c,Ie.s_t1),vs.SolvePositionConstraints_s_C1),n=r-i-this.m_referenceAngle;_=t.Length(),d=Se(n);const o=p.Solve33(t.x,t.y,n,vs.SolvePositionConstraints_s_impulse).SelfNeg(),f=vs.SolvePositionConstraints_s_P.Set(o.x,o.y);e.SelfMulSub(h,f),i-=l*(Ie.CrossVV(this.m_rA,f)+o.z),s.SelfMulAdd(a,f),r+=m*(Ie.CrossVV(this.m_rB,f)+o.z)}return t.positions[this.m_indexA].a=i,t.positions[this.m_indexB].a=r,_<=de&&d<=pe}GetAnchorA(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)}GetAnchorB(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)}GetReactionForce(t,e){return e.x=t*this.m_impulse.x,e.y=t*this.m_impulse.y,e}GetReactionTorque(t){return t*this.m_impulse.z}GetLocalAnchorA(){return this.m_localAnchorA}GetLocalAnchorB(){return this.m_localAnchorB}GetReferenceAngle(){return this.m_referenceAngle}SetStiffness(t){this.m_stiffness=t}GetStiffness(){return this.m_stiffness}SetDamping(t){this.m_damping=t}GetDamping(){return this.m_damping}Dump(t){const e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t("  const jd: b2WeldJointDef = new b2WeldJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.referenceAngle = %.15f;\n",this.m_referenceAngle),t("  jd.stiffness = %.15f;\n",this.m_stiffness),t("  jd.damping = %.15f;\n",this.m_damping),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)}}vs.InitVelocityConstraints_s_P=new Ie,vs.SolveVelocityConstraints_s_Cdot1=new Ie,vs.SolveVelocityConstraints_s_impulse1=new Ie,vs.SolveVelocityConstraints_s_impulse=new Ge,vs.SolveVelocityConstraints_s_P=new Ie,vs.SolvePositionConstraints_s_C1=new Ie,vs.SolvePositionConstraints_s_P=new Ie,vs.SolvePositionConstraints_s_impulse=new Ge;class Ss extends cs{constructor(t){super(t),this.m_localAnchorA=new Ie,this.m_localAnchorB=new Ie,this.m_localXAxisA=new Ie,this.m_localYAxisA=new Ie,this.m_impulse=0,this.m_motorImpulse=0,this.m_springImpulse=0,this.m_lowerImpulse=0,this.m_upperImpulse=0,this.m_translation=0,this.m_lowerTranslation=0,this.m_upperTranslation=0,this.m_maxMotorTorque=0,this.m_motorSpeed=0,this.m_enableLimit=!1,this.m_enableMotor=!1,this.m_stiffness=0,this.m_damping=0,this.m_indexA=0,this.m_indexB=0,this.m_localCenterA=new Ie,this.m_localCenterB=new Ie,this.m_invMassA=0,this.m_invMassB=0,this.m_invIA=0,this.m_invIB=0,this.m_ax=new Ie,this.m_ay=new Ie,this.m_sAx=0,this.m_sBx=0,this.m_sAy=0,this.m_sBy=0,this.m_mass=0,this.m_motorMass=0,this.m_axialMass=0,this.m_springMass=0,this.m_bias=0,this.m_gamma=0,this.m_qA=new Fe,this.m_qB=new Fe,this.m_lalcA=new Ie,this.m_lalcB=new Ie,this.m_rA=new Ie,this.m_rB=new Ie,this.m_localAnchorA.Copy(me(t.localAnchorA,Ie.ZERO)),this.m_localAnchorB.Copy(me(t.localAnchorB,Ie.ZERO)),this.m_localXAxisA.Copy(me(t.localAxisA,Ie.UNITX)),Ie.CrossOneV(this.m_localXAxisA,this.m_localYAxisA),this.m_lowerTranslation=me(t.lowerTranslation,0),this.m_upperTranslation=me(t.upperTranslation,0),this.m_enableLimit=me(t.enableLimit,!1),this.m_maxMotorTorque=me(t.maxMotorTorque,0),this.m_motorSpeed=me(t.motorSpeed,0),this.m_enableMotor=me(t.enableMotor,!1),this.m_ax.SetZero(),this.m_ay.SetZero(),this.m_stiffness=me(t.stiffness,0),this.m_damping=me(t.damping,0)}GetMotorSpeed(){return this.m_motorSpeed}GetMaxMotorTorque(){return this.m_maxMotorTorque}SetSpringFrequencyHz(t){this.m_stiffness=t}GetSpringFrequencyHz(){return this.m_stiffness}SetSpringDampingRatio(t){this.m_damping=t}GetSpringDampingRatio(){return this.m_damping}InitVelocityConstraints(t){this.m_indexA=this.m_bodyA.m_islandIndex,this.m_indexB=this.m_bodyB.m_islandIndex,this.m_localCenterA.Copy(this.m_bodyA.m_sweep.localCenter),this.m_localCenterB.Copy(this.m_bodyB.m_sweep.localCenter),this.m_invMassA=this.m_bodyA.m_invMass,this.m_invMassB=this.m_bodyB.m_invMass,this.m_invIA=this.m_bodyA.m_invI,this.m_invIB=this.m_bodyB.m_invI;const e=this.m_invMassA,i=this.m_invMassB,s=this.m_invIA,r=this.m_invIB,n=t.positions[this.m_indexA].c,o=t.positions[this.m_indexA].a,h=t.velocities[this.m_indexA].v;let a=t.velocities[this.m_indexA].w;const l=t.positions[this.m_indexB].c,m=t.positions[this.m_indexB].a,c=t.velocities[this.m_indexB].v;let u=t.velocities[this.m_indexB].w;const _=this.m_qA.SetAngle(o),d=this.m_qB.SetAngle(m);Ie.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);const p=Fe.MulRV(_,this.m_lalcA,this.m_rA);Ie.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);const f=Fe.MulRV(d,this.m_lalcB,this.m_rB),y=Ie.SubVV(Ie.AddVV(l,f,Ie.s_t0),Ie.AddVV(n,p,Ie.s_t1),Ss.InitVelocityConstraints_s_d);Fe.MulRV(_,this.m_localYAxisA,this.m_ay),this.m_sAy=Ie.CrossVV(Ie.AddVV(y,p,Ie.s_t0),this.m_ay),this.m_sBy=Ie.CrossVV(f,this.m_ay),this.m_mass=e+i+s*this.m_sAy*this.m_sAy+r*this.m_sBy*this.m_sBy,this.m_mass>0&&(this.m_mass=1/this.m_mass),Fe.MulRV(_,this.m_localXAxisA,this.m_ax),this.m_sAx=Ie.CrossVV(Ie.AddVV(y,p,Ie.s_t0),this.m_ax),this.m_sBx=Ie.CrossVV(f,this.m_ax);const x=e+i+s*this.m_sAx*this.m_sAx+r*this.m_sBx*this.m_sBx;if(this.m_axialMass=x>0?1/x:0,this.m_springMass=0,this.m_bias=0,this.m_gamma=0,this.m_stiffness>0&&x>0){this.m_springMass=1/x;const e=Ie.DotVV(y,this.m_ax),i=t.step.dt;this.m_gamma=i*(this.m_damping+i*this.m_stiffness),this.m_gamma>0&&(this.m_gamma=1/this.m_gamma),this.m_bias=e*i*this.m_stiffness*this.m_gamma,this.m_springMass=x+this.m_gamma,this.m_springMass>0&&(this.m_springMass=1/this.m_springMass)}else this.m_springImpulse=0;if(this.m_enableLimit?this.m_translation=Ie.DotVV(this.m_ax,y):(this.m_lowerImpulse=0,this.m_upperImpulse=0),this.m_enableMotor?(this.m_motorMass=s+r,this.m_motorMass>0&&(this.m_motorMass=1/this.m_motorMass)):(this.m_motorMass=0,this.m_motorImpulse=0),t.step.warmStarting){this.m_impulse*=t.step.dtRatio,this.m_springImpulse*=t.step.dtRatio,this.m_motorImpulse*=t.step.dtRatio;const e=this.m_springImpulse+this.m_lowerImpulse-this.m_upperImpulse,i=Ie.AddVV(Ie.MulSV(this.m_impulse,this.m_ay,Ie.s_t0),Ie.MulSV(e,this.m_ax,Ie.s_t1),Ss.InitVelocityConstraints_s_P),s=this.m_impulse*this.m_sAy+e*this.m_sAx+this.m_motorImpulse,r=this.m_impulse*this.m_sBy+e*this.m_sBx+this.m_motorImpulse;h.SelfMulSub(this.m_invMassA,i),a-=this.m_invIA*s,c.SelfMulAdd(this.m_invMassB,i),u+=this.m_invIB*r}else this.m_impulse=0,this.m_springImpulse=0,this.m_motorImpulse=0,this.m_lowerImpulse=0,this.m_upperImpulse=0;t.velocities[this.m_indexA].w=a,t.velocities[this.m_indexB].w=u}SolveVelocityConstraints(t){const e=this.m_invMassA,i=this.m_invMassB,s=this.m_invIA,r=this.m_invIB,n=t.velocities[this.m_indexA].v;let o=t.velocities[this.m_indexA].w;const h=t.velocities[this.m_indexB].v;let a=t.velocities[this.m_indexB].w;{const t=Ie.DotVV(this.m_ax,Ie.SubVV(h,n,Ie.s_t0))+this.m_sBx*a-this.m_sAx*o,l=-this.m_springMass*(t+this.m_bias+this.m_gamma*this.m_springImpulse);this.m_springImpulse+=l;const m=Ie.MulSV(l,this.m_ax,Ss.SolveVelocityConstraints_s_P),c=l*this.m_sAx,u=l*this.m_sBx;n.SelfMulSub(e,m),o-=s*c,h.SelfMulAdd(i,m),a+=r*u}{const e=a-o-this.m_motorSpeed;let i=-this.m_motorMass*e;const n=this.m_motorImpulse,h=t.step.dt*this.m_maxMotorTorque;this.m_motorImpulse=Ae(this.m_motorImpulse+i,-h,h),i=this.m_motorImpulse-n,o-=s*i,a+=r*i}if(this.m_enableLimit){{const l=this.m_translation-this.m_lowerTranslation,m=Ie.DotVV(this.m_ax,Ie.SubVV(h,n,Ie.s_t0))+this.m_sBx*a-this.m_sAx*o;let c=-this.m_axialMass*(m+Be(l,0)*t.step.inv_dt);const u=this.m_lowerImpulse;this.m_lowerImpulse=Be(this.m_lowerImpulse+c,0),c=this.m_lowerImpulse-u;const _=Ie.MulSV(c,this.m_ax,Ss.SolveVelocityConstraints_s_P),d=c*this.m_sAx,p=c*this.m_sBx;n.SelfMulSub(e,_),o-=s*d,h.SelfMulAdd(i,_),a+=r*p}{const l=this.m_upperTranslation-this.m_translation,m=Ie.DotVV(this.m_ax,Ie.SubVV(n,h,Ie.s_t0))+this.m_sAx*o-this.m_sBx*a;let c=-this.m_axialMass*(m+Be(l,0)*t.step.inv_dt);const u=this.m_upperImpulse;this.m_upperImpulse=Be(this.m_upperImpulse+c,0),c=this.m_upperImpulse-u;const _=Ie.MulSV(c,this.m_ax,Ss.SolveVelocityConstraints_s_P),d=c*this.m_sAx,p=c*this.m_sBx;n.SelfMulAdd(e,_),o+=s*d,h.SelfMulSub(i,_),a-=r*p}}{const t=Ie.DotVV(this.m_ay,Ie.SubVV(h,n,Ie.s_t0))+this.m_sBy*a-this.m_sAy*o,l=-this.m_mass*t;this.m_impulse+=l;const m=Ie.MulSV(l,this.m_ay,Ss.SolveVelocityConstraints_s_P),c=l*this.m_sAy,u=l*this.m_sBy;n.SelfMulSub(e,m),o-=s*c,h.SelfMulAdd(i,m),a+=r*u}t.velocities[this.m_indexA].w=o,t.velocities[this.m_indexB].w=a}SolvePositionConstraints(t){const e=t.positions[this.m_indexA].c;let i=t.positions[this.m_indexA].a;const s=t.positions[this.m_indexB].c;let r=t.positions[this.m_indexB].a,n=0;if(this.m_enableLimit){const t=this.m_qA.SetAngle(i),o=this.m_qB.SetAngle(r);Ie.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);const h=Fe.MulRV(t,this.m_lalcA,this.m_rA);Ie.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);const a=Fe.MulRV(o,this.m_lalcB,this.m_rB),l=Ie.AddVV(Ie.SubVV(s,e,Ie.s_t0),Ie.SubVV(a,h,Ie.s_t1),Ss.SolvePositionConstraints_s_d),m=Fe.MulRV(t,this.m_localXAxisA,this.m_ax),c=Ie.CrossVV(Ie.AddVV(l,h,Ie.s_t0),this.m_ax),u=Ie.CrossVV(a,this.m_ax);let _=0;const d=Ie.DotVV(m,l);if(Se(this.m_upperTranslation-this.m_lowerTranslation)<.01?_=d:d<=this.m_lowerTranslation?_=be(d-this.m_lowerTranslation,0):d>=this.m_upperTranslation&&(_=Be(d-this.m_upperTranslation,0)),0!==_){const t=this.m_invMassA+this.m_invMassB+this.m_invIA*c*c+this.m_invIB*u*u;let o=0;0!==t&&(o=-_/t);const h=Ie.MulSV(o,m,Ss.SolvePositionConstraints_s_P),a=o*c,l=o*u;e.SelfMulSub(this.m_invMassA,h),i-=this.m_invIA*a,s.SelfMulAdd(this.m_invMassB,h),r+=this.m_invIB*l,n=Se(_)}}{const t=this.m_qA.SetAngle(i),o=this.m_qB.SetAngle(r);Ie.SubVV(this.m_localAnchorA,this.m_localCenterA,this.m_lalcA);const h=Fe.MulRV(t,this.m_lalcA,this.m_rA);Ie.SubVV(this.m_localAnchorB,this.m_localCenterB,this.m_lalcB);const a=Fe.MulRV(o,this.m_lalcB,this.m_rB),l=Ie.AddVV(Ie.SubVV(s,e,Ie.s_t0),Ie.SubVV(a,h,Ie.s_t1),Ss.SolvePositionConstraints_s_d),m=Fe.MulRV(t,this.m_localYAxisA,this.m_ay),c=Ie.CrossVV(Ie.AddVV(l,h,Ie.s_t0),m),u=Ie.CrossVV(a,m),_=Ie.DotVV(l,m),d=this.m_invMassA+this.m_invMassB+this.m_invIA*this.m_sAy*this.m_sAy+this.m_invIB*this.m_sBy*this.m_sBy;let p=0;0!==d&&(p=-_/d);const f=Ie.MulSV(p,m,Ss.SolvePositionConstraints_s_P),y=p*c,x=p*u;e.SelfMulSub(this.m_invMassA,f),i-=this.m_invIA*y,s.SelfMulAdd(this.m_invMassB,f),r+=this.m_invIB*x,n=Be(n,Se(_))}return t.positions[this.m_indexA].a=i,t.positions[this.m_indexB].a=r,n<=de}GetDefinition(t){return t}GetAnchorA(t){return this.m_bodyA.GetWorldPoint(this.m_localAnchorA,t)}GetAnchorB(t){return this.m_bodyB.GetWorldPoint(this.m_localAnchorB,t)}GetReactionForce(t,e){return e.x=t*(this.m_impulse*this.m_ay.x+(this.m_springImpulse+this.m_lowerImpulse-this.m_upperImpulse)*this.m_ax.x),e.y=t*(this.m_impulse*this.m_ay.y+(this.m_springImpulse+this.m_lowerImpulse-this.m_upperImpulse)*this.m_ax.y),e}GetReactionTorque(t){return t*this.m_motorImpulse}GetLocalAnchorA(){return this.m_localAnchorA}GetLocalAnchorB(){return this.m_localAnchorB}GetLocalAxisA(){return this.m_localXAxisA}GetJointTranslation(){return this.GetPrismaticJointTranslation()}GetJointLinearSpeed(){return this.GetPrismaticJointSpeed()}GetJointAngle(){return this.GetRevoluteJointAngle()}GetJointAngularSpeed(){return this.GetRevoluteJointSpeed()}GetPrismaticJointTranslation(){const t=this.m_bodyA,e=this.m_bodyB,i=t.GetWorldPoint(this.m_localAnchorA,new Ie),s=e.GetWorldPoint(this.m_localAnchorB,new Ie),r=Ie.SubVV(s,i,new Ie),n=t.GetWorldVector(this.m_localXAxisA,new Ie);return Ie.DotVV(r,n)}GetPrismaticJointSpeed(){const t=this.m_bodyA,e=this.m_bodyB;Ie.SubVV(this.m_localAnchorA,t.m_sweep.localCenter,this.m_lalcA);const i=Fe.MulRV(t.m_xf.q,this.m_lalcA,this.m_rA);Ie.SubVV(this.m_localAnchorB,e.m_sweep.localCenter,this.m_lalcB);const s=Fe.MulRV(e.m_xf.q,this.m_lalcB,this.m_rB),r=Ie.AddVV(t.m_sweep.c,i,Ie.s_t0),n=Ie.AddVV(e.m_sweep.c,s,Ie.s_t1),o=Ie.SubVV(n,r,Ie.s_t2),h=t.GetWorldVector(this.m_localXAxisA,new Ie),a=t.m_linearVelocity,l=e.m_linearVelocity,m=t.m_angularVelocity,c=e.m_angularVelocity;return Ie.DotVV(o,Ie.CrossSV(m,h,Ie.s_t0))+Ie.DotVV(h,Ie.SubVV(Ie.AddVCrossSV(l,c,s,Ie.s_t0),Ie.AddVCrossSV(a,m,i,Ie.s_t1),Ie.s_t0))}GetRevoluteJointAngle(){return this.m_bodyB.m_sweep.a-this.m_bodyA.m_sweep.a}GetRevoluteJointSpeed(){const t=this.m_bodyA.m_angularVelocity;return this.m_bodyB.m_angularVelocity-t}IsMotorEnabled(){return this.m_enableMotor}EnableMotor(t){t!==this.m_enableMotor&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableMotor=t)}SetMotorSpeed(t){t!==this.m_motorSpeed&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_motorSpeed=t)}SetMaxMotorTorque(t){t!==this.m_maxMotorTorque&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_maxMotorTorque=t)}GetMotorTorque(t){return t*this.m_motorImpulse}IsLimitEnabled(){return this.m_enableLimit}EnableLimit(t){t!==this.m_enableLimit&&(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_enableLimit=t,this.m_lowerImpulse=0,this.m_upperImpulse=0)}GetLowerLimit(){return this.m_lowerTranslation}GetUpperLimit(){return this.m_upperTranslation}SetLimits(t,e){t===this.m_lowerTranslation&&e===this.m_upperTranslation||(this.m_bodyA.SetAwake(!0),this.m_bodyB.SetAwake(!0),this.m_lowerTranslation=t,this.m_upperTranslation=e,this.m_lowerImpulse=0,this.m_upperImpulse=0)}Dump(t){const e=this.m_bodyA.m_islandIndex,i=this.m_bodyB.m_islandIndex;t("  const jd: b2WheelJointDef = new b2WheelJointDef();\n"),t("  jd.bodyA = bodies[%d];\n",e),t("  jd.bodyB = bodies[%d];\n",i),t("  jd.collideConnected = %s;\n",this.m_collideConnected?"true":"false"),t("  jd.localAnchorA.Set(%.15f, %.15f);\n",this.m_localAnchorA.x,this.m_localAnchorA.y),t("  jd.localAnchorB.Set(%.15f, %.15f);\n",this.m_localAnchorB.x,this.m_localAnchorB.y),t("  jd.localAxisA.Set(%.15f, %.15f);\n",this.m_localXAxisA.x,this.m_localXAxisA.y),t("  jd.enableMotor = %s;\n",this.m_enableMotor?"true":"false"),t("  jd.motorSpeed = %.15f;\n",this.m_motorSpeed),t("  jd.maxMotorTorque = %.15f;\n",this.m_maxMotorTorque),t("  jd.stiffness = %.15f;\n",this.m_stiffness),t("  jd.damping = %.15f;\n",this.m_damping),t("  joints[%d] = this.m_world.CreateJoint(jd);\n",this.m_index)}Draw(t){const e=this.m_bodyA.GetTransform(),i=this.m_bodyB.GetTransform(),s=ke.MulXV(e,this.m_localAnchorA,Ss.Draw_s_pA),r=ke.MulXV(i,this.m_localAnchorB,Ss.Draw_s_pB),n=Fe.MulRV(e.q,this.m_localXAxisA,Ss.Draw_s_axis),o=Ss.Draw_s_c1,h=Ss.Draw_s_c2,a=Ss.Draw_s_c3,l=Ss.Draw_s_c4,m=Ss.Draw_s_c5;if(t.DrawSegment(s,r,m),this.m_enableLimit){const i=Ie.AddVMulSV(s,this.m_lowerTranslation,n,Ss.Draw_s_lower),r=Ie.AddVMulSV(s,this.m_upperTranslation,n,Ss.Draw_s_upper),l=Fe.MulRV(e.q,this.m_localYAxisA,Ss.Draw_s_perp);t.DrawSegment(i,r,o),t.DrawSegment(Ie.AddVMulSV(i,-.5,l,Ie.s_t0),Ie.AddVMulSV(i,.5,l,Ie.s_t1),h),t.DrawSegment(Ie.AddVMulSV(r,-.5,l,Ie.s_t0),Ie.AddVMulSV(r,.5,l,Ie.s_t1),a)}else t.DrawSegment(Ie.AddVMulSV(s,-1,n,Ie.s_t0),Ie.AddVMulSV(s,1,n,Ie.s_t1),o);t.DrawPoint(s,5,o),t.DrawPoint(r,5,l)}}Ss.InitVelocityConstraints_s_d=new Ie,Ss.InitVelocityConstraints_s_P=new Ie,Ss.SolveVelocityConstraints_s_P=new Ie,Ss.SolvePositionConstraints_s_d=new Ie,Ss.SolvePositionConstraints_s_P=new Ie,Ss.Draw_s_pA=new Ie,Ss.Draw_s_pB=new Ie,Ss.Draw_s_axis=new Ie,Ss.Draw_s_c1=new ki(.7,.7,.7),Ss.Draw_s_c2=new ki(.3,.9,.3),Ss.Draw_s_c3=new ki(.9,.3,.3),Ss.Draw_s_c4=new ki(.3,.3,.9),Ss.Draw_s_c5=new ki(.4,.4,.4),Ss.Draw_s_lower=new Ie,Ss.Draw_s_upper=new Ie,Ss.Draw_s_perp=new Ie;class bs{constructor(t){this.m_stack=[],this.m_count=0,this.m_stack=we(t,(t=>null)),this.m_count=0}Reset(){return this.m_count=0,this}Push(t){this.m_stack[this.m_count]=t,this.m_count++}Pop(){this.m_count--;const t=this.m_stack[this.m_count];return this.m_stack[this.m_count]=null,t}GetCount(){return this.m_count}}function Bs(t){if(null===t)throw new Error;return t}class As{constructor(t=0){this.m_id=0,this.aabb=new pi,this._userData=null,this.parent=null,this.child1=null,this.child2=null,this.height=0,this.moved=!1,this.m_id=t}get userData(){if(null===this._userData)throw new Error;return this._userData}set userData(t){if(null!==this._userData)throw new Error;this._userData=t}Reset(){this._userData=null}IsLeaf(){return null===this.child1}}class Vs{constructor(){this.m_root=null,this.m_freeList=null,this.m_insertionCount=0,this.m_stack=new bs(256)}Query(t,e){const i=this.m_stack.Reset();for(i.Push(this.m_root);i.GetCount()>0;){const s=i.Pop();if(null!==s&&s.aabb.TestOverlap(t))if(s.IsLeaf()){if(!e(s))return}else i.Push(s.child1),i.Push(s.child2)}}QueryPoint(t,e){const i=this.m_stack.Reset();for(i.Push(this.m_root);i.GetCount()>0;){const s=i.Pop();if(null!==s&&s.aabb.TestContain(t))if(s.IsLeaf()){if(!e(s))return}else i.Push(s.child1),i.Push(s.child2)}}RayCast(t,e){const i=t.p1,s=t.p2,r=Ie.SubVV(s,i,Vs.s_r);r.Normalize();const n=Ie.CrossOneV(r,Vs.s_v),o=Ie.AbsV(n,Vs.s_abs_v);let h=t.maxFraction;const a=Vs.s_segmentAABB;let l=i.x+h*(s.x-i.x),m=i.y+h*(s.y-i.y);a.lowerBound.x=be(i.x,l),a.lowerBound.y=be(i.y,m),a.upperBound.x=Be(i.x,l),a.upperBound.y=Be(i.y,m);const c=this.m_stack.Reset();for(c.Push(this.m_root);c.GetCount()>0;){const r=c.Pop();if(null===r)continue;if(!fi(r.aabb,a))continue;const u=r.aabb.GetCenter(),_=r.aabb.GetExtents();if(!(Se(Ie.DotVV(n,Ie.SubVV(i,u,Ie.s_t0)))-Ie.DotVV(o,_)>0))if(r.IsLeaf()){const n=Vs.s_subInput;n.p1.Copy(t.p1),n.p2.Copy(t.p2),n.maxFraction=h;const o=e(n,r);if(0===o)return;o>0&&(h=o,l=i.x+h*(s.x-i.x),m=i.y+h*(s.y-i.y),a.lowerBound.x=be(i.x,l),a.lowerBound.y=be(i.y,m),a.upperBound.x=Be(i.x,l),a.upperBound.y=Be(i.y,m))}else c.Push(r.child1),c.Push(r.child2)}}AllocateNode(){if(null!==this.m_freeList){const t=this.m_freeList;return this.m_freeList=t.parent,t.parent=null,t.child1=null,t.child2=null,t.height=0,t.moved=!1,t}return new As(Vs.s_node_id++)}FreeNode(t){t.parent=this.m_freeList,t.child1=null,t.child2=null,t.height=-1,t.Reset(),this.m_freeList=t}CreateProxy(t,e){const i=this.AllocateNode();return i.aabb.lowerBound.x=t.lowerBound.x-.1,i.aabb.lowerBound.y=t.lowerBound.y-.1,i.aabb.upperBound.x=t.upperBound.x+.1,i.aabb.upperBound.y=t.upperBound.y+.1,i.userData=e,i.height=0,i.moved=!0,this.InsertLeaf(i),i}DestroyProxy(t){this.RemoveLeaf(t),this.FreeNode(t)}MoveProxy(t,e,i){const s=Vs.MoveProxy_s_fatAABB;s.lowerBound.x=e.lowerBound.x-.1,s.lowerBound.y=e.lowerBound.y-.1,s.upperBound.x=e.upperBound.x+.1,s.upperBound.y=e.upperBound.y+.1;const r=4*i.x,n=4*i.y;r<0?s.lowerBound.x+=r:s.upperBound.x+=r,n<0?s.lowerBound.y+=n:s.upperBound.y+=n;const o=t.aabb;if(o.Contains(e)){const t=Vs.MoveProxy_s_hugeAABB;if(t.lowerBound.x=s.lowerBound.x-.4,t.lowerBound.y=s.lowerBound.y-.4,t.upperBound.x=s.upperBound.x+.4,t.upperBound.y=s.upperBound.y+.4,t.Contains(o))return!1}return this.RemoveLeaf(t),t.aabb.Copy(s),this.InsertLeaf(t),t.moved=!0,!0}InsertLeaf(t){if(++this.m_insertionCount,null===this.m_root)return this.m_root=t,void(this.m_root.parent=null);const e=t.aabb;let i=this.m_root;for(;!i.IsLeaf();){const t=Bs(i.child1),s=Bs(i.child2),r=i.aabb.GetPerimeter(),n=Vs.s_combinedAABB;n.Combine2(i.aabb,e);const o=n.GetPerimeter(),h=2*o,a=2*(o-r);let l;const m=Vs.s_aabb;let c,u,_;if(t.IsLeaf()?(m.Combine2(e,t.aabb),l=m.GetPerimeter()+a):(m.Combine2(e,t.aabb),c=t.aabb.GetPerimeter(),u=m.GetPerimeter(),l=u-c+a),s.IsLeaf()?(m.Combine2(e,s.aabb),_=m.GetPerimeter()+a):(m.Combine2(e,s.aabb),c=s.aabb.GetPerimeter(),u=m.GetPerimeter(),_=u-c+a),h<l&&h<_)break;i=l<_?t:s}const s=i.parent,r=this.AllocateNode();r.parent=s,r.aabb.Combine2(e,i.aabb),r.height=i.height+1,null!==s?(s.child1===i?s.child1=r:s.child2=r,r.child1=i,r.child2=t,i.parent=r,t.parent=r):(r.child1=i,r.child2=t,i.parent=r,t.parent=r,this.m_root=r);let n=t.parent;for(;null!==n;){n=this.Balance(n);const t=Bs(n.child1),e=Bs(n.child2);n.height=1+Be(t.height,e.height),n.aabb.Combine2(t.aabb,e.aabb),n=n.parent}}RemoveLeaf(t){if(t===this.m_root)return void(this.m_root=null);const e=Bs(t.parent),i=e&&e.parent,s=Bs(e.child1===t?e.child2:e.child1);if(null!==i){i.child1===e?i.child1=s:i.child2=s,s.parent=i,this.FreeNode(e);let t=i;for(;null!==t;){t=this.Balance(t);const e=Bs(t.child1),i=Bs(t.child2);t.aabb.Combine2(e.aabb,i.aabb),t.height=1+Be(e.height,i.height),t=t.parent}}else this.m_root=s,s.parent=null,this.FreeNode(e)}Balance(t){if(t.IsLeaf()||t.height<2)return t;const e=Bs(t.child1),i=Bs(t.child2),s=i.height-e.height;if(s>1){const s=Bs(i.child1),r=Bs(i.child2);return i.child1=t,i.parent=t.parent,t.parent=i,null!==i.parent?i.parent.child1===t?i.parent.child1=i:i.parent.child2=i:this.m_root=i,s.height>r.height?(i.child2=s,t.child2=r,r.parent=t,t.aabb.Combine2(e.aabb,r.aabb),i.aabb.Combine2(t.aabb,s.aabb),t.height=1+Be(e.height,r.height),i.height=1+Be(t.height,s.height)):(i.child2=r,t.child2=s,s.parent=t,t.aabb.Combine2(e.aabb,s.aabb),i.aabb.Combine2(t.aabb,r.aabb),t.height=1+Be(e.height,s.height),i.height=1+Be(t.height,r.height)),i}if(s<-1){const s=Bs(e.child1),r=Bs(e.child2);return e.child1=t,e.parent=t.parent,t.parent=e,null!==e.parent?e.parent.child1===t?e.parent.child1=e:e.parent.child2=e:this.m_root=e,s.height>r.height?(e.child2=s,t.child1=r,r.parent=t,t.aabb.Combine2(i.aabb,r.aabb),e.aabb.Combine2(t.aabb,s.aabb),t.height=1+Be(i.height,r.height),e.height=1+Be(t.height,s.height)):(e.child2=r,t.child1=s,s.parent=t,t.aabb.Combine2(i.aabb,s.aabb),e.aabb.Combine2(t.aabb,r.aabb),t.height=1+Be(i.height,s.height),e.height=1+Be(t.height,r.height)),e}return t}GetHeight(){return null===this.m_root?0:this.m_root.height}static GetAreaNode(t){if(null===t)return 0;if(t.IsLeaf())return 0;let e=t.aabb.GetPerimeter();return e+=Vs.GetAreaNode(t.child1),e+=Vs.GetAreaNode(t.child2),e}GetAreaRatio(){if(null===this.m_root)return 0;const t=this.m_root.aabb.GetPerimeter();return Vs.GetAreaNode(this.m_root)/t}static ComputeHeightNode(t){return null===t||t.IsLeaf()?0:1+Be(Vs.ComputeHeightNode(t.child1),Vs.ComputeHeightNode(t.child2))}ComputeHeight(){return Vs.ComputeHeightNode(this.m_root)}ValidateStructure(t){if(null===t)return;if(this.m_root,t.IsLeaf())return;const e=Bs(t.child1),i=Bs(t.child2);this.ValidateStructure(e),this.ValidateStructure(i)}ValidateMetrics(t){if(null===t)return;if(t.IsLeaf())return;const e=Bs(t.child1),i=Bs(t.child2);Vs.s_aabb.Combine2(e.aabb,i.aabb),this.ValidateMetrics(e),this.ValidateMetrics(i)}Validate(){}static GetMaxBalanceNode(t,e){if(null===t)return e;if(t.height<=1)return e;const i=Bs(t.child1),s=Bs(t.child2);return Be(e,Se(s.height-i.height))}GetMaxBalance(){return Vs.GetMaxBalanceNode(this.m_root,0)}RebuildBottomUp(){this.Validate()}static ShiftOriginNode(t,e){if(null===t)return;if(t.height<=1)return;const i=t.child1,s=t.child2;Vs.ShiftOriginNode(i,e),Vs.ShiftOriginNode(s,e),t.aabb.lowerBound.SelfSub(e),t.aabb.upperBound.SelfSub(e)}ShiftOrigin(t){Vs.ShiftOriginNode(this.m_root,t)}}Vs.s_r=new Ie,Vs.s_v=new Ie,Vs.s_abs_v=new Ie,Vs.s_segmentAABB=new pi,Vs.s_subInput=new _i,Vs.s_combinedAABB=new pi,Vs.s_aabb=new pi,Vs.s_node_id=0,Vs.MoveProxy_s_fatAABB=new pi,Vs.MoveProxy_s_hugeAABB=new pi;class Ms{constructor(t,e){this.proxyA=t,this.proxyB=e}}class Ds{constructor(){this.m_tree=new Vs,this.m_proxyCount=0,this.m_moveCount=0,this.m_moveBuffer=[],this.m_pairCount=0,this.m_pairBuffer=[]}CreateProxy(t,e){const i=this.m_tree.CreateProxy(t,e);return++this.m_proxyCount,this.BufferMove(i),i}DestroyProxy(t){this.UnBufferMove(t),--this.m_proxyCount,this.m_tree.DestroyProxy(t)}MoveProxy(t,e,i){this.m_tree.MoveProxy(t,e,i)&&this.BufferMove(t)}TouchProxy(t){this.BufferMove(t)}GetProxyCount(){return this.m_proxyCount}UpdatePairs(t){this.m_pairCount=0;for(let t=0;t<this.m_moveCount;++t){const e=this.m_moveBuffer[t];if(null===e)continue;const i=e.aabb;this.m_tree.Query(i,(t=>{if(t.m_id===e.m_id)return!0;if(t.moved&&t.m_id>e.m_id)return!0;let i,s;if(t.m_id<e.m_id?(i=t,s=e):(i=e,s=t),this.m_pairCount===this.m_pairBuffer.length)this.m_pairBuffer[this.m_pairCount]=new Ms(i,s);else{const t=this.m_pairBuffer[this.m_pairCount];t.proxyA=i,t.proxyB=s}return++this.m_pairCount,!0}))}for(let e=0;e<this.m_pairCount;++e){const i=this.m_pairBuffer[e];t(i.proxyA.userData,i.proxyB.userData)}for(let t=0;t<this.m_moveCount;++t){const e=this.m_moveBuffer[t];null!==e&&(e.moved=!1)}this.m_moveCount=0}Query(t,e){this.m_tree.Query(t,e)}QueryPoint(t,e){this.m_tree.QueryPoint(t,e)}RayCast(t,e){this.m_tree.RayCast(t,e)}GetTreeHeight(){return this.m_tree.GetHeight()}GetTreeBalance(){return this.m_tree.GetMaxBalance()}GetTreeQuality(){return this.m_tree.GetAreaRatio()}ShiftOrigin(t){this.m_tree.ShiftOrigin(t)}BufferMove(t){this.m_moveBuffer[this.m_moveCount]=t,++this.m_moveCount}UnBufferMove(t){for(let e=0;e<this.m_moveCount;++e)this.m_moveBuffer[e]===t&&(this.m_moveBuffer[e]=null)}}const Is=new Ie,Ps=new Ie,Gs=new Ie,Ts=new Ie,Rs=new Ie;function Fs(t,e){return De(t*e)}function ks(t,e){return t>e?t:e}function Es(t,e){return t<e?t:e}class Ls{constructor(t){this._other=null,this.prev=null,this.next=null,this.contact=t}get other(){if(null===this._other)throw new Error;return this._other}set other(t){if(null!==this._other)throw new Error;this._other=t}Reset(){this._other=null,this.prev=null,this.next=null}}class Os{constructor(){this.m_islandFlag=!1,this.m_touchingFlag=!1,this.m_enabledFlag=!1,this.m_filterFlag=!1,this.m_bulletHitFlag=!1,this.m_toiFlag=!1,this.m_prev=null,this.m_next=null,this.m_nodeA=new Ls(this),this.m_nodeB=new Ls(this),this.m_indexA=0,this.m_indexB=0,this.m_manifold=new mi,this.m_toiCount=0,this.m_toi=0,this.m_friction=0,this.m_restitution=0,this.m_restitutionThreshold=0,this.m_tangentSpeed=0,this.m_oldManifold=new mi}GetManifold(){return this.m_manifold}GetWorldManifold(t){const e=this.m_fixtureA.GetBody(),i=this.m_fixtureB.GetBody(),s=this.GetShapeA(),r=this.GetShapeB();t.Initialize(this.m_manifold,e.GetTransform(),s.m_radius,i.GetTransform(),r.m_radius)}IsTouching(){return this.m_touchingFlag}SetEnabled(t){this.m_enabledFlag=t}IsEnabled(){return this.m_enabledFlag}GetNext(){return this.m_next}GetFixtureA(){return this.m_fixtureA}GetChildIndexA(){return this.m_indexA}GetShapeA(){return this.m_fixtureA.GetShape()}GetFixtureB(){return this.m_fixtureB}GetChildIndexB(){return this.m_indexB}GetShapeB(){return this.m_fixtureB.GetShape()}FlagForFiltering(){this.m_filterFlag=!0}SetFriction(t){this.m_friction=t}GetFriction(){return this.m_friction}ResetFriction(){this.m_friction=Fs(this.m_fixtureA.m_friction,this.m_fixtureB.m_friction)}SetRestitution(t){this.m_restitution=t}GetRestitution(){return this.m_restitution}ResetRestitution(){this.m_restitution=ks(this.m_fixtureA.m_restitution,this.m_fixtureB.m_restitution)}SetRestitutionThreshold(t){this.m_restitutionThreshold=t}GetRestitutionThreshold(){return this.m_restitutionThreshold}ResetRestitutionThreshold(){this.m_restitutionThreshold=Es(this.m_fixtureA.m_restitutionThreshold,this.m_fixtureB.m_restitutionThreshold)}SetTangentSpeed(t){this.m_tangentSpeed=t}GetTangentSpeed(){return this.m_tangentSpeed}Reset(t,e,i,s){this.m_islandFlag=!1,this.m_touchingFlag=!1,this.m_enabledFlag=!0,this.m_filterFlag=!1,this.m_bulletHitFlag=!1,this.m_toiFlag=!1,this.m_fixtureA=t,this.m_fixtureB=i,this.m_indexA=e,this.m_indexB=s,this.m_manifold.pointCount=0,this.m_prev=null,this.m_next=null,this.m_nodeA.Reset(),this.m_nodeB.Reset(),this.m_toiCount=0,this.m_friction=Fs(this.m_fixtureA.m_friction,this.m_fixtureB.m_friction),this.m_restitution=ks(this.m_fixtureA.m_restitution,this.m_fixtureB.m_restitution),this.m_restitutionThreshold=Es(this.m_fixtureA.m_restitutionThreshold,this.m_fixtureB.m_restitutionThreshold)}Update(t){const e=this.m_oldManifold;this.m_oldManifold=this.m_manifold,this.m_manifold=e,this.m_enabledFlag=!0;let i=!1;const s=this.m_touchingFlag,r=this.m_fixtureA.IsSensor(),n=this.m_fixtureB.IsSensor(),o=r||n,h=this.m_fixtureA.GetBody(),a=this.m_fixtureB.GetBody(),l=h.GetTransform(),m=a.GetTransform();if(o){const t=this.GetShapeA(),e=this.GetShapeB();i=Ci(t,this.m_indexA,e,this.m_indexB,l,m),this.m_manifold.pointCount=0}else{this.Evaluate(this.m_manifold,l,m),i=this.m_manifold.pointCount>0;for(let t=0;t<this.m_manifold.pointCount;++t){const e=this.m_manifold.points[t];e.normalImpulse=0,e.tangentImpulse=0;const i=e.id;for(let t=0;t<this.m_oldManifold.pointCount;++t){const s=this.m_oldManifold.points[t];if(s.id.key===i.key){e.normalImpulse=s.normalImpulse,e.tangentImpulse=s.tangentImpulse;break}}}i!==s&&(h.SetAwake(!0),a.SetAwake(!0))}this.m_touchingFlag=i,!s&&i&&t&&t.BeginContact(this),s&&!i&&t&&t.EndContact(this),!o&&i&&t&&t.PreSolve(this,this.m_oldManifold)}ComputeTOI(t,e){const i=Os.ComputeTOI_s_input;i.proxyA.SetShape(this.GetShapeA(),this.m_indexA),i.proxyB.SetShape(this.GetShapeB(),this.m_indexB),i.sweepA.Copy(t),i.sweepB.Copy(e),i.tMax=de;const s=Os.ComputeTOI_s_output;return as(s,i),s.t}}Os.ComputeTOI_s_input=new Hi,Os.ComputeTOI_s_output=new Ki;class zs extends Os{static Create(){return new zs}static Destroy(t){}Evaluate(t,e,i){!function(t,e,i,s,r){t.pointCount=0;const n=ke.MulXV(i,e.m_p,Is),o=ke.MulXV(r,s.m_p,Ps),h=Ie.DistanceSquaredVV(n,o),a=e.m_radius+s.m_radius;h>a*a||(t.type=ni.e_circles,t.localPoint.Copy(e.m_p),t.localNormal.SetZero(),t.pointCount=1,t.points[0].localPoint.Copy(s.m_p),t.points[0].id.key=0)}(t,this.GetShapeA(),e,this.GetShapeB(),i)}}const js=new ke,qs=new Ie,Ns=new Ie;function Ws(t,e,i,s,r){const n=e.m_count,o=s.m_count,h=e.m_normals,a=e.m_vertices,l=s.m_vertices,m=ke.MulTXX(r,i,js);let c=0,u=-ce;for(let t=0;t<n;++t){const e=Fe.MulRV(m.q,h[t],qs),i=ke.MulXV(m,a[t],Ns);let s=ce;for(let t=0;t<o;++t){const r=Ie.DotVV(e,Ie.SubVV(l[t],i,Ie.s_t0));r<s&&(s=r)}s>u&&(u=s,c=t)}return t[0]=c,u}const Xs=new Ie,Us=[new ui,new ui],Js=[new ui,new ui],Zs=[new ui,new ui],Hs=[0],Ys=[0],Qs=new Ie,Ks=new Ie,$s=new Ie,tr=new Ie,er=new Ie,ir=new Ie,sr=new Ie,rr=new Ie;class nr extends Os{static Create(){return new nr}static Destroy(t){}Evaluate(t,e,i){!function(t,e,i,s,r){t.pointCount=0;const n=e.m_radius+s.m_radius,o=Hs;o[0]=0;const h=Ws(o,e,i,s,r);if(h>n)return;const a=Ys;a[0]=0;const l=Ws(a,s,r,e,i);if(l>n)return;let m,c,u,_,d=0,p=0;l>h+5e-4?(m=s,c=e,u=r,_=i,d=a[0],t.type=ni.e_faceB,p=1):(m=e,c=s,u=i,_=r,d=o[0],t.type=ni.e_faceA,p=0);const f=Us;!function(t,e,i,s,r,n){const o=e.m_normals,h=r.m_count,a=r.m_vertices,l=r.m_normals,m=Fe.MulTRV(n.q,Fe.MulRV(i.q,o[s],Ie.s_t0),Xs);let c=0,u=ce;for(let t=0;t<h;++t){const e=Ie.DotVV(m,l[t]);e<u&&(u=e,c=t)}const _=c,d=_+1<h?_+1:0,p=t[0];ke.MulXV(n,a[_],p.v);const f=p.id.cf;f.indexA=s,f.indexB=_,f.typeA=ri.e_face,f.typeB=ri.e_vertex;const y=t[1];ke.MulXV(n,a[d],y.v);const x=y.id.cf;x.indexA=s,x.indexB=d,x.typeA=ri.e_face,x.typeB=ri.e_vertex}(f,m,u,d,c,_);const y=m.m_count,x=m.m_vertices,g=d,w=d+1<y?d+1:0,C=x[g],v=x[w],S=Ie.SubVV(v,C,Qs);S.Normalize();const b=Ie.CrossVOne(S,Ks),B=Ie.MidVV(C,v,$s),A=Fe.MulRV(u.q,S,er),V=Ie.CrossVOne(A,tr),M=ke.MulXV(u,C,sr),D=ke.MulXV(u,v,rr),I=Ie.DotVV(V,M),P=-Ie.DotVV(A,M)+n,G=Ie.DotVV(A,D)+n,T=Js,R=Zs;let F;if(F=yi(T,f,Ie.NegV(A,ir),P,g),F<2)return;if(F=yi(R,T,A,G,w),F<2)return;t.localNormal.Copy(b),t.localPoint.Copy(B);let k=0;for(let e=0;e<2;++e){const i=R[e];if(Ie.DotVV(V,i.v)-I<=n){const e=t.points[k];if(ke.MulTXV(_,i.v,e.localPoint),e.id.Copy(i.id),p){const t=e.id.cf;e.id.cf.indexA=t.indexB,e.id.cf.indexB=t.indexA,e.id.cf.typeA=t.typeB,e.id.cf.typeB=t.typeA}++k}}t.pointCount=k}(t,this.GetShapeA(),e,this.GetShapeB(),i)}}class or extends Os{static Create(){return new or}static Destroy(t){}Evaluate(t,e,i){!function(t,e,i,s,r){t.pointCount=0;const n=ke.MulXV(r,s.m_p,Gs),o=ke.MulTXV(i,n,Ts);let h=0,a=-ce;const l=e.m_radius+s.m_radius,m=e.m_count,c=e.m_vertices,u=e.m_normals;for(let t=0;t<m;++t){const e=Ie.DotVV(u[t],Ie.SubVV(o,c[t],Ie.s_t0));if(e>l)return;e>a&&(a=e,h=t)}const _=h,d=(_+1)%m,p=c[_],f=c[d];if(a<ue)return t.pointCount=1,t.type=ni.e_faceA,t.localNormal.Copy(u[h]),Ie.MidVV(p,f,t.localPoint),t.points[0].localPoint.Copy(s.m_p),void(t.points[0].id.key=0);const y=Ie.DotVV(Ie.SubVV(o,p,Ie.s_t0),Ie.SubVV(f,p,Ie.s_t1)),x=Ie.DotVV(Ie.SubVV(o,f,Ie.s_t0),Ie.SubVV(p,f,Ie.s_t1));if(y<=0){if(Ie.DistanceSquaredVV(o,p)>l*l)return;t.pointCount=1,t.type=ni.e_faceA,Ie.SubVV(o,p,t.localNormal).SelfNormalize(),t.localPoint.Copy(p),t.points[0].localPoint.Copy(s.m_p),t.points[0].id.key=0}else if(x<=0){if(Ie.DistanceSquaredVV(o,f)>l*l)return;t.pointCount=1,t.type=ni.e_faceA,Ie.SubVV(o,f,t.localNormal).SelfNormalize(),t.localPoint.Copy(f),t.points[0].localPoint.Copy(s.m_p),t.points[0].id.key=0}else{const e=Ie.MidVV(p,f,Rs);if(Ie.DotVV(Ie.SubVV(o,e,Ie.s_t1),u[_])>l)return;t.pointCount=1,t.type=ni.e_faceA,t.localNormal.Copy(u[_]).SelfNormalize(),t.localPoint.Copy(e),t.points[0].localPoint.Copy(s.m_p),t.points[0].id.key=0}}(t,this.GetShapeA(),e,this.GetShapeB(),i)}}const hr=new Ie,ar=new Ie,lr=new Ie,mr=new Ie,cr=new Ie,ur=new Ie,_r=new Ie,dr=new ai;function pr(t,e,i,s,r){t.pointCount=0;const n=ke.MulTXV(i,ke.MulXV(r,s.m_p,Ie.s_t0),hr),o=e.m_vertex1,h=e.m_vertex2,a=Ie.SubVV(h,o,ar),l=_r.Set(a.y,-a.x),m=Ie.DotVV(l,Ie.SubVV(n,o,Ie.s_t0));if(e.m_oneSided&&m<0)return;const c=Ie.DotVV(a,Ie.SubVV(h,n,Ie.s_t0)),u=Ie.DotVV(a,Ie.SubVV(n,o,Ie.s_t0)),_=e.m_radius+s.m_radius,d=dr;if(d.cf.indexB=0,d.cf.typeB=ri.e_vertex,u<=0){const i=o,r=Ie.SubVV(n,i,lr);if(Ie.DotVV(r,r)>_*_)return;if(e.m_oneSided){const t=e.m_vertex0,i=o,s=Ie.SubVV(i,t,mr);if(Ie.DotVV(s,Ie.SubVV(i,n,Ie.s_t0))>0)return}return d.cf.indexA=0,d.cf.typeA=ri.e_vertex,t.pointCount=1,t.type=ni.e_circles,t.localNormal.SetZero(),t.localPoint.Copy(i),t.points[0].id.Copy(d),void t.points[0].localPoint.Copy(s.m_p)}if(c<=0){const i=h,r=Ie.SubVV(n,i,lr);if(Ie.DotVV(r,r)>_*_)return;if(e.m_oneSided){const t=e.m_vertex3,i=h,s=Ie.SubVV(t,i,cr);if(Ie.DotVV(s,Ie.SubVV(n,i,Ie.s_t0))>0)return}return d.cf.indexA=1,d.cf.typeA=ri.e_vertex,t.pointCount=1,t.type=ni.e_circles,t.localNormal.SetZero(),t.localPoint.Copy(i),t.points[0].id.Copy(d),void t.points[0].localPoint.Copy(s.m_p)}const p=Ie.DotVV(a,a),f=ur;f.x=1/p*(c*o.x+u*h.x),f.y=1/p*(c*o.y+u*h.y);const y=Ie.SubVV(n,f,lr);Ie.DotVV(y,y)>_*_||(m<0&&l.Set(-l.x,-l.y),l.Normalize(),d.cf.indexA=0,d.cf.typeA=ri.e_face,t.pointCount=1,t.type=ni.e_faceA,t.localNormal.Copy(l),t.localPoint.Copy(o),t.points[0].id.Copy(d),t.points[0].localPoint.Copy(s.m_p))}var fr;!function(t){t[t.e_unknown=0]="e_unknown",t[t.e_edgeA=1]="e_edgeA",t[t.e_edgeB=2]="e_edgeB"}(fr||(fr={}));class yr{constructor(){this.normal=new Ie,this.type=fr.e_unknown,this.index=0,this.separation=0}}const xr=new yr,gr=[new Ie,new Ie],wr=new yr,Cr=new Ie,vr=new ke,Sr=new Ie,br=new Ie,Br=new Ie,Ar=new Ie,Vr=new Ie,Mr=new Ie,Dr=new Ie,Ir=new class{constructor(){this.vertices=[],this.normals=[],this.count=0}},Pr=new class{constructor(){this.i1=0,this.i2=0,this.v1=new Ie,this.v2=new Ie,this.normal=new Ie,this.sideNormal1=new Ie,this.sideOffset1=0,this.sideNormal2=new Ie,this.sideOffset2=0}},Gr=[new ui,new ui],Tr=[new ui,new ui],Rr=[new ui,new ui];function Fr(t,e,i,s,r){t.pointCount=0;const n=ke.MulTXX(i,r,vr),o=ke.MulXV(n,s.m_centroid,Sr),h=e.m_vertex1,a=e.m_vertex2,l=Ie.SubVV(a,h,br);l.Normalize();const m=Br.Set(l.y,-l.x),c=Ie.DotVV(m,Ie.SubVV(o,h,Ie.s_t0)),u=e.m_oneSided;if(u&&c<0)return;const _=Ir;_.count=s.m_count;for(let t=0;t<s.m_count;++t)_.vertices.length<=t&&_.vertices.push(new Ie),_.normals.length<=t&&_.normals.push(new Ie),ke.MulXV(n,s.m_vertices[t],_.vertices[t]),Fe.MulRV(n.q,s.m_normals[t],_.normals[t]);const d=s.m_radius+e.m_radius,p=function(t,e,i){const s=xr;s.type=fr.e_edgeA,s.index=-1,s.separation=-Number.MAX_VALUE,s.normal.SetZero();const r=gr;r[0].Copy(i),r[1].Copy(i).SelfNeg();for(let i=0;i<2;++i){let n=Number.MAX_VALUE;for(let s=0;s<t.count;++s){const o=Ie.DotVV(r[i],Ie.SubVV(t.vertices[s],e,Ie.s_t0));o<n&&(n=o)}n>s.separation&&(s.index=i,s.separation=n,s.normal.Copy(r[i]))}return s}(_,h,m);if(p.separation>d)return;const f=function(t,e,i){const s=wr;s.type=fr.e_unknown,s.index=-1,s.separation=-Number.MAX_VALUE,s.normal.SetZero();for(let r=0;r<t.count;++r){const n=Ie.NegV(t.normals[r],Cr),o=be(Ie.DotVV(n,Ie.SubVV(t.vertices[r],e,Ie.s_t0)),Ie.DotVV(n,Ie.SubVV(t.vertices[r],i,Ie.s_t0)));o>s.separation&&(s.type=fr.e_edgeB,s.index=r,s.separation=o,s.normal.Copy(n))}return s}(_,h,a);if(f.separation>d)return;let y;if(y=f.separation-d>.98*(p.separation-d)+.001?f:p,u){const t=Ie.SubVV(h,e.m_vertex0,Ar);t.Normalize();const i=Vr.Set(t.y,-t.x),s=Ie.CrossVV(t,l)>=0,r=Ie.SubVV(e.m_vertex3,a,Mr);r.Normalize();const n=Dr.Set(r.y,-r.x),o=Ie.CrossVV(l,r)>=0,m=.1;if(Ie.DotVV(y.normal,l)<=0)if(s){if(Ie.CrossVV(y.normal,i)>m)return}else y=p;else if(o){if(Ie.CrossVV(n,y.normal)>m)return}else y=p}const x=Gr,g=Pr;if(y.type===fr.e_edgeA){t.type=ni.e_faceA;let e=0,i=Ie.DotVV(y.normal,_.normals[0]);for(let t=1;t<_.count;++t){const s=Ie.DotVV(y.normal,_.normals[t]);s<i&&(i=s,e=t)}const s=e,r=s+1<_.count?s+1:0;x[0].v.Copy(_.vertices[s]),x[0].id.cf.indexA=0,x[0].id.cf.indexB=s,x[0].id.cf.typeA=ri.e_face,x[0].id.cf.typeB=ri.e_vertex,x[1].v.Copy(_.vertices[r]),x[1].id.cf.indexA=0,x[1].id.cf.indexB=r,x[1].id.cf.typeA=ri.e_face,x[1].id.cf.typeB=ri.e_vertex,g.i1=0,g.i2=1,g.v1.Copy(h),g.v2.Copy(a),g.normal.Copy(y.normal),g.sideNormal1.Copy(l).SelfNeg(),g.sideNormal2.Copy(l)}else t.type=ni.e_faceB,x[0].v.Copy(a),x[0].id.cf.indexA=1,x[0].id.cf.indexB=y.index,x[0].id.cf.typeA=ri.e_vertex,x[0].id.cf.typeB=ri.e_face,x[1].v.Copy(h),x[1].id.cf.indexA=0,x[1].id.cf.indexB=y.index,x[1].id.cf.typeA=ri.e_vertex,x[1].id.cf.typeB=ri.e_face,g.i1=y.index,g.i2=g.i1+1<_.count?g.i1+1:0,g.v1.Copy(_.vertices[g.i1]),g.v2.Copy(_.vertices[g.i2]),g.normal.Copy(_.normals[g.i1]),g.sideNormal1.Set(g.normal.y,-g.normal.x),g.sideNormal2.Copy(g.sideNormal1).SelfNeg();g.sideOffset1=Ie.DotVV(g.sideNormal1,g.v1),g.sideOffset2=Ie.DotVV(g.sideNormal2,g.v2);const w=Tr,C=Rr;let v;if(v=yi(w,x,g.sideNormal1,g.sideOffset1,g.i1),v<2)return;if(v=yi(C,w,g.sideNormal2,g.sideOffset2,g.i2),v<2)return;y.type===fr.e_edgeA?(t.localNormal.Copy(g.normal),t.localPoint.Copy(g.v1)):(t.localNormal.Copy(s.m_normals[g.i1]),t.localPoint.Copy(s.m_vertices[g.i1]));let S=0;for(let e=0;e<2;++e)if(Ie.DotVV(g.normal,Ie.SubVV(C[e].v,g.v1,Ie.s_t0))<=d){const i=t.points[S];y.type===fr.e_edgeA?(ke.MulTXV(n,C[e].v,i.localPoint),i.id.Copy(C[e].id)):(i.localPoint.Copy(C[e].v),i.id.cf.typeA=C[e].id.cf.typeB,i.id.cf.typeB=C[e].id.cf.typeA,i.id.cf.indexA=C[e].id.cf.indexB,i.id.cf.indexB=C[e].id.cf.indexA),++S}t.pointCount=S}class kr extends Os{static Create(){return new kr}static Destroy(t){}Evaluate(t,e,i){pr(t,this.GetShapeA(),e,this.GetShapeB(),i)}}class Er extends Os{static Create(){return new Er}static Destroy(t){}Evaluate(t,e,i){Fr(t,this.GetShapeA(),e,this.GetShapeB(),i)}}class Lr extends je{constructor(){super(Oe.e_edgeShape,.01),this.m_vertex1=new Ie,this.m_vertex2=new Ie,this.m_vertex0=new Ie,this.m_vertex3=new Ie,this.m_oneSided=!1}SetOneSided(t,e,i,s){return this.m_vertex0.Copy(t),this.m_vertex1.Copy(e),this.m_vertex2.Copy(i),this.m_vertex3.Copy(s),this.m_oneSided=!0,this}SetTwoSided(t,e){return this.m_vertex1.Copy(t),this.m_vertex2.Copy(e),this.m_oneSided=!1,this}Clone(){return(new Lr).Copy(this)}Copy(t){return super.Copy(t),this.m_vertex1.Copy(t.m_vertex1),this.m_vertex2.Copy(t.m_vertex2),this.m_vertex0.Copy(t.m_vertex0),this.m_vertex3.Copy(t.m_vertex3),this.m_oneSided=t.m_oneSided,this}GetChildCount(){return 1}TestPoint(t,e){return!1}ComputeDistance(t,e,i,s){const r=ke.MulXV(t,this.m_vertex1,Lr.ComputeDistance_s_v1),n=ke.MulXV(t,this.m_vertex2,Lr.ComputeDistance_s_v2),o=Ie.SubVV(e,r,Lr.ComputeDistance_s_d),h=Ie.SubVV(n,r,Lr.ComputeDistance_s_s),a=Ie.DotVV(o,h);if(a>0){const t=Ie.DotVV(h,h);a>t?Ie.SubVV(e,n,o):o.SelfMulSub(a/t,h)}return i.Copy(o),i.Normalize()}RayCast(t,e,i,s){const r=ke.MulTXV(i,e.p1,Lr.RayCast_s_p1),n=ke.MulTXV(i,e.p2,Lr.RayCast_s_p2),o=Ie.SubVV(n,r,Lr.RayCast_s_d),h=this.m_vertex1,a=this.m_vertex2,l=Ie.SubVV(a,h,Lr.RayCast_s_e),m=t.normal.Set(l.y,-l.x).SelfNormalize(),c=Ie.DotVV(m,Ie.SubVV(h,r,Ie.s_t0));if(this.m_oneSided&&c>0)return!1;const u=Ie.DotVV(m,o);if(0===u)return!1;const _=c/u;if(_<0||e.maxFraction<_)return!1;const d=Ie.AddVMulSV(r,_,o,Lr.RayCast_s_q),p=Ie.SubVV(a,h,Lr.RayCast_s_r),f=Ie.DotVV(p,p);if(0===f)return!1;const y=Ie.DotVV(Ie.SubVV(d,h,Ie.s_t0),p)/f;return!(y<0||1<y||(t.fraction=_,Fe.MulRV(i.q,t.normal,t.normal),c>0&&t.normal.SelfNeg(),0))}ComputeAABB(t,e,i){const s=ke.MulXV(e,this.m_vertex1,Lr.ComputeAABB_s_v1),r=ke.MulXV(e,this.m_vertex2,Lr.ComputeAABB_s_v2);Ie.MinV(s,r,t.lowerBound),Ie.MaxV(s,r,t.upperBound);const n=this.m_radius;t.lowerBound.SelfSubXY(n,n),t.upperBound.SelfAddXY(n,n)}ComputeMass(t,e){t.mass=0,Ie.MidVV(this.m_vertex1,this.m_vertex2,t.center),t.I=0}SetupDistanceProxy(t,e){t.m_vertices=t.m_buffer,t.m_vertices[0].Copy(this.m_vertex1),t.m_vertices[1].Copy(this.m_vertex2),t.m_count=2,t.m_radius=this.m_radius}ComputeSubmergedArea(t,e,i,s){return s.SetZero(),0}Dump(t){t("    const shape: b2EdgeShape = new b2EdgeShape();\n"),t("    shape.m_radius = %.15f;\n",this.m_radius),t("    shape.m_vertex0.Set(%.15f, %.15f);\n",this.m_vertex0.x,this.m_vertex0.y),t("    shape.m_vertex1.Set(%.15f, %.15f);\n",this.m_vertex1.x,this.m_vertex1.y),t("    shape.m_vertex2.Set(%.15f, %.15f);\n",this.m_vertex2.x,this.m_vertex2.y),t("    shape.m_vertex3.Set(%.15f, %.15f);\n",this.m_vertex3.x,this.m_vertex3.y),t("    shape.m_oneSided = %s;\n",this.m_oneSided)}}Lr.ComputeDistance_s_v1=new Ie,Lr.ComputeDistance_s_v2=new Ie,Lr.ComputeDistance_s_d=new Ie,Lr.ComputeDistance_s_s=new Ie,Lr.RayCast_s_p1=new Ie,Lr.RayCast_s_p2=new Ie,Lr.RayCast_s_d=new Ie,Lr.RayCast_s_e=new Ie,Lr.RayCast_s_q=new Ie,Lr.RayCast_s_r=new Ie,Lr.ComputeAABB_s_v1=new Ie,Lr.ComputeAABB_s_v2=new Ie;class Or extends Os{static Create(){return new Or}static Destroy(t){}Evaluate(t,e,i){const s=Or.Evaluate_s_edge;this.GetShapeA().GetChildEdge(s,this.m_indexA),pr(t,s,e,this.GetShapeB(),i)}}Or.Evaluate_s_edge=new Lr;class zr extends Os{static Create(){return new zr}static Destroy(t){}Evaluate(t,e,i){const s=zr.Evaluate_s_edge;this.GetShapeA().GetChildEdge(s,this.m_indexA),Fr(t,s,e,this.GetShapeB(),i)}}zr.Evaluate_s_edge=new Lr;class jr{constructor(){this.pool=[],this.createFcn=null,this.destroyFcn=null,this.primary=!1}}class qr{constructor(){this.m_registers=[],this.InitializeRegisters()}AddType(t,e,i,s){const r=[];function n(){return r.pop()||t()}function o(t){r.push(t)}this.m_registers[i][s].pool=r,this.m_registers[i][s].createFcn=n,this.m_registers[i][s].destroyFcn=o,this.m_registers[i][s].primary=!0,i!==s&&(this.m_registers[s][i].pool=r,this.m_registers[s][i].createFcn=n,this.m_registers[s][i].destroyFcn=o,this.m_registers[s][i].primary=!1)}InitializeRegisters(){for(let t=0;t<Oe.e_shapeTypeCount;t++){this.m_registers[t]=[];for(let e=0;e<Oe.e_shapeTypeCount;e++)this.m_registers[t][e]=new jr}this.AddType(zs.Create,zs.Destroy,Oe.e_circleShape,Oe.e_circleShape),this.AddType(or.Create,or.Destroy,Oe.e_polygonShape,Oe.e_circleShape),this.AddType(nr.Create,nr.Destroy,Oe.e_polygonShape,Oe.e_polygonShape),this.AddType(kr.Create,kr.Destroy,Oe.e_edgeShape,Oe.e_circleShape),this.AddType(Er.Create,Er.Destroy,Oe.e_edgeShape,Oe.e_polygonShape),this.AddType(Or.Create,Or.Destroy,Oe.e_chainShape,Oe.e_circleShape),this.AddType(zr.Create,zr.Destroy,Oe.e_chainShape,Oe.e_polygonShape)}Create(t,e,i,s){const r=t.GetType(),n=i.GetType(),o=this.m_registers[r][n];if(o.createFcn){const r=o.createFcn();return o.primary?r.Reset(t,e,i,s):r.Reset(i,s,t,e),r}return null}Destroy(t){const e=t.m_fixtureA.GetType(),i=t.m_fixtureB.GetType(),s=this.m_registers[e][i];s.destroyFcn&&s.destroyFcn(t)}}class Nr{constructor(){this.m_broadPhase=new Ds,this.m_contactList=null,this.m_contactCount=0,this.m_contactFilter=Ii.b2_defaultFilter,this.m_contactListener=Pi.b2_defaultListener,this.m_contactFactory=new qr}AddPair(t,e){let i=t.fixture,s=e.fixture,r=t.childIndex,n=e.childIndex,o=i.GetBody(),h=s.GetBody();if(o===h)return;let a=h.GetContactList();for(;a;){if(a.other===o){const t=a.contact.GetFixtureA(),e=a.contact.GetFixtureB(),o=a.contact.GetChildIndexA(),h=a.contact.GetChildIndexB();if(t===i&&e===s&&o===r&&h===n)return;if(t===s&&e===i&&o===n&&h===r)return}a=a.next}if(this.m_contactFilter&&!this.m_contactFilter.ShouldCollide(i,s))return;const l=this.m_contactFactory.Create(i,r,s,n);null!==l&&(i=l.GetFixtureA(),s=l.GetFixtureB(),r=l.GetChildIndexA(),n=l.GetChildIndexB(),o=i.m_body,h=s.m_body,l.m_prev=null,l.m_next=this.m_contactList,null!==this.m_contactList&&(this.m_contactList.m_prev=l),this.m_contactList=l,l.m_nodeA.other=h,l.m_nodeA.prev=null,l.m_nodeA.next=o.m_contactList,null!==o.m_contactList&&(o.m_contactList.prev=l.m_nodeA),o.m_contactList=l.m_nodeA,l.m_nodeB.other=o,l.m_nodeB.prev=null,l.m_nodeB.next=h.m_contactList,null!==h.m_contactList&&(h.m_contactList.prev=l.m_nodeB),h.m_contactList=l.m_nodeB,++this.m_contactCount)}FindNewContacts(){this.m_broadPhase.UpdatePairs(((t,e)=>{this.AddPair(t,e)}))}Destroy(t){const e=t.GetFixtureA(),i=t.GetFixtureB(),s=e.GetBody(),r=i.GetBody();this.m_contactListener&&t.IsTouching()&&this.m_contactListener.EndContact(t),t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t===this.m_contactList&&(this.m_contactList=t.m_next),t.m_nodeA.prev&&(t.m_nodeA.prev.next=t.m_nodeA.next),t.m_nodeA.next&&(t.m_nodeA.next.prev=t.m_nodeA.prev),t.m_nodeA===s.m_contactList&&(s.m_contactList=t.m_nodeA.next),t.m_nodeB.prev&&(t.m_nodeB.prev.next=t.m_nodeB.next),t.m_nodeB.next&&(t.m_nodeB.next.prev=t.m_nodeB.prev),t.m_nodeB===r.m_contactList&&(r.m_contactList=t.m_nodeB.next),t.m_manifold.pointCount>0&&!e.IsSensor()&&!i.IsSensor()&&(e.GetBody().SetAwake(!0),i.GetBody().SetAwake(!0)),this.m_contactFactory.Destroy(t),--this.m_contactCount}Collide(){let t=this.m_contactList;for(;t;){const e=t.GetFixtureA(),i=t.GetFixtureB(),s=t.GetChildIndexA(),r=t.GetChildIndexB(),n=e.GetBody(),o=i.GetBody();if(t.m_filterFlag){if(this.m_contactFilter&&!this.m_contactFilter.ShouldCollide(e,i)){const e=t;t=e.m_next,this.Destroy(e);continue}t.m_filterFlag=!1}const h=n.IsAwake()&&n.m_type!==Ai.b2_staticBody,a=o.IsAwake()&&o.m_type!==Ai.b2_staticBody;if(!h&&!a){t=t.m_next;continue}const l=e.m_proxies[s].treeNode,m=i.m_proxies[r].treeNode;if(fi(l.aabb,m.aabb))t.Update(this.m_contactListener),t=t.m_next;else{const e=t;t=e.m_next,this.Destroy(e)}}}}class Wr{constructor(){this.step=0,this.collide=0,this.solve=0,this.solveInit=0,this.solveVelocity=0,this.solvePosition=0,this.broadphase=0,this.solveTOI=0}Reset(){return this.step=0,this.collide=0,this.solve=0,this.solveInit=0,this.solveVelocity=0,this.solvePosition=0,this.broadphase=0,this.solveTOI=0,this}}class Xr{constructor(){this.dt=0,this.inv_dt=0,this.dtRatio=0,this.velocityIterations=0,this.positionIterations=0,this.particleIterations=0,this.warmStarting=!1}Copy(t){return this.dt=t.dt,this.inv_dt=t.inv_dt,this.dtRatio=t.dtRatio,this.positionIterations=t.positionIterations,this.velocityIterations=t.velocityIterations,this.particleIterations=t.particleIterations,this.warmStarting=t.warmStarting,this}}class Ur{constructor(){this.c=new Ie,this.a=0}static MakeArray(t){return we(t,(t=>new Ur))}}class Jr{constructor(){this.v=new Ie,this.w=0}static MakeArray(t){return we(t,(t=>new Jr))}}class Zr{constructor(){this.rA=new Ie,this.rB=new Ie,this.normalImpulse=0,this.tangentImpulse=0,this.normalMass=0,this.tangentMass=0,this.velocityBias=0}static MakeArray(t){return we(t,(t=>new Zr))}}class Hr{constructor(){this.points=Zr.MakeArray(2),this.normal=new Ie,this.tangent=new Ie,this.normalMass=new Te,this.K=new Te,this.indexA=0,this.indexB=0,this.invMassA=0,this.invMassB=0,this.invIA=0,this.invIB=0,this.friction=0,this.restitution=0,this.threshold=0,this.tangentSpeed=0,this.pointCount=0,this.contactIndex=0}static MakeArray(t){return we(t,(t=>new Hr))}}class Yr{constructor(){this.localPoints=Ie.MakeArray(2),this.localNormal=new Ie,this.localPoint=new Ie,this.indexA=0,this.indexB=0,this.invMassA=0,this.invMassB=0,this.localCenterA=new Ie,this.localCenterB=new Ie,this.invIA=0,this.invIB=0,this.type=ni.e_unknown,this.radiusA=0,this.radiusB=0,this.pointCount=0}static MakeArray(t){return we(t,(t=>new Yr))}}class Qr{constructor(){this.normal=new Ie,this.point=new Ie,this.separation=0}Initialize(t,e,i,s){const r=Qr.Initialize_s_pointA,n=Qr.Initialize_s_pointB,o=Qr.Initialize_s_planePoint,h=Qr.Initialize_s_clipPoint;switch(t.type){case ni.e_circles:ke.MulXV(e,t.localPoint,r),ke.MulXV(i,t.localPoints[0],n),Ie.SubVV(n,r,this.normal).SelfNormalize(),Ie.MidVV(r,n,this.point),this.separation=Ie.DotVV(Ie.SubVV(n,r,Ie.s_t0),this.normal)-t.radiusA-t.radiusB;break;case ni.e_faceA:Fe.MulRV(e.q,t.localNormal,this.normal),ke.MulXV(e,t.localPoint,o),ke.MulXV(i,t.localPoints[s],h),this.separation=Ie.DotVV(Ie.SubVV(h,o,Ie.s_t0),this.normal)-t.radiusA-t.radiusB,this.point.Copy(h);break;case ni.e_faceB:Fe.MulRV(i.q,t.localNormal,this.normal),ke.MulXV(i,t.localPoint,o),ke.MulXV(e,t.localPoints[s],h),this.separation=Ie.DotVV(Ie.SubVV(h,o,Ie.s_t0),this.normal)-t.radiusA-t.radiusB,this.point.Copy(h),this.normal.SelfNeg()}}}Qr.Initialize_s_pointA=new Ie,Qr.Initialize_s_pointB=new Ie,Qr.Initialize_s_planePoint=new Ie,Qr.Initialize_s_clipPoint=new Ie;class Kr{constructor(){this.m_step=new Xr,this.m_positionConstraints=Yr.MakeArray(1024),this.m_velocityConstraints=Hr.MakeArray(1024),this.m_count=0}Initialize(t){if(this.m_step.Copy(t.step),this.m_count=t.count,this.m_positionConstraints.length<this.m_count){const t=Be(2*this.m_positionConstraints.length,this.m_count);for(;this.m_positionConstraints.length<t;)this.m_positionConstraints[this.m_positionConstraints.length]=new Yr}if(this.m_velocityConstraints.length<this.m_count){const t=Be(2*this.m_velocityConstraints.length,this.m_count);for(;this.m_velocityConstraints.length<t;)this.m_velocityConstraints[this.m_velocityConstraints.length]=new Hr}this.m_positions=t.positions,this.m_velocities=t.velocities,this.m_contacts=t.contacts;for(let t=0;t<this.m_count;++t){const e=this.m_contacts[t],i=e.m_fixtureA,s=e.m_fixtureB,r=i.GetShape(),n=s.GetShape(),o=r.m_radius,h=n.m_radius,a=i.GetBody(),l=s.GetBody(),m=e.GetManifold(),c=m.pointCount,u=this.m_velocityConstraints[t];u.friction=e.m_friction,u.restitution=e.m_restitution,u.threshold=e.m_restitutionThreshold,u.tangentSpeed=e.m_tangentSpeed,u.indexA=a.m_islandIndex,u.indexB=l.m_islandIndex,u.invMassA=a.m_invMass,u.invMassB=l.m_invMass,u.invIA=a.m_invI,u.invIB=l.m_invI,u.contactIndex=t,u.pointCount=c,u.K.SetZero(),u.normalMass.SetZero();const _=this.m_positionConstraints[t];_.indexA=a.m_islandIndex,_.indexB=l.m_islandIndex,_.invMassA=a.m_invMass,_.invMassB=l.m_invMass,_.localCenterA.Copy(a.m_sweep.localCenter),_.localCenterB.Copy(l.m_sweep.localCenter),_.invIA=a.m_invI,_.invIB=l.m_invI,_.localNormal.Copy(m.localNormal),_.localPoint.Copy(m.localPoint),_.pointCount=c,_.radiusA=o,_.radiusB=h,_.type=m.type;for(let t=0;t<c;++t){const e=m.points[t],i=u.points[t];this.m_step.warmStarting?(i.normalImpulse=this.m_step.dtRatio*e.normalImpulse,i.tangentImpulse=this.m_step.dtRatio*e.tangentImpulse):(i.normalImpulse=0,i.tangentImpulse=0),i.rA.SetZero(),i.rB.SetZero(),i.normalMass=0,i.tangentMass=0,i.velocityBias=0,_.localPoints[t].Copy(e.localPoint)}}return this}InitializeVelocityConstraints(){const t=Kr.InitializeVelocityConstraints_s_xfA,e=Kr.InitializeVelocityConstraints_s_xfB,i=Kr.InitializeVelocityConstraints_s_worldManifold;for(let s=0;s<this.m_count;++s){const r=this.m_velocityConstraints[s],n=this.m_positionConstraints[s],o=n.radiusA,h=n.radiusB,a=this.m_contacts[r.contactIndex].GetManifold(),l=r.indexA,m=r.indexB,c=r.invMassA,u=r.invMassB,_=r.invIA,d=r.invIB,p=n.localCenterA,f=n.localCenterB,y=this.m_positions[l].c,x=this.m_positions[l].a,g=this.m_velocities[l].v,w=this.m_velocities[l].w,C=this.m_positions[m].c,v=this.m_positions[m].a,S=this.m_velocities[m].v,b=this.m_velocities[m].w;t.q.SetAngle(x),e.q.SetAngle(v),Ie.SubVV(y,Fe.MulRV(t.q,p,Ie.s_t0),t.p),Ie.SubVV(C,Fe.MulRV(e.q,f,Ie.s_t0),e.p),i.Initialize(a,t,o,e,h),r.normal.Copy(i.normal),Ie.CrossVOne(r.normal,r.tangent);const B=r.pointCount;for(let t=0;t<B;++t){const e=r.points[t];Ie.SubVV(i.points[t],y,e.rA),Ie.SubVV(i.points[t],C,e.rB);const s=Ie.CrossVV(e.rA,r.normal),n=Ie.CrossVV(e.rB,r.normal),o=c+u+_*s*s+d*n*n;e.normalMass=o>0?1/o:0;const h=r.tangent,a=Ie.CrossVV(e.rA,h),l=Ie.CrossVV(e.rB,h),m=c+u+_*a*a+d*l*l;e.tangentMass=m>0?1/m:0,e.velocityBias=0;const p=Ie.DotVV(r.normal,Ie.SubVV(Ie.AddVCrossSV(S,b,e.rB,Ie.s_t0),Ie.AddVCrossSV(g,w,e.rA,Ie.s_t1),Ie.s_t0));p<-r.threshold&&(e.velocityBias+=-r.restitution*p)}r.pointCount,0}}WarmStart(){const t=Kr.WarmStart_s_P;for(let e=0;e<this.m_count;++e){const i=this.m_velocityConstraints[e],s=i.indexA,r=i.indexB,n=i.invMassA,o=i.invIA,h=i.invMassB,a=i.invIB,l=i.pointCount,m=this.m_velocities[s].v;let c=this.m_velocities[s].w;const u=this.m_velocities[r].v;let _=this.m_velocities[r].w;const d=i.normal,p=i.tangent;for(let e=0;e<l;++e){const s=i.points[e];Ie.AddVV(Ie.MulSV(s.normalImpulse,d,Ie.s_t0),Ie.MulSV(s.tangentImpulse,p,Ie.s_t1),t),c-=o*Ie.CrossVV(s.rA,t),m.SelfMulSub(n,t),_+=a*Ie.CrossVV(s.rB,t),u.SelfMulAdd(h,t)}this.m_velocities[s].w=c,this.m_velocities[r].w=_}}SolveVelocityConstraints(){const t=Kr.SolveVelocityConstraints_s_dv,e=(Kr.SolveVelocityConstraints_s_dv1,Kr.SolveVelocityConstraints_s_dv2,Kr.SolveVelocityConstraints_s_P);Kr.SolveVelocityConstraints_s_a,Kr.SolveVelocityConstraints_s_b,Kr.SolveVelocityConstraints_s_x,Kr.SolveVelocityConstraints_s_d,Kr.SolveVelocityConstraints_s_P1,Kr.SolveVelocityConstraints_s_P2,Kr.SolveVelocityConstraints_s_P1P2;for(let i=0;i<this.m_count;++i){const s=this.m_velocityConstraints[i],r=s.indexA,n=s.indexB,o=s.invMassA,h=s.invIA,a=s.invMassB,l=s.invIB,m=s.pointCount,c=this.m_velocities[r].v;let u=this.m_velocities[r].w;const _=this.m_velocities[n].v;let d=this.m_velocities[n].w;const p=s.normal,f=s.tangent,y=s.friction;for(let i=0;i<m;++i){const r=s.points[i];Ie.SubVV(Ie.AddVCrossSV(_,d,r.rB,Ie.s_t0),Ie.AddVCrossSV(c,u,r.rA,Ie.s_t1),t);const n=Ie.DotVV(t,f)-s.tangentSpeed;let m=r.tangentMass*-n;const p=y*r.normalImpulse,x=Ae(r.tangentImpulse+m,-p,p);m=x-r.tangentImpulse,r.tangentImpulse=x,Ie.MulSV(m,f,e),c.SelfMulSub(o,e),u-=h*Ie.CrossVV(r.rA,e),_.SelfMulAdd(a,e),d+=l*Ie.CrossVV(r.rB,e)}s.pointCount;for(let i=0;i<m;++i){const r=s.points[i];Ie.SubVV(Ie.AddVCrossSV(_,d,r.rB,Ie.s_t0),Ie.AddVCrossSV(c,u,r.rA,Ie.s_t1),t);const n=Ie.DotVV(t,p);let m=-r.normalMass*(n-r.velocityBias);const f=Be(r.normalImpulse+m,0);m=f-r.normalImpulse,r.normalImpulse=f,Ie.MulSV(m,p,e),c.SelfMulSub(o,e),u-=h*Ie.CrossVV(r.rA,e),_.SelfMulAdd(a,e),d+=l*Ie.CrossVV(r.rB,e)}this.m_velocities[r].w=u,this.m_velocities[n].w=d}}StoreImpulses(){for(let t=0;t<this.m_count;++t){const e=this.m_velocityConstraints[t],i=this.m_contacts[e.contactIndex].GetManifold();for(let t=0;t<e.pointCount;++t)i.points[t].normalImpulse=e.points[t].normalImpulse,i.points[t].tangentImpulse=e.points[t].tangentImpulse}}SolvePositionConstraints(){const t=Kr.SolvePositionConstraints_s_xfA,e=Kr.SolvePositionConstraints_s_xfB,i=Kr.SolvePositionConstraints_s_psm,s=Kr.SolvePositionConstraints_s_rA,r=Kr.SolvePositionConstraints_s_rB,n=Kr.SolvePositionConstraints_s_P;let o=0;for(let h=0;h<this.m_count;++h){const a=this.m_positionConstraints[h],l=a.indexA,m=a.indexB,c=a.localCenterA,u=a.invMassA,_=a.invIA,d=a.localCenterB,p=a.invMassB,f=a.invIB,y=a.pointCount,x=this.m_positions[l].c;let g=this.m_positions[l].a;const w=this.m_positions[m].c;let C=this.m_positions[m].a;for(let h=0;h<y;++h){t.q.SetAngle(g),e.q.SetAngle(C),Ie.SubVV(x,Fe.MulRV(t.q,c,Ie.s_t0),t.p),Ie.SubVV(w,Fe.MulRV(e.q,d,Ie.s_t0),e.p),i.Initialize(a,t,e,h);const l=i.normal,m=i.point,y=i.separation;Ie.SubVV(m,x,s),Ie.SubVV(m,w,r),o=be(o,y);const v=Ae(.2*(y+de),-.2,0),S=Ie.CrossVV(s,l),b=Ie.CrossVV(r,l),B=u+p+_*S*S+f*b*b,A=B>0?-v/B:0;Ie.MulSV(A,l,n),x.SelfMulSub(u,n),g-=_*Ie.CrossVV(s,n),w.SelfMulAdd(p,n),C+=f*Ie.CrossVV(r,n)}this.m_positions[l].a=g,this.m_positions[m].a=C}return o>-.015}SolveTOIPositionConstraints(t,e){const i=Kr.SolveTOIPositionConstraints_s_xfA,s=Kr.SolveTOIPositionConstraints_s_xfB,r=Kr.SolveTOIPositionConstraints_s_psm,n=Kr.SolveTOIPositionConstraints_s_rA,o=Kr.SolveTOIPositionConstraints_s_rB,h=Kr.SolveTOIPositionConstraints_s_P;let a=0;for(let l=0;l<this.m_count;++l){const m=this.m_positionConstraints[l],c=m.indexA,u=m.indexB,_=m.localCenterA,d=m.localCenterB,p=m.pointCount;let f=0,y=0;c!==t&&c!==e||(f=m.invMassA,y=m.invIA);let x=0,g=0;u!==t&&u!==e||(x=m.invMassB,g=m.invIB);const w=this.m_positions[c].c;let C=this.m_positions[c].a;const v=this.m_positions[u].c;let S=this.m_positions[u].a;for(let t=0;t<p;++t){i.q.SetAngle(C),s.q.SetAngle(S),Ie.SubVV(w,Fe.MulRV(i.q,_,Ie.s_t0),i.p),Ie.SubVV(v,Fe.MulRV(s.q,d,Ie.s_t0),s.p),r.Initialize(m,i,s,t);const e=r.normal,l=r.point,c=r.separation;Ie.SubVV(l,w,n),Ie.SubVV(l,v,o),a=be(a,c);const u=Ae(.75*(c+de),-.2,0),p=Ie.CrossVV(n,e),b=Ie.CrossVV(o,e),B=f+x+y*p*p+g*b*b,A=B>0?-u/B:0;Ie.MulSV(A,e,h),w.SelfMulSub(f,h),C-=y*Ie.CrossVV(n,h),v.SelfMulAdd(x,h),S+=g*Ie.CrossVV(o,h)}this.m_positions[c].a=C,this.m_positions[u].a=S}return a>=-.0075}}Kr.InitializeVelocityConstraints_s_xfA=new ke,Kr.InitializeVelocityConstraints_s_xfB=new ke,Kr.InitializeVelocityConstraints_s_worldManifold=new ci,Kr.WarmStart_s_P=new Ie,Kr.SolveVelocityConstraints_s_dv=new Ie,Kr.SolveVelocityConstraints_s_dv1=new Ie,Kr.SolveVelocityConstraints_s_dv2=new Ie,Kr.SolveVelocityConstraints_s_P=new Ie,Kr.SolveVelocityConstraints_s_a=new Ie,Kr.SolveVelocityConstraints_s_b=new Ie,Kr.SolveVelocityConstraints_s_x=new Ie,Kr.SolveVelocityConstraints_s_d=new Ie,Kr.SolveVelocityConstraints_s_P1=new Ie,Kr.SolveVelocityConstraints_s_P2=new Ie,Kr.SolveVelocityConstraints_s_P1P2=new Ie,Kr.SolvePositionConstraints_s_xfA=new ke,Kr.SolvePositionConstraints_s_xfB=new ke,Kr.SolvePositionConstraints_s_psm=new Qr,Kr.SolvePositionConstraints_s_rA=new Ie,Kr.SolvePositionConstraints_s_rB=new Ie,Kr.SolvePositionConstraints_s_P=new Ie,Kr.SolveTOIPositionConstraints_s_xfA=new ke,Kr.SolveTOIPositionConstraints_s_xfB=new ke,Kr.SolveTOIPositionConstraints_s_psm=new Qr,Kr.SolveTOIPositionConstraints_s_rA=new Ie,Kr.SolveTOIPositionConstraints_s_rB=new Ie,Kr.SolveTOIPositionConstraints_s_P=new Ie;class $r{constructor(){this.m_bodies=[],this.m_contacts=[],this.m_joints=[],this.m_positions=Ur.MakeArray(1024),this.m_velocities=Jr.MakeArray(1024),this.m_bodyCount=0,this.m_jointCount=0,this.m_contactCount=0,this.m_bodyCapacity=0,this.m_contactCapacity=0,this.m_jointCapacity=0}Initialize(t,e,i,s){if(this.m_bodyCapacity=t,this.m_contactCapacity=e,this.m_jointCapacity=i,this.m_bodyCount=0,this.m_contactCount=0,this.m_jointCount=0,this.m_listener=s,this.m_positions.length<t){const e=Be(2*this.m_positions.length,t);for(;this.m_positions.length<e;)this.m_positions[this.m_positions.length]=new Ur}if(this.m_velocities.length<t){const e=Be(2*this.m_velocities.length,t);for(;this.m_velocities.length<e;)this.m_velocities[this.m_velocities.length]=new Jr}}Clear(){this.m_bodyCount=0,this.m_contactCount=0,this.m_jointCount=0}AddBody(t){t.m_islandIndex=this.m_bodyCount,this.m_bodies[this.m_bodyCount++]=t}AddContact(t){this.m_contacts[this.m_contactCount++]=t}AddJoint(t){this.m_joints[this.m_jointCount++]=t}Solve(t,e,i,s){const r=$r.s_timer.Reset(),n=e.dt;for(let t=0;t<this.m_bodyCount;++t){const e=this.m_bodies[t];this.m_positions[t].c.Copy(e.m_sweep.c);const s=e.m_sweep.a,r=this.m_velocities[t].v.Copy(e.m_linearVelocity);let o=e.m_angularVelocity;e.m_sweep.c0.Copy(e.m_sweep.c),e.m_sweep.a0=e.m_sweep.a,e.m_type===Ai.b2_dynamicBody&&(r.x+=n*e.m_invMass*(e.m_gravityScale*e.m_mass*i.x+e.m_force.x),r.y+=n*e.m_invMass*(e.m_gravityScale*e.m_mass*i.y+e.m_force.y),o+=n*e.m_invI*e.m_torque,r.SelfMul(1/(1+n*e.m_linearDamping)),o*=1/(1+n*e.m_angularDamping)),this.m_positions[t].a=s,this.m_velocities[t].w=o}r.Reset();const o=$r.s_solverData;o.step.Copy(e),o.positions=this.m_positions,o.velocities=this.m_velocities;const h=$r.s_contactSolverDef;h.step.Copy(e),h.contacts=this.m_contacts,h.count=this.m_contactCount,h.positions=this.m_positions,h.velocities=this.m_velocities;const a=$r.s_contactSolver.Initialize(h);a.InitializeVelocityConstraints(),e.warmStarting&&a.WarmStart();for(let t=0;t<this.m_jointCount;++t)this.m_joints[t].InitVelocityConstraints(o);t.solveInit=r.GetMilliseconds(),r.Reset();for(let t=0;t<e.velocityIterations;++t){for(let t=0;t<this.m_jointCount;++t)this.m_joints[t].SolveVelocityConstraints(o);a.SolveVelocityConstraints()}a.StoreImpulses(),t.solveVelocity=r.GetMilliseconds();for(let t=0;t<this.m_bodyCount;++t){const e=this.m_positions[t].c;let i=this.m_positions[t].a;const s=this.m_velocities[t].v;let r=this.m_velocities[t].w;const o=Ie.MulSV(n,s,$r.s_translation);if(Ie.DotVV(o,o)>4){const t=2/o.Length();s.SelfMul(t)}const h=n*r;h*h>xe&&(r*=ye/Se(h)),e.x+=n*s.x,e.y+=n*s.y,i+=n*r,this.m_positions[t].a=i,this.m_velocities[t].w=r}r.Reset();let l=!1;for(let t=0;t<e.positionIterations;++t){const t=a.SolvePositionConstraints();let e=!0;for(let t=0;t<this.m_jointCount;++t){const i=this.m_joints[t].SolvePositionConstraints(o);e=e&&i}if(t&&e){l=!0;break}}for(let t=0;t<this.m_bodyCount;++t){const e=this.m_bodies[t];e.m_sweep.c.Copy(this.m_positions[t].c),e.m_sweep.a=this.m_positions[t].a,e.m_linearVelocity.Copy(this.m_velocities[t].v),e.m_angularVelocity=this.m_velocities[t].w,e.SynchronizeTransform()}if(t.solvePosition=r.GetMilliseconds(),this.Report(a.m_velocityConstraints),s){let t=ce;const e=1e-4,i=.0012184696791469947;for(let s=0;s<this.m_bodyCount;++s){const r=this.m_bodies[s];r.GetType()!==Ai.b2_staticBody&&(!r.m_autoSleepFlag||r.m_angularVelocity*r.m_angularVelocity>i||Ie.DotVV(r.m_linearVelocity,r.m_linearVelocity)>e?(r.m_sleepTime=0,t=0):(r.m_sleepTime+=n,t=be(t,r.m_sleepTime)))}if(t>=.5&&l)for(let t=0;t<this.m_bodyCount;++t)this.m_bodies[t].SetAwake(!1)}}SolveTOI(t,e,i){for(let t=0;t<this.m_bodyCount;++t){const e=this.m_bodies[t];this.m_positions[t].c.Copy(e.m_sweep.c),this.m_positions[t].a=e.m_sweep.a,this.m_velocities[t].v.Copy(e.m_linearVelocity),this.m_velocities[t].w=e.m_angularVelocity}const s=$r.s_contactSolverDef;s.contacts=this.m_contacts,s.count=this.m_contactCount,s.step.Copy(t),s.positions=this.m_positions,s.velocities=this.m_velocities;const r=$r.s_contactSolver.Initialize(s);for(let s=0;s<t.positionIterations&&!r.SolveTOIPositionConstraints(e,i);++s);this.m_bodies[e].m_sweep.c0.Copy(this.m_positions[e].c),this.m_bodies[e].m_sweep.a0=this.m_positions[e].a,this.m_bodies[i].m_sweep.c0.Copy(this.m_positions[i].c),this.m_bodies[i].m_sweep.a0=this.m_positions[i].a,r.InitializeVelocityConstraints();for(let e=0;e<t.velocityIterations;++e)r.SolveVelocityConstraints();const n=t.dt;for(let t=0;t<this.m_bodyCount;++t){const e=this.m_positions[t].c;let i=this.m_positions[t].a;const s=this.m_velocities[t].v;let r=this.m_velocities[t].w;const o=Ie.MulSV(n,s,$r.s_translation);if(Ie.DotVV(o,o)>4){const t=2/o.Length();s.SelfMul(t)}const h=n*r;h*h>xe&&(r*=ye/Se(h)),e.SelfMulAdd(n,s),i+=n*r,this.m_positions[t].a=i,this.m_velocities[t].w=r;const a=this.m_bodies[t];a.m_sweep.c.Copy(e),a.m_sweep.a=i,a.m_linearVelocity.Copy(s),a.m_angularVelocity=r,a.SynchronizeTransform()}this.Report(r.m_velocityConstraints)}Report(t){if(null!==this.m_listener)for(let e=0;e<this.m_contactCount;++e){const i=this.m_contacts[e];if(!i)continue;const s=t[e],r=$r.s_impulse;r.count=s.pointCount;for(let t=0;t<s.pointCount;++t)r.normalImpulses[t]=s.points[t].normalImpulse,r.tangentImpulses[t]=s.points[t].tangentImpulse;this.m_listener.PostSolve(i,r)}}}var tn,en,sn,rn,nn;$r.s_timer=new Fi,$r.s_solverData=new class{constructor(){this.step=new Xr}},$r.s_contactSolverDef=new class{constructor(){this.step=new Xr,this.count=0}},$r.s_contactSolver=new Kr,$r.s_translation=new Ie,$r.s_impulse=new class{constructor(){this.normalImpulses=Ce(2),this.tangentImpulses=Ce(2),this.count=0}},function(t){t[t.b2_waterParticle=0]="b2_waterParticle",t[t.b2_zombieParticle=2]="b2_zombieParticle",t[t.b2_wallParticle=4]="b2_wallParticle",t[t.b2_springParticle=8]="b2_springParticle",t[t.b2_elasticParticle=16]="b2_elasticParticle",t[t.b2_viscousParticle=32]="b2_viscousParticle",t[t.b2_powderParticle=64]="b2_powderParticle",t[t.b2_tensileParticle=128]="b2_tensileParticle",t[t.b2_colorMixingParticle=256]="b2_colorMixingParticle",t[t.b2_destructionListenerParticle=512]="b2_destructionListenerParticle",t[t.b2_barrierParticle=1024]="b2_barrierParticle",t[t.b2_staticPressureParticle=2048]="b2_staticPressureParticle",t[t.b2_reactiveParticle=4096]="b2_reactiveParticle",t[t.b2_repulsiveParticle=8192]="b2_repulsiveParticle",t[t.b2_fixtureContactListenerParticle=16384]="b2_fixtureContactListenerParticle",t[t.b2_particleContactListenerParticle=32768]="b2_particleContactListenerParticle",t[t.b2_fixtureContactFilterParticle=65536]="b2_fixtureContactFilterParticle",t[t.b2_particleContactFilterParticle=131072]="b2_particleContactFilterParticle"}(tn||(tn={}));class on{constructor(){this.flags=0,this.position=new Ie,this.velocity=new Ie,this.color=new ki(0,0,0,0),this.lifetime=0,this.userData=null,this.group=null}}class hn{constructor(){this.m_index=ge}GetIndex(){return this.m_index}SetIndex(t){this.m_index=t}}!function(t){t[t.b2_solidParticleGroup=1]="b2_solidParticleGroup",t[t.b2_rigidParticleGroup=2]="b2_rigidParticleGroup",t[t.b2_particleGroupCanBeEmpty=4]="b2_particleGroupCanBeEmpty",t[t.b2_particleGroupWillBeDestroyed=8]="b2_particleGroupWillBeDestroyed",t[t.b2_particleGroupNeedsUpdateDepth=16]="b2_particleGroupNeedsUpdateDepth",t[t.b2_particleGroupInternalMask=24]="b2_particleGroupInternalMask"}(en||(en={}));class an{constructor(){this.flags=0,this.groupFlags=0,this.position=new Ie,this.angle=0,this.linearVelocity=new Ie,this.angularVelocity=0,this.color=new ki,this.strength=1,this.shapeCount=0,this.stride=0,this.particleCount=0,this.lifetime=0,this.userData=null,this.group=null}}class ln{constructor(t){this.m_firstIndex=0,this.m_lastIndex=0,this.m_groupFlags=0,this.m_strength=1,this.m_prev=null,this.m_next=null,this.m_timestamp=-1,this.m_mass=0,this.m_inertia=0,this.m_center=new Ie,this.m_linearVelocity=new Ie,this.m_angularVelocity=0,this.m_transform=new ke,this.m_userData=null,this.m_system=t}GetNext(){return this.m_next}GetParticleSystem(){return this.m_system}GetParticleCount(){return this.m_lastIndex-this.m_firstIndex}GetBufferIndex(){return this.m_firstIndex}ContainsParticle(t){return this.m_firstIndex<=t&&t<this.m_lastIndex}GetAllParticleFlags(){if(!this.m_system.m_flagsBuffer.data)throw new Error;let t=0;for(let e=this.m_firstIndex;e<this.m_lastIndex;e++)t|=this.m_system.m_flagsBuffer.data[e];return t}GetGroupFlags(){return this.m_groupFlags}SetGroupFlags(t){t|=this.m_groupFlags&en.b2_particleGroupInternalMask,this.m_system.SetGroupFlags(this,t)}GetMass(){return this.UpdateStatistics(),this.m_mass}GetInertia(){return this.UpdateStatistics(),this.m_inertia}GetCenter(){return this.UpdateStatistics(),this.m_center}GetLinearVelocity(){return this.UpdateStatistics(),this.m_linearVelocity}GetAngularVelocity(){return this.UpdateStatistics(),this.m_angularVelocity}GetTransform(){return this.m_transform}GetPosition(){return this.m_transform.p}GetAngle(){return this.m_transform.q.GetAngle()}GetLinearVelocityFromWorldPoint(t,e){const i=ln.GetLinearVelocityFromWorldPoint_s_t0;return this.UpdateStatistics(),Ie.AddVCrossSV(this.m_linearVelocity,this.m_angularVelocity,Ie.SubVV(t,this.m_center,i),e)}GetUserData(){return this.m_userData}SetUserData(t){this.m_userData=t}ApplyForce(t){this.m_system.ApplyForce(this.m_firstIndex,this.m_lastIndex,t)}ApplyLinearImpulse(t){this.m_system.ApplyLinearImpulse(this.m_firstIndex,this.m_lastIndex,t)}DestroyParticles(t){if(this.m_system.m_world.IsLocked())throw new Error;for(let e=this.m_firstIndex;e<this.m_lastIndex;e++)this.m_system.DestroyParticle(e,t)}UpdateStatistics(){if(!this.m_system.m_positionBuffer.data)throw new Error;if(!this.m_system.m_velocityBuffer.data)throw new Error;const t=new Ie,e=new Ie;if(this.m_timestamp!==this.m_system.m_timestamp){const i=this.m_system.GetParticleMass();this.m_mass=i*(this.m_lastIndex-this.m_firstIndex),this.m_center.SetZero(),this.m_linearVelocity.SetZero();for(let t=this.m_firstIndex;t<this.m_lastIndex;t++)this.m_center.SelfMulAdd(i,this.m_system.m_positionBuffer.data[t]),this.m_linearVelocity.SelfMulAdd(i,this.m_system.m_velocityBuffer.data[t]);if(this.m_mass>0){const t=1/this.m_mass;this.m_center.SelfMul(t),this.m_linearVelocity.SelfMul(t)}this.m_inertia=0,this.m_angularVelocity=0;for(let s=this.m_firstIndex;s<this.m_lastIndex;s++)Ie.SubVV(this.m_system.m_positionBuffer.data[s],this.m_center,t),Ie.SubVV(this.m_system.m_velocityBuffer.data[s],this.m_linearVelocity,e),this.m_inertia+=i*Ie.DotVV(t,t),this.m_angularVelocity+=i*Ie.CrossVV(t,e);this.m_inertia>0&&(this.m_angularVelocity*=1/this.m_inertia),this.m_timestamp=this.m_system.m_timestamp}}}ln.GetLinearVelocityFromWorldPoint_s_t0=new Ie;class mn{constructor(t){this.m_buffer=[],this.m_front=0,this.m_back=0,this.m_buffer.fill(null,0,t)}get m_capacity(){return this.m_buffer.length}Push(t){if(this.m_back>=this.m_capacity){for(let t=this.m_front;t<this.m_back;t++)this.m_buffer[t-this.m_front]=this.m_buffer[t];this.m_back-=this.m_front,this.m_front=0}this.m_buffer[this.m_back]=t,this.m_back++}Pop(){this.m_buffer[this.m_front]=null,this.m_front++}Empty(){return this.m_front===this.m_back}Front(){const t=this.m_buffer[this.m_front];if(!t)throw new Error;return t}}class cn{constructor(t){this.m_generatorCapacity=0,this.m_generatorCount=0,this.m_countX=0,this.m_countY=0,this.m_diagram=[],this.m_generatorBuffer=we(t,(t=>new un)),this.m_generatorCapacity=t}AddGenerator(t,e,i){const s=this.m_generatorBuffer[this.m_generatorCount++];s.center.Copy(t),s.tag=e,s.necessary=i}Generate(t,e){const i=1/t,s=new Ie(+ce,+ce),r=new Ie(-ce,-ce);let n=0;for(let t=0;t<this.m_generatorCount;t++){const e=this.m_generatorBuffer[t];e.necessary&&(Ie.MinV(s,e.center,s),Ie.MaxV(r,e.center,r),++n)}if(0===n)return this.m_countX=0,void(this.m_countY=0);s.x-=e,s.y-=e,r.x+=e,r.y+=e,this.m_countX=1+Math.floor(i*(r.x-s.x)),this.m_countY=1+Math.floor(i*(r.y-s.y)),this.m_diagram=[];const o=new mn(4*this.m_countX*this.m_countY);for(let t=0;t<this.m_generatorCount;t++){const e=this.m_generatorBuffer[t];e.center.SelfSub(s).SelfMul(i);const r=Math.floor(e.center.x),n=Math.floor(e.center.y);r>=0&&n>=0&&r<this.m_countX&&n<this.m_countY&&o.Push(new _n(r,n,r+n*this.m_countX,e))}for(;!o.Empty();){const t=o.Front(),e=t.m_x,i=t.m_y,s=t.m_i,r=t.m_generator;o.Pop(),this.m_diagram[s]||(this.m_diagram[s]=r,e>0&&o.Push(new _n(e-1,i,s-1,r)),i>0&&o.Push(new _n(e,i-1,s-this.m_countX,r)),e<this.m_countX-1&&o.Push(new _n(e+1,i,s+1,r)),i<this.m_countY-1&&o.Push(new _n(e,i+1,s+this.m_countX,r)))}for(let t=0;t<this.m_countY;t++)for(let e=0;e<this.m_countX-1;e++){const i=e+t*this.m_countX,s=this.m_diagram[i],r=this.m_diagram[i+1];s!==r&&(o.Push(new _n(e,t,i,r)),o.Push(new _n(e+1,t,i+1,s)))}for(let t=0;t<this.m_countY-1;t++)for(let e=0;e<this.m_countX;e++){const i=e+t*this.m_countX,s=this.m_diagram[i],r=this.m_diagram[i+this.m_countX];s!==r&&(o.Push(new _n(e,t,i,r)),o.Push(new _n(e,t+1,i+this.m_countX,s)))}for(;!o.Empty();){const t=o.Front(),e=t.m_x,i=t.m_y,s=t.m_i,r=t.m_generator;o.Pop();const n=this.m_diagram[s],h=r;if(n!==h){const t=n.center.x-e,r=n.center.y-i,a=h.center.x-e,l=h.center.y-i;t*t+r*r>a*a+l*l&&(this.m_diagram[s]=h,e>0&&o.Push(new _n(e-1,i,s-1,h)),i>0&&o.Push(new _n(e,i-1,s-this.m_countX,h)),e<this.m_countX-1&&o.Push(new _n(e+1,i,s+1,h)),i<this.m_countY-1&&o.Push(new _n(e,i+1,s+this.m_countX,h)))}}}GetNodes(t){for(let e=0;e<this.m_countY-1;e++)for(let i=0;i<this.m_countX-1;i++){const s=i+e*this.m_countX,r=this.m_diagram[s],n=this.m_diagram[s+1],o=this.m_diagram[s+this.m_countX],h=this.m_diagram[s+1+this.m_countX];n!==o&&(r!==n&&r!==o&&(r.necessary||n.necessary||o.necessary)&&t(r.tag,n.tag,o.tag),h!==n&&h!==o&&(r.necessary||n.necessary||o.necessary)&&t(n.tag,h.tag,o.tag))}}}class un{constructor(){this.center=new Ie,this.tag=0,this.necessary=!1}}class _n{constructor(t,e,i,s){this.m_x=t,this.m_y=e,this.m_i=i,this.m_generator=s}}function dn(t,e,i){const s=t[e];t[e]=t[i],t[i]=s}function pn(t,e){return t<e}function fn(t,e=0,i=t.length-e,s=pn){let r=e;const n=[];let o=0;for(;;){for(;r+1<i;i++){const e=t[r+Math.floor(Math.random()*(i-r))];n[o++]=i;for(let n=r-1;;){for(;s(t[++n],e););for(;s(e,t[--i]););if(n>=i)break;dn(t,n,i)}}if(0===o)break;r=i,i=n[--o]}return t}function yn(t,e=0,i=t.length-e,s=pn){return fn(t,e,i,s)}function xn(t,e,i=t.length){let s=0;for(let r=0;r<i;++r)e(t[r])||(r!==s?dn(t,s++,r):++s);return s}function gn(t,e,i,s,r){let n=i-e;for(;n>0;){const i=Math.floor(n/2);let o=e+i;r(t[o],s)?(e=++o,n-=i+1):n=i}return e}function wn(t,e,i,s,r){let n=i-e;for(;n>0;){const i=Math.floor(n/2);let o=e+i;r(s,t[o])?n=i:(e=++o,n-=i+1)}return e}function Cn(t,e,i,s){let r=i;for(;e!==r;)dn(t,e++,r++),r===s?r=i:e===i&&(i=r)}class vn{constructor(t){this.data=[],this.count=0,this.capacity=0,this.allocator=t}Append(){return this.count>=this.capacity&&this.Grow(),this.count++}Reserve(t){if(!(this.capacity>=t)){for(let e=this.capacity;e<t;++e)this.data[e]=this.allocator();this.capacity=t}}Grow(){const t=this.capacity?2*this.capacity:256;this.Reserve(t)}Free(){0!==this.data.length&&(this.data=[],this.capacity=0,this.count=0)}Shorten(t){}Data(){return this.data}GetCount(){return this.count}SetCount(t){this.count=t}GetCapacity(){return this.capacity}RemoveIf(t){this.count=xn(this.data,t,this.count)}Unique(t){this.count=function(t,e,i,s){if(e===i)return i;let r=e;for(;++e!==i;)s(t[r],t[e])||dn(t,++r,e);return++r}(this.data,0,this.count,t)}}class Sn extends Gi{constructor(t){super(),this.m_system=t}ShouldQueryParticleSystem(t){return!1}ReportFixture(t){if(t.IsSensor())return!0;const e=t.GetShape().GetChildCount();for(let i=0;i<e;i++){const e=t.GetAABB(i),s=this.m_system.GetInsideBoundsEnumerator(e);let r;for(;(r=s.GetNext())>=0;)this.ReportFixtureAndParticle(t,i,r)}return!0}ReportParticle(t,e){return!1}ReportFixtureAndParticle(t,e,i){}}class bn{constructor(){this.indexA=0,this.indexB=0,this.weight=0,this.normal=new Ie,this.flags=0}SetIndices(t,e){this.indexA=t,this.indexB=e}SetWeight(t){this.weight=t}SetNormal(t){this.normal.Copy(t)}SetFlags(t){this.flags=t}GetIndexA(){return this.indexA}GetIndexB(){return this.indexB}GetWeight(){return this.weight}GetNormal(){return this.normal}GetFlags(){return this.flags}IsEqual(t){return this.indexA===t.indexA&&this.indexB===t.indexB&&this.flags===t.flags&&this.weight===t.weight&&this.normal.x===t.normal.x&&this.normal.y===t.normal.y}IsNotEqual(t){return!this.IsEqual(t)}ApproximatelyEqual(t){return this.indexA===t.indexA&&this.indexB===t.indexB&&this.flags===t.flags&&Se(this.weight-t.weight)<.01&&Ie.DistanceSquaredVV(this.normal,t.normal)<1e-4}}class Bn{constructor(){this.index=0,this.weight=0,this.normal=new Ie,this.mass=0}}class An{constructor(){this.indexA=0,this.indexB=0,this.flags=0,this.strength=0,this.distance=0}}class Vn{constructor(){this.indexA=0,this.indexB=0,this.indexC=0,this.flags=0,this.strength=0,this.pa=new Ie(0,0),this.pb=new Ie(0,0),this.pc=new Ie(0,0),this.ka=0,this.kb=0,this.kc=0,this.s=0}}class Mn{constructor(){this.strictContactCheck=!1,this.density=1,this.gravityScale=1,this.radius=1,this.maxCount=0,this.pressureStrength=.005,this.dampingStrength=1,this.elasticStrength=.25,this.springStrength=.25,this.viscousStrength=.25,this.surfaceTensionPressureStrength=.2,this.surfaceTensionNormalStrength=.2,this.repulsiveStrength=1,this.powderStrength=.5,this.ejectionStrength=.5,this.staticPressureStrength=.2,this.staticPressureRelaxation=.2,this.staticPressureIterations=8,this.colorMixingStrength=.5,this.destroyByAge=!0,this.lifetimeGranularity=1/60}Copy(t){return this.strictContactCheck=t.strictContactCheck,this.density=t.density,this.gravityScale=t.gravityScale,this.radius=t.radius,this.maxCount=t.maxCount,this.pressureStrength=t.pressureStrength,this.dampingStrength=t.dampingStrength,this.elasticStrength=t.elasticStrength,this.springStrength=t.springStrength,this.viscousStrength=t.viscousStrength,this.surfaceTensionPressureStrength=t.surfaceTensionPressureStrength,this.surfaceTensionNormalStrength=t.surfaceTensionNormalStrength,this.repulsiveStrength=t.repulsiveStrength,this.powderStrength=t.powderStrength,this.ejectionStrength=t.ejectionStrength,this.staticPressureStrength=t.staticPressureStrength,this.staticPressureRelaxation=t.staticPressureRelaxation,this.staticPressureIterations=t.staticPressureIterations,this.colorMixingStrength=t.colorMixingStrength,this.destroyByAge=t.destroyByAge,this.lifetimeGranularity=t.lifetimeGranularity,this}Clone(){return(new Mn).Copy(this)}}class Dn{constructor(t,e){this.m_paused=!1,this.m_timestamp=0,this.m_allParticleFlags=0,this.m_needsUpdateAllParticleFlags=!1,this.m_allGroupFlags=0,this.m_needsUpdateAllGroupFlags=!1,this.m_hasForce=!1,this.m_iterationIndex=0,this.m_inverseDensity=0,this.m_particleDiameter=0,this.m_inverseDiameter=0,this.m_squaredDiameter=0,this.m_count=0,this.m_internalAllocatedCapacity=0,this.m_handleIndexBuffer=new In,this.m_flagsBuffer=new In,this.m_positionBuffer=new In,this.m_velocityBuffer=new In,this.m_forceBuffer=[],this.m_weightBuffer=[],this.m_staticPressureBuffer=[],this.m_accumulationBuffer=[],this.m_accumulation2Buffer=[],this.m_depthBuffer=[],this.m_colorBuffer=new In,this.m_groupBuffer=[],this.m_userDataBuffer=new In,this.m_stuckThreshold=0,this.m_lastBodyContactStepBuffer=new In,this.m_bodyContactCountBuffer=new In,this.m_consecutiveContactStepsBuffer=new In,this.m_stuckParticleBuffer=new vn((()=>0)),this.m_proxyBuffer=new vn((()=>new Pn)),this.m_contactBuffer=new vn((()=>new bn)),this.m_bodyContactBuffer=new vn((()=>new Bn)),this.m_pairBuffer=new vn((()=>new An)),this.m_triadBuffer=new vn((()=>new Vn)),this.m_expirationTimeBuffer=new In,this.m_indexByExpirationTimeBuffer=new In,this.m_timeElapsed=0,this.m_expirationTimeBufferRequiresSorting=!1,this.m_groupCount=0,this.m_groupList=null,this.m_def=new Mn,this.m_prev=null,this.m_next=null,this.UpdateBodyContacts_callback=null,this.SolveCollision_callback=null,this.SetStrictContactCheck(t.strictContactCheck),this.SetDensity(t.density),this.SetGravityScale(t.gravityScale),this.SetRadius(t.radius),this.SetMaxParticleCount(t.maxCount),this.m_def=t.Clone(),this.m_world=e,this.SetDestructionByAge(this.m_def.destroyByAge)}static computeTag(t,e){return(e+Dn.yOffset>>>0<<Dn.yShift)+(Dn.xScale*t+Dn.xOffset>>>0)>>>0}static computeRelativeTag(t,e,i){return t+(i<<Dn.yShift)+(e<<Dn.xShift)>>>0}Drop(){for(;this.m_groupList;)this.DestroyParticleGroup(this.m_groupList);this.FreeUserOverridableBuffer(this.m_handleIndexBuffer),this.FreeUserOverridableBuffer(this.m_flagsBuffer),this.FreeUserOverridableBuffer(this.m_lastBodyContactStepBuffer),this.FreeUserOverridableBuffer(this.m_bodyContactCountBuffer),this.FreeUserOverridableBuffer(this.m_consecutiveContactStepsBuffer),this.FreeUserOverridableBuffer(this.m_positionBuffer),this.FreeUserOverridableBuffer(this.m_velocityBuffer),this.FreeUserOverridableBuffer(this.m_colorBuffer),this.FreeUserOverridableBuffer(this.m_userDataBuffer),this.FreeUserOverridableBuffer(this.m_expirationTimeBuffer),this.FreeUserOverridableBuffer(this.m_indexByExpirationTimeBuffer),this.FreeBuffer(this.m_forceBuffer,this.m_internalAllocatedCapacity),this.FreeBuffer(this.m_weightBuffer,this.m_internalAllocatedCapacity),this.FreeBuffer(this.m_staticPressureBuffer,this.m_internalAllocatedCapacity),this.FreeBuffer(this.m_accumulationBuffer,this.m_internalAllocatedCapacity),this.FreeBuffer(this.m_accumulation2Buffer,this.m_internalAllocatedCapacity),this.FreeBuffer(this.m_depthBuffer,this.m_internalAllocatedCapacity),this.FreeBuffer(this.m_groupBuffer,this.m_internalAllocatedCapacity)}CreateParticle(t){if(this.m_world.IsLocked())throw new Error;if(this.m_count>=this.m_internalAllocatedCapacity){const t=this.m_count?2*this.m_count:256;this.ReallocateInternalAllocatedBuffers(t)}if(this.m_count>=this.m_internalAllocatedCapacity){if(!this.m_def.destroyByAge)return ge;this.DestroyOldestParticle(0,!1),this.SolveZombie()}const e=this.m_count++;this.m_flagsBuffer.data[e]=0,this.m_lastBodyContactStepBuffer.data&&(this.m_lastBodyContactStepBuffer.data[e]=0),this.m_bodyContactCountBuffer.data&&(this.m_bodyContactCountBuffer.data[e]=0),this.m_consecutiveContactStepsBuffer.data&&(this.m_consecutiveContactStepsBuffer.data[e]=0),this.m_positionBuffer.data[e]=(this.m_positionBuffer.data[e]||new Ie).Copy(me(t.position,Ie.ZERO)),this.m_velocityBuffer.data[e]=(this.m_velocityBuffer.data[e]||new Ie).Copy(me(t.velocity,Ie.ZERO)),this.m_weightBuffer[e]=0,this.m_forceBuffer[e]=(this.m_forceBuffer[e]||new Ie).SetZero(),this.m_staticPressureBuffer&&(this.m_staticPressureBuffer[e]=0),this.m_depthBuffer&&(this.m_depthBuffer[e]=0);const i=(new ki).Copy(me(t.color,ki.ZERO));!this.m_colorBuffer.data&&i.IsZero()||(this.m_colorBuffer.data=this.RequestBuffer(this.m_colorBuffer.data),this.m_colorBuffer.data[e]=(this.m_colorBuffer.data[e]||new ki).Copy(i)),(this.m_userDataBuffer.data||t.userData)&&(this.m_userDataBuffer.data=this.RequestBuffer(this.m_userDataBuffer.data),this.m_userDataBuffer.data[e]=t.userData),this.m_handleIndexBuffer.data&&(this.m_handleIndexBuffer.data[e]=null);const s=this.m_proxyBuffer.data[this.m_proxyBuffer.Append()],r=me(t.lifetime,0),n=r>0;(this.m_expirationTimeBuffer.data||n)&&(this.SetParticleLifetime(e,n?r:this.ExpirationTimeToLifetime(-this.GetQuantizedTimeElapsed())),this.m_indexByExpirationTimeBuffer.data[e]=e),s.index=e;const o=me(t.group,null);return this.m_groupBuffer[e]=o,o&&(o.m_firstIndex<o.m_lastIndex?(this.RotateBuffer(o.m_firstIndex,o.m_lastIndex,e),o.m_lastIndex=e+1):(o.m_firstIndex=e,o.m_lastIndex=e+1)),this.SetParticleFlags(e,me(t.flags,0)),e}GetParticleHandleFromIndex(t){this.m_handleIndexBuffer.data=this.RequestBuffer(this.m_handleIndexBuffer.data);let e=this.m_handleIndexBuffer.data[t];return e||(e=new hn,e.SetIndex(t),this.m_handleIndexBuffer.data[t]=e,e)}DestroyParticle(t,e=!1){let i=tn.b2_zombieParticle;e&&(i|=tn.b2_destructionListenerParticle),this.SetParticleFlags(t,this.m_flagsBuffer.data[t]|i)}DestroyOldestParticle(t,e=!1){const i=this.GetParticleCount(),s=this.m_indexByExpirationTimeBuffer.data[i-(t+1)],r=this.m_indexByExpirationTimeBuffer.data[t];this.DestroyParticle(this.m_expirationTimeBuffer.data[s]>0?s:r,e)}DestroyParticlesInShape(t,e,i=!1){const s=Dn.DestroyParticlesInShape_s_aabb;if(this.m_world.IsLocked())throw new Error;const r=new Ln(this,t,e,i),n=s;return t.ComputeAABB(n,e,0),this.m_world.QueryAABB(r,n),r.Destroyed()}CreateParticleGroup(t){const e=Dn.CreateParticleGroup_s_transform;if(this.m_world.IsLocked())throw new Error;const i=e;i.SetPositionAngle(me(t.position,Ie.ZERO),me(t.angle,0));const s=this.m_count;if(t.shape&&this.CreateParticlesWithShapeForGroup(t.shape,t,i),t.shapes&&this.CreateParticlesWithShapesForGroup(t.shapes,me(t.shapeCount,t.shapes.length),t,i),t.positionData){const e=me(t.particleCount,t.positionData.length);for(let s=0;s<e;s++){const e=t.positionData[s];this.CreateParticleForGroup(t,i,e)}}const r=this.m_count;let n=new ln(this);n.m_firstIndex=s,n.m_lastIndex=r,n.m_strength=me(t.strength,1),n.m_userData=t.userData,n.m_transform.Copy(i),n.m_prev=null,n.m_next=this.m_groupList,this.m_groupList&&(this.m_groupList.m_prev=n),this.m_groupList=n,++this.m_groupCount;for(let t=s;t<r;t++)this.m_groupBuffer[t]=n;this.SetGroupFlags(n,me(t.groupFlags,0));const o=new En;return this.UpdateContacts(!0),this.UpdatePairsAndTriads(s,r,o),t.group&&(this.JoinParticleGroups(t.group,n),n=t.group),n}JoinParticleGroups(t,e){if(this.m_world.IsLocked())throw new Error;this.RotateBuffer(e.m_firstIndex,e.m_lastIndex,this.m_count),this.RotateBuffer(t.m_firstIndex,t.m_lastIndex,e.m_firstIndex);const i=new On(e.m_firstIndex);this.UpdateContacts(!0),this.UpdatePairsAndTriads(t.m_firstIndex,e.m_lastIndex,i);for(let i=e.m_firstIndex;i<e.m_lastIndex;i++)this.m_groupBuffer[i]=t;const s=t.m_groupFlags|e.m_groupFlags;this.SetGroupFlags(t,s),t.m_lastIndex=e.m_lastIndex,e.m_firstIndex=e.m_lastIndex,this.DestroyParticleGroup(e)}SplitParticleGroup(t){this.UpdateContacts(!0);const e=we(t.GetParticleCount(),(t=>new Tn));Dn.InitializeParticleLists(t,e),this.MergeParticleListsInContact(t,e);const i=Dn.FindLongestParticleList(t,e);this.MergeZombieParticleListNodes(t,e,i),this.CreateParticleGroupsFromParticleList(t,e,i),this.UpdatePairsAndTriadsWithParticleList(t,e)}GetParticleGroupList(){return this.m_groupList}GetParticleGroupCount(){return this.m_groupCount}GetParticleCount(){return this.m_count}GetMaxParticleCount(){return this.m_def.maxCount}SetMaxParticleCount(t){this.m_def.maxCount=t}GetAllParticleFlags(){return this.m_allParticleFlags}GetAllGroupFlags(){return this.m_allGroupFlags}SetPaused(t){this.m_paused=t}GetPaused(){return this.m_paused}SetDensity(t){this.m_def.density=t,this.m_inverseDensity=1/this.m_def.density}GetDensity(){return this.m_def.density}SetGravityScale(t){this.m_def.gravityScale=t}GetGravityScale(){return this.m_def.gravityScale}SetDamping(t){this.m_def.dampingStrength=t}GetDamping(){return this.m_def.dampingStrength}SetStaticPressureIterations(t){this.m_def.staticPressureIterations=t}GetStaticPressureIterations(){return this.m_def.staticPressureIterations}SetRadius(t){this.m_particleDiameter=2*t,this.m_squaredDiameter=this.m_particleDiameter*this.m_particleDiameter,this.m_inverseDiameter=1/this.m_particleDiameter}GetRadius(){return this.m_particleDiameter/2}GetPositionBuffer(){return this.m_positionBuffer.data}GetVelocityBuffer(){return this.m_velocityBuffer.data}GetColorBuffer(){return this.m_colorBuffer.data=this.RequestBuffer(this.m_colorBuffer.data),this.m_colorBuffer.data}GetGroupBuffer(){return this.m_groupBuffer}GetWeightBuffer(){return this.m_weightBuffer}GetUserDataBuffer(){return this.m_userDataBuffer.data=this.RequestBuffer(this.m_userDataBuffer.data),this.m_userDataBuffer.data}GetFlagsBuffer(){return this.m_flagsBuffer.data}SetParticleFlags(t,e){this.m_flagsBuffer.data[t]&~e&&(this.m_needsUpdateAllParticleFlags=!0),~this.m_allParticleFlags&e&&(e&tn.b2_tensileParticle&&(this.m_accumulation2Buffer=this.RequestBuffer(this.m_accumulation2Buffer)),e&tn.b2_colorMixingParticle&&(this.m_colorBuffer.data=this.RequestBuffer(this.m_colorBuffer.data)),this.m_allParticleFlags|=e),this.m_flagsBuffer.data[t]=e}GetParticleFlags(t){return this.m_flagsBuffer.data[t]}SetFlagsBuffer(t){this.SetUserOverridableBuffer(this.m_flagsBuffer,t)}SetPositionBuffer(t){if(t instanceof Float32Array){if(t.length%2!=0)throw new Error;const e=t.length/2,i=new Array(e);for(let s=0;s<e;++s)i[s]=new Pe(t.subarray(2*s,2*s+2));t=i}this.SetUserOverridableBuffer(this.m_positionBuffer,t)}SetVelocityBuffer(t){if(t instanceof Float32Array){if(t.length%2!=0)throw new Error;const e=t.length/2,i=new Array(e);for(let s=0;s<e;++s)i[s]=new Pe(t.subarray(2*s,2*s+2));t=i}this.SetUserOverridableBuffer(this.m_velocityBuffer,t)}SetColorBuffer(t){if(t instanceof Float32Array){if(t.length%4!=0)throw new Error;const e=t.length/4,i=new Array(e);for(let s=0;s<e;++s)i[s]=new Ei(t.subarray(4*s,4*s+4));t=i}this.SetUserOverridableBuffer(this.m_colorBuffer,t)}SetUserDataBuffer(t){this.SetUserOverridableBuffer(this.m_userDataBuffer,t)}GetContacts(){return this.m_contactBuffer.data}GetContactCount(){return this.m_contactBuffer.count}GetBodyContacts(){return this.m_bodyContactBuffer.data}GetBodyContactCount(){return this.m_bodyContactBuffer.count}GetPairs(){return this.m_pairBuffer.data}GetPairCount(){return this.m_pairBuffer.count}GetTriads(){return this.m_triadBuffer.data}GetTriadCount(){return this.m_triadBuffer.count}SetStuckThreshold(t){this.m_stuckThreshold=t,t>0&&(this.m_lastBodyContactStepBuffer.data=this.RequestBuffer(this.m_lastBodyContactStepBuffer.data),this.m_bodyContactCountBuffer.data=this.RequestBuffer(this.m_bodyContactCountBuffer.data),this.m_consecutiveContactStepsBuffer.data=this.RequestBuffer(this.m_consecutiveContactStepsBuffer.data))}GetStuckCandidates(){return this.m_stuckParticleBuffer.Data()}GetStuckCandidateCount(){return this.m_stuckParticleBuffer.GetCount()}ComputeCollisionEnergy(){const t=Dn.ComputeCollisionEnergy_s_v,e=this.m_velocityBuffer.data;let i=0;for(let s=0;s<this.m_contactBuffer.count;s++){const r=this.m_contactBuffer.data[s],n=r.indexA,o=r.indexB,h=r.normal,a=Ie.SubVV(e[o],e[n],t),l=Ie.DotVV(a,h);l<0&&(i+=l*l)}return.5*this.GetParticleMass()*i}SetStrictContactCheck(t){this.m_def.strictContactCheck=t}GetStrictContactCheck(){return this.m_def.strictContactCheck}SetParticleLifetime(t,e){const i=null===this.m_indexByExpirationTimeBuffer.data;if(this.m_expirationTimeBuffer.data=this.RequestBuffer(this.m_expirationTimeBuffer.data),this.m_indexByExpirationTimeBuffer.data=this.RequestBuffer(this.m_indexByExpirationTimeBuffer.data),i){const t=this.GetParticleCount();for(let e=0;e<t;++e)this.m_indexByExpirationTimeBuffer.data[e]=e}const s=e/this.m_def.lifetimeGranularity,r=s>0?this.GetQuantizedTimeElapsed()+s:s;r!==this.m_expirationTimeBuffer.data[t]&&(this.m_expirationTimeBuffer.data[t]=r,this.m_expirationTimeBufferRequiresSorting=!0)}GetParticleLifetime(t){return this.ExpirationTimeToLifetime(this.GetExpirationTimeBuffer()[t])}SetDestructionByAge(t){t&&this.GetExpirationTimeBuffer(),this.m_def.destroyByAge=t}GetDestructionByAge(){return this.m_def.destroyByAge}GetExpirationTimeBuffer(){return this.m_expirationTimeBuffer.data=this.RequestBuffer(this.m_expirationTimeBuffer.data),this.m_expirationTimeBuffer.data}ExpirationTimeToLifetime(t){return(t>0?t-this.GetQuantizedTimeElapsed():t)*this.m_def.lifetimeGranularity}GetIndexByExpirationTimeBuffer(){return this.GetParticleCount()?this.SetParticleLifetime(0,this.GetParticleLifetime(0)):this.m_indexByExpirationTimeBuffer.data=this.RequestBuffer(this.m_indexByExpirationTimeBuffer.data),this.m_indexByExpirationTimeBuffer.data}ParticleApplyLinearImpulse(t,e){this.ApplyLinearImpulse(t,t+1,e)}ApplyLinearImpulse(t,e,i){const s=this.m_velocityBuffer.data,r=(e-t)*this.GetParticleMass(),n=(new Ie).Copy(i).SelfMul(1/r);for(let i=t;i<e;i++)s[i].SelfAdd(n)}static IsSignificantForce(t){return 0!==t.x||0!==t.y}ParticleApplyForce(t,e){Dn.IsSignificantForce(e)&&this.ForceCanBeApplied(this.m_flagsBuffer.data[t])&&(this.PrepareForceBuffer(),this.m_forceBuffer[t].SelfAdd(e))}ApplyForce(t,e,i){const s=(new Ie).Copy(i).SelfMul(1/(e-t));if(Dn.IsSignificantForce(s)){this.PrepareForceBuffer();for(let i=t;i<e;i++)this.m_forceBuffer[i].SelfAdd(s)}}GetNext(){return this.m_next}QueryAABB(t,e){if(0===this.m_proxyBuffer.count)return;const i=this.m_proxyBuffer.count,s=gn(this.m_proxyBuffer.data,0,i,Dn.computeTag(this.m_inverseDiameter*e.lowerBound.x,this.m_inverseDiameter*e.lowerBound.y),Pn.CompareProxyTag),r=wn(this.m_proxyBuffer.data,s,i,Dn.computeTag(this.m_inverseDiameter*e.upperBound.x,this.m_inverseDiameter*e.upperBound.y),Pn.CompareTagProxy),n=this.m_positionBuffer.data;for(let i=s;i<r;++i){const s=this.m_proxyBuffer.data[i].index,r=n[s];if(e.lowerBound.x<r.x&&r.x<e.upperBound.x&&e.lowerBound.y<r.y&&r.y<e.upperBound.y&&!t.ReportParticle(this,s))break}}QueryShapeAABB(t,e,i,s=0){const r=Dn.QueryShapeAABB_s_aabb;e.ComputeAABB(r,i,s),this.QueryAABB(t,r)}QueryPointAABB(t,e,i=.005){const s=Dn.QueryPointAABB_s_aabb;s.lowerBound.Set(e.x-i,e.y-i),s.upperBound.Set(e.x+i,e.y+i),this.QueryAABB(t,s)}RayCast(t,e,i){const s=Dn.RayCast_s_aabb,r=Dn.RayCast_s_p,n=Dn.RayCast_s_v,o=Dn.RayCast_s_n,h=Dn.RayCast_s_point;if(0===this.m_proxyBuffer.count)return;const a=this.m_positionBuffer.data,l=s;Ie.MinV(e,i,l.lowerBound),Ie.MaxV(e,i,l.upperBound);let m=1;const c=Ie.SubVV(i,e,n),u=Ie.DotVV(c,c),_=this.GetInsideBoundsEnumerator(l);let d;for(;(d=_.GetNext())>=0;){const i=Ie.SubVV(e,a[d],r),s=Ie.DotVV(i,c),n=s*s-u*(Ie.DotVV(i,i)-this.m_squaredDiameter);if(n>=0){const r=De(n);let a=(-s-r)/u;if(a>m)continue;if(a<0&&(a=(-s+r)/u,a<0||a>m))continue;const l=Ie.AddVMulSV(i,a,c,o);if(l.Normalize(),m=be(m,t.ReportParticle(this,d,Ie.AddVMulSV(e,a,c,h),l,a)),m<=0)break}}}ComputeAABB(t){const e=this.GetParticleCount();t.lowerBound.x=+ce,t.lowerBound.y=+ce,t.upperBound.x=-ce,t.upperBound.y=-ce;const i=this.m_positionBuffer.data;for(let s=0;s<e;s++){const e=i[s];Ie.MinV(t.lowerBound,e,t.lowerBound),Ie.MaxV(t.upperBound,e,t.upperBound)}t.lowerBound.x-=this.m_particleDiameter,t.lowerBound.y-=this.m_particleDiameter,t.upperBound.x+=this.m_particleDiameter,t.upperBound.y+=this.m_particleDiameter}FreeBuffer(t,e){null!==t&&(t.length=0)}FreeUserOverridableBuffer(t){0===t.userSuppliedCapacity&&this.FreeBuffer(t.data,this.m_internalAllocatedCapacity)}ReallocateBuffer3(t,e,i){if(i<=e)throw new Error;const s=t?t.slice():[];return s.length=i,s}ReallocateBuffer5(t,e,i,s,r){if(s<=i)throw new Error;if(e&&!(s<=e))throw new Error;return r&&!t||e||(t=this.ReallocateBuffer3(t,i,s)),t}ReallocateBuffer4(t,e,i,s){return this.ReallocateBuffer5(t.data,t.userSuppliedCapacity,e,i,s)}RequestBuffer(t){return t||(0===this.m_internalAllocatedCapacity&&this.ReallocateInternalAllocatedBuffers(256),(t=[]).length=this.m_internalAllocatedCapacity),t}ReallocateHandleBuffers(t){this.m_handleIndexBuffer.data=this.ReallocateBuffer4(this.m_handleIndexBuffer,this.m_internalAllocatedCapacity,t,!0)}ReallocateInternalAllocatedBuffers(t){function e(t,e){return e&&t>e?e:t}if(t=e(t,this.m_def.maxCount),t=e(t,this.m_flagsBuffer.userSuppliedCapacity),t=e(t,this.m_positionBuffer.userSuppliedCapacity),t=e(t,this.m_velocityBuffer.userSuppliedCapacity),t=e(t,this.m_colorBuffer.userSuppliedCapacity),t=e(t,this.m_userDataBuffer.userSuppliedCapacity),this.m_internalAllocatedCapacity<t){this.ReallocateHandleBuffers(t),this.m_flagsBuffer.data=this.ReallocateBuffer4(this.m_flagsBuffer,this.m_internalAllocatedCapacity,t,!1);const e=this.m_stuckThreshold>0;this.m_lastBodyContactStepBuffer.data=this.ReallocateBuffer4(this.m_lastBodyContactStepBuffer,this.m_internalAllocatedCapacity,t,e),this.m_bodyContactCountBuffer.data=this.ReallocateBuffer4(this.m_bodyContactCountBuffer,this.m_internalAllocatedCapacity,t,e),this.m_consecutiveContactStepsBuffer.data=this.ReallocateBuffer4(this.m_consecutiveContactStepsBuffer,this.m_internalAllocatedCapacity,t,e),this.m_positionBuffer.data=this.ReallocateBuffer4(this.m_positionBuffer,this.m_internalAllocatedCapacity,t,!1),this.m_velocityBuffer.data=this.ReallocateBuffer4(this.m_velocityBuffer,this.m_internalAllocatedCapacity,t,!1),this.m_forceBuffer=this.ReallocateBuffer5(this.m_forceBuffer,0,this.m_internalAllocatedCapacity,t,!1),this.m_weightBuffer=this.ReallocateBuffer5(this.m_weightBuffer,0,this.m_internalAllocatedCapacity,t,!1),this.m_staticPressureBuffer=this.ReallocateBuffer5(this.m_staticPressureBuffer,0,this.m_internalAllocatedCapacity,t,!0),this.m_accumulationBuffer=this.ReallocateBuffer5(this.m_accumulationBuffer,0,this.m_internalAllocatedCapacity,t,!1),this.m_accumulation2Buffer=this.ReallocateBuffer5(this.m_accumulation2Buffer,0,this.m_internalAllocatedCapacity,t,!0),this.m_depthBuffer=this.ReallocateBuffer5(this.m_depthBuffer,0,this.m_internalAllocatedCapacity,t,!0),this.m_colorBuffer.data=this.ReallocateBuffer4(this.m_colorBuffer,this.m_internalAllocatedCapacity,t,!0),this.m_groupBuffer=this.ReallocateBuffer5(this.m_groupBuffer,0,this.m_internalAllocatedCapacity,t,!1),this.m_userDataBuffer.data=this.ReallocateBuffer4(this.m_userDataBuffer,this.m_internalAllocatedCapacity,t,!0),this.m_expirationTimeBuffer.data=this.ReallocateBuffer4(this.m_expirationTimeBuffer,this.m_internalAllocatedCapacity,t,!0),this.m_indexByExpirationTimeBuffer.data=this.ReallocateBuffer4(this.m_indexByExpirationTimeBuffer,this.m_internalAllocatedCapacity,t,!1),this.m_internalAllocatedCapacity=t}}CreateParticleForGroup(t,e,i){const s=new on;s.flags=me(t.flags,0),ke.MulXV(e,i,s.position),Ie.AddVV(me(t.linearVelocity,Ie.ZERO),Ie.CrossSV(me(t.angularVelocity,0),Ie.SubVV(s.position,me(t.position,Ie.ZERO),Ie.s_t0),Ie.s_t0),s.velocity),s.color.Copy(me(t.color,ki.ZERO)),s.lifetime=me(t.lifetime,0),s.userData=t.userData,this.CreateParticle(s)}CreateParticlesStrokeShapeForGroup(t,e,i){const s=Dn.CreateParticlesStrokeShapeForGroup_s_edge,r=Dn.CreateParticlesStrokeShapeForGroup_s_d,n=Dn.CreateParticlesStrokeShapeForGroup_s_p;let o=me(e.stride,0);0===o&&(o=this.GetParticleStride());let h=0;const a=t.GetChildCount();for(let l=0;l<a;l++){let a=null;t.GetType()===Oe.e_edgeShape?a=t:(a=s,t.GetChildEdge(a,l));const m=Ie.SubVV(a.m_vertex2,a.m_vertex1,r),c=m.Length();for(;h<c;){const t=Ie.AddVMulSV(a.m_vertex1,h/c,m,n);this.CreateParticleForGroup(e,i,t),h+=o}h-=c}}CreateParticlesFillShapeForGroup(t,e,i){const s=Dn.CreateParticlesFillShapeForGroup_s_aabb,r=Dn.CreateParticlesFillShapeForGroup_s_p;let n=me(e.stride,0);0===n&&(n=this.GetParticleStride());const o=ke.IDENTITY,h=s;t.ComputeAABB(h,o,0);for(let s=Math.floor(h.lowerBound.y/n)*n;s<h.upperBound.y;s+=n)for(let a=Math.floor(h.lowerBound.x/n)*n;a<h.upperBound.x;a+=n){const n=r.Set(a,s);t.TestPoint(o,n)&&this.CreateParticleForGroup(e,i,n)}}CreateParticlesWithShapeForGroup(t,e,i){switch(t.GetType()){case Oe.e_edgeShape:case Oe.e_chainShape:this.CreateParticlesStrokeShapeForGroup(t,e,i);break;case Oe.e_polygonShape:case Oe.e_circleShape:this.CreateParticlesFillShapeForGroup(t,e,i)}}CreateParticlesWithShapesForGroup(t,e,i,s){const r=new zn(t,e);this.CreateParticlesFillShapeForGroup(r,i,s)}CloneParticle(t,e){const i=new on;i.flags=this.m_flagsBuffer.data[t],i.position.Copy(this.m_positionBuffer.data[t]),i.velocity.Copy(this.m_velocityBuffer.data[t]),this.m_colorBuffer.data&&i.color.Copy(this.m_colorBuffer.data[t]),this.m_userDataBuffer.data&&(i.userData=this.m_userDataBuffer.data[t]),i.group=e;const s=this.CreateParticle(i);if(this.m_handleIndexBuffer.data){const e=this.m_handleIndexBuffer.data[t];e&&e.SetIndex(s),this.m_handleIndexBuffer.data[s]=e,this.m_handleIndexBuffer.data[t]=null}return this.m_lastBodyContactStepBuffer.data&&(this.m_lastBodyContactStepBuffer.data[s]=this.m_lastBodyContactStepBuffer.data[t]),this.m_bodyContactCountBuffer.data&&(this.m_bodyContactCountBuffer.data[s]=this.m_bodyContactCountBuffer.data[t]),this.m_consecutiveContactStepsBuffer.data&&(this.m_consecutiveContactStepsBuffer.data[s]=this.m_consecutiveContactStepsBuffer.data[t]),this.m_hasForce&&this.m_forceBuffer[s].Copy(this.m_forceBuffer[t]),this.m_staticPressureBuffer&&(this.m_staticPressureBuffer[s]=this.m_staticPressureBuffer[t]),this.m_depthBuffer&&(this.m_depthBuffer[s]=this.m_depthBuffer[t]),this.m_expirationTimeBuffer.data&&(this.m_expirationTimeBuffer.data[s]=this.m_expirationTimeBuffer.data[t]),s}DestroyParticlesInGroup(t,e=!1){for(let i=t.m_firstIndex;i<t.m_lastIndex;i++)this.DestroyParticle(i,e)}DestroyParticleGroup(t){this.m_world.m_destructionListener&&this.m_world.m_destructionListener.SayGoodbyeParticleGroup(t),this.SetGroupFlags(t,0);for(let e=t.m_firstIndex;e<t.m_lastIndex;e++)this.m_groupBuffer[e]=null;t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t===this.m_groupList&&(this.m_groupList=t.m_next),--this.m_groupCount}static ParticleCanBeConnected(t,e){return 0!=(t&(tn.b2_wallParticle|tn.b2_springParticle|tn.b2_elasticParticle))||null!==e&&0!=(e.GetGroupFlags()&en.b2_rigidParticleGroup)}UpdatePairsAndTriads(t,e,i){const s=Dn.UpdatePairsAndTriads_s_dab,r=Dn.UpdatePairsAndTriads_s_dbc,n=Dn.UpdatePairsAndTriads_s_dca,o=this.m_positionBuffer.data;let h=0;for(let i=t;i<e;i++)h|=this.m_flagsBuffer.data[i];if(h&Dn.k_pairFlags)for(let s=0;s<this.m_contactBuffer.count;s++){const r=this.m_contactBuffer.data[s],n=r.indexA,h=r.indexB,a=this.m_flagsBuffer.data[n],l=this.m_flagsBuffer.data[h],m=this.m_groupBuffer[n],c=this.m_groupBuffer[h];if(n>=t&&n<e&&h>=t&&h<e&&!((a|l)&tn.b2_zombieParticle)&&(a|l)&Dn.k_pairFlags&&(i.IsNecessary(n)||i.IsNecessary(h))&&Dn.ParticleCanBeConnected(a,m)&&Dn.ParticleCanBeConnected(l,c)&&i.ShouldCreatePair(n,h)){const t=this.m_pairBuffer.data[this.m_pairBuffer.Append()];t.indexA=n,t.indexB=h,t.flags=r.flags,t.strength=be(m?m.m_strength:1,c?c.m_strength:1),t.distance=Ie.DistanceVV(o[n],o[h])}yn(this.m_pairBuffer.data,0,this.m_pairBuffer.count,Dn.ComparePairIndices),this.m_pairBuffer.Unique(Dn.MatchPairIndices)}if(h&Dn.k_triadFlags){const h=new cn(e-t);for(let s=t;s<e;s++){const t=this.m_flagsBuffer.data[s],e=this.m_groupBuffer[s];t&tn.b2_zombieParticle||!Dn.ParticleCanBeConnected(t,e)||h.AddGenerator(o[s],s,i.IsNecessary(s))}const a=this.GetParticleStride();h.Generate(a/2,2*a);const l=this,m=(t,e,h)=>{const a=l.m_flagsBuffer.data[t],m=l.m_flagsBuffer.data[e],c=l.m_flagsBuffer.data[h];if((a|m|c)&Dn.k_triadFlags&&i.ShouldCreateTriad(t,e,h)){const i=o[t],u=o[e],_=o[h],d=Ie.SubVV(i,u,s),p=Ie.SubVV(u,_,r),f=Ie.SubVV(_,i,n),y=4*l.m_squaredDiameter;if(Ie.DotVV(d,d)>y||Ie.DotVV(p,p)>y||Ie.DotVV(f,f)>y)return;const x=l.m_groupBuffer[t],g=l.m_groupBuffer[e],w=l.m_groupBuffer[h],C=l.m_triadBuffer.data[l.m_triadBuffer.Append()];C.indexA=t,C.indexB=e,C.indexC=h,C.flags=a|m|c,C.strength=be(be(x?x.m_strength:1,g?g.m_strength:1),w?w.m_strength:1);const v=(i.x+u.x+_.x)/3,S=(i.y+u.y+_.y)/3;C.pa.x=i.x-v,C.pa.y=i.y-S,C.pb.x=u.x-v,C.pb.y=u.y-S,C.pc.x=_.x-v,C.pc.y=_.y-S,C.ka=-Ie.DotVV(f,d),C.kb=-Ie.DotVV(d,p),C.kc=-Ie.DotVV(p,f),C.s=Ie.CrossVV(i,u)+Ie.CrossVV(u,_)+Ie.CrossVV(_,i)}};h.GetNodes(m),yn(this.m_triadBuffer.data,0,this.m_triadBuffer.count,Dn.CompareTriadIndices),this.m_triadBuffer.Unique(Dn.MatchTriadIndices)}}UpdatePairsAndTriadsWithReactiveParticles(){const t=new jn(this.m_flagsBuffer);this.UpdatePairsAndTriads(0,this.m_count,t);for(let t=0;t<this.m_count;t++)this.m_flagsBuffer.data[t]&=~tn.b2_reactiveParticle;this.m_allParticleFlags&=~tn.b2_reactiveParticle}static ComparePairIndices(t,e){const i=t.indexA-e.indexA;return 0!==i?i<0:t.indexB<e.indexB}static MatchPairIndices(t,e){return t.indexA===e.indexA&&t.indexB===e.indexB}static CompareTriadIndices(t,e){const i=t.indexA-e.indexA;if(0!==i)return i<0;const s=t.indexB-e.indexB;return 0!==s?s<0:t.indexC<e.indexC}static MatchTriadIndices(t,e){return t.indexA===e.indexA&&t.indexB===e.indexB&&t.indexC===e.indexC}static InitializeParticleLists(t,e){const i=t.GetBufferIndex(),s=t.GetParticleCount();for(let t=0;t<s;t++){const s=e[t];s.list=s,s.next=null,s.count=1,s.index=t+i}}MergeParticleListsInContact(t,e){const i=t.GetBufferIndex();for(let s=0;s<this.m_contactBuffer.count;s++){const r=this.m_contactBuffer.data[s],n=r.indexA,o=r.indexB;if(!t.ContainsParticle(n)||!t.ContainsParticle(o))continue;let h=e[n-i].list,a=e[o-i].list;if(h!==a){if(h.count<a.count){const t=h;h=a,a=t}Dn.MergeParticleLists(h,a)}}}static MergeParticleLists(t,e){for(let i=e;;){i.list=t;const e=i.next;if(!e){i.next=t.next;break}i=e}t.next=e,t.count+=e.count,e.count=0}static FindLongestParticleList(t,e){const i=t.GetParticleCount();let s=e[0];for(let t=0;t<i;t++){const i=e[t];s.count<i.count&&(s=i)}return s}MergeZombieParticleListNodes(t,e,i){const s=t.GetParticleCount();for(let t=0;t<s;t++){const s=e[t];s!==i&&this.m_flagsBuffer.data[s.index]&tn.b2_zombieParticle&&Dn.MergeParticleListAndNode(i,s)}}static MergeParticleListAndNode(t,e){e.list=t,e.next=t.next,t.next=e,t.count++,e.count=0}CreateParticleGroupsFromParticleList(t,e,i){const s=t.GetParticleCount(),r=new an;r.groupFlags=t.GetGroupFlags(),r.userData=t.GetUserData();for(let t=0;t<s;t++){const s=e[t];if(!s.count||s===i)continue;const n=this.CreateParticleGroup(r);for(let t=s;t;t=t.next){const e=t.index,i=this.CloneParticle(e,n);this.m_flagsBuffer.data[e]|=tn.b2_zombieParticle,t.index=i}}}UpdatePairsAndTriadsWithParticleList(t,e){const i=t.GetBufferIndex();for(let s=0;s<this.m_pairBuffer.count;s++){const r=this.m_pairBuffer.data[s],n=r.indexA,o=r.indexB;t.ContainsParticle(n)&&(r.indexA=e[n-i].index),t.ContainsParticle(o)&&(r.indexB=e[o-i].index)}for(let s=0;s<this.m_triadBuffer.count;s++){const r=this.m_triadBuffer.data[s],n=r.indexA,o=r.indexB,h=r.indexC;t.ContainsParticle(n)&&(r.indexA=e[n-i].index),t.ContainsParticle(o)&&(r.indexB=e[o-i].index),t.ContainsParticle(h)&&(r.indexC=e[h-i].index)}}ComputeDepth(){const t=[];let e=0;for(let i=0;i<this.m_contactBuffer.count;i++){const s=this.m_contactBuffer.data[i],r=s.indexA,n=s.indexB,o=this.m_groupBuffer[r],h=this.m_groupBuffer[n];o&&o===h&&o.m_groupFlags&en.b2_particleGroupNeedsUpdateDepth&&(t[e++]=s)}const i=[];let s=0;for(let t=this.m_groupList;t;t=t.GetNext())if(t.m_groupFlags&en.b2_particleGroupNeedsUpdateDepth){i[s++]=t,this.SetGroupFlags(t,t.m_groupFlags&~en.b2_particleGroupNeedsUpdateDepth);for(let e=t.m_firstIndex;e<t.m_lastIndex;e++)this.m_accumulationBuffer[e]=0}for(let i=0;i<e;i++){const e=t[i],s=e.indexA,r=e.indexB,n=e.weight;this.m_accumulationBuffer[s]+=n,this.m_accumulationBuffer[r]+=n}for(let t=0;t<s;t++){const e=i[t];for(let t=e.m_firstIndex;t<e.m_lastIndex;t++){const e=this.m_accumulationBuffer[t];this.m_depthBuffer[t]=e<.8?0:ce}}const r=De(this.m_count)>>0;for(let i=0;i<r;i++){let i=!1;for(let s=0;s<e;s++){const e=t[s],r=e.indexA,n=e.indexB,o=1-e.weight,h=this.m_depthBuffer[r],a=this.m_depthBuffer[n],l=a+o,m=h+o;h>l&&(this.m_depthBuffer[r]=l,i=!0),a>m&&(this.m_depthBuffer[n]=m,i=!0)}if(!i)break}for(let t=0;t<s;t++){const e=i[t];for(let t=e.m_firstIndex;t<e.m_lastIndex;t++)this.m_depthBuffer[t]<ce?this.m_depthBuffer[t]*=this.m_particleDiameter:this.m_depthBuffer[t]=0}}GetInsideBoundsEnumerator(t){const e=Dn.computeTag(this.m_inverseDiameter*t.lowerBound.x-1,this.m_inverseDiameter*t.lowerBound.y-1),i=Dn.computeTag(this.m_inverseDiameter*t.upperBound.x+1,this.m_inverseDiameter*t.upperBound.y+1),s=this.m_proxyBuffer.count,r=gn(this.m_proxyBuffer.data,0,s,e,Pn.CompareProxyTag),n=wn(this.m_proxyBuffer.data,0,s,i,Pn.CompareTagProxy);return new Gn(this,e,i,r,n)}UpdateAllParticleFlags(){this.m_allParticleFlags=0;for(let t=0;t<this.m_count;t++)this.m_allParticleFlags|=this.m_flagsBuffer.data[t];this.m_needsUpdateAllParticleFlags=!1}UpdateAllGroupFlags(){this.m_allGroupFlags=0;for(let t=this.m_groupList;t;t=t.GetNext())this.m_allGroupFlags|=t.m_groupFlags;this.m_needsUpdateAllGroupFlags=!1}AddContact(t,e,i){const s=this.m_flagsBuffer.data,r=this.m_positionBuffer.data,n=Ie.SubVV(r[e],r[t],Dn.AddContact_s_d),o=Ie.DotVV(n,n);if(0<o&&o<this.m_squaredDiameter){const i=Me(o),r=this.m_contactBuffer.data[this.m_contactBuffer.Append()];r.indexA=t,r.indexB=e,r.flags=s[t]|s[e],r.weight=1-o*i*this.m_inverseDiameter,r.normal.x=i*n.x,r.normal.y=i*n.y}}FindContacts_Reference(t){const e=this.m_proxyBuffer.count;this.m_contactBuffer.count=0;for(let t=0,i=0;t<e;t++){const s=Dn.computeRelativeTag(this.m_proxyBuffer.data[t].tag,1,0);for(let i=t+1;i<e&&!(s<this.m_proxyBuffer.data[i].tag);i++)this.AddContact(this.m_proxyBuffer.data[t].index,this.m_proxyBuffer.data[i].index,this.m_contactBuffer);const r=Dn.computeRelativeTag(this.m_proxyBuffer.data[t].tag,-1,1);for(;i<e&&!(r<=this.m_proxyBuffer.data[i].tag);i++);const n=Dn.computeRelativeTag(this.m_proxyBuffer.data[t].tag,1,1);for(let s=i;s<e&&!(n<this.m_proxyBuffer.data[s].tag);s++)this.AddContact(this.m_proxyBuffer.data[t].index,this.m_proxyBuffer.data[s].index,this.m_contactBuffer)}}FindContacts(t){this.FindContacts_Reference(t)}UpdateProxies_Reference(t){const e=this.m_positionBuffer.data,i=this.m_inverseDiameter;for(let t=0;t<this.m_proxyBuffer.count;++t){const s=this.m_proxyBuffer.data[t],r=e[s.index];s.tag=Dn.computeTag(i*r.x,i*r.y)}}UpdateProxies(t){this.UpdateProxies_Reference(t)}SortProxies(t){fn(this.m_proxyBuffer.data,0,this.m_proxyBuffer.count,Pn.CompareProxyProxy)}FilterContacts(t){const e=this.GetParticleContactFilter();if(null===e)return;const i=this;this.m_contactBuffer.RemoveIf((t=>0!=(t.flags&tn.b2_particleContactFilterParticle)&&!e.ShouldCollideParticleParticle(i,t.indexA,t.indexB)))}NotifyContactListenerPreContact(t){if(null!==this.GetParticleContactListener())throw t.Initialize(this.m_contactBuffer,this.m_flagsBuffer),new Error}NotifyContactListenerPostContact(t){const e=this.GetParticleContactListener();if(null!==e){for(let i=0;i<this.m_contactBuffer.count;++i){const s=this.m_contactBuffer.data[i],r=-1;r>=0?t.Invalidate(r):e.BeginContactParticleParticle(this,s)}throw new Error}}static b2ParticleContactIsZombie(t){return(t.flags&tn.b2_zombieParticle)===tn.b2_zombieParticle}UpdateContacts(t){this.UpdateProxies(this.m_proxyBuffer),this.SortProxies(this.m_proxyBuffer);const e=new kn;this.NotifyContactListenerPreContact(e),this.FindContacts(this.m_contactBuffer),this.FilterContacts(this.m_contactBuffer),this.NotifyContactListenerPostContact(e),t&&this.m_contactBuffer.RemoveIf(Dn.b2ParticleContactIsZombie)}NotifyBodyContactListenerPreContact(t){if(null!==this.GetFixtureContactListener())throw t.Initialize(this.m_bodyContactBuffer,this.m_flagsBuffer),new Error}NotifyBodyContactListenerPostContact(t){const e=this.GetFixtureContactListener();if(null!==e){for(let i=0;i<this.m_bodyContactBuffer.count;i++){const s=this.m_bodyContactBuffer.data[i],r=-1;r>=0?t.Invalidate(r):e.BeginContactFixtureParticle(this,s)}throw new Error}}UpdateBodyContacts(){const t=Dn.UpdateBodyContacts_s_aabb,e=new Fn;if(this.NotifyBodyContactListenerPreContact(e),this.m_stuckThreshold>0){const t=this.GetParticleCount();for(let e=0;e<t;e++)this.m_bodyContactCountBuffer.data[e]=0,this.m_timestamp>this.m_lastBodyContactStepBuffer.data[e]+1&&(this.m_consecutiveContactStepsBuffer.data[e]=0)}this.m_bodyContactBuffer.SetCount(0),this.m_stuckParticleBuffer.SetCount(0);const i=t;this.ComputeAABB(i),null===this.UpdateBodyContacts_callback&&(this.UpdateBodyContacts_callback=new qn(this));const s=this.UpdateBodyContacts_callback;s.m_contactFilter=this.GetFixtureContactFilter(),this.m_world.QueryAABB(s,i),this.m_def.strictContactCheck&&this.RemoveSpuriousBodyContacts(),this.NotifyBodyContactListenerPostContact(e)}Solve(t){const e=Dn.Solve_s_subStep;if(0!==this.m_count&&(this.m_expirationTimeBuffer.data&&this.SolveLifetimes(t),this.m_allParticleFlags&tn.b2_zombieParticle&&this.SolveZombie(),this.m_needsUpdateAllParticleFlags&&this.UpdateAllParticleFlags(),this.m_needsUpdateAllGroupFlags&&this.UpdateAllGroupFlags(),!this.m_paused))for(this.m_iterationIndex=0;this.m_iterationIndex<t.particleIterations;this.m_iterationIndex++){++this.m_timestamp;const i=e.Copy(t);i.dt/=t.particleIterations,i.inv_dt*=t.particleIterations,this.UpdateContacts(!1),this.UpdateBodyContacts(),this.ComputeWeight(),this.m_allGroupFlags&en.b2_particleGroupNeedsUpdateDepth&&this.ComputeDepth(),this.m_allParticleFlags&tn.b2_reactiveParticle&&this.UpdatePairsAndTriadsWithReactiveParticles(),this.m_hasForce&&this.SolveForce(i),this.m_allParticleFlags&tn.b2_viscousParticle&&this.SolveViscous(),this.m_allParticleFlags&tn.b2_repulsiveParticle&&this.SolveRepulsive(i),this.m_allParticleFlags&tn.b2_powderParticle&&this.SolvePowder(i),this.m_allParticleFlags&tn.b2_tensileParticle&&this.SolveTensile(i),this.m_allGroupFlags&en.b2_solidParticleGroup&&this.SolveSolid(i),this.m_allParticleFlags&tn.b2_colorMixingParticle&&this.SolveColorMixing(),this.SolveGravity(i),this.m_allParticleFlags&tn.b2_staticPressureParticle&&this.SolveStaticPressure(i),this.SolvePressure(i),this.SolveDamping(i),this.m_allParticleFlags&Dn.k_extraDampingFlags&&this.SolveExtraDamping(),this.m_allParticleFlags&tn.b2_elasticParticle&&this.SolveElastic(i),this.m_allParticleFlags&tn.b2_springParticle&&this.SolveSpring(i),this.LimitVelocity(i),this.m_allGroupFlags&en.b2_rigidParticleGroup&&this.SolveRigidDamping(),this.m_allParticleFlags&tn.b2_barrierParticle&&this.SolveBarrier(i),this.SolveCollision(i),this.m_allGroupFlags&en.b2_rigidParticleGroup&&this.SolveRigid(i),this.m_allParticleFlags&tn.b2_wallParticle&&this.SolveWall();for(let t=0;t<this.m_count;t++)this.m_positionBuffer.data[t].SelfMulAdd(i.dt,this.m_velocityBuffer.data[t])}}SolveCollision(t){const e=Dn.SolveCollision_s_aabb,i=this.m_positionBuffer.data,s=this.m_velocityBuffer.data,r=e;r.lowerBound.x=+ce,r.lowerBound.y=+ce,r.upperBound.x=-ce,r.upperBound.y=-ce;for(let e=0;e<this.m_count;e++){const n=s[e],o=i[e],h=o.x+t.dt*n.x,a=o.y+t.dt*n.y;r.lowerBound.x=be(r.lowerBound.x,be(o.x,h)),r.lowerBound.y=be(r.lowerBound.y,be(o.y,a)),r.upperBound.x=Be(r.upperBound.x,Be(o.x,h)),r.upperBound.y=Be(r.upperBound.y,Be(o.y,a))}null===this.SolveCollision_callback&&(this.SolveCollision_callback=new Nn(this,t));const n=this.SolveCollision_callback;n.m_step=t,this.m_world.QueryAABB(n,r)}LimitVelocity(t){const e=this.m_velocityBuffer.data,i=this.GetCriticalVelocitySquared(t);for(let t=0;t<this.m_count;t++){const s=e[t],r=Ie.DotVV(s,s);r>i&&s.SelfMul(De(i/r))}}SolveGravity(t){const e=Dn.SolveGravity_s_gravity,i=this.m_velocityBuffer.data,s=Ie.MulSV(t.dt*this.m_def.gravityScale,this.m_world.GetGravity(),e);for(let t=0;t<this.m_count;t++)i[t].SelfAdd(s)}SolveBarrier(t){const e=Dn.SolveBarrier_s_aabb,i=Dn.SolveBarrier_s_va,s=Dn.SolveBarrier_s_vb,r=Dn.SolveBarrier_s_pba,n=Dn.SolveBarrier_s_vba,o=Dn.SolveBarrier_s_vc,h=Dn.SolveBarrier_s_pca,a=Dn.SolveBarrier_s_vca,l=Dn.SolveBarrier_s_qba,m=Dn.SolveBarrier_s_qca,c=Dn.SolveBarrier_s_dv,u=Dn.SolveBarrier_s_f,_=this.m_positionBuffer.data,d=this.m_velocityBuffer.data;for(let t=0;t<this.m_count;t++)0!=(this.m_flagsBuffer.data[t]&Dn.k_barrierWallFlags)&&d[t].SetZero();const p=2.5*t.dt,f=this.GetParticleMass();for(let y=0;y<this.m_pairBuffer.count;y++){const x=this.m_pairBuffer.data[y];if(x.flags&tn.b2_barrierParticle){const y=x.indexA,g=x.indexB,w=_[y],C=_[g],v=e;Ie.MinV(w,C,v.lowerBound),Ie.MaxV(w,C,v.upperBound);const S=this.m_groupBuffer[y],b=this.m_groupBuffer[g],B=this.GetLinearVelocity(S,y,w,i),A=this.GetLinearVelocity(b,g,C,s),V=Ie.SubVV(C,w,r),M=Ie.SubVV(A,B,n),D=this.GetInsideBoundsEnumerator(v);let I;for(;(I=D.GetNext())>=0;){const e=_[I],i=this.m_groupBuffer[I];if(S!==i&&b!==i){const s=this.GetLinearVelocity(i,I,e,o),r=Ie.SubVV(e,w,h),n=Ie.SubVV(s,B,a),_=Ie.CrossVV(M,n),y=Ie.CrossVV(V,n)-Ie.CrossVV(r,M),x=Ie.CrossVV(V,r);let g,C;const v=l,S=m;if(0===_){if(0===y)continue;if(C=-x/y,!(C>=0&&C<p))continue;if(Ie.AddVMulSV(V,C,M,v),Ie.AddVMulSV(r,C,n,S),g=Ie.DotVV(v,S)/Ie.DotVV(v,v),!(g>=0&&g<=1))continue}else{const t=y*y-4*x*_;if(t<0)continue;const e=De(t);let i=(-y-e)/(2*_),s=(-y+e)/(2*_);if(i>s){const t=i;i=s,s=t}if(C=i,Ie.AddVMulSV(V,C,M,v),Ie.AddVMulSV(r,C,n,S),g=Ie.DotVV(v,S)/Ie.DotVV(v,v),!(C>=0&&C<p&&g>=0&&g<=1)){if(C=s,!(C>=0&&C<p))continue;if(Ie.AddVMulSV(V,C,M,v),Ie.AddVMulSV(r,C,n,S),g=Ie.DotVV(v,S)/Ie.DotVV(v,v),!(g>=0&&g<=1))continue}}const b=c;b.x=B.x+g*M.x-s.x,b.y=B.y+g*M.y-s.y;const A=Ie.MulSV(f,b,u);if(i&&this.IsRigidGroup(i)){const t=i.GetMass(),s=i.GetInertia();t>0&&i.m_linearVelocity.SelfMulAdd(1/t,A),s>0&&(i.m_angularVelocity+=Ie.CrossVV(Ie.SubVV(e,i.GetCenter(),Ie.s_t0),A)/s)}else d[I].SelfAdd(b);this.ParticleApplyForce(I,A.SelfMul(-t.inv_dt))}}}}}SolveStaticPressure(t){this.m_staticPressureBuffer=this.RequestBuffer(this.m_staticPressureBuffer);const e=this.GetCriticalPressure(t),i=this.m_def.staticPressureStrength*e,s=.25*e,r=this.m_def.staticPressureRelaxation;for(let t=0;t<this.m_def.staticPressureIterations;t++){for(let t=0;t<this.m_count;t++)this.m_accumulationBuffer[t]=0;for(let t=0;t<this.m_contactBuffer.count;t++){const e=this.m_contactBuffer.data[t];if(e.flags&tn.b2_staticPressureParticle){const t=e.indexA,i=e.indexB,s=e.weight;this.m_accumulationBuffer[t]+=s*this.m_staticPressureBuffer[i],this.m_accumulationBuffer[i]+=s*this.m_staticPressureBuffer[t]}}for(let t=0;t<this.m_count;t++){const e=this.m_weightBuffer[t];if(this.m_flagsBuffer.data[t]&tn.b2_staticPressureParticle){const n=(this.m_accumulationBuffer[t]+i*(e-1))/(e+r);this.m_staticPressureBuffer[t]=Ae(n,0,s)}else this.m_staticPressureBuffer[t]=0}}}ComputeWeight(){for(let t=0;t<this.m_count;t++)this.m_weightBuffer[t]=0;for(let t=0;t<this.m_bodyContactBuffer.count;t++){const e=this.m_bodyContactBuffer.data[t],i=e.index,s=e.weight;this.m_weightBuffer[i]+=s}for(let t=0;t<this.m_contactBuffer.count;t++){const e=this.m_contactBuffer.data[t],i=e.indexA,s=e.indexB,r=e.weight;this.m_weightBuffer[i]+=r,this.m_weightBuffer[s]+=r}}SolvePressure(t){const e=Dn.SolvePressure_s_f,i=this.m_positionBuffer.data,s=this.m_velocityBuffer.data,r=this.GetCriticalPressure(t),n=this.m_def.pressureStrength*r,o=.25*r;for(let t=0;t<this.m_count;t++){const e=n*Be(0,this.m_weightBuffer[t]-1);this.m_accumulationBuffer[t]=be(e,o)}if(this.m_allParticleFlags&Dn.k_noPressureFlags)for(let t=0;t<this.m_count;t++)this.m_flagsBuffer.data[t]&Dn.k_noPressureFlags&&(this.m_accumulationBuffer[t]=0);if(this.m_allParticleFlags&tn.b2_staticPressureParticle)for(let t=0;t<this.m_count;t++)this.m_flagsBuffer.data[t]&tn.b2_staticPressureParticle&&(this.m_accumulationBuffer[t]+=this.m_staticPressureBuffer[t]);const h=t.dt/(this.m_def.density*this.m_particleDiameter),a=this.GetParticleInvMass();for(let t=0;t<this.m_bodyContactBuffer.count;t++){const r=this.m_bodyContactBuffer.data[t],o=r.index,l=r.body,m=r.weight,c=r.mass,u=r.normal,_=i[o],d=this.m_accumulationBuffer[o]+n*m,p=Ie.MulSV(h*m*c*d,u,e);s[o].SelfMulSub(a,p),l.ApplyLinearImpulse(p,_,!0)}for(let t=0;t<this.m_contactBuffer.count;t++){const i=this.m_contactBuffer.data[t],r=i.indexA,n=i.indexB,o=i.weight,a=i.normal,l=this.m_accumulationBuffer[r]+this.m_accumulationBuffer[n],m=Ie.MulSV(h*o*l,a,e);s[r].SelfSub(m),s[n].SelfAdd(m)}}SolveDamping(t){const e=Dn.SolveDamping_s_v,i=Dn.SolveDamping_s_f,s=this.m_positionBuffer.data,r=this.m_velocityBuffer.data,n=this.m_def.dampingStrength,o=1/this.GetCriticalVelocity(t),h=this.GetParticleInvMass();for(let t=0;t<this.m_bodyContactBuffer.count;t++){const a=this.m_bodyContactBuffer.data[t],l=a.index,m=a.body,c=a.weight,u=a.mass,_=a.normal,d=s[l],p=Ie.SubVV(m.GetLinearVelocityFromWorldPoint(d,Ie.s_t0),r[l],e),f=Ie.DotVV(p,_);if(f<0){const t=Be(n*c,be(-o*f,.5)),e=Ie.MulSV(t*u*f,_,i);r[l].SelfMulAdd(h,e),m.ApplyLinearImpulse(e.SelfNeg(),d,!0)}}for(let t=0;t<this.m_contactBuffer.count;t++){const s=this.m_contactBuffer.data[t],h=s.indexA,a=s.indexB,l=s.weight,m=s.normal,c=Ie.SubVV(r[a],r[h],e),u=Ie.DotVV(c,m);if(u<0){const t=Be(n*l,be(-o*u,.5)),e=Ie.MulSV(t*u,m,i);r[h].SelfAdd(e),r[a].SelfSub(e)}}}SolveRigidDamping(){const t=Dn.SolveRigidDamping_s_t0,e=Dn.SolveRigidDamping_s_t1,i=Dn.SolveRigidDamping_s_p,s=Dn.SolveRigidDamping_s_v,r=[0],n=[0],o=[0],h=[0],a=[0],l=[0],m=this.m_positionBuffer.data,c=this.m_def.dampingStrength;for(let i=0;i<this.m_bodyContactBuffer.count;i++){const u=this.m_bodyContactBuffer.data[i],_=u.index,d=this.m_groupBuffer[_];if(d&&this.IsRigidGroup(d)){const i=u.body,p=u.normal,f=u.weight,y=m[_],x=Ie.SubVV(i.GetLinearVelocityFromWorldPoint(y,t),d.GetLinearVelocityFromWorldPoint(y,e),s),g=Ie.DotVV(x,p);if(g<0){this.InitDampingParameterWithRigidGroupOrParticle(r,n,o,!0,d,_,y,p),this.InitDampingParameter(h,a,l,i.GetMass(),i.GetInertia()-i.GetMass()*i.GetLocalCenter().LengthSquared(),i.GetWorldCenter(),y,p);const t=c*be(f,1)*this.ComputeDampingImpulse(r[0],n[0],o[0],h[0],a[0],l[0],g);this.ApplyDamping(r[0],n[0],o[0],!0,d,_,t,p),i.ApplyLinearImpulse(Ie.MulSV(-t,p,Ie.s_t0),y,!0)}}}for(let u=0;u<this.m_contactBuffer.count;u++){const _=this.m_contactBuffer.data[u],d=_.indexA,p=_.indexB,f=_.normal,y=_.weight,x=this.m_groupBuffer[d],g=this.m_groupBuffer[p],w=this.IsRigidGroup(x),C=this.IsRigidGroup(g);if(x!==g&&(w||C)){const u=Ie.MidVV(m[d],m[p],i),_=Ie.SubVV(this.GetLinearVelocity(g,p,u,t),this.GetLinearVelocity(x,d,u,e),s),v=Ie.DotVV(_,f);if(v<0){this.InitDampingParameterWithRigidGroupOrParticle(r,n,o,w,x,d,u,f),this.InitDampingParameterWithRigidGroupOrParticle(h,a,l,C,g,p,u,f);const t=c*y*this.ComputeDampingImpulse(r[0],n[0],o[0],h[0],a[0],l[0],v);this.ApplyDamping(r[0],n[0],o[0],w,x,d,t,f),this.ApplyDamping(h[0],a[0],l[0],C,g,p,-t,f)}}}}SolveExtraDamping(){const t=Dn.SolveExtraDamping_s_v,e=Dn.SolveExtraDamping_s_f,i=this.m_velocityBuffer.data,s=this.m_positionBuffer.data,r=this.GetParticleInvMass();for(let n=0;n<this.m_bodyContactBuffer.count;n++){const o=this.m_bodyContactBuffer.data[n],h=o.index;if(this.m_flagsBuffer.data[h]&Dn.k_extraDampingFlags){const n=o.body,a=o.mass,l=o.normal,m=s[h],c=Ie.SubVV(n.GetLinearVelocityFromWorldPoint(m,Ie.s_t0),i[h],t),u=Ie.DotVV(c,l);if(u<0){const t=Ie.MulSV(.5*a*u,l,e);i[h].SelfMulAdd(r,t),n.ApplyLinearImpulse(t.SelfNeg(),m,!0)}}}}SolveWall(){const t=this.m_velocityBuffer.data;for(let e=0;e<this.m_count;e++)this.m_flagsBuffer.data[e]&tn.b2_wallParticle&&t[e].SetZero()}SolveRigid(t){const e=Dn.SolveRigid_s_position,i=Dn.SolveRigid_s_rotation,s=Dn.SolveRigid_s_transform,r=Dn.SolveRigid_s_velocityTransform,n=this.m_positionBuffer.data,o=this.m_velocityBuffer.data;for(let h=this.m_groupList;h;h=h.GetNext())if(h.m_groupFlags&en.b2_rigidParticleGroup){h.UpdateStatistics();const a=i;a.SetAngle(t.dt*h.m_angularVelocity);const l=Ie.AddVV(h.m_center,Ie.SubVV(Ie.MulSV(t.dt,h.m_linearVelocity,Ie.s_t0),Fe.MulRV(a,h.m_center,Ie.s_t1),Ie.s_t0),e),m=s;m.SetPositionRotation(l,a),ke.MulXX(m,h.m_transform,h.m_transform);const c=r;c.p.x=t.inv_dt*m.p.x,c.p.y=t.inv_dt*m.p.y,c.q.s=t.inv_dt*m.q.s,c.q.c=t.inv_dt*(m.q.c-1);for(let t=h.m_firstIndex;t<h.m_lastIndex;t++)ke.MulXV(c,n[t],o[t])}}SolveElastic(t){const e=Dn.SolveElastic_s_pa,i=Dn.SolveElastic_s_pb,s=Dn.SolveElastic_s_pc,r=Dn.SolveElastic_s_r,n=Dn.SolveElastic_s_t0,o=this.m_positionBuffer.data,h=this.m_velocityBuffer.data,a=t.inv_dt*this.m_def.elasticStrength;for(let l=0;l<this.m_triadBuffer.count;l++){const m=this.m_triadBuffer.data[l];if(m.flags&tn.b2_elasticParticle){const l=m.indexA,c=m.indexB,u=m.indexC,_=m.pa,d=m.pb,p=m.pc,f=e.Copy(o[l]),y=i.Copy(o[c]),x=s.Copy(o[u]),g=h[l],w=h[c],C=h[u];f.SelfMulAdd(t.dt,g),y.SelfMulAdd(t.dt,w),x.SelfMulAdd(t.dt,C);const v=(f.x+y.x+x.x)/3,S=(f.y+y.y+x.y)/3;f.x-=v,f.y-=S,y.x-=v,y.y-=S,x.x-=v,x.y-=S;const b=r;b.s=Ie.CrossVV(_,f)+Ie.CrossVV(d,y)+Ie.CrossVV(p,x),b.c=Ie.DotVV(_,f)+Ie.DotVV(d,y)+Ie.DotVV(p,x);let B=Me(b.s*b.s+b.c*b.c);isFinite(B)||(B=198177537e11),b.s*=B,b.c*=B;const A=a*m.strength;Fe.MulRV(b,_,n),Ie.SubVV(n,f,n),Ie.MulSV(A,n,n),g.SelfAdd(n),Fe.MulRV(b,d,n),Ie.SubVV(n,y,n),Ie.MulSV(A,n,n),w.SelfAdd(n),Fe.MulRV(b,p,n),Ie.SubVV(n,x,n),Ie.MulSV(A,n,n),C.SelfAdd(n)}}}SolveSpring(t){const e=Dn.SolveSpring_s_pa,i=Dn.SolveSpring_s_pb,s=Dn.SolveSpring_s_d,r=Dn.SolveSpring_s_f,n=this.m_positionBuffer.data,o=this.m_velocityBuffer.data,h=t.inv_dt*this.m_def.springStrength;for(let a=0;a<this.m_pairBuffer.count;a++){const l=this.m_pairBuffer.data[a];if(l.flags&tn.b2_springParticle){const a=l.indexA,m=l.indexB,c=e.Copy(n[a]),u=i.Copy(n[m]),_=o[a],d=o[m];c.SelfMulAdd(t.dt,_),u.SelfMulAdd(t.dt,d);const p=Ie.SubVV(u,c,s),f=l.distance,y=p.Length(),x=h*l.strength,g=Ie.MulSV(x*(f-y)/y,p,r);_.SelfSub(g),d.SelfAdd(g)}}}SolveTensile(t){const e=Dn.SolveTensile_s_weightedNormal,i=Dn.SolveTensile_s_s,s=Dn.SolveTensile_s_f,r=this.m_velocityBuffer.data;for(let t=0;t<this.m_count;t++)this.m_accumulation2Buffer[t]=new Ie,this.m_accumulation2Buffer[t].SetZero();for(let t=0;t<this.m_contactBuffer.count;t++){const i=this.m_contactBuffer.data[t];if(i.flags&tn.b2_tensileParticle){const t=i.indexA,s=i.indexB,r=i.weight,n=i.normal,o=Ie.MulSV((1-r)*r,n,e);this.m_accumulation2Buffer[t].SelfSub(o),this.m_accumulation2Buffer[s].SelfAdd(o)}}const n=this.GetCriticalVelocity(t),o=this.m_def.surfaceTensionPressureStrength*n,h=this.m_def.surfaceTensionNormalStrength*n,a=.5*n;for(let t=0;t<this.m_contactBuffer.count;t++){const e=this.m_contactBuffer.data[t];if(e.flags&tn.b2_tensileParticle){const t=e.indexA,n=e.indexB,l=e.weight,m=e.normal,c=this.m_weightBuffer[t]+this.m_weightBuffer[n],u=Ie.SubVV(this.m_accumulation2Buffer[n],this.m_accumulation2Buffer[t],i),_=be(o*(c-2)+h*Ie.DotVV(u,m),a)*l,d=Ie.MulSV(_,m,s);r[t].SelfSub(d),r[n].SelfAdd(d)}}}SolveViscous(){const t=Dn.SolveViscous_s_v,e=Dn.SolveViscous_s_f,i=this.m_positionBuffer.data,s=this.m_velocityBuffer.data,r=this.m_def.viscousStrength,n=this.GetParticleInvMass();for(let o=0;o<this.m_bodyContactBuffer.count;o++){const h=this.m_bodyContactBuffer.data[o],a=h.index;if(this.m_flagsBuffer.data[a]&tn.b2_viscousParticle){const o=h.body,l=h.weight,m=h.mass,c=i[a],u=Ie.SubVV(o.GetLinearVelocityFromWorldPoint(c,Ie.s_t0),s[a],t),_=Ie.MulSV(r*m*l,u,e);s[a].SelfMulAdd(n,_),o.ApplyLinearImpulse(_.SelfNeg(),c,!0)}}for(let i=0;i<this.m_contactBuffer.count;i++){const n=this.m_contactBuffer.data[i];if(n.flags&tn.b2_viscousParticle){const i=n.indexA,o=n.indexB,h=n.weight,a=Ie.SubVV(s[o],s[i],t),l=Ie.MulSV(r*h,a,e);s[i].SelfAdd(l),s[o].SelfSub(l)}}}SolveRepulsive(t){const e=Dn.SolveRepulsive_s_f,i=this.m_velocityBuffer.data,s=this.m_def.repulsiveStrength*this.GetCriticalVelocity(t);for(let t=0;t<this.m_contactBuffer.count;t++){const r=this.m_contactBuffer.data[t];if(r.flags&tn.b2_repulsiveParticle){const t=r.indexA,n=r.indexB;if(this.m_groupBuffer[t]!==this.m_groupBuffer[n]){const o=r.weight,h=r.normal,a=Ie.MulSV(s*o,h,e);i[t].SelfSub(a),i[n].SelfAdd(a)}}}}SolvePowder(t){const e=Dn.SolvePowder_s_f,i=this.m_positionBuffer.data,s=this.m_velocityBuffer.data,r=this.m_def.powderStrength*this.GetCriticalVelocity(t),n=.25,o=this.GetParticleInvMass();for(let t=0;t<this.m_bodyContactBuffer.count;t++){const h=this.m_bodyContactBuffer.data[t],a=h.index;if(this.m_flagsBuffer.data[a]&tn.b2_powderParticle){const t=h.weight;if(t>n){const l=h.body,m=h.mass,c=i[a],u=h.normal,_=Ie.MulSV(r*m*(t-n),u,e);s[a].SelfMulSub(o,_),l.ApplyLinearImpulse(_,c,!0)}}}for(let t=0;t<this.m_contactBuffer.count;t++){const i=this.m_contactBuffer.data[t];if(i.flags&tn.b2_powderParticle){const t=i.weight;if(t>n){const o=i.indexA,h=i.indexB,a=i.normal,l=Ie.MulSV(r*(t-n),a,e);s[o].SelfSub(l),s[h].SelfAdd(l)}}}}SolveSolid(t){const e=Dn.SolveSolid_s_f,i=this.m_velocityBuffer.data;this.m_depthBuffer=this.RequestBuffer(this.m_depthBuffer);const s=t.inv_dt*this.m_def.ejectionStrength;for(let t=0;t<this.m_contactBuffer.count;t++){const r=this.m_contactBuffer.data[t],n=r.indexA,o=r.indexB;if(this.m_groupBuffer[n]!==this.m_groupBuffer[o]){const t=r.weight,h=r.normal,a=this.m_depthBuffer[n]+this.m_depthBuffer[o],l=Ie.MulSV(s*a*t,h,e);i[n].SelfSub(l),i[o].SelfAdd(l)}}}SolveForce(t){const e=this.m_velocityBuffer.data,i=t.dt*this.GetParticleInvMass();for(let t=0;t<this.m_count;t++)e[t].SelfMulAdd(i,this.m_forceBuffer[t]);this.m_hasForce=!1}SolveColorMixing(){const t=.5*this.m_def.colorMixingStrength;if(t)for(let e=0;e<this.m_contactBuffer.count;e++){const i=this.m_contactBuffer.data[e],s=i.indexA,r=i.indexB;if(this.m_flagsBuffer.data[s]&this.m_flagsBuffer.data[r]&tn.b2_colorMixingParticle){const e=this.m_colorBuffer.data[s],i=this.m_colorBuffer.data[r];ki.MixColors(e,i,t)}}}SolveZombie(){let t=0;const e=[];for(let t=0;t<this.m_count;t++)e[t]=ge;let i=0;for(let s=0;s<this.m_count;s++){const r=this.m_flagsBuffer.data[s];if(r&tn.b2_zombieParticle){const t=this.m_world.m_destructionListener;if(r&tn.b2_destructionListenerParticle&&t&&t.SayGoodbyeParticle(this,s),this.m_handleIndexBuffer.data){const t=this.m_handleIndexBuffer.data[s];t&&(t.SetIndex(ge),this.m_handleIndexBuffer.data[s]=null)}e[s]=ge}else{if(e[s]=t,s!==t){if(this.m_handleIndexBuffer.data){const e=this.m_handleIndexBuffer.data[s];e&&e.SetIndex(t),this.m_handleIndexBuffer.data[t]=e}this.m_flagsBuffer.data[t]=this.m_flagsBuffer.data[s],this.m_lastBodyContactStepBuffer.data&&(this.m_lastBodyContactStepBuffer.data[t]=this.m_lastBodyContactStepBuffer.data[s]),this.m_bodyContactCountBuffer.data&&(this.m_bodyContactCountBuffer.data[t]=this.m_bodyContactCountBuffer.data[s]),this.m_consecutiveContactStepsBuffer.data&&(this.m_consecutiveContactStepsBuffer.data[t]=this.m_consecutiveContactStepsBuffer.data[s]),this.m_positionBuffer.data[t].Copy(this.m_positionBuffer.data[s]),this.m_velocityBuffer.data[t].Copy(this.m_velocityBuffer.data[s]),this.m_groupBuffer[t]=this.m_groupBuffer[s],this.m_hasForce&&this.m_forceBuffer[t].Copy(this.m_forceBuffer[s]),this.m_staticPressureBuffer&&(this.m_staticPressureBuffer[t]=this.m_staticPressureBuffer[s]),this.m_depthBuffer&&(this.m_depthBuffer[t]=this.m_depthBuffer[s]),this.m_colorBuffer.data&&this.m_colorBuffer.data[t].Copy(this.m_colorBuffer.data[s]),this.m_userDataBuffer.data&&(this.m_userDataBuffer.data[t]=this.m_userDataBuffer.data[s]),this.m_expirationTimeBuffer.data&&(this.m_expirationTimeBuffer.data[t]=this.m_expirationTimeBuffer.data[s])}t++,i|=r}}for(let t=0;t<this.m_proxyBuffer.count;t++){const i=this.m_proxyBuffer.data[t];i.index=e[i.index]}this.m_proxyBuffer.RemoveIf((t=>t.index<0));for(let t=0;t<this.m_contactBuffer.count;t++){const i=this.m_contactBuffer.data[t];i.indexA=e[i.indexA],i.indexB=e[i.indexB]}this.m_contactBuffer.RemoveIf((t=>t.indexA<0||t.indexB<0));for(let t=0;t<this.m_bodyContactBuffer.count;t++){const i=this.m_bodyContactBuffer.data[t];i.index=e[i.index]}this.m_bodyContactBuffer.RemoveIf((t=>t.index<0));for(let t=0;t<this.m_pairBuffer.count;t++){const i=this.m_pairBuffer.data[t];i.indexA=e[i.indexA],i.indexB=e[i.indexB]}this.m_pairBuffer.RemoveIf((t=>t.indexA<0||t.indexB<0));for(let t=0;t<this.m_triadBuffer.count;t++){const i=this.m_triadBuffer.data[t];i.indexA=e[i.indexA],i.indexB=e[i.indexB],i.indexC=e[i.indexC]}if(this.m_triadBuffer.RemoveIf((t=>t.indexA<0||t.indexB<0||t.indexC<0)),this.m_indexByExpirationTimeBuffer.data){let t=0;for(let i=0;i<this.m_count;i++){const s=e[this.m_indexByExpirationTimeBuffer.data[i]];s!==ge&&(this.m_indexByExpirationTimeBuffer.data[t++]=s)}}for(let i=this.m_groupList;i;i=i.GetNext()){let s=t,r=0,n=!1;for(let t=i.m_firstIndex;t<i.m_lastIndex;t++){const i=e[t];i>=0?(s=be(s,i),r=Be(r,i+1)):n=!0}s<r?(i.m_firstIndex=s,i.m_lastIndex=r,n&&i.m_groupFlags&en.b2_solidParticleGroup&&this.SetGroupFlags(i,i.m_groupFlags|en.b2_particleGroupNeedsUpdateDepth)):(i.m_firstIndex=0,i.m_lastIndex=0,i.m_groupFlags&en.b2_particleGroupCanBeEmpty||this.SetGroupFlags(i,i.m_groupFlags|en.b2_particleGroupWillBeDestroyed))}this.m_count=t,this.m_allParticleFlags=i,this.m_needsUpdateAllParticleFlags=!1;for(let t=this.m_groupList;t;){const e=t.GetNext();t.m_groupFlags&en.b2_particleGroupWillBeDestroyed&&this.DestroyParticleGroup(t),t=e}}SolveLifetimes(t){this.m_timeElapsed=this.LifetimeToExpirationTime(t.dt);const e=this.GetQuantizedTimeElapsed(),i=this.m_expirationTimeBuffer.data,s=this.m_indexByExpirationTimeBuffer.data,r=this.GetParticleCount();if(this.m_expirationTimeBufferRequiresSorting){const t=(t,e)=>{const s=i[t],r=i[e],n=s<=0;return n===r<=0?s>r:n};fn(s,0,r,t),this.m_expirationTimeBufferRequiresSorting=!1}for(let t=r-1;t>=0;--t){const r=s[t],n=i[r];if(e<n||n<=0)break;this.DestroyParticle(r)}}RotateBuffer(t,e,i){if(t!==e&&e!==i){if(Cn(this.m_flagsBuffer.data,t,e,i),this.m_lastBodyContactStepBuffer.data&&Cn(this.m_lastBodyContactStepBuffer.data,t,e,i),this.m_bodyContactCountBuffer.data&&Cn(this.m_bodyContactCountBuffer.data,t,e,i),this.m_consecutiveContactStepsBuffer.data&&Cn(this.m_consecutiveContactStepsBuffer.data,t,e,i),Cn(this.m_positionBuffer.data,t,e,i),Cn(this.m_velocityBuffer.data,t,e,i),Cn(this.m_groupBuffer,t,e,i),this.m_hasForce&&Cn(this.m_forceBuffer,t,e,i),this.m_staticPressureBuffer&&Cn(this.m_staticPressureBuffer,t,e,i),this.m_depthBuffer&&Cn(this.m_depthBuffer,t,e,i),this.m_colorBuffer.data&&Cn(this.m_colorBuffer.data,t,e,i),this.m_userDataBuffer.data&&Cn(this.m_userDataBuffer.data,t,e,i),this.m_handleIndexBuffer.data){Cn(this.m_handleIndexBuffer.data,t,e,i);for(let e=t;e<i;++e){const t=this.m_handleIndexBuffer.data[e];t&&t.SetIndex(s(t.GetIndex()))}}if(this.m_expirationTimeBuffer.data){Cn(this.m_expirationTimeBuffer.data,t,e,i);const r=this.GetParticleCount(),n=this.m_indexByExpirationTimeBuffer.data;for(let t=0;t<r;++t)n[t]=s(n[t])}for(let t=0;t<this.m_proxyBuffer.count;t++){const e=this.m_proxyBuffer.data[t];e.index=s(e.index)}for(let t=0;t<this.m_contactBuffer.count;t++){const e=this.m_contactBuffer.data[t];e.indexA=s(e.indexA),e.indexB=s(e.indexB)}for(let t=0;t<this.m_bodyContactBuffer.count;t++){const e=this.m_bodyContactBuffer.data[t];e.index=s(e.index)}for(let t=0;t<this.m_pairBuffer.count;t++){const e=this.m_pairBuffer.data[t];e.indexA=s(e.indexA),e.indexB=s(e.indexB)}for(let t=0;t<this.m_triadBuffer.count;t++){const e=this.m_triadBuffer.data[t];e.indexA=s(e.indexA),e.indexB=s(e.indexB),e.indexC=s(e.indexC)}for(let t=this.m_groupList;t;t=t.GetNext())t.m_firstIndex=s(t.m_firstIndex),t.m_lastIndex=s(t.m_lastIndex-1)+1}function s(s){return s<t?s:s<e?s+i-e:s<i?s+t-e:s}}GetCriticalVelocity(t){return this.m_particleDiameter*t.inv_dt}GetCriticalVelocitySquared(t){const e=this.GetCriticalVelocity(t);return e*e}GetCriticalPressure(t){return this.m_def.density*this.GetCriticalVelocitySquared(t)}GetParticleStride(){return.75*this.m_particleDiameter}GetParticleMass(){const t=this.GetParticleStride();return this.m_def.density*t*t}GetParticleInvMass(){const t=1.3333333333333333*this.m_inverseDiameter;return this.m_inverseDensity*t*t}GetFixtureContactFilter(){return this.m_allParticleFlags&tn.b2_fixtureContactFilterParticle?this.m_world.m_contactManager.m_contactFilter:null}GetParticleContactFilter(){return this.m_allParticleFlags&tn.b2_particleContactFilterParticle?this.m_world.m_contactManager.m_contactFilter:null}GetFixtureContactListener(){return this.m_allParticleFlags&tn.b2_fixtureContactListenerParticle?this.m_world.m_contactManager.m_contactListener:null}GetParticleContactListener(){return this.m_allParticleFlags&tn.b2_particleContactListenerParticle?this.m_world.m_contactManager.m_contactListener:null}SetUserOverridableBuffer(t,e){t.data=e,t.userSuppliedCapacity=e.length}SetGroupFlags(t,e){const i=t.m_groupFlags;(i^e)&en.b2_solidParticleGroup&&(e|=en.b2_particleGroupNeedsUpdateDepth),i&~e&&(this.m_needsUpdateAllGroupFlags=!0),~this.m_allGroupFlags&e&&(e&en.b2_solidParticleGroup&&(this.m_depthBuffer=this.RequestBuffer(this.m_depthBuffer)),this.m_allGroupFlags|=e),t.m_groupFlags=e}static BodyContactCompare(t,e){return t.index===e.index?t.weight>e.weight:t.index<e.index}RemoveSpuriousBodyContacts(){fn(this.m_bodyContactBuffer.data,0,this.m_bodyContactBuffer.count,Dn.BodyContactCompare);const t=Dn.RemoveSpuriousBodyContacts_s_n,e=Dn.RemoveSpuriousBodyContacts_s_pos,i=Dn.RemoveSpuriousBodyContacts_s_normal,s=this;let r=-1,n=0;this.m_bodyContactBuffer.count=xn(this.m_bodyContactBuffer.data,(o=>{if(o.index!==r&&(n=0,r=o.index),n++>3)return!0;const h=t.Copy(o.normal);h.SelfMul(s.m_particleDiameter*(1-o.weight));const a=Ie.AddVV(s.m_positionBuffer.data[o.index],h,e);if(!o.fixture.TestPoint(a)){const t=o.fixture.GetShape().GetChildCount();for(let e=0;e<t;e++){const t=i;if(o.fixture.ComputeDistance(a,t,e)<de)return!1}return!0}return!1}),this.m_bodyContactBuffer.count)}DetectStuckParticle(t){this.m_stuckThreshold<=0||(++this.m_bodyContactCountBuffer.data[t],2===this.m_bodyContactCountBuffer.data[t]&&(++this.m_consecutiveContactStepsBuffer.data[t],this.m_consecutiveContactStepsBuffer.data[t]>this.m_stuckThreshold&&(this.m_stuckParticleBuffer.data[this.m_stuckParticleBuffer.Append()]=t)),this.m_lastBodyContactStepBuffer.data[t]=this.m_timestamp)}ValidateParticleIndex(t){return t>=0&&t<this.GetParticleCount()&&t!==ge}GetQuantizedTimeElapsed(){return Math.floor(this.m_timeElapsed/4294967296)}LifetimeToExpirationTime(t){return this.m_timeElapsed+Math.floor(t/this.m_def.lifetimeGranularity*4294967296)}ForceCanBeApplied(t){return!(t&tn.b2_wallParticle)}PrepareForceBuffer(){if(!this.m_hasForce){for(let t=0;t<this.m_count;t++)this.m_forceBuffer[t].SetZero();this.m_hasForce=!0}}IsRigidGroup(t){return null!==t&&0!=(t.m_groupFlags&en.b2_rigidParticleGroup)}GetLinearVelocity(t,e,i,s){return t&&this.IsRigidGroup(t)?t.GetLinearVelocityFromWorldPoint(i,s):s.Copy(this.m_velocityBuffer.data[e])}InitDampingParameter(t,e,i,s,r,n,o,h){t[0]=s>0?1/s:0,e[0]=r>0?1/r:0,i[0]=Ie.CrossVV(Ie.SubVV(o,n,Ie.s_t0),h)}InitDampingParameterWithRigidGroupOrParticle(t,e,i,s,r,n,o,h){if(r&&s)this.InitDampingParameter(t,e,i,r.GetMass(),r.GetInertia(),r.GetCenter(),o,h);else{const s=this.m_flagsBuffer.data[n];this.InitDampingParameter(t,e,i,s&tn.b2_wallParticle?0:this.GetParticleMass(),0,o,o,h)}}ComputeDampingImpulse(t,e,i,s,r,n,o){const h=t+e*i*i+s+r*n*n;return h>0?o/h:0}ApplyDamping(t,e,i,s,r,n,o,h){r&&s?(r.m_linearVelocity.SelfMulAdd(o*t,h),r.m_angularVelocity+=o*i*e):this.m_velocityBuffer.data[n].SelfMulAdd(o*t,h)}}Dn.xTruncBits=12,Dn.yTruncBits=12,Dn.tagBits=32,Dn.yOffset=1<<Dn.yTruncBits-1,Dn.yShift=Dn.tagBits-Dn.yTruncBits,Dn.xShift=Dn.tagBits-Dn.yTruncBits-Dn.xTruncBits,Dn.xScale=1<<Dn.xShift,Dn.xOffset=Dn.xScale*(1<<Dn.xTruncBits-1),Dn.yMask=(1<<Dn.yTruncBits)-1<<Dn.yShift,Dn.xMask=~Dn.yMask,Dn.DestroyParticlesInShape_s_aabb=new pi,Dn.CreateParticleGroup_s_transform=new ke,Dn.ComputeCollisionEnergy_s_v=new Ie,Dn.QueryShapeAABB_s_aabb=new pi,Dn.QueryPointAABB_s_aabb=new pi,Dn.RayCast_s_aabb=new pi,Dn.RayCast_s_p=new Ie,Dn.RayCast_s_v=new Ie,Dn.RayCast_s_n=new Ie,Dn.RayCast_s_point=new Ie,Dn.k_pairFlags=tn.b2_springParticle,Dn.k_triadFlags=tn.b2_elasticParticle,Dn.k_noPressureFlags=tn.b2_powderParticle|tn.b2_tensileParticle,Dn.k_extraDampingFlags=tn.b2_staticPressureParticle,Dn.k_barrierWallFlags=tn.b2_barrierParticle|tn.b2_wallParticle,Dn.CreateParticlesStrokeShapeForGroup_s_edge=new Lr,Dn.CreateParticlesStrokeShapeForGroup_s_d=new Ie,Dn.CreateParticlesStrokeShapeForGroup_s_p=new Ie,Dn.CreateParticlesFillShapeForGroup_s_aabb=new pi,Dn.CreateParticlesFillShapeForGroup_s_p=new Ie,Dn.UpdatePairsAndTriads_s_dab=new Ie,Dn.UpdatePairsAndTriads_s_dbc=new Ie,Dn.UpdatePairsAndTriads_s_dca=new Ie,Dn.AddContact_s_d=new Ie,Dn.UpdateBodyContacts_s_aabb=new pi,Dn.Solve_s_subStep=new Xr,Dn.SolveCollision_s_aabb=new pi,Dn.SolveGravity_s_gravity=new Ie,Dn.SolveBarrier_s_aabb=new pi,Dn.SolveBarrier_s_va=new Ie,Dn.SolveBarrier_s_vb=new Ie,Dn.SolveBarrier_s_pba=new Ie,Dn.SolveBarrier_s_vba=new Ie,Dn.SolveBarrier_s_vc=new Ie,Dn.SolveBarrier_s_pca=new Ie,Dn.SolveBarrier_s_vca=new Ie,Dn.SolveBarrier_s_qba=new Ie,Dn.SolveBarrier_s_qca=new Ie,Dn.SolveBarrier_s_dv=new Ie,Dn.SolveBarrier_s_f=new Ie,Dn.SolvePressure_s_f=new Ie,Dn.SolveDamping_s_v=new Ie,Dn.SolveDamping_s_f=new Ie,Dn.SolveRigidDamping_s_t0=new Ie,Dn.SolveRigidDamping_s_t1=new Ie,Dn.SolveRigidDamping_s_p=new Ie,Dn.SolveRigidDamping_s_v=new Ie,Dn.SolveExtraDamping_s_v=new Ie,Dn.SolveExtraDamping_s_f=new Ie,Dn.SolveRigid_s_position=new Ie,Dn.SolveRigid_s_rotation=new Fe,Dn.SolveRigid_s_transform=new ke,Dn.SolveRigid_s_velocityTransform=new ke,Dn.SolveElastic_s_pa=new Ie,Dn.SolveElastic_s_pb=new Ie,Dn.SolveElastic_s_pc=new Ie,Dn.SolveElastic_s_r=new Fe,Dn.SolveElastic_s_t0=new Ie,Dn.SolveSpring_s_pa=new Ie,Dn.SolveSpring_s_pb=new Ie,Dn.SolveSpring_s_d=new Ie,Dn.SolveSpring_s_f=new Ie,Dn.SolveTensile_s_weightedNormal=new Ie,Dn.SolveTensile_s_s=new Ie,Dn.SolveTensile_s_f=new Ie,Dn.SolveViscous_s_v=new Ie,Dn.SolveViscous_s_f=new Ie,Dn.SolveRepulsive_s_f=new Ie,Dn.SolvePowder_s_f=new Ie,Dn.SolveSolid_s_f=new Ie,Dn.RemoveSpuriousBodyContacts_s_n=new Ie,Dn.RemoveSpuriousBodyContacts_s_pos=new Ie,Dn.RemoveSpuriousBodyContacts_s_normal=new Ie;class In{constructor(){this._data=null,this.userSuppliedCapacity=0}get data(){return this._data}set data(t){this._data=t}}class Pn{constructor(){this.index=ge,this.tag=0}static CompareProxyProxy(t,e){return t.tag<e.tag}static CompareTagProxy(t,e){return t<e.tag}static CompareProxyTag(t,e){return t.tag<e}}class Gn{constructor(t,e,i,s,r){this.m_system=t,this.m_xLower=(e&Dn.xMask)>>>0,this.m_xUpper=(i&Dn.xMask)>>>0,this.m_yLower=(e&Dn.yMask)>>>0,this.m_yUpper=(i&Dn.yMask)>>>0,this.m_first=s,this.m_last=r}GetNext(){for(;this.m_first<this.m_last;){const t=(this.m_system.m_proxyBuffer.data[this.m_first].tag&Dn.xMask)>>>0;if(t>=this.m_xLower&&t<=this.m_xUpper)return this.m_system.m_proxyBuffer.data[this.m_first++].index;this.m_first++}return ge}}class Tn{constructor(){this.next=null,this.count=0,this.index=0}}class Rn{Allocate(t,e){return e}Clear(){}GetCount(){return 0}Invalidate(t){}GetValidBuffer(){return[]}GetBuffer(){return[]}SetCount(t){}}class Fn extends Rn{Initialize(t,e){}Find(t){return ge}}class kn extends Rn{Initialize(t,e){}Find(t){return ge}}class En{IsNecessary(t){return!0}ShouldCreatePair(t,e){return!0}ShouldCreateTriad(t,e,i){return!0}}class Ln extends Gi{constructor(t,e,i,s){super(),this.m_callDestructionListener=!1,this.m_destroyed=0,this.m_system=t,this.m_shape=e,this.m_xf=i,this.m_callDestructionListener=s,this.m_destroyed=0}ReportFixture(t){return!1}ReportParticle(t,e){return t===this.m_system&&(this.m_shape.TestPoint(this.m_xf,this.m_system.m_positionBuffer.data[e])&&(this.m_system.DestroyParticle(e,this.m_callDestructionListener),this.m_destroyed++),!0)}Destroyed(){return this.m_destroyed}}class On extends En{constructor(t){super(),this.m_threshold=0,this.m_threshold=t}ShouldCreatePair(t,e){return t<this.m_threshold&&this.m_threshold<=e||e<this.m_threshold&&this.m_threshold<=t}ShouldCreateTriad(t,e,i){return(t<this.m_threshold||e<this.m_threshold||i<this.m_threshold)&&(this.m_threshold<=t||this.m_threshold<=e||this.m_threshold<=i)}}class zn extends je{constructor(t,e=t.length){super(Oe.e_unknown,0),this.m_shapeCount=0,this.m_shapes=t,this.m_shapeCount=e}Clone(){throw new Error}GetChildCount(){return 1}TestPoint(t,e){for(let i=0;i<this.m_shapeCount;i++)if(this.m_shapes[i].TestPoint(t,e))return!0;return!1}ComputeDistance(t,e,i,s){return 0}RayCast(t,e,i,s){return!1}ComputeAABB(t,e,i){const s=new pi;t.lowerBound.x=+ce,t.lowerBound.y=+ce,t.upperBound.x=-ce,t.upperBound.y=-ce;for(let i=0;i<this.m_shapeCount;i++){const r=this.m_shapes[i].GetChildCount();for(let n=0;n<r;n++){const r=s;this.m_shapes[i].ComputeAABB(r,e,n),t.Combine1(r)}}}ComputeMass(t,e){}SetupDistanceProxy(t,e){}ComputeSubmergedArea(t,e,i,s){return 0}Dump(t){}}class jn extends En{constructor(t){super(),this.m_flagsBuffer=t}IsNecessary(t){return 0!=(this.m_flagsBuffer.data[t]&tn.b2_reactiveParticle)}}class qn extends Sn{constructor(t,e=null){super(t),this.m_contactFilter=null,this.m_contactFilter=e}ShouldCollideFixtureParticle(t,e,i){return!(this.m_contactFilter&&this.m_system.GetFlagsBuffer()[i]&tn.b2_fixtureContactFilterParticle)||this.m_contactFilter.ShouldCollideFixtureParticle(t,this.m_system,i)}ReportFixtureAndParticle(t,e,i){const s=qn.ReportFixtureAndParticle_s_n,r=qn.ReportFixtureAndParticle_s_rp,n=this.m_system.m_positionBuffer.data[i],o=s,h=t.ComputeDistance(n,o,e);if(h<this.m_system.m_particleDiameter&&this.ShouldCollideFixtureParticle(t,this.m_system,i)){const e=t.GetBody(),s=e.GetWorldCenter(),a=e.GetMass(),l=e.GetInertia()-a*e.GetLocalCenter().LengthSquared(),m=a>0?1/a:0,c=l>0?1/l:0,u=this.m_system.m_flagsBuffer.data[i]&tn.b2_wallParticle?0:this.m_system.GetParticleInvMass(),_=Ie.SubVV(n,s,r),d=Ie.CrossVV(_,o),p=u+m+c*d*d,f=this.m_system.m_bodyContactBuffer.data[this.m_system.m_bodyContactBuffer.Append()];f.index=i,f.body=e,f.fixture=t,f.weight=1-h*this.m_system.m_inverseDiameter,f.normal.Copy(o.SelfNeg()),f.mass=p>0?1/p:0,this.m_system.DetectStuckParticle(i)}}}qn.ReportFixtureAndParticle_s_n=new Ie,qn.ReportFixtureAndParticle_s_rp=new Ie;class Nn extends Sn{constructor(t,e){super(t),this.m_step=e}ReportFixtureAndParticle(t,e,i){const s=Nn.ReportFixtureAndParticle_s_p1,r=Nn.ReportFixtureAndParticle_s_output,n=Nn.ReportFixtureAndParticle_s_input,o=Nn.ReportFixtureAndParticle_s_p,h=Nn.ReportFixtureAndParticle_s_v,a=Nn.ReportFixtureAndParticle_s_f,l=t.GetBody(),m=this.m_system.m_positionBuffer.data[i],c=this.m_system.m_velocityBuffer.data[i],u=r,_=n;if(0===this.m_system.m_iterationIndex){const e=ke.MulTXV(l.m_xf0,m,s);t.GetShape().GetType()===Oe.e_circleShape&&(e.SelfSub(l.GetLocalCenter()),Fe.MulRV(l.m_xf0.q,e,e),Fe.MulTRV(l.m_xf.q,e,e),e.SelfAdd(l.GetLocalCenter())),ke.MulXV(l.m_xf,e,_.p1)}else _.p1.Copy(m);if(Ie.AddVMulSV(m,this.m_step.dt,c,_.p2),_.maxFraction=1,t.RayCast(u,_,e)){const t=u.normal,e=o;e.x=(1-u.fraction)*_.p1.x+u.fraction*_.p2.x+de*t.x,e.y=(1-u.fraction)*_.p1.y+u.fraction*_.p2.y+de*t.y;const s=h;s.x=this.m_step.inv_dt*(e.x-m.x),s.y=this.m_step.inv_dt*(e.y-m.y),this.m_system.m_velocityBuffer.data[i].Copy(s);const r=a;r.x=this.m_step.inv_dt*this.m_system.GetParticleMass()*(c.x-s.x),r.y=this.m_step.inv_dt*this.m_system.GetParticleMass()*(c.y-s.y),this.m_system.ParticleApplyForce(i,r)}}ReportParticle(t,e){return!1}}Nn.ReportFixtureAndParticle_s_p1=new Ie,Nn.ReportFixtureAndParticle_s_output=new di,Nn.ReportFixtureAndParticle_s_input=new _i,Nn.ReportFixtureAndParticle_s_p=new Ie,Nn.ReportFixtureAndParticle_s_v=new Ie,Nn.ReportFixtureAndParticle_s_f=new Ie;class Wn{constructor(t){this.m_contactManager=new Nr,this.m_bodyList=null,this.m_jointList=null,this.m_particleSystemList=null,this.m_bodyCount=0,this.m_jointCount=0,this.m_gravity=new Ie,this.m_allowSleep=!0,this.m_destructionListener=null,this.m_debugDraw=null,this.m_inv_dt0=0,this.m_newContacts=!1,this.m_locked=!1,this.m_clearForces=!0,this.m_warmStarting=!0,this.m_continuousPhysics=!0,this.m_subStepping=!1,this.m_stepComplete=!0,this.m_profile=new Wr,this.m_island=new $r,this.s_stack=[],this.m_controllerList=null,this.m_controllerCount=0,this.m_gravity.Copy(t)}SetDestructionListener(t){this.m_destructionListener=t}SetContactFilter(t){this.m_contactManager.m_contactFilter=t}SetContactListener(t){this.m_contactManager.m_contactListener=t}SetDebugDraw(t){this.m_debugDraw=t}CreateBody(t={}){if(this.IsLocked())throw new Error;const e=new Di(t,this);return e.m_prev=null,e.m_next=this.m_bodyList,this.m_bodyList&&(this.m_bodyList.m_prev=e),this.m_bodyList=e,++this.m_bodyCount,e}DestroyBody(t){if(this.IsLocked())throw new Error;let e=t.m_jointList;for(;e;){const i=e;e=e.next,this.m_destructionListener&&this.m_destructionListener.SayGoodbyeJoint(i.joint),this.DestroyJoint(i.joint),t.m_jointList=e}t.m_jointList=null;let i=t.m_controllerList;for(;i;){const e=i;i=i.nextController,e.controller.RemoveBody(t)}let s=t.m_contactList;for(;s;){const t=s;s=s.next,this.m_contactManager.Destroy(t.contact)}t.m_contactList=null;let r=t.m_fixtureList;for(;r;){const e=r;r=r.m_next,this.m_destructionListener&&this.m_destructionListener.SayGoodbyeFixture(e),e.DestroyProxies(),e.Reset(),t.m_fixtureList=r,t.m_fixtureCount-=1}t.m_fixtureList=null,t.m_fixtureCount=0,t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t===this.m_bodyList&&(this.m_bodyList=t.m_next),--this.m_bodyCount}static _Joint_Create(t){switch(t.type){case ls.e_distanceJoint:return new _s(t);case ls.e_mouseJoint:return new xs(t);case ls.e_prismaticJoint:return new gs(t);case ls.e_revoluteJoint:return new Cs(t);case ls.e_pulleyJoint:return new ws(t);case ls.e_gearJoint:return new fs(t);case ls.e_wheelJoint:return new Ss(t);case ls.e_weldJoint:return new vs(t);case ls.e_frictionJoint:return new ps(t);case ls.e_motorJoint:return new ys(t);case ls.e_areaJoint:return new ds(t)}throw new Error}static _Joint_Destroy(t){}CreateJoint(t){if(this.IsLocked())throw new Error;const e=Wn._Joint_Create(t);e.m_prev=null,e.m_next=this.m_jointList,this.m_jointList&&(this.m_jointList.m_prev=e),this.m_jointList=e,++this.m_jointCount,e.m_edgeA.prev=null,e.m_edgeA.next=e.m_bodyA.m_jointList,e.m_bodyA.m_jointList&&(e.m_bodyA.m_jointList.prev=e.m_edgeA),e.m_bodyA.m_jointList=e.m_edgeA,e.m_edgeB.prev=null,e.m_edgeB.next=e.m_bodyB.m_jointList,e.m_bodyB.m_jointList&&(e.m_bodyB.m_jointList.prev=e.m_edgeB),e.m_bodyB.m_jointList=e.m_edgeB;const i=e.m_bodyA,s=e.m_bodyB;if(!e.m_collideConnected){let t=s.GetContactList();for(;t;)t.other===i&&t.contact.FlagForFiltering(),t=t.next}return e}DestroyJoint(t){if(this.IsLocked())throw new Error;t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t===this.m_jointList&&(this.m_jointList=t.m_next);const e=t.m_bodyA,i=t.m_bodyB,s=t.m_collideConnected;if(e.SetAwake(!0),i.SetAwake(!0),t.m_edgeA.prev&&(t.m_edgeA.prev.next=t.m_edgeA.next),t.m_edgeA.next&&(t.m_edgeA.next.prev=t.m_edgeA.prev),t.m_edgeA===e.m_jointList&&(e.m_jointList=t.m_edgeA.next),t.m_edgeA.Reset(),t.m_edgeB.prev&&(t.m_edgeB.prev.next=t.m_edgeB.next),t.m_edgeB.next&&(t.m_edgeB.next.prev=t.m_edgeB.prev),t.m_edgeB===i.m_jointList&&(i.m_jointList=t.m_edgeB.next),t.m_edgeB.Reset(),Wn._Joint_Destroy(t),--this.m_jointCount,!s){let t=i.GetContactList();for(;t;)t.other===e&&t.contact.FlagForFiltering(),t=t.next}}CreateParticleSystem(t){if(this.IsLocked())throw new Error;const e=new Dn(t,this);return e.m_prev=null,e.m_next=this.m_particleSystemList,this.m_particleSystemList&&(this.m_particleSystemList.m_prev=e),this.m_particleSystemList=e,e}DestroyParticleSystem(t){if(this.IsLocked())throw new Error;t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),t===this.m_particleSystemList&&(this.m_particleSystemList=t.m_next)}CalculateReasonableParticleIterations(t){return null===this.m_particleSystemList?1:function(t,e,i){return Ae(Math.ceil(Math.sqrt(t/(.01*e))*i),1,8)}(this.m_gravity.Length(),function(t){let e=ce;for(let i=t.GetParticleSystemList();null!==i;i=i.m_next)e=be(e,i.GetRadius());return e}(this),t)}Step(t,e,i,s=this.CalculateReasonableParticleIterations(t)){const r=Wn.Step_s_stepTimer.Reset();this.m_newContacts&&(this.m_contactManager.FindNewContacts(),this.m_newContacts=!1),this.m_locked=!0;const n=Wn.Step_s_step;n.dt=t,n.velocityIterations=e,n.positionIterations=i,n.particleIterations=s,n.inv_dt=t>0?1/t:0,n.dtRatio=this.m_inv_dt0*t,n.warmStarting=this.m_warmStarting;const o=Wn.Step_s_timer.Reset();if(this.m_contactManager.Collide(),this.m_profile.collide=o.GetMilliseconds(),this.m_stepComplete&&n.dt>0){const t=Wn.Step_s_timer.Reset();for(let t=this.m_particleSystemList;t;t=t.m_next)t.Solve(n);this.Solve(n),this.m_profile.solve=t.GetMilliseconds()}if(this.m_continuousPhysics&&n.dt>0){const t=Wn.Step_s_timer.Reset();this.SolveTOI(n),this.m_profile.solveTOI=t.GetMilliseconds()}n.dt>0&&(this.m_inv_dt0=n.inv_dt),this.m_clearForces&&this.ClearForces(),this.m_locked=!1,this.m_profile.step=r.GetMilliseconds()}ClearForces(){for(let t=this.m_bodyList;t;t=t.m_next)t.m_force.SetZero(),t.m_torque=0}DrawParticleSystem(t){if(null===this.m_debugDraw)return;const e=t.GetParticleCount();if(e){const i=t.GetRadius(),s=t.GetPositionBuffer();if(t.m_colorBuffer.data){const r=t.GetColorBuffer();this.m_debugDraw.DrawParticles(s,i,r,e)}else this.m_debugDraw.DrawParticles(s,i,null,e)}}DebugDraw(){if(null===this.m_debugDraw)return;const t=this.m_debugDraw.GetFlags(),e=Wn.DebugDraw_s_color.SetRGB(0,0,0);if(t&Vi.e_shapeBit)for(let t=this.m_bodyList;t;t=t.m_next){const i=t.m_xf;this.m_debugDraw.PushTransform(i);for(let i=t.GetFixtureList();i;i=i.m_next)t.GetType()===Ai.b2_dynamicBody&&0===t.m_mass?this.DrawShape(i,new ki(1,0,0)):t.IsEnabled()?t.GetType()===Ai.b2_staticBody?(e.SetRGB(.5,.9,.5),this.DrawShape(i,e)):t.GetType()===Ai.b2_kinematicBody?(e.SetRGB(.5,.5,.9),this.DrawShape(i,e)):t.IsAwake()?(e.SetRGB(.9,.7,.7),this.DrawShape(i,e)):(e.SetRGB(.6,.6,.6),this.DrawShape(i,e)):(e.SetRGB(.5,.5,.3),this.DrawShape(i,e));this.m_debugDraw.PopTransform(i)}if(t&Vi.e_particleBit)for(let t=this.m_particleSystemList;t;t=t.m_next)this.DrawParticleSystem(t);if(t&Vi.e_jointBit)for(let t=this.m_jointList;t;t=t.m_next)t.Draw(this.m_debugDraw);if(t&Vi.e_pairBit){e.SetRGB(.3,.9,.9);for(let t=this.m_contactManager.m_contactList;t;t=t.m_next){const i=t.GetFixtureA(),s=t.GetFixtureB(),r=t.GetChildIndexA(),n=t.GetChildIndexB(),o=i.GetAABB(r).GetCenter(),h=s.GetAABB(n).GetCenter();this.m_debugDraw.DrawSegment(o,h,e)}}if(t&Vi.e_aabbBit){e.SetRGB(.9,.3,.9);const t=Wn.DebugDraw_s_vs;for(let i=this.m_bodyList;i;i=i.m_next)if(i.IsEnabled())for(let s=i.GetFixtureList();s;s=s.m_next)for(let i=0;i<s.m_proxyCount;++i){const r=s.m_proxies[i].treeNode.aabb;t[0].Set(r.lowerBound.x,r.lowerBound.y),t[1].Set(r.upperBound.x,r.lowerBound.y),t[2].Set(r.upperBound.x,r.upperBound.y),t[3].Set(r.lowerBound.x,r.upperBound.y),this.m_debugDraw.DrawPolygon(t,4,e)}}if(t&Vi.e_centerOfMassBit)for(let t=this.m_bodyList;t;t=t.m_next){const e=Wn.DebugDraw_s_xf;e.q.Copy(t.m_xf.q),e.p.Copy(t.GetWorldCenter()),this.m_debugDraw.DrawTransform(e)}if(t&Vi.e_controllerBit)for(let t=this.m_controllerList;t;t=t.m_next)t.Draw(this.m_debugDraw)}QueryAABB(...t){t[0]instanceof Gi?this._QueryAABB(t[0],t[1]):this._QueryAABB(null,t[0],t[1])}_QueryAABB(t,e,i){if(this.m_contactManager.m_broadPhase.Query(e,(e=>{const s=e.userData.fixture;return t?t.ReportFixture(s):!i||i(s)})),t instanceof Gi)for(let i=this.m_particleSystemList;i;i=i.m_next)t.ShouldQueryParticleSystem(i)&&i.QueryAABB(t,e)}QueryAllAABB(t,e=[]){return this.QueryAABB(t,(t=>(e.push(t),!0))),e}QueryPointAABB(...t){t[0]instanceof Gi?this._QueryPointAABB(t[0],t[1]):this._QueryPointAABB(null,t[0],t[1])}_QueryPointAABB(t,e,i){if(this.m_contactManager.m_broadPhase.QueryPoint(e,(e=>{const s=e.userData.fixture;return t?t.ReportFixture(s):!i||i(s)})),t instanceof Gi)for(let i=this.m_particleSystemList;i;i=i.m_next)t.ShouldQueryParticleSystem(i)&&i.QueryPointAABB(t,e)}QueryAllPointAABB(t,e=[]){return this.QueryPointAABB(t,(t=>(e.push(t),!0))),e}QueryFixtureShape(...t){t[0]instanceof Gi?this._QueryFixtureShape(t[0],t[1],t[2],t[3]):this._QueryFixtureShape(null,t[0],t[1],t[2],t[3])}_QueryFixtureShape(t,e,i,s,r){const n=Wn.QueryFixtureShape_s_aabb;if(e.ComputeAABB(n,s,i),this.m_contactManager.m_broadPhase.Query(n,(n=>{const o=n.userData,h=o.fixture;if(Ci(e,i,h.GetShape(),o.childIndex,s,h.GetBody().GetTransform())){if(t)return t.ReportFixture(h);if(r)return r(h)}return!0})),t instanceof Gi)for(let e=this.m_particleSystemList;e;e=e.m_next)t.ShouldQueryParticleSystem(e)&&e.QueryAABB(t,n)}QueryAllFixtureShape(t,e,i,s=[]){return this.QueryFixtureShape(t,e,i,(t=>(s.push(t),!0))),s}QueryFixturePoint(...t){t[0]instanceof Gi?this._QueryFixturePoint(t[0],t[1]):this._QueryFixturePoint(null,t[0],t[1])}_QueryFixturePoint(t,e,i){if(this.m_contactManager.m_broadPhase.QueryPoint(e,(s=>{const r=s.userData.fixture;if(r.TestPoint(e)){if(t)return t.ReportFixture(r);if(i)return i(r)}return!0})),t)for(let i=this.m_particleSystemList;i;i=i.m_next)t.ShouldQueryParticleSystem(i)&&i.QueryPointAABB(t,e)}QueryAllFixturePoint(t,e=[]){return this.QueryFixturePoint(t,(t=>(e.push(t),!0))),e}RayCast(...t){t[0]instanceof Ti?this._RayCast(t[0],t[1],t[2]):this._RayCast(null,t[0],t[1],t[2])}_RayCast(t,e,i,s){const r=Wn.RayCast_s_input;if(r.maxFraction=1,r.p1.Copy(e),r.p2.Copy(i),this.m_contactManager.m_broadPhase.RayCast(r,((r,n)=>{const o=n.userData,h=o.fixture,a=o.childIndex,l=Wn.RayCast_s_output;if(h.RayCast(l,r,a)){const r=l.fraction,n=Wn.RayCast_s_point;if(n.Set((1-r)*e.x+r*i.x,(1-r)*e.y+r*i.y),t)return t.ReportFixture(h,n,l.normal,r);if(s)return s(h,n,l.normal,r)}return r.maxFraction})),t)for(let s=this.m_particleSystemList;s;s=s.m_next)t.ShouldQueryParticleSystem(s)&&s.RayCast(t,e,i)}RayCastOne(t,e){let i=null,s=1;return this.RayCast(t,e,((t,e,r,n)=>(n<s&&(s=n,i=t),s))),i}RayCastAll(t,e,i=[]){return this.RayCast(t,e,((t,e,s,r)=>(i.push(t),1))),i}GetBodyList(){return this.m_bodyList}GetJointList(){return this.m_jointList}GetParticleSystemList(){return this.m_particleSystemList}GetContactList(){return this.m_contactManager.m_contactList}SetAllowSleeping(t){if(t!==this.m_allowSleep&&(this.m_allowSleep=t,!this.m_allowSleep))for(let t=this.m_bodyList;t;t=t.m_next)t.SetAwake(!0)}GetAllowSleeping(){return this.m_allowSleep}SetWarmStarting(t){this.m_warmStarting=t}GetWarmStarting(){return this.m_warmStarting}SetContinuousPhysics(t){this.m_continuousPhysics=t}GetContinuousPhysics(){return this.m_continuousPhysics}SetSubStepping(t){this.m_subStepping=t}GetSubStepping(){return this.m_subStepping}GetProxyCount(){return this.m_contactManager.m_broadPhase.GetProxyCount()}GetBodyCount(){return this.m_bodyCount}GetJointCount(){return this.m_jointCount}GetContactCount(){return this.m_contactManager.m_contactCount}GetTreeHeight(){return this.m_contactManager.m_broadPhase.GetTreeHeight()}GetTreeBalance(){return this.m_contactManager.m_broadPhase.GetTreeBalance()}GetTreeQuality(){return this.m_contactManager.m_broadPhase.GetTreeQuality()}SetGravity(t,e=!0){if(!Ie.IsEqualToV(this.m_gravity,t)&&(this.m_gravity.Copy(t),e))for(let t=this.m_bodyList;t;t=t.m_next)t.SetAwake(!0)}GetGravity(){return this.m_gravity}IsLocked(){return this.m_locked}SetAutoClearForces(t){this.m_clearForces=t}GetAutoClearForces(){return this.m_clearForces}ShiftOrigin(t){if(this.IsLocked())throw new Error;for(let e=this.m_bodyList;e;e=e.m_next)e.m_xf.p.SelfSub(t),e.m_sweep.c0.SelfSub(t),e.m_sweep.c.SelfSub(t);for(let e=this.m_jointList;e;e=e.m_next)e.ShiftOrigin(t);this.m_contactManager.m_broadPhase.ShiftOrigin(t)}GetContactManager(){return this.m_contactManager}GetProfile(){return this.m_profile}Dump(t){if(this.m_locked)return;t("const g: b2Vec2 = new b2Vec2(%.15f, %.15f);\n",this.m_gravity.x,this.m_gravity.y),t("this.m_world.SetGravity(g);\n"),t("const bodies: b2Body[] = [];\n"),t("const joints: b2Joint[] = [];\n");let e=0;for(let i=this.m_bodyList;i;i=i.m_next)i.m_islandIndex=e,i.Dump(t),++e;e=0;for(let t=this.m_jointList;t;t=t.m_next)t.m_index=e,++e;for(let e=this.m_jointList;e;e=e.m_next)e.m_type!==ls.e_gearJoint&&(t("{\n"),e.Dump(t),t("}\n"));for(let e=this.m_jointList;e;e=e.m_next)e.m_type===ls.e_gearJoint&&(t("{\n"),e.Dump(t),t("}\n"))}DrawShape(t,e){if(null===this.m_debugDraw)return;const i=t.GetShape();switch(i.m_type){case Oe.e_circleShape:{const t=i,s=t.m_p,r=t.m_radius,n=Ie.UNITX;this.m_debugDraw.DrawSolidCircle(s,r,n,e);break}case Oe.e_edgeShape:{const t=i,s=t.m_vertex1,r=t.m_vertex2;this.m_debugDraw.DrawSegment(s,r,e),!1===t.m_oneSided&&(this.m_debugDraw.DrawPoint(s,4,e),this.m_debugDraw.DrawPoint(r,4,e));break}case Oe.e_chainShape:{const t=i,s=t.m_count,r=t.m_vertices;let n=r[0];for(let t=1;t<s;++t){const i=r[t];this.m_debugDraw.DrawSegment(n,i,e),n=i}break}case Oe.e_polygonShape:{const t=i,s=t.m_count,r=t.m_vertices;this.m_debugDraw.DrawSolidPolygon(r,s,e);break}}}Solve(t){for(let t=this.m_bodyList;t;t=t.m_next)t.m_xf0.Copy(t.m_xf);for(let e=this.m_controllerList;e;e=e.m_next)e.Step(t);this.m_profile.solveInit=0,this.m_profile.solveVelocity=0,this.m_profile.solvePosition=0;const e=this.m_island;e.Initialize(this.m_bodyCount,this.m_contactManager.m_contactCount,this.m_jointCount,this.m_contactManager.m_contactListener);for(let t=this.m_bodyList;t;t=t.m_next)t.m_islandFlag=!1;for(let t=this.m_contactManager.m_contactList;t;t=t.m_next)t.m_islandFlag=!1;for(let t=this.m_jointList;t;t=t.m_next)t.m_islandFlag=!1;const i=this.s_stack;for(let s=this.m_bodyList;s;s=s.m_next){if(s.m_islandFlag)continue;if(!s.IsAwake()||!s.IsEnabled())continue;if(s.GetType()===Ai.b2_staticBody)continue;e.Clear();let r=0;for(i[r++]=s,s.m_islandFlag=!0;r>0;){const t=i[--r];if(!t)throw new Error;if(e.AddBody(t),t.GetType()!==Ai.b2_staticBody){t.m_awakeFlag=!0;for(let s=t.m_contactList;s;s=s.next){const t=s.contact;if(t.m_islandFlag)continue;if(!t.IsEnabled()||!t.IsTouching())continue;const n=t.m_fixtureA.m_isSensor,o=t.m_fixtureB.m_isSensor;if(n||o)continue;e.AddContact(t),t.m_islandFlag=!0;const h=s.other;h.m_islandFlag||(i[r++]=h,h.m_islandFlag=!0)}for(let s=t.m_jointList;s;s=s.next){if(s.joint.m_islandFlag)continue;const t=s.other;t.IsEnabled()&&(e.AddJoint(s.joint),s.joint.m_islandFlag=!0,t.m_islandFlag||(i[r++]=t,t.m_islandFlag=!0))}}}const n=new Wr;e.Solve(n,t,this.m_gravity,this.m_allowSleep),this.m_profile.solveInit+=n.solveInit,this.m_profile.solveVelocity+=n.solveVelocity,this.m_profile.solvePosition+=n.solvePosition;for(let t=0;t<e.m_bodyCount;++t){const i=e.m_bodies[t];i.GetType()===Ai.b2_staticBody&&(i.m_islandFlag=!1)}}for(let t=0;t<i.length&&i[t];++t)i[t]=null;const s=new Fi;for(let t=this.m_bodyList;t;t=t.m_next)t.m_islandFlag&&t.GetType()!==Ai.b2_staticBody&&t.SynchronizeFixtures();this.m_contactManager.FindNewContacts(),this.m_profile.broadphase=s.GetMilliseconds()}SolveTOI(t){const e=this.m_island;if(e.Initialize(64,32,0,this.m_contactManager.m_contactListener),this.m_stepComplete){for(let t=this.m_bodyList;t;t=t.m_next)t.m_islandFlag=!1,t.m_sweep.alpha0=0;for(let t=this.m_contactManager.m_contactList;t;t=t.m_next)t.m_toiFlag=!1,t.m_islandFlag=!1,t.m_toiCount=0,t.m_toi=1}for(;;){let i=null,s=1;for(let t=this.m_contactManager.m_contactList;t;t=t.m_next){if(!t.IsEnabled())continue;if(t.m_toiCount>8)continue;let e=1;if(t.m_toiFlag)e=t.m_toi;else{const i=t.GetFixtureA(),s=t.GetFixtureB();if(i.IsSensor()||s.IsSensor())continue;const r=i.GetBody(),n=s.GetBody(),o=r.m_type,h=n.m_type,a=r.IsAwake()&&o!==Ai.b2_staticBody,l=n.IsAwake()&&h!==Ai.b2_staticBody;if(!a&&!l)continue;const m=r.IsBullet()||o!==Ai.b2_dynamicBody,c=n.IsBullet()||h!==Ai.b2_dynamicBody;if(!m&&!c)continue;let u=r.m_sweep.alpha0;r.m_sweep.alpha0<n.m_sweep.alpha0?(u=n.m_sweep.alpha0,r.m_sweep.Advance(u)):n.m_sweep.alpha0<r.m_sweep.alpha0&&(u=r.m_sweep.alpha0,n.m_sweep.Advance(u));const _=t.GetChildIndexA(),d=t.GetChildIndexB(),p=Wn.SolveTOI_s_toi_input;p.proxyA.SetShape(i.GetShape(),_),p.proxyB.SetShape(s.GetShape(),d),p.sweepA.Copy(r.m_sweep),p.sweepB.Copy(n.m_sweep),p.tMax=1;const f=Wn.SolveTOI_s_toi_output;as(f,p);const y=f.t;e=f.state===Yi.e_touching?be(u+(1-u)*y,1):1,t.m_toi=e,t.m_toiFlag=!0}e<s&&(i=t,s=e)}if(null===i||.9999<s){this.m_stepComplete=!0;break}const r=i.GetFixtureA(),n=i.GetFixtureB(),o=r.GetBody(),h=n.GetBody(),a=Wn.SolveTOI_s_backup1.Copy(o.m_sweep),l=Wn.SolveTOI_s_backup2.Copy(h.m_sweep);if(o.Advance(s),h.Advance(s),i.Update(this.m_contactManager.m_contactListener),i.m_toiFlag=!1,++i.m_toiCount,!i.IsEnabled()||!i.IsTouching()){i.SetEnabled(!1),o.m_sweep.Copy(a),h.m_sweep.Copy(l),o.SynchronizeTransform(),h.SynchronizeTransform();continue}o.SetAwake(!0),h.SetAwake(!0),e.Clear(),e.AddBody(o),e.AddBody(h),e.AddContact(i),o.m_islandFlag=!0,h.m_islandFlag=!0,i.m_islandFlag=!0;for(let t=0;t<2;++t){const i=0===t?o:h;if(i.m_type===Ai.b2_dynamicBody)for(let t=i.m_contactList;t&&e.m_bodyCount!==e.m_bodyCapacity&&e.m_contactCount!==e.m_contactCapacity;t=t.next){const r=t.contact;if(r.m_islandFlag)continue;const n=t.other;if(n.m_type===Ai.b2_dynamicBody&&!i.IsBullet()&&!n.IsBullet())continue;const o=r.m_fixtureA.m_isSensor,h=r.m_fixtureB.m_isSensor;if(o||h)continue;const a=Wn.SolveTOI_s_backup.Copy(n.m_sweep);n.m_islandFlag||n.Advance(s),r.Update(this.m_contactManager.m_contactListener),r.IsEnabled()&&r.IsTouching()?(r.m_islandFlag=!0,e.AddContact(r),n.m_islandFlag||(n.m_islandFlag=!0,n.m_type!==Ai.b2_staticBody&&n.SetAwake(!0),e.AddBody(n))):(n.m_sweep.Copy(a),n.SynchronizeTransform())}}const m=Wn.SolveTOI_s_subStep;m.dt=(1-s)*t.dt,m.inv_dt=1/m.dt,m.dtRatio=1,m.positionIterations=20,m.velocityIterations=t.velocityIterations,m.particleIterations=t.particleIterations,m.warmStarting=!1,e.SolveTOI(m,o.m_islandIndex,h.m_islandIndex);for(let t=0;t<e.m_bodyCount;++t){const i=e.m_bodies[t];if(i.m_islandFlag=!1,i.m_type===Ai.b2_dynamicBody){i.SynchronizeFixtures();for(let t=i.m_contactList;t;t=t.next)t.contact.m_toiFlag=!1,t.contact.m_islandFlag=!1}}if(this.m_contactManager.FindNewContacts(),this.m_subStepping){this.m_stepComplete=!1;break}}}AddController(t){return t.m_next=this.m_controllerList,t.m_prev=null,this.m_controllerList&&(this.m_controllerList.m_prev=t),this.m_controllerList=t,++this.m_controllerCount,t}RemoveController(t){return t.m_prev&&(t.m_prev.m_next=t.m_next),t.m_next&&(t.m_next.m_prev=t.m_prev),this.m_controllerList===t&&(this.m_controllerList=t.m_next),--this.m_controllerCount,t.m_prev=null,t.m_next=null,t}}Wn.Step_s_step=new Xr,Wn.Step_s_stepTimer=new Fi,Wn.Step_s_timer=new Fi,Wn.DebugDraw_s_color=new ki(0,0,0),Wn.DebugDraw_s_vs=Ie.MakeArray(4),Wn.DebugDraw_s_xf=new ke,Wn.QueryFixtureShape_s_aabb=new pi,Wn.RayCast_s_input=new _i,Wn.RayCast_s_output=new di,Wn.RayCast_s_point=new Ie,Wn.SolveTOI_s_subStep=new Xr,Wn.SolveTOI_s_backup=new Ee,Wn.SolveTOI_s_backup1=new Ee,Wn.SolveTOI_s_backup2=new Ee,Wn.SolveTOI_s_toi_input=new Hi,Wn.SolveTOI_s_toi_output=new Ki;class Xn{constructor(t){const e=Object.entries(t);e.sort(((t,e)=>{const i=Object.entries(t[1]).length;return Object.entries(e[1]).length-i}));const i=new Set;for(const t of e){if(i.has(t[0]))throw new Error(`Duplicate layer name: ${t[0]}`);i.add(t[0])}this.oo=new Map,this.ro=new Map,this.no=new Map;for(let t=0,i=1;t<e.length;t++,i<<=1){const s=e[t][0];this.oo.set(s,i),this.ro.set(i,s),this.no.set(i,0)}for(let t=0;t<e.length;++t){const i=e[t],s=i[0],r=Object.entries(i[1]);for(let t=0;t<r.length;++t){const e=r[t][0],i=r[t][1],n=this.oo.get(s),o=this.oo.get(e),h=this.no.get(n),a=this.no.get(o);i&&(this.no.set(n,h|o),this.no.set(o,a|n))}}}nameToLayer(t){const e=this.oo.get(t);if(void 0===e)throw new Error("Layer not found");return e}layerToName(t){const e=this.ro.get(t);if(void 0===e)throw new Error("Layer not found");return e}createMaskFromName(...t){let e=0;for(let i=0;i<t.length;i++)e|=this.nameToLayer(t[i]);return e}createMaskFromLayer(...t){let e=0;for(let i=0;i<t.length;i++)e|=t[i];return e}getMaskFromName(t){const e=this.oo.get(t);if(void 0===e)throw new Error("Layer not found");const i=this.no.get(e);if(void 0===i)throw new Error("Mask not found");return i}getMaskFromLayer(t){const e=this.no.get(t);if(void 0===e)throw new Error("Mask not found");return e}copy(t){this.oo.clear(),this.ro.clear(),this.no.clear();for(const[e,i]of t.oo)this.oo.set(e,i);for(const[e,i]of t.ro)this.ro.set(e,i);for(const[e,i]of t.no)this.no.set(e,i)}clone(){const t=new Xn({});return t.copy(this),t}}class Un{constructor(){this.li=null,this.ui=null,this.di=null,this.ai=null,this.fi=null,this.Ci=new Ut,this.Ve=new Ut,this.De=new Ut,this.xe=0,this.Ie=0,this.Re=0}setData(t,e,i,s,r,n){this.li=t;const o=t.GetFixtureA(),h=t.GetFixtureB();if(this.ui=o.GetUserData(),this.di=o.GetBody().GetUserData().rigidbody,this.ai=h.GetUserData(),this.fi=h.GetBody().GetUserData().rigidbody,n)this.Ci.copy(n);else{const t=Un._tempVec.Copy(o.GetBody().GetLinearVelocity()).SelfSub(h.GetBody().GetLinearVelocity());this.Ci.set(t.x,t.y)}this.Ve.set(s.x,s.y),this.De.set(i.x,i.y),this.xe=e.normalImpulse,this.Ie=e.tangentImpulse,this.Re=r}get enabled(){var t,e;return null!==(e=null===(t=this.li)||void 0===t?void 0:t.IsEnabled())&&void 0!==e&&e}get collider(){return this.ui}get rigidbody(){return this.di}get otherCollider(){return this.ai}get otherRigidbody(){return this.fi}get relativeVelocity(){return this.Ci}get point(){return this.Ve}get normal(){return this.De}get normalImpulse(){return this.xe}get tangentImpulse(){return this.Ie}get separation(){return this.Re}}Un._tempVec=new Ie;class Jn{constructor(){this.li=null,this.ci=new ci,this.ui=null,this.di=null,this.ai=null,this.fi=null,this.gi=0,this.Ci=new Ut}setData(t){this.li=t;const e=t.GetFixtureA(),i=t.GetFixtureB(),s=e.GetUserData(),r=i.GetUserData(),n=e.GetBody(),o=i.GetBody();this.ui=s,this.di=n.GetUserData().rigidbody,this.ai=r,this.fi=o.GetUserData().rigidbody,this.gi=t.GetManifold().pointCount;const h=Jn._tempVec.Copy(n.GetLinearVelocity()).SelfSub(o.GetLinearVelocity());this.Ci.set(h.x,h.y)}get collider(){return this.ui}get rigidbody(){return this.di}get otherCollider(){return this.ai}get otherRigidbody(){return this.fi}get contactCount(){return this.gi}getContacts(t){if(!this.li)return 0;let e=0;const i=this.li.GetManifold();for(let s=0;s<i.pointCount;s++)t[e]||(t[e]=new Un),this.li.GetWorldManifold(this.ci),t[e].setData(this.li,i.points[s],this.ci.normal,this.ci.points[s],this.ci.separations[s],this.Ci),e+=1;return e}getContact(t,e){if(!this.li)return null;const i=this.li.GetManifold();return t<0||i.pointCount<=t?null:(e||(e=new Un),this.li.GetWorldManifold(this.ci),e.setData(this.li,i.points[t],this.ci.normal,this.ci.points[t],this.ci.separations[t],this.Ci),e)}get enabled(){var t,e;return null!==(e=null===(t=this.li)||void 0===t?void 0:t.IsEnabled())&&void 0!==e&&e}set enabled(t){var e;null===(e=this.li)||void 0===e||e.SetEnabled(t)}get relativeVelocity(){return this.Ci}}Jn._tempVec=new Ie;class Zn{constructor(){this.type=0,this.colliderA=null,this.colliderB=null}invoke(){switch(this.type){case 0:this.colliderA.gameObject.gameObjectEventContainer.invokeOnTriggerEnter2D(this.colliderB),this.colliderB.gameObject.gameObjectEventContainer.invokeOnTriggerEnter2D(this.colliderA);break;case 1:this.colliderA.gameObject.gameObjectEventContainer.invokeOnTriggerStay2D(this.colliderB),this.colliderB.gameObject.gameObjectEventContainer.invokeOnTriggerStay2D(this.colliderA);break;case 2:this.colliderA.gameObject.gameObjectEventContainer.invokeOnTriggerExit2D(this.colliderB),this.colliderB.gameObject.gameObjectEventContainer.invokeOnTriggerExit2D(this.colliderA)}}}class Hn{constructor(){this.type=0,this.colliderA=null,this.colliderB=null,this.collision2D=null,this.collisionPool=null}invoke(){var t;switch(this.type){case 0:this.colliderA.gameObject.gameObjectEventContainer.invokeOnCollisionEnter2D(this.collision2D),this.colliderB.gameObject.gameObjectEventContainer.invokeOnCollisionEnter2D(this.collision2D);break;case 1:this.colliderA.gameObject.gameObjectEventContainer.invokeOnCollisionStay2D(this.collision2D),this.colliderB.gameObject.gameObjectEventContainer.invokeOnCollisionStay2D(this.collision2D);break;case 2:this.colliderA.gameObject.gameObjectEventContainer.invokeOnCollisionExit2D(this.collision2D),this.colliderB.gameObject.gameObjectEventContainer.invokeOnCollisionExit2D(this.collision2D)}null===(t=this.collisionPool)||void 0===t||t.release(this.collision2D)}}class Yn{constructor(t,e){this.tr=new Set,this.sr=t,this.rr=e}add(t){const e=this.sr.CreateFixture(t);return this.tr.add(e),e}remove(t){this.tr.delete(t),this.sr.DestroyFixture(t)}clear(){for(const t of this.tr)this.sr.DestroyFixture(t);this.tr.clear()}foreachFixture(t){for(const e of this.tr)t(e)}contains(t){return this.tr.has(t)}get body(){return this.sr}get physicObject(){return this.rr}}class Qn{constructor(t=.4,e=0){this.ji=new A,this.qi=t,this.zi=e}get friction(){return this.qi}set friction(t){this.qi=t,this.ji.invoke()}get bounciness(){return this.zi}set bounciness(t){this.zi=t,this.ji.invoke()}get onChanged(){return this.ji}copy(t){this.friction=t.friction,this.bounciness=t.bounciness,this.ji.invoke()}clone(){return new Qn(this.friction,this.bounciness)}}class Kn{constructor(){this.ir=new Ut,this.ui=null,this.er=0,this.hr=0,this.De=new Ut,this.Ve=new Ut,this.di=null,this.Vt=null}setData(t,e,i,s,r,n,o,h){this.ir.set(t.x,t.y),this.ui=e,this.er=i,this.hr=s,this.De.set(r.x,r.y),this.Ve.set(n.x,n.y),this.di=o,this.Vt=h}get centroid(){return this.ir}get collider(){return this.ui}get distance(){return this.er}get fraction(){return this.hr}get normal(){return this.De}get point(){return this.Ve}get rigidbody(){return this.di}get transform(){return this.Vt}}class $n extends Ti{constructor(){super(...arguments),this.Vi=0,this.Qi=null,this.Ki=new Ie,this.Ui=null}setRaycastData(t,e,i){this.Vi=0,this.Qi=t,this.Ki.Copy(e),this.Ui=i}get hitCount(){return this.Vi}ReportFixture(t,e,i,s){const r=t.GetUserData();if(!this.Ui.useTriggers&&r.isTrigger)return-1;const n=$n._tempVec2.Copy(e).SelfSub(this.Ki).Length();if(this.Ui.useLayerMask&&0==(r.getThisOrRigidBodyLayer()&this.Ui.layerMask))return-1;const o=r.transform;if(this.Ui.useDepth){const t=o.position.z,e=t<this.Ui.minDepth||this.Ui.maxDepth<t;if(this.Ui.useOutsideDepth?!e:e)return-1}if(this.Ui.useNormalAngle){const t=Math.atan2(-i.y,i.x)+Math.PI,e=t<this.Ui.minNormalAngle||this.Ui.maxNormalAngle<t;if(this.Ui.useOutsideNormalAngle?!e:e)return-1}return this.Qi[this.hitCount]||(this.Qi[this.hitCount]=new Kn),this.Qi[this.hitCount].setData(e,r,n,s,i,e,t.GetBody().GetUserData().rigidbody,o),this.Vi+=1,1}ReportParticle(){return-1}ShouldQueryParticleSystem(){return!1}}$n._tempVec2=new Ie;class to extends Ti{constructor(t){super(),this.Oe=!1,this.Se=null,this.Ki=new Ie,this.Fe=0,this.Qe=0,this.je=0,this.qe=t}setRaycastData(t,e,i,s,r){this.Oe=!1,this.Se=t,this.Ki.Copy(e),this.Fe=i,this.Qe=s,this.je=r}get hit(){return this.Oe}ReportFixture(t,e,i,s){const r=t.GetUserData();if(!this.qe.queriesHitTriggers&&r.isTrigger)return-1;const n=to._tempVec2.Copy(e).SelfSub(this.Ki).Length();if(0==(r.getThisOrRigidBodyLayer()&this.Fe))return-1;const o=r.transform,h=o.position.z;return h<this.Qe||this.je<h?-1:(this.Se.setData(e,r,n,s,i,e,t.GetBody().GetUserData().rigidbody,o),this.Oe=!0,s)}ReportParticle(){return-1}ShouldQueryParticleSystem(){return!1}}to._tempVec2=new Ie;class eo{}eo.angularSleepTolerance=.03490658503988889,eo.baumgarte=.2,eo.linearSleepTolerance=.01,eo.maxAngularCorrection=fe,eo.maxLinearCorrection=.2,eo.maxRotation=ye,eo.maxTranslation=2,eo.timeToSleep=.5,eo.toiBaumgarte=.75,eo.BodyType=Ai,eo.BodyDef=Mi,eo.ContactListener=Pi,eo.FixtureDef=Si,eo.Filter=vi,eo.MassData=Le,eo.PolygonShape=Ri,eo.WorldManifold=ci,eo.World=Wn,eo.Vec2=Ie,eo.Collision2DPool=class{constructor(){this.io=[]}getInstance(){return this.io.length>0?this.io.pop():new Jn}release(t){this.io.push(t)}},eo.Collision2D=Jn,eo.CollisionLayerMaskConverter=Xn,eo.PhysicsObject2D=class{constructor(t,e,i){this.Gi=null,this._i=null,this.Ai=[],this.Hi=()=>{for(let t=0;t<this.Ai.length;t++)this.Ai[t].updateFixturesMaterialInfo()},this.gameObject=t,this.body=e,this.Rt=i,e.SetUserData(this)}addRigidBody(t){if(this._i)throw new Error("RigidBody already exists");return this._i=t,this}removeRigidBody(){this._i=null,this.body.SetType(Ai.b2_kinematicBody),this.body.SetBullet(!1),this.body.SetEnabled(!0),this.Ji()}addCollider(t){return this.Ai.push(t),new Yn(this.body,this)}removeCollider(t,e){const i=this.Ai.indexOf(t);if(-1===i)throw new Error("Collider not found");this.Ai.splice(i,1),e.clear(),this.Ji()}Ji(){0===this.Ai.length&&null===this._i&&(this.body.GetWorld().DestroyBody(this.body),this.Rt())}setSharedPhysicsMaterial(t){var e;t?this.Gi?this.Gi.copy(t):(this.Gi=new Qn(t.friction,t.bounciness),this.Gi.onChanged.addListener(this.Hi)):(null===(e=this.Gi)||void 0===e||e.onChanged.removeListener(this.Hi),this.Gi=null),this.Hi()}get sharedMaterial(){return this.Gi}get rigidbody(){return this._i}get colliders(){return this.Ai}},eo.TriggerEventPool=class{constructor(){this.vi=[],this.ki=0}insert(t,e,i){this.vi.length<=this.ki&&this.vi.push(new Zn);const s=this.vi[this.ki];s.type=t,s.colliderA=e,s.colliderB=i,this.ki+=1}invoke(){for(let t=0;t<this.ki;t+=1)this.vi[t].invoke();this.ki=0}},eo.CollisionEventPool=class{constructor(){this.bi=[],this.ki=0}insert(t,e,i,s,r){this.bi.length<=this.ki&&this.bi.push(new Hn);const n=this.bi[this.ki];n.type=t,n.colliderA=e,n.colliderB=i,n.collision2D=s,n.collisionPool=null!=r?r:null,this.ki+=1}invoke(){for(let t=0;t<this.ki;t+=1)this.bi[t].invoke();this.ki=0}},eo.RaycastHit2D=Kn,eo.RayCastOneCallback=to,eo.RayCastFilterCallback=$n;class io{constructor(t=null){this.ref=t}}class so extends Mt{constructor(){super(),this.isCamera=!0,this.type="Camera",this.matrixWorldInverse=new it,this.projectionMatrix=new it,this.projectionMatrixInverse=new it}copy(t,e){return super.copy(t,e),this.matrixWorldInverse.copy(t.matrixWorldInverse),this.projectionMatrix.copy(t.projectionMatrix),this.projectionMatrixInverse.copy(t.projectionMatrixInverse),this}getWorldDirection(t){this.updateWorldMatrix(!0,!1);const e=this.matrixWorld.elements;return t.set(-e[8],-e[9],-e[10]).normalize()}updateMatrixWorld(t){super.updateMatrixWorld(t),this.matrixWorldInverse.copy(this.matrixWorld).invert()}updateWorldMatrix(t,e){super.updateWorldMatrix(t,e),this.matrixWorldInverse.copy(this.matrixWorld).invert()}clone(){return(new this.constructor).copy(this)}}class ro extends so{constructor(t=50,e=1,i=.1,s=2e3){super(),this.isPerspectiveCamera=!0,this.type="PerspectiveCamera",this.fov=t,this.zoom=1,this.near=i,this.far=s,this.focus=10,this.aspect=e,this.view=null,this.filmGauge=35,this.filmOffset=0,this.updateProjectionMatrix()}copy(t,e){return super.copy(t,e),this.fov=t.fov,this.zoom=t.zoom,this.near=t.near,this.far=t.far,this.focus=t.focus,this.aspect=t.aspect,this.view=null===t.view?null:Object.assign({},t.view),this.filmGauge=t.filmGauge,this.filmOffset=t.filmOffset,this}setFocalLength(t){const e=.5*this.getFilmHeight()/t;this.fov=2*i*Math.atan(e),this.updateProjectionMatrix()}getFocalLength(){const t=Math.tan(.5*e*this.fov);return.5*this.getFilmHeight()/t}getEffectiveFOV(){return 2*i*Math.atan(Math.tan(.5*e*this.fov)/this.zoom)}getFilmWidth(){return this.filmGauge*Math.min(this.aspect,1)}getFilmHeight(){return this.filmGauge/Math.max(this.aspect,1)}setViewOffset(t,e,i,s,r,n){this.aspect=t/e,null===this.view&&(this.view={enabled:!0,fullWidth:1,fullHeight:1,offsetX:0,offsetY:0,width:1,height:1}),this.view.enabled=!0,this.view.fullWidth=t,this.view.fullHeight=e,this.view.offsetX=i,this.view.offsetY=s,this.view.width=r,this.view.height=n,this.updateProjectionMatrix()}clearViewOffset(){null!==this.view&&(this.view.enabled=!1),this.updateProjectionMatrix()}updateProjectionMatrix(){const t=this.near;let i=t*Math.tan(.5*e*this.fov)/this.zoom,s=2*i,r=this.aspect*s,n=-.5*r;const o=this.view;if(null!==this.view&&this.view.enabled){const t=o.fullWidth,e=o.fullHeight;n+=o.offsetX*r/t,i-=o.offsetY*s/e,r*=o.width/t,s*=o.height/e}const h=this.filmOffset;0!==h&&(n+=t*h/this.getFilmWidth()),this.projectionMatrix.makePerspective(n,n+r,i,i-s,t,this.far),this.projectionMatrixInverse.copy(this.projectionMatrix).invert()}toJSON(t){const e=super.toJSON(t);return e.object.fov=this.fov,e.object.zoom=this.zoom,e.object.near=this.near,e.object.far=this.far,e.object.focus=this.focus,e.object.aspect=this.aspect,null!==this.view&&(e.object.view=Object.assign({},this.view)),e.object.filmGauge=this.filmGauge,e.object.filmOffset=this.filmOffset,e}}class no extends so{constructor(t=-1,e=1,i=1,s=-1,r=.1,n=2e3){super(),this.isOrthographicCamera=!0,this.type="OrthographicCamera",this.zoom=1,this.view=null,this.left=t,this.right=e,this.top=i,this.bottom=s,this.near=r,this.far=n,this.updateProjectionMatrix()}copy(t,e){return super.copy(t,e),this.left=t.left,this.right=t.right,this.top=t.top,this.bottom=t.bottom,this.near=t.near,this.far=t.far,this.zoom=t.zoom,this.view=null===t.view?null:Object.assign({},t.view),this}setViewOffset(t,e,i,s,r,n){null===this.view&&(this.view={enabled:!0,fullWidth:1,fullHeight:1,offsetX:0,offsetY:0,width:1,height:1}),this.view.enabled=!0,this.view.fullWidth=t,this.view.fullHeight=e,this.view.offsetX=i,this.view.offsetY=s,this.view.width=r,this.view.height=n,this.updateProjectionMatrix()}clearViewOffset(){null!==this.view&&(this.view.enabled=!1),this.updateProjectionMatrix()}updateProjectionMatrix(){const t=(this.right-this.left)/(2*this.zoom),e=(this.top-this.bottom)/(2*this.zoom),i=(this.right+this.left)/2,s=(this.top+this.bottom)/2;let r=i-t,n=i+t,o=s+e,h=s-e;if(null!==this.view&&this.view.enabled){const t=(this.right-this.left)/this.view.fullWidth/this.zoom,e=(this.top-this.bottom)/this.view.fullHeight/this.zoom;r+=t*this.view.offsetX,n=r+t*this.view.width,o-=e*this.view.offsetY,h=o-e*this.view.height}this.projectionMatrix.makeOrthographic(r,n,o,h,this.near,this.far),this.projectionMatrixInverse.copy(this.projectionMatrix).invert()}toJSON(t){const e=super.toJSON(t);return e.object.zoom=this.zoom,e.object.left=this.left,e.object.right=this.right,e.object.top=this.top,e.object.bottom=this.bottom,e.object.near=this.near,e.object.far=this.far,null!==this.view&&(e.object.view=Object.assign({},this.view)),e}}class oo{constructor(t,e,i){this.gt=t,this.vt=0,this.xt=e,this.It=null,this.Tt=!1,this.Yt=i}get component(){return this.gt}get elapsedTime(){return this.vt}set elapsedTime(t){this.vt=t}get currentYieldInstruction(){return this.It}get currentYieldInstructionExist(){return this.Tt}fatchNextInstruction(){var t;const e=this.xt.next();return e.done?(this.It=null,this.Tt=!1,null===(t=this.Yt)||void 0===t||t.call(this),this.Yt=null,null):(this.It=e.value,this.Tt=!0,this.It)}}class ho{constructor(){this.awakeCalled=!1,this.startRegistered=!1,this.startCalled=!1,this.updateRegistered=!1,this.enabled=!1}}class ao{constructor(t){this.Ut=null,this.Rt=null,this.qt=null,this.zt=null,this.Bt=null,this.Gt=null,this.Ht=null,this.Jt=null,this.Kt=null,this.Lt=null,this.gt=t,this.g=t.engine.sceneProcessor,this.H=t.engine.instantiater,this.Mt=new ho,function(t){return void 0!==t.awake}(t)&&(this.Ut=H.createAwakeEvent(this.H,t.awake.bind(t))),function(t){return void 0!==t.onDestroy}(t)&&(this.Rt=H.createOnDestroyEvent(this.H,t.onDestroy.bind(t),t.executionOrder)),function(t){return void 0!==t.onCollisionEnter2D}(t)&&(this.qt=H.createOnCollisionEnter2DEvent(this.H,(e=>t.onCollisionEnter2D(e)),t.executionOrder)),function(t){return void 0!==t.onCollisionStay2D}(t)&&(this.zt=H.createOnCollisionStay2DEvent(this.H,(e=>t.onCollisionStay2D(e)),t.executionOrder)),function(t){return void 0!==t.onCollisionExit2D}(t)&&(this.Bt=H.createOnCollisionExit2DEvent(this.H,(e=>t.onCollisionExit2D(e)),t.executionOrder)),function(t){return void 0!==t.onTriggerEnter2D}(t)&&(this.Gt=H.createOnTriggerEnter2DEvent(this.H,(e=>t.onTriggerEnter2D(e)),t.executionOrder)),function(t){return void 0!==t.onTriggerStay2D}(t)&&(this.Ht=H.createOnTriggerStay2DEvent(this.H,(e=>t.onTriggerStay2D(e)),t.executionOrder)),function(t){return void 0!==t.onTriggerExit2D}(t)&&(this.Jt=H.createOnTriggerExit2DEvent(this.H,(e=>t.onTriggerExit2D(e)),t.executionOrder)),function(t){return void 0!==t.start}(t)&&(this.Kt=H.createStartEvent(this.H,(()=>{this.Mt.startCalled=!0,t.start(),this.Mt.startRegistered&&this.g.removeEventFromNonSyncedCollection(this.Kt)}),t.executionOrder)),function(t){return void 0!==t.update}(t)&&(this.Lt=H.createUpdateEvent(this.H,t.update.bind(t),t.executionOrder))}tryCallAwake(){var t;this.Mt.awakeCalled||(this.Mt.awakeCalled=!0,null===(t=this.Ut)||void 0===t||t.invoke())}tryRegisterOnEnable(){if(this.gt._engine_internal_destroyed)return;if(this.Mt.enabled)return;if(this.Mt.enabled=!0,!function(t){return void 0!==t.onEnable}(this.gt))return;const t=H.createOnEnableEvent(this.H,this.gt.onEnable.bind(this.gt),this.gt.executionOrder);this.g.addEventToSyncedCollection(t)}tryRegisterOnDisable(){if(this.gt._engine_internal_destroyed)return;if(!this.Mt.enabled)return;if(this.Mt.enabled=!1,!function(t){return void 0!==t.onDisable}(this.gt))return;const t=H.createOnDisableEvent(this.H,this.gt.onDisable.bind(this.gt),this.gt.executionOrder);this.g.addEventToSyncedCollection(t)}tryRegisterOnDestroy(){this.Rt&&this.g.addEventToSyncedCollection(this.Rt)}tryRegisterStart(){this.Kt&&(this.gt._engine_internal_destroyed||this.Mt.startCalled||this.Mt.startRegistered||(this.Mt.startRegistered=!0,this.g.addEventToNonSyncedCollection(this.Kt)))}tryUnregisterStart(){this.Kt&&this.Mt.startRegistered&&!this.Mt.startCalled&&(this.Mt.startRegistered=!1,this.g.removeEventFromNonSyncedCollection(this.Kt))}tryRegisterUpdate(){this.Lt&&(this.gt._engine_internal_destroyed||this.Mt.updateRegistered||(this.Mt.updateRegistered=!0,this.g.addEventToNonSyncedCollection(this.Lt)))}tryUnregisterUpdate(){this.Lt&&this.Mt.updateRegistered&&(this.Mt.updateRegistered=!1,this.g.removeEventFromNonSyncedCollection(this.Lt))}get onCollisionEnter2D(){return this.qt}get onCollisionStay2D(){return this.zt}get onCollisionExit2D(){return this.Bt}get onTriggerEnter2D(){return this.Gt}get onTriggerStay2D(){return this.Ht}get onTriggerExit2D(){return this.Jt}}class lo{constructor(t){this.disallowMultipleComponent=!1,this.requiredComponents=[],this.executionOrder=0,this._runningCoroutines=[],this._engine_internal_destroyed=!1,this._enabled=!0,this._gameObject=t,this._instanceId=t.engine.instantiater.generateId(),this._engine_internal_componentEventContainer=null}engine_internal_constructAfterProcess(){this._engine_internal_componentEventContainer=new ao(this),Object.defineProperties(this,{disallowMultipleComponent:{configurable:!1,writable:!1},requiredComponents:{configurable:!1,writable:!1},executionOrder:{configurable:!1,writable:!1}})}startCoroutine(t){this.checkComponentIsExist();const e=new oo(this,t,(()=>{const t=this._runningCoroutines.indexOf(e);t>=0&&this._runningCoroutines.splice(t,1)}));return this._runningCoroutines.push(e),e.fatchNextInstruction(),this.engine.coroutineProcessor.addCoroutine(e),e}stopAllCoroutines(){this.checkComponentIsExist(),this._runningCoroutines.forEach((t=>{this.stopCoroutine(t)})),this._runningCoroutines.length=0}stopCoroutine(t){if(this.checkComponentIsExist(),t.component!==this)throw new Error("Coroutine is not owned by this component");this.engine.coroutineProcessor.removeCoroutine(t);const e=this._runningCoroutines.indexOf(t);e>=0&&this._runningCoroutines.splice(e,1)}get enabled(){return this._enabled}set enabled(t){this.checkComponentIsExist(),this._enabled!==t&&(this._enabled=t,this._gameObject.initialized&&this._gameObject.activeInHierarchy&&(this._enabled?(this._engine_internal_componentEventContainer.tryRegisterOnEnable(),this._engine_internal_componentEventContainer.tryRegisterStart(),this._engine_internal_componentEventContainer.tryRegisterUpdate(),this.engine.sceneProcessor.tryStartProcessSyncedEvent()):(this._engine_internal_componentEventContainer.tryRegisterOnDisable(),this._engine_internal_componentEventContainer.tryUnregisterStart(),this._engine_internal_componentEventContainer.tryUnregisterUpdate(),this.engine.sceneProcessor.tryStartProcessSyncedEvent())))}checkComponentIsExist(){if(this._engine_internal_destroyed)throw new Error("Component "+this.constructor.name+" is destroyed")}get gameObject(){return this._gameObject}get transform(){return this._gameObject.transform}get engine(){return this._gameObject.engine}get instanceId(){return this._instanceId}get initialized(){return this._gameObject.initialized}get exists(){return!this._engine_internal_destroyed}destroy(){this._engine_internal_destroyed||(this.enabled&&this.gameObject.activeInHierarchy&&(this._engine_internal_componentEventContainer.tryRegisterOnDisable(),this._engine_internal_componentEventContainer.tryUnregisterStart(),this._engine_internal_componentEventContainer.tryUnregisterUpdate()),this.stopAllCoroutines(),this._engine_internal_componentEventContainer.tryRegisterOnDestroy(),this._engine_internal_destroyed=!0,this.engine.sceneProcessor.tryStartProcessSyncedEvent(),this.engine.sceneProcessor.addRemoveComponent(this))}}class mo{constructor(t=0,e=0,i=0,s=1){1<t?t=1:0>t&&(t=0),1<e?e=1:0>e&&(e=0),1<i?i=1:0>i&&(i=0),1<s?s=1:0>s&&(s=0),this.Wi=t,this.$i=e,this.Xi=i,this.Yi=s}set(t,e,i,s=1){return 1<t?t=1:0>t&&(t=0),1<e?e=1:0>e&&(e=0),1<i?i=1:0>i&&(i=0),1<s?s=1:0>s&&(s=0),this.Wi=t,this.$i=e,this.Xi=i,this.Yi=s,this}copy(t){return this.Wi=t.r,this.$i=t.g,this.Xi=t.b,this.Yi=t.a,this}clone(){return new mo(this.Wi,this.$i,this.Xi,this.Yi)}get r(){return this.Wi}set r(t){1<t?t=1:0>t&&(t=0),this.Wi=t}get g(){return this.$i}set g(t){1<t?t=1:0>t&&(t=0),this.$i=t}get b(){return this.Xi}set b(t){1<t?t=1:0>t&&(t=0),this.Xi=t}get a(){return this.Yi}set a(t){1<t?t=1:0>t&&(t=0),this.Yi=t}toString(){return"rgb("+255*this.Wi+", "+255*this.$i+", "+255*this.Xi+")"}toStringWithAlpha(){return"rgba("+255*this.Wi+", "+255*this.$i+", "+255*this.Xi+", "+this.Yi+")"}toHex(){return"#"+((Math.round(255*this.Wi)<<16)+(Math.round(255*this.$i)<<8)+(Math.round(255*this.Xi)<<0)).toString(16).padStart(6,"0")}toHexWithAlpha(){return"#"+((Math.round(255*this.Wi)<<16)+(Math.round(255*this.$i)<<8)+(Math.round(255*this.Xi)<<0)).toString(16).padStart(6,"0")+Math.round(255*this.Yi).toString(16).padStart(2,"0")}toArray(){return[this.Wi,this.$i,this.Xi,this.Yi]}static fromHex(t){const e=parseInt(t.slice(1,3),16)/255,i=parseInt(t.slice(3,5),16)/255,s=parseInt(t.slice(5,7),16)/255;return new mo(e,i,s)}static fromArray(t){return new mo(t[0],t[1],t[2],t[3])}static fromString(t){const e=t.match(/^rgba\((\d+),\s*(\d+),\s*(\d+),\s*(\d*(?:\.\d+)?)\)$/);return e?new mo(parseInt(e[1]),parseInt(e[2]),parseInt(e[3]),parseFloat(e[4])):mo.fromHex(t)}hueRotate(t=0,e){t=t/180*Math.PI;const i=Math.sin(t),s=Math.cos(t);this.multiplyMatrix((null!=e?e:new dt).set(.213+.787*s-.213*i,.715-.715*s-.715*i,.072-.072*s+.928*i,.213-.213*s+.143*i,.715+.285*s+.14*i,.072-.072*s-.283*i,.213-.213*s-.787*i,.715-.715*s+.715*i,.072+.928*s+.072*i))}grayscale(t=1,e){this.multiplyMatrix((null!=e?e:new dt).set(.2126+.7874*(1-t),.7152-.7152*(1-t),.0722-.0722*(1-t),.2126-.2126*(1-t),.7152+.2848*(1-t),.0722-.0722*(1-t),.2126-.2126*(1-t),.7152-.7152*(1-t),.0722+.9278*(1-t)))}sepia(t=1,e){this.multiplyMatrix((null!=e?e:new dt).set(.393+.607*(1-t),.769-.769*(1-t),.189-.189*(1-t),.349-.349*(1-t),.686+.314*(1-t),.168-.168*(1-t),.272-.272*(1-t),.534-.534*(1-t),.131+.869*(1-t)))}saturate(t=1,e){this.multiplyMatrix((null!=e?e:new dt).set(.213+.787*t,.715-.715*t,.072-.072*t,.213-.213*t,.715+.285*t,.072-.072*t,.213-.213*t,.715-.715*t,.072+.928*t))}brightness(t=1){this.linear(t)}contrast(t=1){this.linear(t,-.5*t+.5)}invert(t=1){let e=t+this.Wi*(1-2*t),i=t+this.$i*(1-2*t),s=t+this.Xi*(1-2*t);1<e?e=1:e<0&&(e=0),1<i?i=1:i<0&&(i=0),1<s?s=1:s<0&&(s=0),this.Wi=e,this.$i=i,this.Xi=s}multiplyMatrix(t){const e=t.elements;let i=this.Wi*e[0]+this.$i*e[1]+this.Xi*e[2],s=this.Wi*e[3]+this.$i*e[4]+this.Xi*e[5],r=this.Wi*e[6]+this.$i*e[7]+this.Xi*e[8];return 1<i?i=1:i<0&&(i=0),1<s?s=1:s<0&&(s=0),1<r?r=1:r<0&&(r=0),this.Wi=i,this.$i=s,this.Xi=r,this}linear(t=1,e=0){let i=this.Wi*t+e,s=this.$i*t+e,r=this.Xi*t+e;return 1<i?i=1:i<0&&(i=0),1<s?s=1:s<0&&(s=0),1<r?r=1:r<0&&(r=0),this.Wi=i,this.$i=s,this.Xi=r,this}hsl(){const t=this.Wi,e=this.$i,i=this.Xi,s=Math.max(t,e,i),r=Math.min(t,e,i);let n,o;const h=(s+r)/2;if(s===r)n=o=0;else{const a=s-r;switch(o=h>.5?a/(2-s-r):a/(s+r),s){case t:n=(e-i)/a+(e<i?6:0);break;case e:n=(i-t)/a+2;break;case i:n=(t-e)/a+4;break;default:throw new Error("Unreachable")}n/=6}return{h:n,s:o,l:h}}}class co{constructor(t,e){this.Dt=t,this.Cr=(new mo).copy(e)}get priority(){return this.Dt}set priority(t){this.Dt=t}get backgroundColor(){return this.Cr}set backgroundColor(t){this.Cr.copy(t)}}!function(t){t[t.Perspective=0]="Perspective",t[t.Orthographic=1]="Orthographic"}(sn||(sn={}));class uo extends lo{constructor(){super(...arguments),this.mh=null,this.Ta=sn.Orthographic,this.va=75,this.ya=5,this.wa=.1,this.Pa=1e3,this.Dt=0,this.Oa=new mo(1,1,1,0),this._a=(t,e)=>{const i=t/e;if(this.mh instanceof ro)this.mh.aspect=i,this.mh.updateProjectionMatrix();else if(this.mh instanceof no){const t=this.ya;this.mh.left=-t*i,this.mh.right=t*i,this.mh.top=t,this.mh.bottom=-t,this.mh.updateProjectionMatrix()}}}onEnable(){this.engine.screen.onResize.addListener(this._a),this.ba()}onWorldMatrixUpdated(){this.mh&&(Et.updateRawObject3DWorldMatrixRecursively(this.mh),this.mh.matrixWorldInverse.copy(this.mh.matrixWorld).invert())}ba(){const t=this.engine.screen.width/this.engine.screen.height;if(this.Ta===sn.Perspective)this.mh?this.mh instanceof ro?(this.mh.aspect=t,this.mh.fov=this.va,this.mh.near=this.wa,this.mh.far=this.Pa,this.mh.updateProjectionMatrix()):(this.mh.removeFromParent(),this.mh=this.xa(),this.transform.unsafeGetObject3D().add(this.mh)):(this.mh=this.xa(),this.transform.unsafeGetObject3D().add(this.mh));else{if(this.Ta!==sn.Orthographic)throw new Error("Camera type not supported");if(this.mh)if(this.mh instanceof no){const e=this.ya;this.mh.left=-e*t,this.mh.right=e*t,this.mh.top=e,this.mh.bottom=-e,this.mh.near=this.wa,this.mh.far=this.Pa,this.mh.updateProjectionMatrix()}else this.mh.removeFromParent(),this.mh=this.Ia(),this.transform.unsafeGetObject3D().add(this.mh);else this.mh=this.Ia(),this.transform.unsafeGetObject3D().add(this.mh)}Et.updateRawObject3DWorldMatrixRecursively(this.mh),this.engine.cameraContainer.addCamera(this,new co(this.Dt,this.Oa))}xa(){const t=this.engine.screen.width/this.engine.screen.height;return new ro(this.va,t,this.wa,this.Pa)}Ia(){const t=this.engine.screen.width/this.engine.screen.height,e=this.ya;return new no(-e*t,e*t,e,-e,this.wa,this.Pa)}onDisable(){this.engine.screen.onResize.removeListener(this._a),this.mh&&this.engine.cameraContainer.removeCamera(this)}onDestroy(){var t;null===(t=this.mh)||void 0===t||t.removeFromParent()}get cameraType(){return this.Ta}set cameraType(t){this.Ta!==t&&(this.Ta=t,this.mh&&this.ba())}get fov(){return this.va}set fov(t){this.va!==t&&(this.va=t,this.mh instanceof ro&&(this.mh.fov=t,this.mh.updateProjectionMatrix()))}get viewSize(){return this.ya}set viewSize(t){if(this.ya!==t&&(this.ya=t,this.mh instanceof no)){const t=this.engine.screen.width/this.engine.screen.height,e=this.ya;this.mh.left=-e*t,this.mh.right=e*t,this.mh.top=e,this.mh.bottom=-e,this.mh.updateProjectionMatrix()}}get near(){return this.wa}set near(t){this.wa!==t&&(this.wa=t,this.mh instanceof ro&&(this.mh.near=t,this.mh.updateProjectionMatrix()))}get far(){return this.Pa}set far(t){this.Pa!==t&&(this.Pa=t,this.mh instanceof ro&&(this.mh.far=t,this.mh.updateProjectionMatrix()))}get priority(){return this.Dt}set priority(t){this.Dt=t,this.mh&&this.engine.cameraContainer.changeCameraPriority(this,t)}get backgroundColor(){return this.Oa}set backgroundColor(t){this.Oa.copy(t),this.mh&&this.engine.cameraContainer.changeCameraBackgroundColor(this,t)}get threeCamera(){return this.mh}}class _o extends Mt{constructor(t=document.createElement("div")){super(),this.isCSS3DObject=!0,this.element=t,this.element.style.position="absolute",this.element.style.pointerEvents="auto",this.element.style.userSelect="none",this.element.setAttribute("draggable","false"),this.addEventListener("removed",(()=>{this.traverse((t=>{t instanceof _o&&t.element instanceof Element&&null!==t.element.parentNode&&t.element.parentNode.removeChild(t.element)}))}))}copy(t,e){return super.copy(t,e),this.element=t.element.cloneNode(!0),this}}new $,new K,new $,new it,new it;class po{constructor(t=0,e=0,i=0,s=new mo,r=null){this.tc=t,this.sc=e,this.dl=i,this.hc=(new mo).copy(s),this.vl=r}get onChange(){return this.vl}set onChange(t){this.vl=t}get offsetX(){return this.tc}set offsetX(t){var e;this.tc=t,null===(e=this.vl)||void 0===e||e.call(this)}get offsetY(){return this.sc}set offsetY(t){var e;this.sc=t,null===(e=this.vl)||void 0===e||e.call(this)}get blur(){return this.dl}set blur(t){var e;this.dl=t,null===(e=this.vl)||void 0===e||e.call(this)}get color(){return this.hc}set color(t){var e;this.hc.copy(t),null===(e=this.vl)||void 0===e||e.call(this)}copy(t){var e;this.tc=t.offsetX,this.sc=t.offsetY,this.dl=t.blur,this.hc.copy(t.color),null===(e=this.vl)||void 0===e||e.call(this)}clone(){return new po(this.tc,this.sc,this.dl,this.hc.clone())}toString(){return"drop-shadow("+this.tc+"px "+this.sc+"px "+this.dl+"px "+this.hc.toString()+")"}}class fo{constructor(t=null){this.dl=0,this.ud=1,this.ld=1,this.vd=null,this.fd=0,this.gd=0,this.pd=0,this.wd=1,this.Sd=0,this.vl=t}copy(t){var e;this.dl=t.dl,this.ud=t.ud,this.ld=t.ld,!this.vd&&t.vd?(this.vd=new po(void 0,void 0,void 0,void 0,this.vl),this.vd.copy(t.vd)):this.vd&&t.vd&&this.vd.copy(t.vd),this.fd=t.fd,this.gd=t.gd,this.pd=t.pd,this.wd=t.wd,this.Sd=t.Sd,null===(e=this.vl)||void 0===e||e.call(this)}clone(){const t=new fo;return t.copy(this),t}get blur(){return this.dl}set blur(t){var e;this.dl=t,null===(e=this.vl)||void 0===e||e.call(this)}get brightness(){return this.ud}set brightness(t){var e;this.ud=t,null===(e=this.vl)||void 0===e||e.call(this)}get contrast(){return this.ld}set contrast(t){var e;this.ld=t,null===(e=this.vl)||void 0===e||e.call(this)}get dropShadow(){return this.vd}set dropShadow(t){t?(this.vd||(this.vd=new po(void 0,void 0,void 0,void 0,this.vl)),this.vd.copy(t)):this.vd&&(this.vd.onChange=null,this.vd=null)}get grayscale(){return this.fd}set grayscale(t){var e;this.fd=t,null===(e=this.vl)||void 0===e||e.call(this)}get hueRotate(){return this.gd}set hueRotate(t){var e;this.gd=t,null===(e=this.vl)||void 0===e||e.call(this)}get invert(){return this.pd}set invert(t){var e;this.pd=t,null===(e=this.vl)||void 0===e||e.call(this)}get saturate(){return this.wd}set saturate(t){var e;this.wd=t,null===(e=this.vl)||void 0===e||e.call(this)}get sepia(){return this.Sd}set sepia(t){var e;this.Sd=t,null===(e=this.vl)||void 0===e||e.call(this)}toString(){let t="";return 0!==this.dl&&(t+="blur("+this.dl+"px) "),1!==this.ud&&(t+="brightness("+this.ud+") "),1!==this.ld&&(t+="contrast("+this.ld+") "),0!==this.fd&&(t+="grayscale("+this.fd+") "),0!==this.gd&&(t+="hue-rotate("+this.gd+"deg) "),0!==this.pd&&(t+="invert("+this.pd+") "),1!==this.wd&&(t+="saturate("+this.wd+") "),0!==this.Sd&&(t+="sepia("+this.Sd+") "),this.vd&&(t+=this.vd.toString()),t}}class yo extends lo{constructor(){super(...arguments),this.css3DObject=null,this.htmlElement=null,this.da=new Ut,this.dn=.1,this.un=!0,this.fn=()=>{this.htmlElement&&(this.htmlElement.style.filter=this.Ui.toString())},this.Ui=new fo(this.fn),this.Cl=!1}start(){this.Cl=!0,this.renderInitialize()}onDestroy(){this.css3DObject&&(this.transform.dequeueRenderAttachedObject3D(this.css3DObject),this.transform.unsafeGetObject3D().remove(this.css3DObject),this.css3DObject=null,this.htmlElement=null)}onEnable(){this.css3DObject&&(this.css3DObject.visible=!0,this.transform.enqueueRenderAttachedObject3D(this.css3DObject))}onDisable(){this.css3DObject&&(this.css3DObject.visible=!1,this.transform.enqueueRenderAttachedObject3D(this.css3DObject))}onWorldMatrixUpdated(){this.css3DObject&&(Et.updateRawObject3DWorldMatrixRecursively(this.css3DObject),this.transform.enqueueRenderAttachedObject3D(this.css3DObject))}renderInitialize(){throw new Error("Yon can't Use CssRenderer Directly, use Derived Class e.g. CssSpriteRenderer")}initializeBaseComponents(t){const e=this.htmlElement;if(!e)throw new Error("htmlElement is null");let i=!1;return t?(this.css3DObject&&this.transform.unsafeGetObject3D().remove(this.css3DObject),this.css3DObject=new _o(e),i=!0):this.css3DObject?this.css3DObject.element=e:(this.css3DObject=new _o(e),i=!0),i&&(e.style.pointerEvents=this.pointerEvents?"auto":"none",e.style.filter=this.Ui.toString(),this.enabled&&this.gameObject.activeInHierarchy?this.css3DObject.visible=!0:this.css3DObject.visible=!1),this.updateViewScale(!1),this.updateCenterOffset(!1),this.transform.unsafeGetObject3D().add(this.css3DObject),this.css3DObject}updateCenterOffset(t){throw new Error("Yon can't Use CssRenderer Directly, use Derived Class e.g. CssSpriteRenderer")}updateViewScale(t){throw new Error("Yon can't Use CssRenderer Directly, use Derived Class e.g. CssSpriteRenderer")}get centerOffset(){return this.da}set centerOffset(t){this.da.copy(t),this.updateCenterOffset(!0)}get viewScale(){return this.dn}set viewScale(t){this.dn=t,this.updateViewScale(!0)}get pointerEvents(){return this.un}set pointerEvents(t){this.un=t,this.htmlElement&&(this.htmlElement.style.pointerEvents=t?"auto":"none")}get filter(){return this.Ui}get readyToDraw(){return this.Cl}get htmlElementEventHandler(){return this.htmlElement}}class xo extends yo{constructor(){super(...arguments),this.tu=1,this.su=1,this.iu=!1,this.Ca=null}renderInitialize(){var t;null===(t=this.Ca)||void 0===t||t.call(this),this.htmlElement||(this.element=null)}updateCenterOffset(t){if(!this.css3DObject)return;let e,i;if(this.iu)if(this.css3DObject.element.parentElement){const t=this.css3DObject.element.style.display;this.css3DObject.element.style.display="",e=this.css3DObject.element.offsetWidth*this.viewScale,i=this.css3DObject.element.offsetHeight*this.viewScale,this.css3DObject.element.style.display=t}else{const t=this.css3DObject.element.style.display;this.css3DObject.element.style.display="";const s=this.css3DObject.element.style.transform;this.css3DObject.element.style.transform="translateX(1000000px)",document.body.appendChild(this.css3DObject.element),e=this.css3DObject.element.offsetWidth*this.viewScale,i=this.css3DObject.element.offsetHeight*this.viewScale,this.css3DObject.element.style.display=t,this.css3DObject.element.style.transform=s,document.body.removeChild(this.css3DObject.element)}else e=this.tu,i=this.su;this.css3DObject.position.set(e*this.centerOffset.x,i*this.centerOffset.y,0),t&&(Et.updateRawObject3DWorldMatrixRecursively(this.css3DObject),this.transform.enqueueRenderAttachedObject3D(this.css3DObject))}updateViewScale(t){if(!this.css3DObject)return;const e=this.viewScale;this.iu?(this.css3DObject.scale.set(e,e,e),this.updateCenterOffset(!1)):(this.css3DObject.element.style.width=this.tu/this.viewScale+"px",this.css3DObject.element.style.height=this.su/this.viewScale+"px",this.css3DObject.scale.set(e,e,e)),t&&(Et.updateRawObject3DWorldMatrixRecursively(this.css3DObject),this.transform.enqueueRenderAttachedObject3D(this.css3DObject))}get element(){return this.htmlElement}set element(t){const e=this.htmlElement=null!=t?t:document.createElement("div");this.readyToDraw?this.hu(e):this.Ca=()=>this.hu(e)}hu(t){this.iu?(t.style.width="auto",t.style.height="auto"):(t.style.width=this.tu/this.viewScale+"px",t.style.height=this.su/this.viewScale+"px");const e=this.initializeBaseComponents(!0);Et.updateRawObject3DWorldMatrixRecursively(e),this.transform.enqueueRenderAttachedObject3D(e)}get elementWidth(){if(this.iu){if(this.htmlElement){const t=this.htmlElement.style.display;this.htmlElement.style.display="";const e=this.htmlElement.offsetWidth*this.viewScale;return this.htmlElement.style.display=t,e}return 0}return this.tu}set elementWidth(t){this.iu||(this.tu=t,this.htmlElement&&(this.htmlElement.style.width=t/this.viewScale+"px"),this.updateCenterOffset(!0))}get elementHeight(){if(this.iu){if(this.htmlElement){const t=this.htmlElement.style.display;this.htmlElement.style.display="";const e=this.htmlElement.offsetHeight*this.viewScale;return this.htmlElement.style.display=t,e}return 0}return this.su}set elementHeight(t){this.iu||(this.su=t,this.htmlElement&&(this.htmlElement.style.height=t/this.viewScale+"px"),this.updateCenterOffset(!0))}get autoSize(){return this.iu}set autoSize(t){this.iu=t,this.htmlElement&&(t?(this.htmlElement.style.width="auto",this.htmlElement.style.height="auto"):(this.htmlElement.style.width=this.tu/this.viewScale+"px",this.htmlElement.style.height=this.su/this.viewScale+"px"))}}class go{}go.defaultSpriteSrc="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAIAAACQkWg2AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAA8SURBVDhP7dEhCgAxDADB+/k9Lh8rDCtq6yo6JrAhKt9s/k2JEjceNGlPiRI3HjRpT4kS7w81SpQ4PJhZxl3jEH3ZDWcAAAAASUVORK5CYII=",(nn=rn||(rn={})).Auto="auto",nn.CrispEdges="crisp-edges",nn.Pixelated="pixelated";class wo extends yo{constructor(){super(...arguments),this.Ga=0,this.Ha=0,this.Xa=!1,this.Ya=!1,this.$a=1,this.gn=rn.Pixelated,this.Ca=null}renderInitialize(){this.Ca?this.Ca():this.asyncSetImageFromPath(go.defaultSpriteSrc)}updateCenterOffset(t){this.css3DObject&&(this.css3DObject.position.set(this.Ga*this.centerOffset.x,this.Ha*this.centerOffset.y,0),t&&(Et.updateRawObject3DWorldMatrixRecursively(this.css3DObject),this.transform.enqueueRenderAttachedObject3D(this.css3DObject)))}updateViewScale(t){if(!this.css3DObject)return;const e=this.viewScale,i=this.htmlElement;i.style.width=this.Ga/this.viewScale+"px",i.style.height=this.Ha/this.viewScale+"px";const s=this.Xa?-1:1,r=this.Ya?-1:1;this.css3DObject.scale.set(e*s,e*r,e),t&&(Et.updateRawObject3DWorldMatrixRecursively(this.css3DObject),this.transform.enqueueRenderAttachedObject3D(this.css3DObject))}get image(){return this.htmlElement}asyncSetImageFromPath(t,e){var i;if(!this.readyToDraw)return void(this.Ca=()=>this.asyncSetImageFromPath(t,e));const s=null!==(i=this.htmlElement)&&void 0!==i?i:new Image;s.src=t;const r=t=>{this.exists&&(s.removeEventListener("load",r),this.setImage(s),null==e||e())};s.addEventListener("load",r)}setImage(t){if(!t.complete)throw new Error(`Image {${t.src}} is not loaded.`);if(this.htmlElement=t,!this.readyToDraw)return void(this.Ca=()=>this.setImage(t));t.alt=this.gameObject.name+"_sprite",t.style.imageRendering=this.gn,0===this.Ga&&(this.Ga=.1*t.naturalWidth),0===this.Ha&&(this.Ha=.1*t.naturalHeight),t.style.width=this.Ga/this.viewScale+"px",t.style.height=this.Ha/this.viewScale+"px",t.style.opacity=this.$a.toString();const e=this.initializeBaseComponents(!1);Et.updateRawObject3DWorldMatrixRecursively(e),this.transform.enqueueRenderAttachedObject3D(e)}get imageWidth(){return this.Ga}set imageWidth(t){this.Ga=t,this.htmlElement&&(this.htmlElement.style.width=t/this.viewScale+"px"),this.updateCenterOffset(!0)}get imageHeight(){return this.Ha}set imageHeight(t){this.Ha=t,this.htmlElement&&(this.htmlElement.style.height=t/this.viewScale+"px"),this.updateCenterOffset(!0)}get imageFlipX(){return this.Xa}set imageFlipX(t){this.Xa=t,this.css3DObject&&(this.Xa?0<this.css3DObject.scale.x&&(this.css3DObject.scale.x*=-1):this.css3DObject.scale.x<0&&(this.css3DObject.scale.x*=-1),Et.updateRawObject3DWorldMatrixRecursively(this.css3DObject),this.transform.enqueueRenderAttachedObject3D(this.css3DObject))}get imageFlipY(){return this.Ya}set imageFlipY(t){this.Ya=t,this.css3DObject&&(this.Ya?0<this.css3DObject.scale.y&&(this.css3DObject.scale.y*=-1):this.css3DObject.scale.y<0&&(this.css3DObject.scale.y*=-1),Et.updateRawObject3DWorldMatrixRecursively(this.css3DObject),this.transform.enqueueRenderAttachedObject3D(this.css3DObject))}get opacity(){return this.$a}set opacity(t){this.$a=t,this.htmlElement&&(this.htmlElement.style.opacity=this.$a.toString())}get imageRenderingMode(){return this.gn}set imageRenderingMode(t){this.gn=t,this.htmlElement&&(this.htmlElement.style.imageRendering=this.gn)}}class Co extends lo{constructor(){super(...arguments),this.jo=null}set target(t){this.jo=t,t.transform.localPosition.x=this.transform.position.x,t.transform.localPosition.y=this.transform.position.y,t.transform.localEulerAngles.z=this.transform.eulerAngles.z}onWorldMatrixUpdated(){const t=this.jo.transform;t.localPosition.x=this.transform.position.x,t.localPosition.y=this.transform.position.y,t.localEulerAngles.z=this.transform.eulerAngles.z}}const vo="physics_debug_object";class So extends lo{constructor(){super(...arguments),this.tl=null,this.il=1,this.sl=null,this.hl=!1,this.rl=new Ut,this.Eo=null,this.updateFixturesMaterialInfo=()=>{if(this.tl){let t=null;if(this.sl)t=this.sl;else if(this.tl){const e=this.tl.physicObject.sharedMaterial;e&&(t=e)}t||(t=new Qn),this.tl.foreachFixture((e=>{e.SetFriction(t.friction),e.SetRestitution(t.bounciness)}))}},this.ci=new ci}onEnable(){this.ol(),this.tl.body.SetAwake(!0)}onDisable(){var t;null===(t=this.tl)||void 0===t||t.body.SetAwake(!0),this.ll()}onDestroy(){var t;null===(t=this.sl)||void 0===t||t.onChanged.removeListener(this.updateFixturesMaterialInfo)}ol(){var t;if(this.tl)return;this.tl=this.engine.physics2DProcessor.addCollider(this.gameObject,this);const e=this.createShapes();for(let t=0;t<e.length;t++){const i=e[t],s=new Si;s.userData=this,s.density=this.il,s.isSensor=this.hl,s.shape=i,this.tl.add(s)}this.updateFixturesMaterialInfo(),this.updateFixturesFilter(),null===(t=this.tl.physicObject.rigidbody)||void 0===t||t.updateMass()}ll(){var t;this.tl&&(this.engine.physics2DProcessor.removeCollider(this.gameObject,this,this.tl),null===(t=this.tl.physicObject.rigidbody)||void 0===t||t.updateMass(),this.tl=null)}updateFixture(){this.tl&&(this.ll(),this.ol(),this.tl.body.SetAwake(!0))}updateFixturesFilter(){if(!this.tl)return;const t=So._filterBuffer,e=this.tl.physicObject.rigidbody;let i;i=this.Eo?this.Eo:e?e.layer:1,t.categoryBits=i,e&&!e.simulated?t.maskBits=0:t.maskBits=this.engine.physics.collisionLayerMask.getMaskFromLayer(i),this.tl.foreachFixture((e=>e.SetFilterData(t)))}createShapes(){throw new Error("You should not use Collider2D directly but one of its subclasses. e.g. BoxCollider2D")}get density(){return this.il}set density(t){if(this.tl){const t=this.tl.physicObject;if(t&&t.rigidbody&&!t.rigidbody.useAutoMass)throw new Error("You cannot change the density of a collider when the rigid body is not using auto mass.")}this.il=t,this.tl&&this.tl.foreachFixture((e=>e.SetDensity(t)))}get material(){return this.sl}set material(t){var e;t?this.sl?this.sl.copy(t):(this.sl=new Qn(t.friction,t.bounciness),this.sl.onChanged.addListener(this.updateFixturesMaterialInfo)):(null===(e=this.sl)||void 0===e||e.onChanged.removeListener(this.updateFixturesMaterialInfo),this.sl=null),this.updateFixturesMaterialInfo()}get isTrigger(){return this.hl}set isTrigger(t){this.hl=t,this.tl&&this.tl.foreachFixture((e=>e.SetSensor(t)))}get offset(){return this.rl}set offset(t){this.rl.copy(t),this.updateFixture()}getLayerToName(){return this.Eo?this.engine.physics.collisionLayerMask.layerToName(this.Eo):null}setLayerFromName(t){this.Eo=t?this.engine.physics.collisionLayerMask.nameToLayer(t):null,this.updateFixturesFilter()}get layer(){return this.Eo}set layer(t){this.Eo=t,this.updateFixturesFilter()}getThisOrRigidBodyLayerToName(){var t,e,i;return this.Eo?this.engine.physics.collisionLayerMask.layerToName(this.Eo):null!==(i=null===(e=null===(t=this.tl)||void 0===t?void 0:t.physicObject.rigidbody)||void 0===e?void 0:e.getLayerToName())&&void 0!==i?i:"default"}getThisOrRigidBodyLayer(){var t,e,i;return this.Eo?this.Eo:null!==(i=null===(e=null===(t=this.tl)||void 0===t?void 0:t.physicObject.rigidbody)||void 0===e?void 0:e.layer)&&void 0!==i?i:1}getContacts(t){if(!this.tl)return 0;let e=0,i=this.tl.body.GetContactList();for(;i;){const s=i;if(i=i.next,!this.tl.contains(s.contact.GetFixtureA())&&!this.tl.contains(s.contact.GetFixtureB()))continue;const r=s.contact.GetManifold();for(let i=0;i<r.pointCount;i++)t[e]||(t[e]=new Un),s.contact.GetWorldManifold(this.ci),t[e].setData(s.contact,r.points[i],this.ci.normal,this.ci.points[i],this.ci.separations[i]),e+=1}return e}}So._filterBuffer=new vi;class bo extends So{constructor(){super(...arguments),this.ki=new Ut(1,1),this.Xo=0,this.Yo=!0,this.Zo=null,this.$o=[new Ri]}Qn(){if(this.Yo){let t=this.gameObject.getComponent(Co);if(t||(t=this.gameObject.addComponent(Co)),this.Zo){const t=this.Zo.getComponentInChildren(xo);t.element.style.borderRadius=100*this.edgeRadius+"px",t.elementWidth=this.ki.x+2*this.edgeRadius,t.elementHeight=this.ki.y+2*this.edgeRadius}else{const e=function(t){let e=null;return t.scene.iterateChild((t=>t.gameObject.name!==vo||(e=t.gameObject,!1))),e||(e=t.scene.addChildFromBuilder(t.instantiater.buildGameObject(vo))),e}(this.engine);this.Zo=e.addChildFromBuilder(this.engine.instantiater.buildGameObject(this.gameObject.name+"_debug_box").withChild(this.engine.instantiater.buildGameObject("debug_box",new $(this.offset.x,this.offset.y,200)).withComponent(xo,(t=>{const e=document.createElement("div");e.style.border="2px solid rgba(255, 255, 0, 0.3)",e.style.borderRadius=100*this.edgeRadius+"px",e.style.margin="0",e.style.padding="0",e.style.backgroundColor="rgba(0, 0, 0, 0)",t.element=e,t.elementWidth=this.ki.x+2*this.edgeRadius,t.elementHeight=this.ki.y+2*this.edgeRadius,t.viewScale=.01,t.pointerEvents=!1})))),t.target=this.Zo}}}onEnable(){super.onEnable(),this.Qn()}onDisable(){super.onDisable(),this.Zo&&(this.Zo.destroy(),this.Zo=null)}createShapes(){const t=this.$o[0];return t.SetAsBox(this.ki.x/2,this.ki.y/2,this.offset),t.m_radius=this.Xo,this.$o}get size(){return this.ki}set size(t){if(t.x<=0||t.y<=0)throw new Error("size must be greater than 0");this.ki.copy(t),this.updateFixture(),this.Qn()}get edgeRadius(){return this.Xo}set edgeRadius(t){this.Xo=t,this.updateFixture(),this.Qn()}get debugDraw(){return this.Yo}set debugDraw(t){this.Yo=t,this.enabled&&this.gameObject.activeInHierarchy&&(t?this.Qn():this.Zo&&(this.Zo.destroy(),this.Zo=null))}}var Bo,Ao,Vo,Mo;!function(t){t[t.Dynamic=0]="Dynamic",t[t.Kinematic=1]="Kinematic",t[t.Static=2]="Static"}(Bo||(Bo={})),function(t){t[t.Discrete=0]="Discrete",t[t.Continuous=1]="Continuous"}(Ao||(Ao={})),function(t){t[t.NeverSleep=0]="NeverSleep",t[t.StartAwake=1]="StartAwake",t[t.StartAsleep=2]="StartAsleep"}(Vo||(Vo={})),function(t){t[t.Force=0]="Force",t[t.Impulse=1]="Impulse"}(Mo||(Mo={}));class Do extends lo{constructor(){super(...arguments),this.disallowMultipleComponent=!0,this.yo=null,this.sr=null,this.Ro=Ai.b2_dynamicBody,this.Vo=!0,this.Fo=!1,this.No=1,this.So=0,this.Bo=.05,this.Po=1,this.ko=Ao.Discrete,this.Ao=Vo.StartAwake,this.Oo=!1,this.Eo=1,this.zo=new Ut(NaN,NaN),this.Lo=new Ut(NaN,NaN),this.Uo=NaN,this.Wo=new Ut,this.qo=0,this.Io=new Le,this.Ko=new Ie,this.ci=new ci}awake(){if(this.yo)return;const t=new Mi;if(t.userData=this,t.type=this.Ro,t.enabled=this.Vo,t.linearDamping=this.So,t.angularDamping=this.Bo,t.gravityScale=this.Po,t.bullet=this.ko===Ao.Continuous,t.allowSleep=this.Ao!==Vo.NeverSleep,t.awake=this.Ao===Vo.StartAwake||this.Ao===Vo.NeverSleep,t.fixedRotation=this.Oo,t.position.Set(this.transform.position.x,this.transform.position.y),t.angle=this.transform.eulerAngles.z,t.linearVelocity.Copy(this.Wo),t.angularVelocity=this.qo,this.yo=this.engine.physics2DProcessor.addRigidBody(this.gameObject,this,t),this.Go(),this.sr=this.yo.body,isNaN(this.zo.x)){const t=this.sr.GetLocalCenter();this.zo.set(t.x,t.y)}isNaN(this.Uo)&&(this.Uo=this.sr.GetInertia()),this.Ho()}onDestroy(){var t;null===(t=this.yo)||void 0===t||t.setSharedPhysicsMaterial(null),this.engine.physics2DProcessor.removeRigidBody(this.gameObject),this.yo=null,this.sr=null,this.Go()}onEnable(){this.Vo=!0,this.Jo().SetEnabled(!0),this.Go()}onDisable(){var t;this.Vo=!1,null===(t=this.sr)||void 0===t||t.SetEnabled(!1),this.Go()}Go(){if(!this.yo)return;const t=this.yo.colliders;for(let e=0,i=t.length;e<i;e++)t[e].updateFixturesFilter()}Qo(){return this.yo||this.awake(),this.yo}Jo(){return this.sr||this.awake(),this.sr}Ho(){if(!this.sr)return;const t=this.Io;this.sr.GetMassData(t),this.Fo||(t.mass=this.No),t.center.Copy(this.zo),t.I=this.Uo,this.sr.SetMassData(t)}updateMass(){if(!this.sr)return;if(!this.Fo)return;const t=this.Io;this.sr.GetMassData(t),t.mass=this.No,this.sr.SetMassData(t)}get bodyType(){switch(this.Ro){case Ai.b2_staticBody:return Bo.Static;case Ai.b2_kinematicBody:return Bo.Kinematic;case Ai.b2_dynamicBody:return Bo.Dynamic}throw new Error("Unknown body type")}set bodyType(t){switch(t){case Bo.Dynamic:this.Ro=Ai.b2_dynamicBody;break;case Bo.Kinematic:this.Ro=Ai.b2_kinematicBody;break;case Bo.Static:this.Ro=Ai.b2_staticBody}}get material(){return this.Qo().sharedMaterial}set material(t){this.Qo().setSharedPhysicsMaterial(t)}get simulated(){return this.Vo}set simulated(t){this.enabled=t}get useAutoMass(){return this.Fo}set useAutoMass(t){this.Fo=t,this.sr&&this.Fo&&(this.No=this.sr.GetMass()),this.Ho()}get mass(){return this.Fo?this.Jo().GetMass():this.No}set mass(t){if(this.Fo)throw new Error("Cannot set mass when useAutoMass is true");this.No=t,this.Ho()}get drag(){return this.So}set drag(t){var e;this.So=t,null===(e=this.sr)||void 0===e||e.SetLinearDamping(t)}get angularDrag(){return this.Bo}set angularDrag(t){var e;this.Bo=t,null===(e=this.sr)||void 0===e||e.SetAngularDamping(t)}get gravityScale(){return this.Po}set gravityScale(t){var e;this.Po=t,null===(e=this.sr)||void 0===e||e.SetGravityScale(t)}get collisionDetection(){return this.ko}set collisionDetection(t){var e;this.ko=t,null===(e=this.sr)||void 0===e||e.SetBullet(t===Ao.Continuous)}get sleepMode(){return this.Ao}set sleepMode(t){var e,i;this.Ao=t,null===(e=this.sr)||void 0===e||e.SetSleepingAllowed(t!==Vo.NeverSleep),null===(i=this.sr)||void 0===i||i.SetAwake(t===Vo.StartAwake||t===Vo.NeverSleep)}get freezeRotation(){return this.Oo}set freezeRotation(t){var e;this.Oo=t,null===(e=this.sr)||void 0===e||e.SetFixedRotation(t)}getLayerToName(){return this.engine.physics.collisionLayerMask.layerToName(this.Eo)}setLayerFromName(t){this.Eo=this.engine.physics.collisionLayerMask.nameToLayer(t),this.Go()}get layer(){return this.Eo}set layer(t){this.Eo=t,this.Go()}get centerOfMass(){const t=this.Jo().GetLocalCenter();return this.zo.set(t.x,t.y),this.zo}set centerOfMass(t){this.zo.copy(t),this.Ho()}get worldCenterOfMass(){const t=this.Jo().GetWorldCenter();return this.Lo.set(t.x,t.y),this.Lo}get inertia(){return this.Uo}set inertia(t){this.Uo=t,this.Ho()}get velocity(){if(this.sr){const t=this.sr.GetLinearVelocity();this.Wo.set(t.x,t.y)}return this.Wo}set velocity(t){this.Wo.copy(t),this.sr&&this.sr.SetLinearVelocity(t)}get angularVelocity(){return this.sr&&(this.qo=this.sr.GetAngularVelocity()),this.qo}set angularVelocity(t){this.qo=t,this.sr&&this.sr.SetAngularVelocity(t)}get attachedColliderCount(){return this.Qo().colliders.length}addForce(t,e=Mo.Force){const i=this.Jo();e===Mo.Impulse?i.ApplyLinearImpulse(t,i.GetWorldCenter(),!0):i.ApplyForce(t,i.GetWorldCenter(),!0)}addForceAtPosition(t,e,i=Mo.Force){const s=this.Jo(),r=this.Ko.Copy(e);i===Mo.Impulse?s.ApplyLinearImpulse(t,r,!0):s.ApplyForce(t,r,!0)}addRelativeForce(t,e=Mo.Force){const i=this.Jo(),s=i.GetWorldVector(t,this.Ko);e===Mo.Impulse?i.ApplyLinearImpulse(s,i.GetWorldCenter(),!0):i.ApplyForce(s,i.GetWorldCenter(),!0)}addTorque(t,e=Mo.Force){const i=this.Jo();e===Mo.Impulse?i.ApplyAngularImpulse(t,!0):i.ApplyTorque(t,!0)}getPoint(t,e){const i=null!=e?e:new Ut,s=this.Ko.Copy(t);return this.Jo().GetLocalPoint(s,i)}getPointVelocity(t,e){const i=null!=e?e:new Ut,s=this.Ko.Copy(t);return this.Jo().GetLinearVelocityFromWorldPoint(s,i)}getRelativePoint(t,e){const i=null!=e?e:new Ut,s=this.Ko.Copy(t);return this.Jo().GetWorldPoint(s,i)}getRelativePointVelocity(t,e){const i=null!=e?e:new Ut,s=this.Ko.Copy(t);return this.Jo().GetLinearVelocityFromWorldPoint(s,i)}getRelativeVector(t,e){const i=null!=e?e:new Ut;return this.Jo().GetWorldVector(t,i)}getVector(t,e){const i=null!=e?e:new Ut;return this.Jo().GetLocalVector(t,i)}getAttachedColliders(t){const e=this.Qo().colliders;t.length<e.length&&(t.length=e.length);for(let i=0;i<e.length;i++)t[i]=e[i];return e.length}getContacts(t){let e=0,i=this.Jo().GetContactList();for(;i;){const s=i;i=i.next;const r=s.contact.GetManifold();for(let i=0;i<r.pointCount;i++)t[e]||(t[e]=new Un),s.contact.GetWorldManifold(this.ci),t[e].setData(s.contact,r.points[i],this.ci.normal,this.ci.points[i],this.ci.separations[i]),e+=1}return e}overlapPoint(t){const e=this.Ko.Copy(t);let i=this.Jo().GetFixtureList();for(;i;){if(i.TestPoint(e))return!0;i=i.GetNext()}return!1}isSleeping(){return!this.Jo().IsAwake()}sleep(){this.Jo().SetAwake(!1)}isAwake(){return this.Jo().IsAwake()}wakeUp(){this.Jo().SetAwake(!0)}}class Io{constructor(t,e,i){this.imageUrl=t,this.title=e,this.siteUrl=i}}class Po{constructor(){}static fatch(t){return e=this,i=void 0,r=function*(){const e=yield fetch(`https://www.googleapis.com/customsearch/v1?key=${encodeURIComponent(Po._apiKey)}&cx=${encodeURIComponent(Po._searchEngineID)}&q=${encodeURIComponent(t)}`);return(yield e.json()).items.filter((t=>t.pagemap&&t.pagemap.cse_thumbnail&&1<=t.pagemap.cse_thumbnail.length)).map((t=>new Io(t.pagemap.cse_thumbnail[0].src,t.title,t.link)))},new((s=void 0)||(s=Promise))((function(t,n){function o(t){try{a(r.next(t))}catch(t){n(t)}}function h(t){try{a(r.throw(t))}catch(t){n(t)}}function a(e){var i;e.done?t(e.value):(i=e.value,i instanceof s?i:new s((function(t){t(i)}))).then(o,h)}a((r=r.apply(e,i||[])).next())}));var e,i,s,r}}Po._apiKey="AIzaSyAJhEuo0_VTzt3bXcNYKOdXSC5hMJ6b2Z8",Po._searchEngineID="edfb26c41430b8e2b";class Go extends lo{constructor(){super(...arguments),this.requiredComponents=[Do,yo],this.disallowMultipleComponent=!0,this._rigidBody=null,this._renderer=null,this._isDragging=!1,this._mousePosition=new Ut,this.onPointerMove=t=>{const e=this.engine.screen,i=2*this.engine.cameraContainer.camera.viewSize,s=e.width/e.height,r=(t.pageX/this.engine.screen.width-.5)*i*s,n=(-t.pageY/this.engine.screen.height+.5)*i;this._mousePosition.set(r,n)},this.onPointerLeave=()=>{this._isDragging=!1},this._tempVector2=new Ut}awake(){this._rigidBody=this.gameObject.getComponent(Do),this._renderer=this.gameObject.getComponent(yo),this.engine.input.onPointerMove.addListener(this.onPointerMove),this.engine.input.onPointerLeave.addListener(this.onPointerLeave),this.engine.input.onPointerUp.addListener(this.onPointerLeave),this.startCoroutine(this.waitAndInitialize())}*waitAndInitialize(){yield new v((()=>null===this._renderer.htmlElementEventHandler)),this._renderer.htmlElementEventHandler.onmousedown=()=>{this._isDragging=!0}}onDestroy(){this.engine.input.onPointerMove.removeListener(this.onPointerMove),this.engine.input.onPointerLeave.removeListener(this.onPointerLeave),this.engine.input.onPointerUp.removeListener(this.onPointerLeave),this._renderer.htmlElementEventHandler&&(this._renderer.htmlElementEventHandler.onmousedown=null),this._rigidBody=null,this._renderer=null}update(){if(this._isDragging){const t=this._mousePosition,e=this._rigidBody,i=e.transform.position,s=this._tempVector2.set(i.x,i.y).sub(t).multiplyScalar(-40);e.addForce(s)}}}class To extends lo{constructor(){super(...arguments),this.maxSpawnDelay=2,this.minSpawnDelay=.3,this.spawnMaxX=5,this.spawnMinY=-5,this.spawnY=0,this.spawnRotationMax=Math.PI/2,this.spawnRotationMin=0,this.maxSpawnCount=20,this.imageScale=2,this._spawnedImages=[]}generateRandomNumber(t,e){return Math.floor(Math.random()*(e-t+1))+t}spawn(t){this.startCoroutine(this.spawnInternal(t))}clear(){for(let t=0;t<this._spawnedImages.length;t++)this._spawnedImages[t].gameObject.destroy();this._spawnedImages.length=0}*spawnInternal(t){let e=null;Po.fatch(t).then((t=>e=t)),yield new v((()=>null===e));for(const t of e){if(this._spawnedImages.length>=this.maxSpawnCount){const t=this._spawnedImages.shift();t&&t.gameObject.destroy()}const e=new io,i=new io,s=new $(this.generateRandomNumber(this.spawnMinY,this.spawnMaxX),this.spawnY,0).add(this.gameObject.transform.position),r=(new K).setFromAxisAngle(new $(0,0,1),this.generateRandomNumber(this.spawnRotationMin,this.spawnRotationMax));this.engine.scene.addChildFromBuilder(this.engine.instantiater.buildGameObject(t.title,s,r).withComponent(wo,(e=>{e.asyncSetImageFromPath(t.imageUrl,(()=>{const t=e.imageWidth,s=e.imageHeight;e.imageWidth=1*this.imageScale,e.imageHeight=s/t*e.imageWidth,i.ref.size=new Ut(e.imageWidth,e.imageHeight)}))})).withComponent(Do).withComponent(bo).withComponent(Go).getComponent(wo,e).getComponent(bo,i)),this._spawnedImages.push(e.ref),yield new w(this.generateRandomNumber(this.minSpawnDelay,this.maxSpawnDelay))}}}class Ro extends class{constructor(t,e){this.H=t.instantiater,this.V=e||null,this.W=new oe(t.sceneProcessor),this.S=new le(le.createDefaultObject())}getGameSettingObject(){return Object.freeze(this.S),this.S.make()}get instantiater(){return this.H}get interopObject(){return this.V}get sceneBuilder(){return this.W}get setting(){return this.S}}{run(){this.setting.physics.loader(eo);const t=this.instantiater,e=new io;return this.sceneBuilder.withChild(t.buildGameObject("Camera").withComponent(uo,(t=>{t.backgroundColor=new mo(.1,.1,.1)})).withChild(t.buildGameObject("TextInput",new $(0,0,1)).withComponent(xo,(t=>{const i=document.createElement("div"),s=document.createElement("input");s.type="text",s.placeholder="Search for an image",s.style.width="100%",s.style.height="100%",s.style.border="none",s.style.opacity="0.5";let r=0,n="";s.addEventListener("keyup",(t=>{if("Enter"===t.key){if(Date.now()-r<1e3)return;if(s.value==n)return;if(""===s.value)return void e.ref.clear();const t=e.ref;t&&t.spawn(s.value),r=Date.now(),n=s.value}})),i.appendChild(s),t.element=i,t.elementWidth=8,t.viewScale=.04})))).withChild(t.buildGameObject("Spawner",new $(0,6,0)).withComponent(To,(t=>{globalThis.spawner=t})).getComponent(To,e)).withChild(t.buildGameObject("Ground",new $(0,-5,0)).withComponent(wo,(t=>{t.imageWidth=30,t.imageHeight=1})).withComponent(bo,(t=>{t.size=new Ut(30,1),t.debugDraw=!1})))}}!function(t){const e=new ne(t);e.run(Ro),e.inputHandler.startHandleEvents()}(document.body)})();